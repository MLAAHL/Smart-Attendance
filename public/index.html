<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Attendance</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="demo.css">

  <!-- Inline Styles -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    
    /* Teacher mode styles */
    .teacher-mode #viewTab {
      min-height: 100vh;
      padding: 20px;
    }
    
    .teacher-mode .tabcontent {
      border: none;
      box-shadow: none;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            customDark: '#060D0C',
            customLight: '#F0EDE5',
            customAccent: '#2A3B36',
            customMuted: '#8B9B8F',
          }
        }
      }
    }
  </script>
</head>

<body>
  <!-- Main Wrapper -->
  <div id="homePage" class="hidden">
    
    <!-- Header Section -->
    <header class="relative w-full px-5 py-6 text-white overflow-hidden flex items-center justify-center h-[200vh]">
      
      <!-- Toggle Button -->
      <div class="menu-icon cursor-pointer" onclick="toggleMenu()">
        <div class="line long bg-gray-800 h-1 w-6 mb-1"></div>
        <div class="line short bg-gray-800 h-1 w-4"></div>
      </div>

      <!-- User Icon -->
      <div class="absolute top-4 right-4 flex items-center space-x-2">
        <span class="text-sm font-medium" style="color: #060D0C;" id="userName"></span>
        <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User"
             class="w-8 h-8 rounded-full shadow-lg border" style="border-color: #8B9B8F;"/>
      </div>

      <!-- Side Menu -->
      <div id="mobileMenu" class="side-menu hidden fixed top-0 left-0 w-64 h-full bg-white shadow z-50 p-4 transition-transform transform -translate-x-full">
        <div class="mb-8">
          <div class="text-2xl font-bold flex items-center" style="color: #060D0C;">
            <i class="fas fa-chalkboard-teacher mr-2"></i>
            Smart Panel
          </div>
          <div class="text-xs mt-1" style="color: #8B9B8F;">Teacher Dashboard</div>
        </div>
        
        <div class="user-profile flex flex-col items-center mb-8">
          <div class="relative mb-4">
            <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" 
                 class="w-20 h-20 rounded-full border-4 object-cover shadow-lg" style="border-color: #F0EDE5;"/>
            <div class="absolute bottom-0 right-0 w-6 h-6 bg-green-400 rounded-full border-2 border-white"></div>
          </div>
          <span id="userName" class="font-semibold text-lg" style="color: #060D0C;"></span>
          <span id="userEmail" class="text-sm mt-1" style="color: #8B9B8F;"></span>
        </div>
        
        <ul class="space-y-4 text-black">
          <li>
            <button onclick="window.location.href = 'myclass.html'" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.backgroundColor='transparent'">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #F0EDE5; color: #060D0C;">
                <i class="fas fa-home text-sm"></i>
              </div>
              <span>Dashboard</span>
            </button>
          </li>
          <li>
            <a href="/myclass.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.backgroundColor='transparent'">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #F0EDE5; color: #060D0C;">
                <i class="fas fa-comments text-sm"></i>
            </div>
            <span>My class</span>
            </a>
          </li>
          
        
          <!-- ✅ NEW: Promote Students Button -->
          <li>
            <a href="/promotion.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.backgroundColor='transparent'">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #F0EDE5; color: #060D0C;">
                <i class="fas fa-user-graduate text-sm"></i>
              </div>
              <span>Promote Students</span>
            </a>
          </li>
          <li>
            <a href="/msg.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.backgroundColor='transparent'">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #F0EDE5; color: #060D0C;">
                <i class="fas fa-comments text-sm"></i>
            </div>
            <span>WhatsApp</span>
            </a>
          </li>
          
          <li>
            <a href="/report.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.backgroundColor='transparent'">
              <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #F0EDE5; color: #060D0C;">
                <i class="fas fa-user-graduate text-sm"></i>
              </div>
              <span>Reports</span>
            </a>
          </li>
          
       
        </ul>
        
        <!-- Logout Button -->
        <div class="mt-auto pt-4">
          <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.backgroundColor='transparent'">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #F0EDE5; color: #060D0C;">
              <i class="fas fa-sign-out-alt text-sm"></i>
            </div>
            <span>Logout</span>
          </button>
        </div>
        
    </header>

    <div class="banner-wrapper">
      <div class="banner">
        <div class="banner-text">
          <div class="badge">MLA AHL</div>
          <h1>Smart Attendance System</h1>
          <p>Mark it. View it.</p>
             <P>Stay on track.</p>
        </div>
        <div class="banner-img">
          <img src="b1.png" 
         alt="Attendance Illustration" 
         class="w-40 sm:w-40 drop-shadow-lg" />
        </div>

        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
      </div>
    </div>


  </div> <!-- End of #homePage -->


    <div id="tabs">
      <!-- ✅ MOBILE HEADER: Optimized spacing -->
      <header class="w-full shadow-sm border-b px-3 py-3 mb-4" style="background-color: #F0EDE5; border-color: #8B9B8F;">
        <div class="flex items-center justify-between">
          <!-- Left: Back Button -->
          <button onclick="window.location.href = 'myclass.html'" class="w-8 h-8 rounded-full border flex items-center justify-center transition-all duration-200 active:scale-95" style="background-color: #F0EDE5; border-color: #8B9B8F;" onmouseover="this.style.backgroundColor='#060D0C'; this.style.color='#F0EDE5'" onmouseout="this.style.backgroundColor='#F0EDE5'; this.style.color='#060D0C'">
            <i class="fa-solid fa-angle-left text-xs" style="color: #060D0C;"></i>
          </button>
          
          
          <!-- Center: Title -->
          <div class="flex items-center space-x-3 rounded-lg px-3 py-2">
            <div class="text-center">
              <p class="font-semibold text-sm" style="color: #060D0C;">Attendance Management</p>
            </div>
          </div>
          
          <!-- Right: Spacer -->
          <div class="w-8 h-8"></div>
          
        </div>
      </header>
      
      <!-- ✅ TAB BUTTONS: Better spacing -->
      <div class="px-4 mb-6">
        <div class="flex rounded-full shadow-md p-1 max-w-sm mx-auto" style="background-color: #F0EDE5;">
          <button onclick="showTab('markTab')" id="markBtn"
            class="tablinks flex-1 px-4 py-2 text-white rounded-full transition-all duration-300 shadow-md text-xs font-medium" style="background-color: #060D0C;">
            Mark Attendance
          </button>
          <button onclick="showTab('viewTab')" id="viewBtn"
            class="tablinks flex-1 px-4 py-2 rounded-full transition-all duration-300 text-xs font-medium" style="color: #8B9B8F;" onmouseover="this.style.color='#060D0C'; this.style.backgroundColor='#F0EDE5'" onmouseout="this.style.color='#8B9B8F'; this.style.backgroundColor='transparent'">
            View Attendance
          </button>
        </div>
      </div>
    </div>
    
    
    <div id="markTab" class="tabcontent p-3 sm:p-4">
      <!-- ✅ COMPACT: Title with responsive spacing -->
      <h3 class="text-base sm:text-lg font-semibold mb-3 flex items-center" style="color: #060D0C;">
        <i class="fas fa-edit mr-2" style="color: #060D0C;"></i>
        Mark Attendance
      </h3>
    
      <!-- ✅ RESPONSIVE: Date and subject layout -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4 px-1">
        <!-- Date Input -->
        <div class="relative">
          <label class="block text-xs mb-1" style="color: #8B9B8F;">Date</label>
          <input 
            type="date" 
            id="date" 
            class="w-full p-2 text-sm border rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'" 
            onchange="checkDateWarnings()"
          />
          <div id="dateWarning" class="hidden mt-1 text-xs flex items-center" style="color: #8B9B8F;">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="dateWarningText"></span>
          </div>
        </div>
        
        <!-- Subject Select -->
        <div>
          <label class="block text-xs mb-1" style="color: #8B9B8F;">Subject</label>
          <select id="subject-mark" class="w-full px-3 py-2 text-sm bg-white rounded-lg shadow focus:outline-none focus:ring-2 transition duration-200" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
            <option value="">-- Select Subject --</option>
          </select>
        </div>
      </div>
    
      <!-- ✅ RESPONSIVE: Students table -->
      <div class="overflow-x-auto rounded-lg shadow mb-4">
        <table class="table-auto w-full border bg-white rounded-lg overflow-hidden" style="border-color: #8B9B8F; color: #060D0C;">
          <thead class="text-white" style="background: linear-gradient(to right, #060D0C, #2A3B36);">
            <tr>
              <th class="p-2 sm:p-3 border text-center text-xs sm:text-sm" style="border-color: #8B9B8F;">#</th>
              <th class="p-2 sm:p-3 border text-center text-xs sm:text-sm" style="border-color: #8B9B8F;">ID</th>
              <th class="p-2 sm:p-3 border text-left text-xs sm:text-sm" style="border-color: #8B9B8F;">Name</th>
              <th class="p-2 sm:p-3 border text-center text-xs sm:text-sm" style="border-color: #8B9B8F;">Present</th>
            </tr>
          </thead>
          <tbody id="students-list" class="text-xs sm:text-sm"></tbody>
        </table>
      </div>
    
      <!-- ✅ RESPONSIVE: Submit button -->
      <div class="flex justify-center mt-4">
        <button id="submitAttendance" class="text-white px-6 py-2 sm:px-8 sm:py-3 rounded-full font-medium hover:shadow-lg transition flex items-center text-sm sm:text-base" style="background: linear-gradient(to right, #060D0C, #2A3B36);" onmouseover="this.style.background='linear-gradient(to right, #2A3B36, #060D0C)'" onmouseout="this.style.background='linear-gradient(to right, #060D0C, #2A3B36)'">
          <i class="fas fa-paper-plane mr-2"></i> 
          <span class="hidden sm:inline">Submit Attendance</span>
          <span class="sm:hidden">Submit</span>
        </button>
      </div>
    </div>
    
    <div id="viewTab" class="tabcontent hidden p-2 sm:p-4">
      <!-- Mobile-optimized header -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold flex items-center" style="color: #060D0C;">
          <i class="fas fa-table mr-2 text-sm" style="color: #060D0C;"></i>
          Register
        </h3>
        <!-- Back to My Class button (only shown in teacher mode) -->
        <button id="backToMyClassBtn" onclick="backToMyClass()" class="hidden px-3 py-1 text-xs rounded-lg transition-all" style="background-color: #F0EDE5; color: #060D0C; border: 1px solid #8B9B8F;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='#F0EDE5'">
          <i class="fas fa-arrow-left mr-1"></i>My Class
        </button>
      </div>
    
      <!-- Stream/Semester/Subject selection for teacher mode -->
      <div id="teacherSelectionInterface" class="hidden space-y-3 mb-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label for="teacher-stream-select" class="block text-xs font-medium mb-1" style="color: #8B9B8F;">Select Stream</label>
            <select id="teacher-stream-select" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
              <option value="">-- Select Stream --</option>
            </select>
          </div>
          <div>
            <label for="teacher-semester-select" class="block text-xs font-medium mb-1" style="color: #8B9B8F;">Select Semester</label>
            <select id="teacher-semester-select" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
              <option value="">-- Select Semester --</option>
            </select>
          </div>
        </div>
        <div>
          <label for="teacher-subject-select" class="block text-xs font-medium mb-1" style="color: #8B9B8F;">Select Subject</label>
          <select id="teacher-subject-select" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
            <option value="">-- Select Subject --</option>
          </select>
        </div>
        <button id="teacherLoadRegisterBtn" class="w-full sm:w-auto px-4 py-2 text-white rounded-lg text-sm font-medium transition-all" style="background: linear-gradient(to right, #060D0C, #2A3B36);" onmouseover="this.style.background='linear-gradient(to right, #2A3B36, #060D0C)'" onmouseout="this.style.background='linear-gradient(to right, #060D0C, #2A3B36)'">
          <i class="fas fa-search mr-2"></i>Load Attendance Register
        </button>
      </div>

      <!-- Original subject selection (for normal mode) -->
      <div id="normalSelectionInterface" class="space-y-2 mb-4">
        <label for="subject-view" class="block text-xs font-medium" style="color: #8B9B8F;">Select Subject</label>
        <select id="subject-view" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
          <option value="">-- Select Subject --</option>
        </select>
        <button id="loadRegisterBtn" class="w-full sm:w-auto px-4 py-2 text-white rounded-lg text-sm font-medium transition-all" style="background: linear-gradient(to right, #060D0C, #2A3B36);" onmouseover="this.style.background='linear-gradient(to right, #2A3B36, #060D0C)'" onmouseout="this.style.background='linear-gradient(to right, #060D0C, #2A3B36)'">
          <i class="fas fa-search mr-2"></i>Load Attendance Register
        </button>
      </div>
    
      <!-- Register display -->
      <div id="registerTable" class="hidden">
        <!-- Action buttons -->
        <div class="flex justify-end gap-2 mb-3">
          <button id="saveChangesBtn" onclick="saveAttendanceChanges()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-white rounded-lg text-xs sm:text-sm font-medium hidden transition-all" style="background-color: #2A3B36;" onmouseover="this.style.backgroundColor='#060D0C'" onmouseout="this.style.backgroundColor='#2A3B36'">
            <i class="fas fa-save text-sm mr-1"></i>
            <span class="hidden sm:inline">Save Changes</span>
            <span class="sm:hidden text-xs">Save</span>
          </button>
          <button id="exportExcelBtn" onclick="exportToExcel()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-white rounded-lg text-xs sm:text-sm font-medium hidden transition-all" style="background-color: #060D0C;" onmouseover="this.style.backgroundColor='#2A3B36'" onmouseout="this.style.backgroundColor='#060D0C'">
            <i class="fas fa-file-excel text-sm mr-1"></i>
            <span class="hidden sm:inline">Export Excel</span>
            <span class="sm:hidden text-xs">Export</span>
          </button>
        </div>
        
      
        <!-- ✅ FIXED: Table with sticky student column -->
        <div class="rounded-lg shadow border overflow-hidden bg-white" style="border-color: #8B9B8F;">
          <div class="overflow-x-auto relative">
            <table class="min-w-full text-xs sm:text-sm border-collapse">
              <thead class="text-white sticky top-0 z-30" style="background-color: #060D0C;" id="view-thead">
                <!-- Headers will be populated by JavaScript -->
              </thead>
              <tbody class="bg-white divide-y" style="color: #060D0C; border-color: #F0EDE5;" id="view-tbody">
                <!-- Rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
    
        <!-- Mobile scroll hint -->
        <div class="mt-2 text-xs text-center flex items-center justify-center gap-2" style="color: #8B9B8F;">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Student column stays fixed • Scroll horizontally to view all dates</span>
        </div>
        
        <!-- ✅ Stats summary -->
        <div class="mt-3 p-2 rounded-lg text-xs grid grid-cols-2 sm:grid-cols-4 gap-2" style="background-color: #F0EDE5; color: #060D0C;" id="attendanceStats">
          <!-- Stats will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    
    
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
    // ✅ COMPLETE FIXED ATTENDANCE MANAGEMENT SYSTEM
    // Enhanced with proper error handling, language subject filtering, and WhatsApp integration
    
    // ✅ Global Variables
    let selectedStream = "";
    let selectedSem = "";
    let subjectChangeListenerAdded = false;
    let menuClickListenerAdded = false;
    
    // ✅ DOM Element References
    const streamSection = document.getElementById("streamSection");
    const semesterSection = document.getElementById("semesterSection");
    const tabs = document.getElementById("tabs");
    const markTab = document.getElementById("markTab");
    const viewTab = document.getElementById("viewTab");
    const subjectMark = document.getElementById("subject-mark");
    const subjectView = document.getElementById("subject-view");
    const studentsList = document.getElementById("students-list");
    const submitBtn = document.getElementById("submitAttendance");
    const viewThead = document.getElementById("view-thead");
    const viewTbody = document.getElementById("view-tbody");
    const markBtn = document.getElementById("markBtn");
    const viewBtn = document.getElementById("viewBtn");
    
    // ✅ CRITICAL FIX: Date Validation Function (Must be defined first)
    function validateAttendanceDates(dates) {
      const invalidDates = [];
      const validatedDates = [];
    
      dates.forEach(dateStr => {
        const cleanDateStr = String(dateStr).trim();
        
        // Basic ISO format check (YYYY-MM-DD)
        const isoRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!isoRegex.test(cleanDateStr)) {
          invalidDates.push({ 
            date: cleanDateStr, 
            issue: 'Invalid format - use YYYY-MM-DD' 
          });
          return;
        }
    
        try {
          // Parse date with UTC to avoid timezone issues
          const date = new Date(cleanDateStr + 'T00:00:00.000Z');
          
          if (isNaN(date.getTime())) {
            invalidDates.push({ 
              date: cleanDateStr, 
              issue: 'Invalid date value' 
            });
            return;
          }
    
          // ✅ RELAXED: Allow reasonable date range (1 year back, 1 year forward)
          const today = new Date();
          const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
          const oneYearFromNow = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
    
          if (date < oneYearAgo) {
            invalidDates.push({ 
              date: cleanDateStr, 
              issue: 'Date too far in past (>1 year)' 
            });
            return;
          }
    
          if (date > oneYearFromNow) {
            invalidDates.push({ 
              date: cleanDateStr, 
              issue: 'Date too far in future (>1 year)' 
            });
            return;
          }
    
          // Date is valid
          validatedDates.push(cleanDateStr);
    
        } catch (error) {
          invalidDates.push({ 
            date: cleanDateStr, 
            issue: `Date parsing error: ${error.message}` 
          });
        }
      });
    
      return { invalidDates, validatedDates };
    }
    
    // ✅ FALLBACK: Simple date validation
    function validateAttendanceDatesSimple(dates) {
      const invalidDates = [];
      const validatedDates = [];
    
      for (const dateStr of dates) {
        const cleanDate = String(dateStr).trim();
        
        if (!/^\d{4}-\d{2}-\d{2}$/.test(cleanDate)) {
          invalidDates.push({ date: cleanDate, issue: 'Invalid format' });
          continue;
        }
    
        const date = new Date(cleanDate);
        if (isNaN(date.getTime())) {
          invalidDates.push({ date: cleanDate, issue: 'Invalid date' });
          continue;
        }
    
        validatedDates.push(cleanDate);
      }
    
      return { invalidDates, validatedDates };
    }
    
    // ✅ TEACHER VIEW MODE SETUP
    function setupTeacherViewMode(teacherInfo) {
      console.log('🔧 Setting up teacher view mode...');
      
      // Add teacher mode class to body
      document.body.classList.add('teacher-mode');
      
      // Hide the header/banner for teacher mode
      const header = document.querySelector('header');
      if (header) {
        header.style.display = 'none';
      }
      
      // Hide the home page content and show only tabs
      const homePage = document.getElementById("homePage");
      if (homePage) {
        homePage.classList.remove("hidden");
        
        // Hide everything except the tabs section
        const children = homePage.children;
        for (let i = 0; i < children.length; i++) {
          const child = children[i];
          if (!child.id || (child.id !== 'tabs' && child.id !== 'viewTab')) {
            child.style.display = 'none';
          }
        }
      }
      
      // Show tabs section
      const tabs = document.getElementById('tabs');
      if (tabs) {
        tabs.classList.remove('hidden');
        tabs.style.display = 'block';
      }
      
      // Auto-navigate to view attendance tab after a short delay
      setTimeout(() => {
        // Show the view attendance tab directly
        showTab('viewTab');
        
        // Hide the mark attendance tab button completely
        const markBtn = document.getElementById('markBtn');
        const viewBtn = document.getElementById('viewBtn');
        
        if (markBtn) {
          markBtn.style.display = 'none';
        }
        
        if (viewBtn) {
          viewBtn.style.backgroundColor = '#060D0C';
          viewBtn.style.color = 'white';
          viewBtn.style.width = '100%'; // Make it full width since mark button is hidden
        }
        
        // Show stream/semester selection interface
        setupTeacherStreamSelection();
        
        // Show a welcome message
        showTeacherWelcomeMessage(teacherInfo);
        
        // Show the back to my class button
        const backBtn = document.getElementById('backToMyClassBtn');
        if (backBtn) {
          backBtn.classList.remove('hidden');
        }
        
      }, 500);
    }
    
    // ✅ BACK TO MY CLASS FUNCTION
    function backToMyClass() {
      window.location.href = 'myclass.html';
    }
    
    // ✅ SETUP TEACHER STREAM SELECTION
    function setupTeacherStreamSelection() {
      console.log('🔧 Setting up teacher stream selection interface...');
      
      // Hide normal interface, show teacher interface
      const normalInterface = document.getElementById('normalSelectionInterface');
      const teacherInterface = document.getElementById('teacherSelectionInterface');
      
      if (normalInterface) normalInterface.classList.add('hidden');
      if (teacherInterface) teacherInterface.classList.remove('hidden');
      
      // Populate streams (same as myclass.html)
      populateTeacherStreams();
      
      // Setup event listeners
      setupTeacherSelectionListeners();
    }
    
    // ✅ POPULATE TEACHER STREAMS
    function populateTeacherStreams() {
      const streamSelect = document.getElementById('teacher-stream-select');
      if (!streamSelect) return;
      
      // Same streams as in myclass.html
      const streams = [
        'BCA', 'BBA', 'BCom', 'BCom Section A', 'BCom Section B', 
        'BSc', 'BA', 'MA', 'MSc', 'MCom', 'MCA'
      ];
      
      streamSelect.innerHTML = '<option value="">-- Select Stream --</option>';
      streams.forEach(stream => {
        const option = document.createElement('option');
        option.value = stream;
        option.textContent = stream;
        streamSelect.appendChild(option);
      });
    }
    
    // ✅ SETUP TEACHER SELECTION LISTENERS
    function setupTeacherSelectionListeners() {
      const streamSelect = document.getElementById('teacher-stream-select');
      const semesterSelect = document.getElementById('teacher-semester-select');
      const subjectSelect = document.getElementById('teacher-subject-select');
      const loadBtn = document.getElementById('teacherLoadRegisterBtn');
      
      if (streamSelect) {
        streamSelect.addEventListener('change', () => {
          const selectedStream = streamSelect.value;
          populateTeacherSemesters(selectedStream);
          
          // Clear subject selection
          if (subjectSelect) {
            subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
          }
        });
      }
      
      if (semesterSelect) {
        semesterSelect.addEventListener('change', () => {
          const selectedStream = streamSelect.value;
          const selectedSemester = semesterSelect.value;
          
          if (selectedStream && selectedSemester) {
            loadTeacherSubjects(selectedStream, selectedSemester);
          }
        });
      }
      
      if (loadBtn) {
        loadBtn.addEventListener('click', loadTeacherAttendanceRegister);
      }
    }
    
    // ✅ POPULATE TEACHER SEMESTERS
    function populateTeacherSemesters(stream) {
      const semesterSelect = document.getElementById('teacher-semester-select');
      if (!semesterSelect || !stream) return;
      
      // Same logic as myclass.html
      let maxSemesters = 6; // Default
      
      if (stream.includes('BCA') || stream.includes('BBA') || stream.includes('BSc')) {
        maxSemesters = 6;
      } else if (stream.includes('BCom') || stream.includes('BA')) {
        maxSemesters = 6;
      } else if (stream.includes('MA') || stream.includes('MSc') || stream.includes('MCom') || stream.includes('MCA')) {
        maxSemesters = 4;
      }
      
      semesterSelect.innerHTML = '<option value="">-- Select Semester --</option>';
      for (let i = 1; i <= maxSemesters; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Semester ${i}`;
        semesterSelect.appendChild(option);
      }
    }
    
    // ✅ LOAD TEACHER SUBJECTS
    async function loadTeacherSubjects(stream, semester) {
      const subjectSelect = document.getElementById('teacher-subject-select');
      if (!subjectSelect) return;
      
      try {
        console.log(`📚 Loading subjects for: ${stream} Semester ${semester}`);
        
        const response = await fetch(`/api/subjects/${stream}/sem${semester}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        const data = await response.json();
        const subjects = data.subjects || [];
        
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        
        // Group by type
        const coreSubjects = subjects.filter(s => s.subjectType === 'CORE');
        const languageSubjects = subjects.filter(s => s.subjectType === 'LANGUAGE');
        
        if (coreSubjects.length > 0) {
          const coreGroup = document.createElement('optgroup');
          coreGroup.label = 'Core Subjects';
          coreSubjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.subjectName;
            option.textContent = subject.subjectName;
            coreGroup.appendChild(option);
          });
          subjectSelect.appendChild(coreGroup);
        }
        
        if (languageSubjects.length > 0) {
          const langGroup = document.createElement('optgroup');
          langGroup.label = 'Language Subjects';
          languageSubjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.subjectName;
            option.textContent = subject.subjectName;
            langGroup.appendChild(option);
          });
          subjectSelect.appendChild(langGroup);
        }
        
        console.log(`✅ Loaded ${subjects.length} subjects (${coreSubjects.length} core, ${languageSubjects.length} language)`);
        
      } catch (error) {
        console.error('❌ Error loading subjects:', error);
        subjectSelect.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
      }
    }
    
    // ✅ LOAD TEACHER ATTENDANCE REGISTER
    async function loadTeacherAttendanceRegister() {
      const streamSelect = document.getElementById('teacher-stream-select');
      const semesterSelect = document.getElementById('teacher-semester-select');
      const subjectSelect = document.getElementById('teacher-subject-select');
      const loadBtn = document.getElementById('teacherLoadRegisterBtn');
      
      const stream = streamSelect?.value;
      const semester = semesterSelect?.value;
      const subject = subjectSelect?.value;
      
      if (!stream || !semester || !subject) {
        showAlert("Missing Information", "Please select stream, semester, and subject.", "error");
        return;
      }
      
      try {
        loadBtn.disabled = true;
        loadBtn.innerHTML = '<span class="loading-spinner"></span> Loading...';
        
        console.log(`📊 Loading register for: ${stream} Semester ${semester} - ${subject}`);
        
        const res = await fetch(`/api/attendance-register/${stream}/sem${semester}/${encodeURIComponent(subject)}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        console.log('📊 Register response:', data);
        
        let students, attendanceMap, subjectInfo;
        
        if (data.success && data.data) {
          ({ students, attendanceMap, subjectInfo } = data.data);
        } else if (data.students && data.attendanceMap) {
          ({ students, attendanceMap } = data);
          subjectInfo = data.subjectInfo;
        } else {
          throw new Error(data.message || 'Failed to load register');
        }
        
        const dates = Object.keys(attendanceMap).sort();
        
        console.log(`✅ Loaded: ${students.length} students, ${dates.length} dates`);
        
        if (students.length === 0) {
          const message = subjectInfo?.isLanguageSubject ? 
            `No students found who chose ${subjectInfo.languageType} language` :
            'No students found for this subject';
          showAlert("No Students", message, "warning");
          return;
        }
        
        await renderAttendanceTable(students, dates, attendanceMap);
        
        const registerTable = document.getElementById("registerTable");
        const saveBtn = document.getElementById("saveChangesBtn");
        const exportExcelBtn = document.getElementById("exportExcelBtn");
        
        if (registerTable) registerTable.classList.remove("hidden");
        if (saveBtn) saveBtn.classList.remove("hidden");
        if (exportExcelBtn) exportExcelBtn.classList.remove("hidden");
        
        const avgAttendance = students.length > 0 ?
          (students.reduce((sum, stu) => {
            const attendedCount = dates.filter(date => attendanceMap[date]?.includes(stu.studentID)).length;
            return sum + (dates.length > 0 ? (attendedCount / dates.length) * 100 : 0);
          }, 0) / students.length).toFixed(1) : 0;
        
        let successMessage = `Register loaded successfully!\n\n`;
        successMessage += `Subject: ${subject}\n`;
        successMessage += `Stream: ${stream} Semester ${semester}\n`;
        if (subjectInfo?.isLanguageSubject) {
          successMessage += `Language: ${subjectInfo.languageType} students only\n`;
        }
        successMessage += `Students: ${students.length}\n`;
        successMessage += `Days: ${dates.length}\n`;
        successMessage += `Average Attendance: ${avgAttendance}%`;
        
        showAlert("Success", successMessage, "success");
        
      } catch (err) {
        console.error("Error loading attendance register:", err);
        showAlert("Loading Error", `Failed to load register: ${err.message}`, "error");
      } finally {
        loadBtn.disabled = false;
        loadBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Load Attendance Register';
      }
    }
    
    // ✅ SHOW TEACHER WELCOME MESSAGE
    function showTeacherWelcomeMessage(teacherInfo) {
      // Create a temporary welcome message
      const welcomeDiv = document.createElement('div');
      welcomeDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg';
      welcomeDiv.style.backgroundColor = '#060D0C';
      welcomeDiv.style.color = 'white';
      welcomeDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <i class="fas fa-chalkboard-teacher"></i>
          <span>Welcome ${teacherInfo.name}! View attendance for any subject</span>
        </div>
      `;
      
      document.body.appendChild(welcomeDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        if (welcomeDiv.parentNode) {
          welcomeDiv.parentNode.removeChild(welcomeDiv);
        }
      }, 3000);
    }
    
    // ✅ MAIN INITIALIZATION
    document.addEventListener("DOMContentLoaded", () => {
      // Check for teacher view mode from myclass.html
      const teacherViewMode = sessionStorage.getItem('teacherViewMode');
      if (teacherViewMode === 'true') {
        try {
          const teacherInfo = JSON.parse(sessionStorage.getItem('teacherInfo') || '{}');
          
          console.log('👨‍🏫 Teacher view mode activated:', {
            teacherInfo
          });
          
          // Set up teacher view mode
          setupTeacherViewMode(teacherInfo);
          
          // Clear the session data
          sessionStorage.removeItem('teacherViewMode');
          sessionStorage.removeItem('teacherInfo');
          
        } catch (error) {
          console.error('❌ Error setting up teacher view mode:', error);
        }
      }
      
      // Check for auto-selection from myclass.html
      const selectedClassInfo = sessionStorage.getItem('selectedClass');
      if (selectedClassInfo) {
        try {
          const classInfo = JSON.parse(selectedClassInfo);
          console.log('🎯 Auto-selecting class from myclass.html:', classInfo);
          
          sessionStorage.removeItem('selectedClass');
          
          setTimeout(async () => {
            await autoSelectClass(classInfo);
          }, 500);
        } catch (error) {
          console.error('❌ Error parsing selected class info:', error);
        }
      }
    
      initializeSystem();
    });
    
    // ✅ Auto-selection function from myclass.html
    async function autoSelectClass(classInfo) {
      const { stream, semester, subject } = classInfo;
      
      try {
        console.log(`🚀 Auto-selecting: ${stream} Semester ${semester} - ${subject}`);
        
        selectedStream = stream;
        selectedSem = semester;
        
        
        document.getElementById("homePage").classList.add("hidden");
        tabs.classList.remove("hidden");
        showTab("markTab");
        
        await loadSubjectsAndStudents(stream, semester);
        
        setTimeout(() => {
          const subjectOption = Array.from(subjectMark.options).find(
            option => option.value === subject
          );
          
          if (subjectOption) {
            subjectMark.value = subject;
            subjectView.value = subject;
            subjectMark.dispatchEvent(new Event('change'));
            
            console.log(`✅ Auto-selected subject: ${subject}`);
            showAutoSelectMessage(stream, semester, subject);
          } else {
            console.warn(`⚠️ Subject "${subject}" not found in dropdown`);
            showAlert("Warning", `Subject "${subject}" not found. Please select manually.`, "warning");
          }
        }, 1000);
        
      } catch (error) {
        console.error('❌ Error auto-selecting class:', error);
        showAlert("Error", 'Error loading class data. Please try selecting manually.', "error");
      }
    }
    
    // ✅ Auto-select success message
    function showAutoSelectMessage(stream, semester, subject) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm';
      messageDiv.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-2"></i>
          <div>
            <div class="font-semibold">Class Auto-Selected!</div>
            <div class="text-sm">${stream} Sem ${semester} - ${subject}</div>
          </div>
        </div>
      `;
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        if (document.body.contains(messageDiv)) {
          document.body.removeChild(messageDiv);
        }
      }, 4000);
    }
    
    // ✅ SYSTEM INITIALIZATION
    function initializeSystem() {
      addMenuClickListener();
      setupDateInput();
      setupSubmitButton();
      setupTabButtons();
      setupViewButtons();
      initializeExcelExport();
      console.log("✅ Attendance system initialized successfully");
    }
    
    // ✅ HOME NAVIGATION
    function goToStreamsHome() {
      console.log("🏠 Navigating back to myclass.html");
      window.location.href = 'myclass.html';
    }
    
    // ✅ TAB MANAGEMENT - LUXE NOIR Theme
    function showTab(tabId) {
      markTab.classList.add("hidden");
      viewTab.classList.add("hidden");
      document.getElementById(tabId).classList.remove("hidden");
      
      // Reset both buttons to inactive state (LUXE NOIR)
      document.getElementById('markBtn').className =
        "tablinks flex-1 px-4 py-2 rounded-full transition-all duration-300 text-xs font-medium";
      document.getElementById('markBtn').style.cssText = "color: #8B9B8F; background-color: transparent;";
      document.getElementById('markBtn').onmouseover = function() { this.style.color='#060D0C'; this.style.backgroundColor='#F0EDE5'; };
      document.getElementById('markBtn').onmouseout = function() { this.style.color='#8B9B8F'; this.style.backgroundColor='transparent'; };
      
      document.getElementById('viewBtn').className =
        "tablinks flex-1 px-4 py-2 rounded-full transition-all duration-300 text-xs font-medium";
      document.getElementById('viewBtn').style.cssText = "color: #8B9B8F; background-color: transparent;";
      document.getElementById('viewBtn').onmouseover = function() { this.style.color='#060D0C'; this.style.backgroundColor='#F0EDE5'; };
      document.getElementById('viewBtn').onmouseout = function() { this.style.color='#8B9B8F'; this.style.backgroundColor='transparent'; };
    
      // Set active tab (LUXE NOIR)
      if (tabId === 'markTab') {
        document.getElementById('markBtn').className =
          "tablinks flex-1 px-4 py-2 text-white rounded-full transition-all duration-300 shadow-md text-xs font-medium";
        document.getElementById('markBtn').style.cssText = "background-color: #060D0C; color: #F0EDE5;";
        document.getElementById('markBtn').onmouseover = null;
        document.getElementById('markBtn').onmouseout = null;
      } else {
        document.getElementById('viewBtn').className =
          "tablinks flex-1 px-4 py-2 text-white rounded-full transition-all duration-300 shadow-md text-xs font-medium";
        document.getElementById('viewBtn').style.cssText = "background-color: #060D0C; color: #F0EDE5;";
        document.getElementById('viewBtn').onmouseover = null;
        document.getElementById('viewBtn').onmouseout = null;
      }
    }
    
    // ✅ ENHANCED SUBJECTS AND STUDENTS LOADING
    async function loadSubjectsAndStudents(stream, sem) {
      try {
        console.log(`🔄 Loading data for: ${stream} Sem ${sem}`);
        
        window.selectedStream = stream;
        window.selectedSem = sem;
        
        const subjectsRes = await fetch(`/api/subjects/${stream}/sem${sem}`);
        
        if (!subjectsRes.ok) {
          throw new Error(`Failed to fetch subjects: ${subjectsRes.status} ${subjectsRes.statusText}`);
        }
        
        const subjectsData = await subjectsRes.json();
        console.log('📚 Subjects response:', subjectsData);
        
        const subjects = subjectsData.subjects || subjectsData || [];
        
        populateSubjectDropdowns(subjects);
        await loadAllStudents(stream, sem);
        setupSubjectFilteringListener(stream, sem);
        
        console.log(`✅ Data loaded successfully: ${subjects.length} subjects`);
        
      } catch (error) {
        console.error("❌ Error loading data:", error);
        handleLoadingError(error, stream, sem);
      }
    }
    
    // ✅ ENHANCED SUBJECT DROPDOWN POPULATION WITH LANGUAGE SUPPORT
    function populateSubjectDropdowns(subjects) {
      subjectMark.innerHTML = '<option value="">-- Select Subject --</option>';
      subjectView.innerHTML = '<option value="">-- Select Subject --</option>';
      
      if (!Array.isArray(subjects) || subjects.length === 0) {
        console.warn('⚠️ No subjects found');
        return;
      }
      
      subjects.forEach(sub => {
        const subjectName = sub.subjectName || sub.name || sub;
        
        const markOption = new Option(subjectName, subjectName);
        const viewOption = new Option(subjectName, subjectName);
        
        if (sub.isLanguageSubject || (sub.subjectType === 'LANGUAGE')) {
          markOption.setAttribute('data-type', 'LANGUAGE');
          markOption.setAttribute('data-language', sub.languageType);
          viewOption.setAttribute('data-type', 'LANGUAGE');  
          viewOption.setAttribute('data-language', sub.languageType);
          
          console.log(`🔤 Language subject: ${subjectName} (${sub.languageType})`);
        } else {
          markOption.setAttribute('data-type', 'CORE');
          viewOption.setAttribute('data-type', 'CORE');
        }
        
        subjectMark.appendChild(markOption);
        subjectView.appendChild(viewOption);
      });
      
      console.log(`✅ Populated ${subjects.length} subjects with language attributes`);
    }
    
    // ✅ LOAD ALL STUDENTS INITIALLY
    async function loadAllStudents(stream, sem) {
      try {
        const studentsRes = await fetch(`/api/students/${stream}/sem${sem}`);
        
        if (!studentsRes.ok) {
          throw new Error(`Failed to fetch students: ${studentsRes.status} ${studentsRes.statusText}`);
        }
        
        const studentsData = await studentsRes.json();
        console.log('👥 Students response:', studentsData);
        
        const students = studentsData.students || studentsData || [];
        displayStudents(students);
        
        console.log(`✅ Loaded ${students.length} students initially`);
        
      } catch (error) {
        console.error("❌ Error loading students:", error);
        throw error;
      }
    }
    
    // ✅ SUBJECT FILTERING WITH LANGUAGE SUPPORT
    function setupSubjectFilteringListener(stream, sem) {
      if (window.subjectChangeListenerAdded) return;
      
      subjectMark.addEventListener("change", async function(event) {
        const selectedSubject = event.target.value;
        const selectedOption = event.target.selectedOptions[0];
        
        if (!selectedSubject) {
          console.log("🔄 No subject selected, showing all students");
          await loadAllStudents(stream, sem);
          return;
        }
        
        const subjectType = selectedOption.getAttribute('data-type');
        const languageType = selectedOption.getAttribute('data-language');
        
        console.log(`🎯 Subject selected: ${selectedSubject}`);
        console.log(`📋 Subject type: ${subjectType}`);
        if (languageType) console.log(`🔤 Language type: ${languageType}`);
        
        try {
          studentsList.innerHTML = `
            <tr>
              <td colspan="4" class="p-6 text-center">
                <div class="flex items-center justify-center">
                  <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mr-3"></div>
                  Loading ${languageType ? languageType + ' ' : ''}students...
                </div>
              </td>
            </tr>
          `;
          
          const response = await fetch(`/api/attendance-students/${stream}/sem${sem}/${encodeURIComponent(selectedSubject)}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          
          if (!data.success) {
            throw new Error(data.message || 'Failed to get students');
          }
          
          const students = data.students || [];
          displayStudents(students);
          
          if (subjectType === 'LANGUAGE' && languageType) {
            console.log(`✅ Filtered to ${students.length} ${languageType} students`);
            
            if (students.length === 0) {
              studentsList.innerHTML = `
                <tr>
                  <td colspan="4" class="p-6 text-center text-yellow-500">
                    <i class="fas fa-info-circle text-3xl mb-2"></i>
                    <p class="font-semibold">No ${languageType} Students Found</p>
                    <p class="text-sm">No students have chosen ${languageType} as their language subject.</p>
                  </td>
                </tr>
              `;
            }
          } else {
            console.log(`✅ Showing ${students.length} total students`);
          }
          
        } catch (error) {
          console.error('❌ Error filtering students:', error);
          
          studentsList.innerHTML = `
            <tr>
              <td colspan="4" class="p-6 text-center text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p class="font-semibold">Error Loading Students</p>
                <p class="text-sm">${error.message}</p>
                <button 
                  onclick="loadAllStudents('${stream}', '${sem}')"
                  class="mt-2 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                >
                  Show All Students
                </button>
              </td>
            </tr>
          `;
        }
      });
      
      subjectView.addEventListener("change", async function(event) {
        const selectedSubject = event.target.value;
        
        if (selectedSubject) {
          subjectMark.value = selectedSubject;
          subjectMark.dispatchEvent(new Event('change'));
        } else {
          await loadAllStudents(stream, sem);
        }
      });
      
      window.subjectChangeListenerAdded = true;
      console.log("✅ Subject filtering setup with language support");
    }
    
    // ✅ DISPLAY STUDENTS WITH ENHANCED SORTING
    function displayStudents(students) {
      studentsList.innerHTML = '';
      
      if (!Array.isArray(students) || students.length === 0) {
        studentsList.innerHTML = `
          <tr>
            <td colspan="4" class="p-6 text-center text-gray-500">
              <i class="fas fa-users-slash text-4xl mb-3 text-gray-300"></i>
              <p class="font-semibold text-lg">No students found</p>
              <p class="text-sm">Please verify the data in your database.</p>
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort students by Student ID
      const sortedStudents = students.sort((a, b) => {
        const aNum = parseInt(a.studentID);
        const bNum = parseInt(b.studentID);
        
        if (!isNaN(aNum) && !isNaN(bNum) && 
            a.studentID === aNum.toString() && 
            b.studentID === bNum.toString()) {
          return aNum - bNum;
        }
        
        return a.studentID.localeCompare(b.studentID, undefined, {
          numeric: true,
          sensitivity: 'base'
        });
      });
      
      sortedStudents.forEach((student, index) => {
        const serialNumber = index + 1;
        const studentID = student.studentID || student.id || 'N/A';
        const studentName = student.name || 'Unknown';
        
        const tableRow = document.createElement('tr');
        tableRow.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-100 transition duration-200`;
        
        tableRow.innerHTML = `
          <td class="p-3 border border-gray-300 text-[#0f172a] font-medium text-center">
            ${serialNumber}
          </td>
          <td class="p-3 border border-gray-300 text-[#0f172a] font-medium">
            ${studentID}
          </td>
          <td class="p-3 border border-gray-300 text-[#0f172a]">
            ${studentName}
          </td>
          <td class="p-3 border border-gray-300 text-center">
            <input 
              type="checkbox" 
              value="${studentID}" 
              checked 
              class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-400 transition duration-200"
            />
          </td>
        `;
        
        studentsList.appendChild(tableRow);
      });
      
      console.log(`✅ Displayed ${sortedStudents.length} students (sorted by Student ID)`);
    }
    
    // ✅ ENHANCED ERROR HANDLING
    function handleLoadingError(error, stream, sem) {
      showAlert("Error", `Error loading data for ${stream} Semester ${sem}: ${error.message}`, "error");
      
      if (subjectMark) subjectMark.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
      if (subjectView) subjectView.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
      if (studentsList) {
        studentsList.innerHTML = `
          <tr>
            <td colspan="4" class="p-6 text-center text-red-500">
              <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
              <p class="font-semibold">Error loading data</p>
              <p class="text-sm">${error.message}</p>
              <button 
                onclick="loadSubjectsAndStudents('${stream}', '${sem}')" 
                class="mt-3 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
              >
                <i class="fas fa-redo mr-2"></i>
                Retry
              </button>
            </td>
          </tr>
        `;
      }
    }
    
    // ✅ DATE INPUT SETUP
    function setupDateInput() {
      const today = new Date().toISOString().split("T")[0];
      const dateInput = document.getElementById("date");
      if (dateInput) {
        dateInput.value = today;
        dateInput.max = today;
        
        dateInput.addEventListener('input', function() {
          const selectedDate = this.value;
          if (selectedDate > today) {
            showAlert('Warning', 'Future dates are not allowed for attendance marking!', 'warning');
            this.value = today;
          }
        });
      }
    }
    
    // ✅ SUBMIT BUTTON SETUP WITH ENHANCED VALIDATION
    function setupSubmitButton() {
      if (submitBtn) {
        submitBtn.addEventListener("click", async () => {
          const subject = subjectMark.value;
          const dateInput = document.getElementById("date");
          const date = dateInput ? dateInput.value : '';
    
          if (!subject || !date) {
            showAlert("Missing Information", "Please fill in both Date and Subject.", "error");
            return;
          }
    
          const today = new Date().toISOString().split("T")[0];
          if (date > today) {
            showAlert("Invalid Date", "Future dates are not allowed for attendance marking.", "error");
            return;
          }
    
          try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Checking...';
    
            const attendanceExists = await checkAttendanceExists(window.selectedStream, window.selectedSem, subject, date);
            
            if (attendanceExists) {
              const overwriteConfirm = await showConfirmDialog(
                "Attendance Already Exists",
                `Subject: ${subject}\nDate: ${date}\nClass: ${window.selectedStream} Semester ${window.selectedSem}\n\nAttendance has already been recorded.\nDo you want to OVERWRITE it?`,
                "warning"
              );
              
              if (!overwriteConfirm) {
                showAlert("Cancelled", "Attendance submission cancelled.", "info");
                return;
              }
            }
    
            if (isWeekend(date)) {
              const dayName = isSunday(date) ? "SUNDAY" : "SATURDAY";
              const weekendConfirm = await showConfirmDialog(
                "Weekend Alert",
                `Selected date (${date}) is a ${dayName}.\n\nAre you sure about weekend attendance?`,
                "warning"
              );
              
              if (!weekendConfirm) {
                showAlert("Cancelled", "Please select a different date.", "info");
                return;
              }
            }
    
            const checkboxes = studentsList.querySelectorAll("input[type='checkbox']");
            const checkedBoxes = studentsList.querySelectorAll("input:checked");
            const totalStudents = checkboxes.length;
            const presentStudents = checkedBoxes.length;
            const absentStudents = totalStudents - presentStudents;
    
            const confirmMessage = `Subject: ${subject}\nDate: ${date}\nClass: ${window.selectedStream} Semester ${window.selectedSem}\n\nTotal Students: ${totalStudents}\nPresent: ${presentStudents}\nAbsent: ${absentStudents}\n\nWhatsApp notifications will be sent to parents.\n\nProceed?`;
    
            const finalConfirm = await showConfirmDialog("Confirm Submission", confirmMessage, "info");
    
            if (!finalConfirm) {
              showAlert("Cancelled", "Attendance submission cancelled.", "info");
              return;
            }
    
            const studentsPresent = Array.from(checkedBoxes).map(cb => cb.value);
    
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
            
            const res = await fetch(
              `/api/attendance/${window.selectedStream}/sem${window.selectedSem}/${encodeURIComponent(subject)}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ date, subject, studentsPresent })
              }
            );
    
            const result = await res.json();
    
            if (res.ok) {
              const { summary } = result;
              const successMessage = `✅ Attendance Submitted Successfully!\n\nSubject: ${subject}\nDate: ${date}\n\nTotal Students: ${summary?.totalStudents || totalStudents}\nPresent: ${summary?.presentStudents || presentStudents}\nAbsent: ${summary?.absentStudents || absentStudents}`;
              
              showAlert("Success", successMessage, "success");
              
              subjectMark.value = "";
              if (dateInput) dateInput.value = new Date().toISOString().split("T")[0];
              
              await loadAllStudents(window.selectedStream, window.selectedSem);
              
            } else {
              showAlert("Submission Failed", result.message || "Unknown error occurred.", "error");
            }
    
          } catch (err) {
            console.error("Submission error:", err);
            showAlert("Network Error", "Failed to submit attendance. Please check your connection.", "error");
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span class="check-icon"></span> Submit Attendance';
          }
        });
      }
    }
    
    // ✅ TAB BUTTONS SETUP
    function setupTabButtons() {
      if (markBtn) {
        markBtn.addEventListener('click', () => showTab('markTab'));
      }
      if (viewBtn) {
        viewBtn.addEventListener('click', () => showTab('viewTab'));
      }
    }
    
    // ✅ VIEW BUTTONS SETUP
    function setupViewButtons() {
      const loadRegisterBtn = document.getElementById("loadRegisterBtn");
      const saveChangesBtn = document.getElementById("saveChangesBtn");
    
      if (loadRegisterBtn) {
        loadRegisterBtn.addEventListener("click", loadAttendanceRegister);
      }
    
      if (saveChangesBtn) {
        saveChangesBtn.addEventListener("click", saveAttendanceChanges);
      }
    
      if (subjectView) {
        subjectView.addEventListener("change", () => {
          const subject = subjectView.value;
          const registerTable = document.getElementById("registerTable");
          const saveBtn = document.getElementById("saveChangesBtn");
          const exportExcelBtn = document.getElementById("exportExcelBtn");
    
          if (registerTable) registerTable.classList.add("hidden");
          if (saveBtn) saveBtn.classList.add("hidden");
          if (exportExcelBtn) exportExcelBtn.classList.add("hidden");
        });
      }
    }
    
    // ✅ LOAD ATTENDANCE REGISTER
    async function loadAttendanceRegister() {
      const subject = subjectView.value;
      const registerTable = document.getElementById("registerTable");
      const saveBtn = document.getElementById("saveChangesBtn");
      const exportExcelBtn = document.getElementById("exportExcelBtn");
      const loadBtn = document.getElementById("loadRegisterBtn");
    
      if (!subject) {
        showAlert("Missing Subject", "Please select a subject.", "error");
        return;
      }
    
      try {
        loadBtn.disabled = true;
        loadBtn.innerHTML = '<span class="loading-spinner"></span> Loading...';
    
        console.log(`📊 Loading register for: ${subject}`);
        
        // Get stream and semester from selected option (for teacher subjects)
        const selectedOption = subjectView.options[subjectView.selectedIndex];
        const streamFromOption = selectedOption.getAttribute('data-stream');
        const semesterFromOption = selectedOption.getAttribute('data-semester');
        
        // Use stream/semester from option if available (teacher mode), otherwise use global variables
        const streamToUse = streamFromOption || selectedStream;
        const semesterToUse = semesterFromOption || selectedSem;
        
        console.log(`📊 Using stream: ${streamToUse}, semester: ${semesterToUse} for subject: ${subject}`);
    
        const res = await fetch(`/api/attendance-register/${streamToUse}/sem${semesterToUse}/${encodeURIComponent(subject)}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
    
        const data = await res.json();
        console.log('📊 Register response:', data);
    
        let students, attendanceMap, subjectInfo;
        
        if (data.success && data.data) {
          ({ students, attendanceMap, subjectInfo } = data.data);
        } else if (data.students && data.attendanceMap) {
          ({ students, attendanceMap } = data);
          subjectInfo = data.subjectInfo;
        } else {
          throw new Error(data.message || 'Failed to load register');
        }
    
        const dates = Object.keys(attendanceMap).sort();
    
        console.log(`✅ Loaded: ${students.length} students, ${dates.length} dates`);
    
        if (students.length === 0) {
          const message = subjectInfo?.isLanguageSubject ? 
            `No students found who chose ${subjectInfo.languageType} language` :
            'No students found for this subject';
          showAlert("No Students", message, "warning");
          return;
        }
    
        await renderAttendanceTable(students, dates, attendanceMap);
    
        if (registerTable) registerTable.classList.remove("hidden");
        if (saveBtn) saveBtn.classList.remove("hidden");
        if (exportExcelBtn) exportExcelBtn.classList.remove("hidden");
    
        const avgAttendance = students.length > 0 ?
          (students.reduce((sum, stu) => {
            const attendedCount = dates.filter(date => attendanceMap[date]?.includes(stu.studentID)).length;
            return sum + (dates.length > 0 ? (attendedCount / dates.length) * 100 : 0);
          }, 0) / students.length).toFixed(1) : 0;
    
        let successMessage = `Register loaded successfully!\n\n`;
        successMessage += `Subject: ${subject}\n`;
        if (subjectInfo?.isLanguageSubject) {
          successMessage += `Language: ${subjectInfo.languageType} students only\n`;
        }
        successMessage += `Students: ${students.length}\n`;
        successMessage += `Days: ${dates.length}\n`;
        successMessage += `Average Attendance: ${avgAttendance}%`;
    
        showAlert("Success", successMessage, "success");
    
      } catch (err) {
        console.error("Error loading attendance register:", err);
        showAlert("Loading Error", `Failed to load register: ${err.message}`, "error");
      } finally {
        loadBtn.disabled = false;
        loadBtn.innerHTML = '<i class="fas fa-table mr-2"></i>Load Register';
      }
    }
    
    // ✅ RENDER ATTENDANCE TABLE
    async function renderAttendanceTable(students, dates, attendanceMap) {
      if (!viewThead || !viewTbody) {
        console.error('❌ Table elements not found');
        return;
      }
    
      // Sort students by Student ID
      const sortedStudents = students.sort((a, b) => {
        const aNum = parseInt(a.studentID);
        const bNum = parseInt(b.studentID);
        
        if (!isNaN(aNum) && !isNaN(bNum) && 
            a.studentID === aNum.toString() && 
            b.studentID === bNum.toString()) {
          return aNum - bNum;
        }
        
        return a.studentID.localeCompare(b.studentID, undefined, {
          numeric: true,
          sensitivity: 'base'
        });
      });
    
      // Create table header
      viewThead.innerHTML = `
        <tr class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white">
          <th class="p-3 text-center font-bold text-sm">#</th>
          <th class="p-3 text-left font-bold text-sm">Student ID</th>
          <th class="p-3 text-left font-bold text-sm">Name</th>
          ${dates.map(d => {
            const dateObj = new Date(d);
            const displayDate = dateObj.toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'});
            const title = dateObj.toLocaleDateString('en-IN', { 
              weekday: 'short', 
              month: 'short', 
              day: 'numeric' 
            });
            
            return `<th class="p-2 text-center font-semibold text-xs min-w-12" data-date="${d}" title="${title}">${displayDate}</th>`;
          }).join('')}
          
          <th class="p-3 text-center font-bold bg-gray-700 text-xs">Total</th>
          <th class="p-3 text-center font-bold bg-blue-700 text-xs">Present</th>
          <th class="p-3 text-center font-bold bg-green-700 text-xs">%</th>
        </tr>
      `;
    
      // Create table body
      viewTbody.innerHTML = "";
      
      sortedStudents.forEach((stu, index) => {
        let attended = 0;
        const row = [];
    
        row.push(`<td class="p-3 text-center font-medium">${index + 1}</td>`);
        row.push(`
          <td class="p-3 font-medium">
            <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-md whitespace-nowrap">${stu.studentID}</span>
          </td>
        `);
        row.push(`
          <td class="p-3 font-medium">
            <span class="text-gray-800 text-sm">${stu.name}</span>
          </td>
        `);
    
        dates.forEach(date => {
          const present = attendanceMap[date]?.includes(stu.studentID);
          if (present) attended++;
          
          row.push(`
            <td class="p-2 text-center">
              <input 
                type="checkbox" 
                ${present ? "checked" : ""} 
                data-date="${date}"
                data-student-id="${stu.studentID}"
                class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-400 transition duration-200"
                onchange="markUnsavedChanges()"
              />
            </td>
          `);
        });
    
        const total = dates.length;
        const percentage = total ? ((attended / total) * 100).toFixed(1) : "0.0";
        const percentClass = percentage < 75 ? 'text-red-600 bg-red-50' : 
                            percentage >= 85 ? 'text-green-600 bg-green-50' : 
                            'text-yellow-600 bg-yellow-50';
    
        row.push(`<td class="p-3 text-center font-semibold text-gray-700 bg-gray-50">${total}</td>`);
        row.push(`<td class="p-3 text-center font-semibold text-blue-600 bg-blue-50">${attended}</td>`);
        row.push(`<td class="p-3 text-center font-bold ${percentClass} rounded-md">${percentage}%</td>`);
    
        const tr = document.createElement('tr');
        tr.className = `hover:bg-indigo-50 transition duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
        tr.dataset.studentId = stu.studentID;
        tr.innerHTML = row.join("");
        
        viewTbody.appendChild(tr);
      });
    
      console.log(`✅ Table rendered with ${sortedStudents.length} students (sorted by Student ID)`);
    }
    
    // ✅ FIXED: SAVE ATTENDANCE CHANGES WITH PROPER DATE VALIDATION
    async function saveAttendanceChanges() {
      const subject = subjectView.value;
      const saveBtn = document.getElementById("saveChangesBtn");
    
      if (!subject) {
        showAlert("Missing Subject", "Please select a subject.", "error");
        return;
      }
    
      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
    
        const confirmUpdate = await showConfirmDialog(
          "Confirm Update",
          `Subject: ${subject}\n\nThis will overwrite the existing attendance data.\nAre you sure you want to continue?`,
          "warning"
        );
    
        if (!confirmUpdate) {
          showAlert("Cancelled", "Update cancelled.", "info");
          return;
        }
    
        const rows = document.querySelectorAll("#view-tbody tr");
        const dateHeaders = Array.from(document.querySelectorAll("#view-thead th[data-date]"))
          .map(th => th.dataset.date)
          .filter(date => date && date !== 'undefined' && date !== 'null');
    
        console.log(`📅 Found ${dateHeaders.length} date headers:`, dateHeaders);
    
        if (dateHeaders.length === 0) {
          showAlert("No Dates", "No valid date columns found. Please reload the register.", "error");
          return;
        }
    
        const attendanceMap = {};
        dateHeaders.forEach(date => (attendanceMap[date] = []));
    
        rows.forEach((row, rowIndex) => {
          const studentID = row.dataset.studentId;
          
          if (!studentID) {
            console.warn(`⚠️ Row ${rowIndex} missing studentId`);
            return;
          }
    
          const checkboxes = row.querySelectorAll("input[type='checkbox'][data-date]");
          
          checkboxes.forEach(cb => {
            const cbDate = cb.dataset.date;
            
            if (cb.checked && cbDate && attendanceMap.hasOwnProperty(cbDate)) {
              attendanceMap[cbDate].push(studentID);
            }
          });
        });
    
        console.log(`📊 Attendance data to save:`, attendanceMap);
    
        // ✅ FIXED: Use the proper validation function
        let validationResult;
        
        try {
          // Try the main validation function
          validationResult = validateAttendanceDates(Object.keys(attendanceMap));
        } catch (validationError) {
          console.warn("⚠️ Main validation failed, using simple validation:", validationError);
          // Fallback to simple validation
          validationResult = validateAttendanceDatesSimple(Object.keys(attendanceMap));
        }
        
        const { invalidDates, validatedDates } = validationResult;
        
        if (invalidDates.length > 0) {
          showAlert("Invalid Dates", `Found invalid date formats: ${invalidDates.map(d => d.date).join(', ')}`, "error");
          return;
        }
    
        // Send to server
        const res = await fetch(`/api/update-attendance/${selectedStream}/sem${selectedSem}/${encodeURIComponent(subject)}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ attendanceMap })
        });
    
        let result;
        try {
          result = await res.json();
        } catch (parseError) {
          console.error("❌ JSON Parse Error:", parseError);
          throw new Error("Invalid response from server");
        }
    
        console.log(`📊 Server response:`, result);
    
        if (res.ok && result.success) {
          const totalDates = Object.keys(attendanceMap).length;
          const totalEntries = Object.values(attendanceMap).reduce((sum, arr) => sum + arr.length, 0);
          
          showAlert("Success", `✅ Attendance updated successfully!\n\nUpdated: ${totalDates} dates\nTotal entries: ${totalEntries}\n\nRegister will refresh automatically.`, "success");
          
          saveBtn.classList.add("hidden");
          saveBtn.classList.remove("animate-pulse", "bg-yellow-500", "hover:bg-yellow-600");
          saveBtn.classList.add("bg-yellow-500", "hover:bg-yellow-600");
          
          console.log("🔄 Silently refreshing register...");
          await silentReloadRegister(subject);
          console.log("✅ Register refreshed silently");
          
        } else {
          const errorMsg = result.message || result.error || "Unknown error occurred.";
          showAlert("Update Failed", errorMsg, "error");
        }
    
      } catch (err) {
        console.error("❌ Update error:", err);
        showAlert("Network Error", `Failed to update attendance: ${err.message}`, "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Save Changes';
      }
    }
    
    // ✅ SILENT RELOAD FUNCTION
    async function silentReloadRegister(subject) {
      try {
        console.log(`🔄 Silent reload for: ${subject}`);
    
        const res = await fetch(`/api/attendance-register/${selectedStream}/sem${selectedSem}/${encodeURIComponent(subject)}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
    
        const data = await res.json();
        console.log('📊 Silent reload response:', data);
        
        let students, attendanceMap, subjectInfo;
        
        if (data.success && data.data) {
          ({ students, attendanceMap, subjectInfo } = data.data);
        } else if (data.students && data.attendanceMap) {
          ({ students, attendanceMap } = data);
          subjectInfo = data.subjectInfo;
        } else {
          throw new Error(data.message || 'Invalid response format');
        }
    
        const dates = Object.keys(attendanceMap).sort();
    
        console.log(`✅ Silent reload: ${students.length} students, ${dates.length} dates`);
    
        if (students.length === 0) {
          console.warn('⚠️ No students found in silent reload');
          return;
        }
    
        await renderAttendanceTable(students, dates, attendanceMap);
    
      } catch (error) {
        console.error("❌ Silent reload failed:", error);
      }
    }
    
    // ✅ HELPER FUNCTIONS
    function markUnsavedChanges() {
      const saveBtn = document.getElementById("saveChangesBtn");
      if (saveBtn) {
        saveBtn.classList.remove("hidden");
        saveBtn.classList.add("animate-pulse", "bg-red-500", "hover:bg-red-600");
        saveBtn.classList.remove("bg-yellow-500", "hover:bg-yellow-600", "bg-indigo-500", "hover:bg-indigo-600");
        saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Save Changes *';
      }
    }
    
    async function checkAttendanceExists(stream, sem, subject, date) {
      try {
        const response = await fetch(`/api/check-attendance/${stream}/sem${sem}/${encodeURIComponent(subject)}/${date}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const result = await response.json();
        return result.exists || false;
      } catch (error) {
        console.error("Error checking attendance:", error);
        return false;
      }
    }
    
    function isSunday(dateString) {
      const date = new Date(dateString);
      return date.getDay() === 0;
    }
    
    function isSaturday(dateString) {
      const date = new Date(dateString);
      return date.getDay() === 6;
    }
    
    function isWeekend(dateString) {
      return isSunday(dateString) || isSaturday(dateString);
    }
    
    function addMenuClickListener() {
      if (!menuClickListenerAdded) {
        document.addEventListener("click", (event) => {
          const menu = document.getElementById("mobileMenu");
          const toggle = document.querySelector(".menu-icon");
          if (menu && toggle && !menu.contains(event.target) && !toggle.contains(event.target)) {
            menu.classList.add("hidden");
            menu.classList.add("-translate-x-full");
          }
        });
        menuClickListenerAdded = true;
      }
    }
    
    function backToSemesters() {
      document.getElementById("markTab").classList.add("hidden");
      document.getElementById("viewTab").classList.add("hidden");
      document.getElementById("tabs").classList.add("hidden");
      document.getElementById("semesterSection").classList.remove("hidden");
    }
    
    window.toggleMenu = () => {
      const menu = document.getElementById("mobileMenu");
      if (menu) {
        menu.classList.toggle("hidden");
        menu.classList.toggle("-translate-x-full");
      }
    };
    
    // ✅ ENHANCED ALERT FUNCTIONS
    function showAlert(title, message, type = "info") {
      const prefixes = {
        success: "✅ SUCCESS: ",
        error: "❌ ERROR: ",
        warning: "⚠️ WARNING: ",
        info: "ℹ️ INFO: "
      };
      
      alert(`${prefixes[type]}${title}\n\n${message}`);
    }
    
    async function showConfirmDialog(title, message, type = "info") {
      const prefixes = {
        success: "✅ CONFIRM: ",
        error: "❌ CONFIRM: ",
        warning: "⚠️ CONFIRM: ",
        info: "❓ CONFIRM: "
      };
      
      return confirm(`${prefixes[type]}${title}\n\n${message}`);
    }
    
    // ✅ EXCEL/CSV EXPORT FUNCTIONALITY
    function initializeExcelExport() {
      const exportExcelBtn = document.getElementById("exportExcelBtn");
      
      if (!exportExcelBtn) {
        console.warn("⚠️ Export Excel button not found");
        return;
      }
    
      exportExcelBtn.addEventListener("click", async () => {
        console.log("🚀 Excel export started");
        
        const originalText = exportExcelBtn.innerHTML;
        exportExcelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
        exportExcelBtn.disabled = true;
    
        try {
          if (typeof XLSX === 'undefined') {
            console.log("📄 XLSX not available, creating CSV export instead");
            await exportToCSV();
            return;
          }
          
          const table = document.querySelector("#registerTable table") || 
                       document.querySelector("#registerTable") ||
                       document.querySelector("table");
          
          if (!table) {
            throw new Error("No attendance table found. Please load the register first.");
          }
    
          const tbody = table.querySelector("tbody");
          const rows = tbody ? tbody.querySelectorAll("tr") : [];
          
          if (rows.length === 0) {
            throw new Error("No student data found. Please load attendance register first.");
          }
    
          const subject = (window.subjectView && subjectView.value) ? subjectView.value : "Attendance";
          const stream = window.selectedStream || "Unknown";
          const sem = window.selectedSem || "0";
    
          const processedData = [];
          
          const headerRow = ["#", "Student ID", "Name"];
          const dateHeaders = table.querySelectorAll("th[data-date]");
          
          dateHeaders.forEach(header => {
            if (header.dataset.date) {
              const date = new Date(header.dataset.date);
              if (!isNaN(date.getTime())) {
                headerRow.push(date.toLocaleDateString('en-GB', {
                  day: '2-digit',
                  month: '2-digit',
                  year: '2-digit'
                }));
              }
            }
          });
          
          headerRow.push("Total", "Present", "Percentage");
          processedData.push(headerRow);
    
          rows.forEach((row, rowIndex) => {
            try {
              const cells = row.querySelectorAll("td");
              if (cells.length < 3) return;
    
              let studentID = `Student_${rowIndex + 1}`;
              let studentName = "Unknown";
              let attended = 0;
              let totalDays = 0;
    
              if (cells[1]) {
                const span = cells[1].querySelector('span');
                studentID = span ? span.textContent.trim() : cells[1].textContent.trim();
              }
              
              if (cells[2]) {
                const span = cells[2].querySelector('span');
                studentName = span ? span.textContent.trim() : cells[2].textContent.trim();
              }
    
              const dataRow = [rowIndex + 1, studentID, studentName];
    
              const checkboxes = row.querySelectorAll("input[type='checkbox']");
              checkboxes.forEach(checkbox => {
                totalDays++;
                const isPresent = checkbox.checked;
                if (isPresent) attended++;
                dataRow.push(isPresent ? "Present" : "Absent");
              });
    
              const percentage = totalDays > 0 ? (attended / totalDays) * 100 : 0;
              
              dataRow.push(totalDays, attended, `${percentage.toFixed(1)}%`);
              processedData.push(dataRow);
    
            } catch (e) {
              console.warn(`⚠️ Error processing row ${rowIndex}:`, e);
            }
          });
    
          if (processedData.length <= 1) {
            throw new Error("No valid student data found.");
          }
    
          const ws = XLSX.utils.aoa_to_sheet(processedData);
          
          ws['!cols'] = [
            { wch: 5 },  // #
            { wch: 15 }, // Student ID
            { wch: 25 }, // Name
            ...Array(dateHeaders.length).fill({ wch: 10 }), // Dates
            { wch: 8 },  // Total
            { wch: 10 }, // Present
            { wch: 10 }  // %
          ];
    
          const wb = XLSX.utils.book_new();
          const sheetName = `${subject.substring(0, 15)}_Attendance`.substring(0, 31);
          XLSX.utils.book_append_sheet(wb, ws, sheetName);
    
          const now = new Date();
          const dateStr = now.toLocaleDateString('en-GB').replace(/\//g, '-');
          const timeStr = now.toLocaleTimeString('en-GB', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
          }).replace(/:/g, '');
          
          const filename = `${subject.replace(/[^\w]/g, '_')}_${stream.replace(/\s/g, '_')}_S${sem}_${dateStr}_${timeStr}.xlsx`;
    
          XLSX.writeFile(wb, filename);
    
          showAlert("Export Success", `✅ Excel exported successfully!\n\n📚 Subject: ${subject}\n📁 File: ${filename}`, "success");
    
        } catch (error) {
          console.error("❌ Excel export error:", error);
          console.log("📄 Falling back to CSV export");
          await exportToCSV();
          
        } finally {
          exportExcelBtn.innerHTML = originalText;
          exportExcelBtn.disabled = false;
        }
      });
    
      async function exportToCSV() {
        try {
          const table = document.querySelector("#registerTable table");
          if (!table) throw new Error("No table found");
    
          const rows = table.querySelectorAll("tbody tr");
          if (rows.length === 0) throw new Error("No data found");
    
          let csvContent = "data:text/csv;charset=utf-8,";
          
          csvContent += "#,Student ID,Name";
          const dateHeaders = table.querySelectorAll("th[data-date]");
          dateHeaders.forEach(header => {
            if (header.dataset.date) {
              const date = new Date(header.dataset.date);
              csvContent += "," + date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
              });
            }
          });
          csvContent += ",Total,Present,Percentage\n";
    
          rows.forEach((row, index) => {
            const cells = row.querySelectorAll("td");
            if (cells.length < 3) return;
    
            let studentID = cells[1] ? cells[1].textContent.trim() : `Student_${index + 1}`;
            let studentName = cells[2] ? cells[2].textContent.trim() : "Unknown";
            let attended = 0;
            let totalDays = 0;
    
            studentID = studentID.replace(/,/g, ' ');
            studentName = studentName.replace(/,/g, ' ');
    
            let rowData = `${index + 1},"${studentID}","${studentName}"`;
    
            const checkboxes = row.querySelectorAll("input[type='checkbox']");
            checkboxes.forEach(checkbox => {
              totalDays++;
              const isPresent = checkbox.checked;
              if (isPresent) attended++;
              rowData += "," + (isPresent ? "Present" : "Absent");
            });
    
            const percentage = totalDays > 0 ? (attended / totalDays) * 100 : 0;
            rowData += `,${totalDays},${attended},${percentage.toFixed(1)}%\n`;
            
            csvContent += rowData;
          });
    
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          
          const subject = (window.subjectView && subjectView.value) ? subjectView.value : "Attendance";
          const stream = window.selectedStream || "Unknown";
          const sem = window.selectedSem || "0";
          const now = new Date();
          const dateStr = now.toLocaleDateString('en-GB').replace(/\//g, '-');
          
          const filename = `${subject.replace(/[^\w]/g, '_')}_${stream.replace(/\s/g, '_')}_S${sem}_${dateStr}.csv`;
          link.setAttribute("download", filename);
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
    
          showAlert("CSV Export Success", `✅ Data exported as CSV!\n\n📚 Subject: ${subject}\n📁 File: ${filename}`, "success");
    
        } catch (error) {
          console.error("❌ CSV export error:", error);
          showAlert("Export Error", `❌ Export failed: ${error.message}`, "error");
        }
      }
    }
    
    // ✅ SUBJECT MANAGEMENT FUNCTIONALITY
    let subjectsToAdd = [];
    
    function addSubjectToList() {
      const subjectInput = document.getElementById('newSubject');
      const subjectName = subjectInput.value.trim();
      
      if (!subjectName) {
        showAlert('Error', 'Subject name cannot be empty', 'error');
        return;
      }
      
      if (subjectName.length < 2) {
        showAlert('Error', 'Subject name must be at least 2 characters long', 'error');
        return;
      }
      
      if (subjectsToAdd.some(s => s.toLowerCase() === subjectName.toLowerCase())) {
        showAlert('Warning', 'Subject already added to the list', 'warning');
        return;
      }
      
      subjectsToAdd.push(subjectName);
      updateSubjectsList();
      subjectInput.value = '';
      subjectInput.focus();
      
      console.log('📚 Subject added to list:', subjectName);
    }
    
    function updateSubjectsList() {
      const listDiv = document.getElementById('subjectsList');
      
      if (subjectsToAdd.length === 0) {
        listDiv.innerHTML = '<p class="text-gray-500 text-center py-8 text-lg">📚 No subjects added yet</p>';
        return;
      }
      
      listDiv.innerHTML = subjectsToAdd.map((subject, index) => `
        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl border border-blue-200 hover:bg-blue-100 transition-all">
          <span class="font-semibold text-gray-800 text-lg">${subject}</span>
          <button onclick="removeSubject(${index})" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-100 transition-all">
            <i class="fas fa-trash text-lg"></i>
          </button>
        </div>
      `).join('');
    }
    
    function removeSubject(index) {
      const subjectName = subjectsToAdd[index];
      subjectsToAdd.splice(index, 1);
      updateSubjectsList();
      console.log('🗑️ Subject removed:', subjectName);
    }
    
    async function saveAllSubjects() {
      console.log('💾 Starting to save subjects...');
      
      if (subjectsToAdd.length === 0) {
        showAlert('Error', 'No subjects to save. Please add at least one subject.', 'error');
        return;
      }
      
      if (!window.promotionStream || !window.promotionSemester) {
        showAlert('Error', 'Please select stream and semester first from the promotion section', 'error');
        return;
      }
      
      const confirmSave = confirm(`💾 Save ${subjectsToAdd.length} subjects for ${window.promotionStream} Semester ${window.promotionSemester}?\n\nSubjects to be added:\n${subjectsToAdd.map(s => `• ${s}`).join('\n')}\n\nContinue?`);
      
      if (!confirmSave) {
        return;
      }
      
      const saveButton = document.querySelector('button[onclick="saveAllSubjects()"]');
      const originalText = saveButton.innerHTML;
      saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
      saveButton.disabled = true;
      
      try {
        const response = await fetch(`/api/setup-subjects/${window.promotionStream}/sem${window.promotionSemester}`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ 
            subjects: subjectsToAdd 
          })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          let successMessage = `✅ Subjects Setup Complete!\n\n`;
          successMessage += `Stream: ${result.stream}\n`;
          successMessage += `Semester: ${result.semester}\n`;
          successMessage += `Successfully Added: ${result.added}/${result.total}`;
          
          showAlert("Success", successMessage, "success");
          
          subjectsToAdd = [];
          updateSubjectsList();
          
        } else {
          throw new Error(result.message || 'Unknown server error');
        }
        
      } catch (error) {
        console.error('❌ Error saving subjects:', error);
        showAlert("Error", `Failed to save subjects: ${error.message}`, "error");
        
      } finally {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
      }
    }
    
    // ✅ MAKE FUNCTIONS GLOBALLY AVAILABLE
    window.validateAttendanceDates = validateAttendanceDates;
    window.validateAttendanceDatesSimple = validateAttendanceDatesSimple;
    window.goToStreamsHome = goToStreamsHome;
    window.showTab = showTab;
    window.backToSemesters = backToSemesters;
    window.loadSubjectsAndStudents = loadSubjectsAndStudents;
    window.loadAllStudents = loadAllStudents;
    window.checkAttendanceExists = checkAttendanceExists;
    window.showAlert = showAlert;
    window.showConfirmDialog = showConfirmDialog;
    window.saveAttendanceChanges = saveAttendanceChanges;
    window.silentReloadRegister = silentReloadRegister;
    window.renderAttendanceTable = renderAttendanceTable;
    window.markUnsavedChanges = markUnsavedChanges;
    window.addSubjectToList = addSubjectToList;
    window.removeSubject = removeSubject;
    window.saveAllSubjects = saveAllSubjects;
    
    console.log("✅ Complete attendance system loaded with validateAttendanceDates function properly defined");
    
    </script>
    
    <script type="module">
    // ✅ FIREBASE AUTHENTICATION MODULE
    import { firebaseConfig } from './firebase-config.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let authStateChecked = false;
    
    function showAuthLoading() {
      const loadingScreen = document.getElementById('authLoadingScreen');
      const mainContent = document.getElementById('mainContent');
      
      if (loadingScreen) loadingScreen.style.display = 'flex';
      if (mainContent) mainContent.style.display = 'none';
    }
    
    function hideAuthLoading() {
      const loadingScreen = document.getElementById('authLoadingScreen');
      const mainContent = document.getElementById('mainContent');
      
      if (loadingScreen) loadingScreen.style.display = 'none';
      if (mainContent) mainContent.style.display = 'block';
    }
    
    function isAuthorizedUser(email) {
      // Allow all users with valid email addresses
      return email && email.includes('@') && email.includes('.');
    }
    
    onAuthStateChanged(auth, (user) => {
      authStateChecked = true;
    
      if (user) {
        const email = user.email;
        
        if (!email || !isAuthorizedUser(email)) {
          signOut(auth).then(() => {
            window.location.href = "login.html";
          });
          return;
        }
    
        updateUserInterface(user, email);
        hideAuthLoading();
    
      } else {
        setTimeout(() => {
          window.location.href = "login.html";
        }, 100);
      }
    });
    
    function updateUserInterface(user, email) {
      try {
        const userName = localStorage.getItem("userName") || user.displayName || email.split('@')[0];
        const profilePhoto = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=8b5cf6&color=fff&size=64`;
        
        const userNameElement = document.getElementById("userName");
        const userEmailElement = document.getElementById("userEmail");
        const profilePicElement = document.getElementById("profilePic");
        
        if (userNameElement) userNameElement.textContent = userName;
        if (userEmailElement) userEmailElement.textContent = email;
        if (profilePicElement) {
          profilePicElement.src = profilePhoto;
          profilePicElement.onerror = () => {
            profilePicElement.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=8b5cf6&color=fff&size=64`;
          };
        }
    
        localStorage.setItem("userName", userName);
        localStorage.setItem("userEmail", email);
    
      } catch (error) {
        console.error('❌ Error updating UI:', error);
      }
    }
    
    window.logout = async () => {
      try {
        const confirmLogout = confirm("Are you sure you want to logout?");
        
        if (!confirmLogout) {
          return;
        }
        
        await signOut(auth);
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "/login.html";
        
      } catch (error) {
        console.error('❌ Logout error:', error);
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "/login.html";
      }
    };
    
    // Initialize
    showAuthLoading();
    
    setTimeout(() => {
      if (!authStateChecked) {
        window.location.href = "login.html";
      }
    }, 10000);
    
    </script>
    


</body>
</html>
