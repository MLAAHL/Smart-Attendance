<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark Attendance</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Beautiful Blue Gradient Palette */
      --navy-deep: #001D39;
      --ocean-blue: #0A4174;
      --steel-blue: #49769F;
      --teal-blue: #4E8EA2;
      --sky-blue: #6EA2B3;
      --light-blue: #7BBDE8;
      --pale-blue: #BDD8E9;
      
      /* Status Colors */
      --present: #4CAF50;
      --absent: #EF5350;
      --accent: #FFD54F;
    }

    * {
      scroll-behavior: smooth;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', system-ui, -apple-system, sans-serif;
      background: 
        radial-gradient(circle at 20% 50%, rgba(1, 29, 57, 0.03), transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(10, 65, 116, 0.05), transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(73, 118, 159, 0.04), transparent 50%),
        linear-gradient(135deg, var(--pale-blue) 0%, rgba(255, 255, 255, 0.9) 100%);
      min-height: 100vh;
      color: var(--navy-deep);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 0;
      position: relative;
    }

    /* Subtle gradient overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(1, 29, 57, 0.03), transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(10, 65, 116, 0.05), transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(73, 118, 159, 0.04), transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    
    /* 🌊 ENHANCED HEADER WITH GLASS MORPHISM */
    .header {
      background: linear-gradient(135deg, var(--navy-deep) 0%, var(--ocean-blue) 50%, var(--steel-blue) 100%);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      color: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 
        0 4px 20px rgba(1, 29, 57, 0.08),
        0 1px 0 rgba(255, 255, 255, 0.2) inset;
      border-bottom: 1px solid rgba(189, 216, 233, 0.2);
    }
    
    .back-btn {
      background: rgba(189, 216, 233, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(123, 189, 232, 0.3);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 0.9rem;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.3) inset;
    }
    
    .back-btn:hover {
      background: rgba(123, 189, 232, 0.1);
      border-color: var(--steel-blue);
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(73, 118, 159, 0.2);
    }
    
    .title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
      flex: 1;
    }
    
    .header-icon {
      font-size: 1rem;
      opacity: 0.9;
      background: rgba(189, 216, 233, 0.15);
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(189, 216, 233, 0.2);
    }

    /* 📋 GLASS MORPHISM CLASS INFO CARD */
    .class-info-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(189, 216, 233, 0.5);
      box-shadow: 
        0 8px 32px rgba(1, 29, 57, 0.1),
        0 1px 0 rgba(255, 255, 255, 0.6) inset;
      color: var(--navy-deep);
      padding: 12px 16px;
      margin: 8px 16px;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    .class-info-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--steel-blue), var(--light-blue), var(--sky-blue));
      border-radius: 12px 12px 0 0;
    }

    .class-info-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 0 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--navy-deep);
    }

    .class-info-title i {
      background: linear-gradient(135deg, 
        rgba(123, 189, 232, 0.2), 
        rgba(189, 216, 233, 0.3));
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(123, 189, 232, 0.3);
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--steel-blue);
    }

    .class-info-details {
      font-size: 0.75rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      color: rgba(1, 29, 57, 0.8);
    }

    .class-info-details span {
      background: rgba(189, 216, 233, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(123, 189, 232, 0.3);
      padding: 3px 8px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* 📱 GLASS MORPHISM FORM SECTION */
    .form-section {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(189, 216, 233, 0.4);
      box-shadow: 
        0 8px 32px rgba(1, 29, 57, 0.1),
        0 1px 0 rgba(255, 255, 255, 0.6) inset;
      padding: 12px 16px;
      margin: 8px 16px;
      border-radius: 12px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .label {
      display: block;
      font-weight: 600;
      color: var(--navy-deep);
      margin-bottom: 4px;
      font-size: 0.75rem;
    }

    .input, .select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid rgba(123, 189, 232, 0.2);
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--navy-deep);
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .input:focus, .select:focus {
      outline: none;
      border-color: var(--steel-blue);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 
        0 0 0 3px rgba(73, 118, 159, 0.1),
        0 4px 15px rgba(78, 142, 162, 0.15);
      transform: translateY(-1px);
    }

    /* 🎯 GLASS MORPHISM SUBJECT DISPLAY */
    .subject-display {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--light-blue);
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--navy-deep);
      background: rgba(189, 216, 233, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.5) inset;
    }

    .subject-badge {
      background: linear-gradient(135deg, var(--ocean-blue), var(--steel-blue));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      box-shadow: 
        0 2px 8px rgba(10, 65, 116, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.3) inset;
    }

    /* 📊 GLASS MORPHISM STATS */
    .stats {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(189, 216, 233, 0.4);
      box-shadow: 
        0 4px 20px rgba(1, 29, 57, 0.08),
        0 1px 0 rgba(255, 255, 255, 0.6) inset;
      padding: 8px 12px;
      margin: 0 16px 8px 16px;
      border-radius: 10px;
      font-weight: 600;
      color: var(--navy-deep);
      font-size: 0.75rem;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 8px;
      border-radius: 6px;
      background: rgba(189, 216, 233, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(123, 189, 232, 0.3);
      flex: 1;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.5) inset;
    }

    .stat-item:hover {
      background: rgba(123, 189, 232, 0.1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(78, 142, 162, 0.15);
    }
    
    /* 📋 ENHANCED GLASS MORPHISM TABLE */
    .table-container {
      margin: 0 16px 8px 16px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(189, 216, 233, 0.4);
      box-shadow: 
        0 8px 32px rgba(1, 29, 57, 0.1),
        0 1px 0 rgba(255, 255, 255, 0.6) inset;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }
    
    thead {
      background: linear-gradient(135deg, var(--navy-deep) 0%, var(--ocean-blue) 50%, var(--steel-blue) 100%);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color: white;
    }
    
    th {
      padding: 12px 8px;
      font-weight: 600;
      font-size: 0.8rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1) inset;
    }

    th:last-child {
      border-right: none;
    }
    
    td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(189, 216, 233, 0.3);
      border-right: 1px solid rgba(189, 216, 233, 0.2);
      font-size: 0.75rem;
      color: var(--navy-deep);
      text-align: center;
      background: transparent;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    td:last-child {
      border-right: none;
    }
    
    .student-name {
      text-align: left !important;
      font-weight: 500;
    }
    
    .student-id {
      font-weight: 600;
      color: var(--steel-blue);
      font-family: 'JetBrains Mono', monospace;
    }
    
    tbody tr:nth-child(even) td {
      background: rgba(189, 216, 233, 0.1);
    }
    
    tbody tr:hover td {
      background: rgba(123, 189, 232, 0.15);
      transform: translateX(2px);
      box-shadow: 4px 0 15px rgba(73, 118, 159, 0.15);
    }
    
    .checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--steel-blue);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .checkbox:hover {
      transform: scale(1.1);
    }

    /* Enhanced loading state */
    .loading-state {
      padding: 24px 20px;
      text-align: center;
      color: var(--steel-blue);
      border: none;
      font-size: 0.8rem;
    }

    .loading-state i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      display: block;
      opacity: 0.5;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    /* 🚀 GLASS MORPHISM SUBMIT SECTION */
    .submit-section {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(189, 216, 233, 0.4);
      box-shadow: 
        0 8px 32px rgba(1, 29, 57, 0.1),
        0 1px 0 rgba(255, 255, 255, 0.6) inset;
      padding: 12px 16px;
      margin: 8px 16px 16px 16px;
      border-radius: 12px;
    }
    
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--ocean-blue), var(--steel-blue));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0);
      box-shadow: 
        0 4px 15px rgba(10, 65, 116, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.3) inset;
    }
    
    .submit-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--navy-deep), var(--ocean-blue));
      transform: translateY(-2px);
      box-shadow: 
        0 8px 25px rgba(1, 29, 57, 0.4),
        0 1px 0 rgba(255, 255, 255, 0.3) inset;
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fa-spin {
      animation: spin 1s linear infinite;
    }

    @keyframes slideInFromTop {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .class-info-card:not(.hidden) {
      animation: slideInFromTop 0.3s ease-out;
    }

    .hidden {
      display: none;
    }

    /* 🎯 GLASS MORPHISM NOTIFICATIONS */
    .notification {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      z-index: 9999;
      padding: 12px 16px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 320px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .notification.success {
      background: linear-gradient(135deg, var(--steel-blue), var(--teal-blue));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 
        0 8px 25px rgba(73, 118, 159, 0.3),
        0 1px 0 rgba(255, 255, 255, 0.4) inset;
    }

    .notification.error {
      background: rgba(239, 83, 80, 0.1);
      color: var(--absent);
      border: 1px solid rgba(239, 83, 80, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .notification.info {
      background: rgba(255, 213, 79, 0.1);
      color: var(--accent);
      border: 1px solid rgba(255, 213, 79, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* 📱 MOBILE RESPONSIVE */
    @media (max-width: 380px) {
      .class-info-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .form-section, .submit-section {
        padding: 10px 12px;
      }

      .stats {
        padding: 6px 10px;
      }

      th, td {
        padding: 6px 4px;
        font-size: 0.65rem;
      }
    }

    /* Modern blue scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(189, 216, 233, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--steel-blue), var(--teal-blue));
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--ocean-blue), var(--steel-blue));
    }

    /* Enhanced focus states for accessibility */
    button:focus-visible,
    select:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--steel-blue);
      outline-offset: 2px;
    }

    /* Smooth transitions for theme consistency */
    * {
      transition: background-color 0.3s ease, 
                  border-color 0.3s ease, 
                  color 0.3s ease;
    }
</style>
</head>

<body>
    <!-- 🌊 ENHANCED GLASS HEADER -->
    <div class="header">
      <button class="back-btn" onclick="window.location.href='myclass.html'">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="title">Mark Attendance</h1>
      <div class="header-icon">
        <i class="fas fa-user-graduate"></i>
      </div>
    </div>

    <!-- 📋 GLASS MORPHISM CLASS INFO CARD -->
    <div id="classInfoCard" class="class-info-card hidden">
      <div class="class-info-title">
        <i class="fas fa-chalkboard-teacher"></i>
        <span id="classSubjectName">Loading...</span>
      </div>
      <div class="class-info-details">
        <span id="classStreamSem">
          <i class="fas fa-graduation-cap"></i>
          Loading...
        </span>
        <span id="classDate">
          <i class="fas fa-calendar-alt"></i>
          Today
        </span>
        <span id="classTimeSlot">
          <i class="fas fa-clock"></i>
          Period TBD
        </span>
      </div>
    </div>

    <!-- 📱 GLASS MORPHISM FORM SECTION -->
    <div class="form-section">
      <div class="form-group">
        <label class="label">Date</label>
        <input type="date" id="date" class="input" />
      </div>

      <div class="form-group">
        <label class="label">Subject</label>
        
        <div id="subjectDisplay" class="subject-display hidden">
          <span id="selectedSubjectName">Loading...</span>
          <span class="subject-badge">Selected</span>
        </div>
        
        <select id="subject" class="select">
          <option value="">Select Subject</option>
        </select>
      </div>
    </div>

    <!-- 📊 GLASS MORPHISM STATS -->
    <div class="stats">
      <div class="stat-item">
        <i class="fas fa-user-check" style="color: var(--present); font-size: 0.8rem;"></i>
        Present: <strong id="presentCount">0</strong>
      </div>
      <div class="stat-item">
        <i class="fas fa-user-times" style="color: var(--absent); font-size: 0.8rem;"></i>
        Absent: <strong id="absentCount">0</strong>
      </div>
    </div>

    <!-- 📋 ENHANCED GLASS MORPHISM TABLE -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 10%;">#</th>
            <th style="width: 25%;">Student ID</th>
            <th style="width: 45%;">Student Name</th>
            <th style="width: 20%;">Present</th>
          </tr>
        </thead>
        <tbody id="students-list">
          <tr>
            <td colspan="4" class="loading-state">
              <i class="fas fa-users"></i>
              Loading students...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 🚀 GLASS MORPHISM SUBMIT -->
    <div class="submit-section">
      <button id="submitAttendance" class="submit-btn">
        <i class="fas fa-paper-plane"></i>
        Submit Attendance
      </button>
    </div>




  <script>
    let currentClassInfo = null;
    let isPreSelectedSubject = false;

    // DOM Elements
    const dateInput = document.getElementById('date');
    const subjectSelect = document.getElementById('subject');
    const subjectDisplay = document.getElementById('subjectDisplay');
    const selectedSubjectName = document.getElementById('selectedSubjectName');
    const studentsList = document.getElementById('students-list');
    const presentCountSpan = document.getElementById('presentCount');
    const absentCountSpan = document.getElementById('absentCount');
    const submitBtn = document.getElementById('submitAttendance');
    const classInfoCard = document.getElementById('classInfoCard');

    // ✅ ENHANCED PERSISTENCE
    function saveToLocalStorage() {
      const attendanceData = {
        date: dateInput.value,
        subject: getSelectedSubject(),
        students: [],
        presentCount: presentCountSpan.textContent,
        absentCount: absentCountSpan.textContent,
        classInfo: currentClassInfo,
        isPreSelected: isPreSelectedSubject,
        timestamp: new Date().toISOString()
      };

      const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        attendanceData.students.push({
          studentID: checkbox.dataset.studentId || checkbox.value,
          name: checkbox.dataset.studentName || 'Unknown',
          present: checkbox.checked
        });
      });

      localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
    }

    function loadFromLocalStorage() {
      const savedData = localStorage.getItem('attendanceData');
      if (savedData) {
        try {
          const attendanceData = JSON.parse(savedData);
          
          if (attendanceData.date) {
            dateInput.value = attendanceData.date;
          }
          
          if (attendanceData.classInfo && attendanceData.isPreSelected) {
            currentClassInfo = attendanceData.classInfo;
            isPreSelectedSubject = true;
            showPreSelectedSubject(currentClassInfo.subject);
            showClassInfo(currentClassInfo);
            loadStudentsFromDatabase(currentClassInfo);
          }
          
          // Restore student attendance
          setTimeout(() => {
            if (attendanceData.students && attendanceData.students.length > 0) {
              restoreStudentAttendance(attendanceData.students);
            }
          }, 1000);
          
        } catch (error) {
          console.error('Error loading from localStorage:', error);
        }
      }
    }

    function restoreStudentAttendance(savedStudents) {
      const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
      
      checkboxes.forEach(checkbox => {
        const studentID = checkbox.dataset.studentId || checkbox.value;
        const savedStudent = savedStudents.find(s => s.studentID === studentID);
        
        if (savedStudent) {
          checkbox.checked = savedStudent.present;
        }
      });
      
      const total = checkboxes.length;
      const present = Array.from(checkboxes).filter(cb => cb.checked).length;
      updateCounts(present, total - present);
    }

    function clearLocalStorage() {
      localStorage.removeItem('attendanceData');
    }

    // ✅ NEW: Get selected subject from either dropdown or pre-selected
    function getSelectedSubject() {
      if (isPreSelectedSubject && currentClassInfo) {
        return currentClassInfo.subject;
      }
      return subjectSelect.value;
    }

    // ✅ NEW: Show pre-selected subject (no dropdown)
    function showPreSelectedSubject(subjectName) {
      selectedSubjectName.textContent = subjectName;
      subjectDisplay.classList.remove('hidden');
      subjectSelect.classList.add('hidden');
      isPreSelectedSubject = true;
    }

    // ✅ NEW: Show dropdown for manual selection
    function showSubjectDropdown() {
      subjectDisplay.classList.add('hidden');
      subjectSelect.classList.remove('hidden');
      isPreSelectedSubject = false;
    }
    function calculateCurrentTimeSlot() {
      try {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        // Convert current time to minutes since midnight for easier comparison
        const currentTotalMinutes = currentHour * 60 + currentMinute;
        
        // Define time slots (in 24-hour format)
        const timeSlots = [
          { start: 9 * 60, end: 10 * 60, period: "9:00 AM - 10:00 AM" },
          { start: 10 * 60, end: 11 * 60, period: "10:00 AM - 11:00 AM" },
          { start: 11 * 60, end: 12 * 60, period: "11:00 AM - 12:00 PM" },
          { start: 12 * 60, end: 13 * 60, period: "12:00 PM - 1:00 PM" },
          { start: 13 * 60, end: 14 * 60, period: "1:00 PM - 2:00 PM" },
          { start: 14 * 60, end: 15 * 60, period: "2:00 PM - 3:00 PM" },
          { start: 15 * 60, end: 16 * 60, period: "3:00 PM - 4:00 PM" },
          { start: 16 * 60, end: 17 * 60, period: "4:00 PM - 5:00 PM" }
        ];
        
        // Find current time slot
        for (let slot of timeSlots) {
          if (currentTotalMinutes >= slot.start && currentTotalMinutes < slot.end) {
            return slot.period;
          }
        }
        
        // If outside regular hours, show smart period based on 30-minute threshold
        let startHour, startMinute;
        
        if (currentMinute <= 30) {
          startHour = currentHour;
          startMinute = 0;
        } else {
          startHour = currentHour;
          startMinute = 30;
        }
        
        // Calculate end time (1 hour later)
        let endHour = startHour;
        let endMinute = startMinute + 60;
        
        if (endMinute >= 60) {
          endMinute -= 60;
          endHour += 1;
        }
        
        // Format with AM/PM
        const formatTime = (h, m) => {
          const period = h >= 12 ? 'PM' : 'AM';
          const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
          const displayMinute = m.toString().padStart(2, '0');
          return `${displayHour}:${displayMinute} ${period}`;
        };
        
        return `${formatTime(startHour, startMinute)} - ${formatTime(endHour, endMinute)}`;
        
      } catch (error) {
        console.warn('Error calculating time slot:', error);
        return 'Current Period';
      }
    }
    
    // ✅ NEW: Show class info card
    function showClassInfo(classInfo) {
      document.getElementById('classSubjectName').textContent = classInfo.subject;
      document.getElementById('classStreamSem').textContent = `${classInfo.stream} • Semester ${classInfo.semester}`;
      document.getElementById('classDate').textContent = new Date().toLocaleDateString();
      classInfoCard.classList.remove('hidden');
    }
    const timeSlot = calculateCurrentTimeSlot();
    const timeSlotElement = document.getElementById('classTimeSlot');
    if (timeSlotElement) {
      timeSlotElement.innerHTML = `
        <i class="fas fa-clock" style="margin-right: 4px; opacity: 0.8;"></i>
        ${timeSlot}
      `;
    }
    
    classInfoCard.classList.remove('hidden');
  
    // ✅ MAIN INITIALIZATION
    document.addEventListener("DOMContentLoaded", async () => {
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      dateInput.max = today;

      // ✅ Check for class info from myclass.html
      const selectedClassInfo = sessionStorage.getItem('selectedClass');
      if (selectedClassInfo) {
        try {
          currentClassInfo = JSON.parse(selectedClassInfo);
          console.log('🎯 Auto-loading class:', currentClassInfo);
          
          isPreSelectedSubject = true;
          showPreSelectedSubject(currentClassInfo.subject);
          showClassInfo(currentClassInfo);
          
          await loadStudentsFromDatabase(currentClassInfo);
          sessionStorage.removeItem('selectedClass');
        } catch (error) {
          console.error('❌ Error parsing class info:', error);
          showSubjectDropdown();
          await loadAllSubjects();
        }
      } else {
        // ✅ Check localStorage for persistence
        const savedData = localStorage.getItem('attendanceData');
        if (savedData) {
          loadFromLocalStorage();
        } else {
          showSubjectDropdown();
          await loadAllSubjects();
        }
      }

      setupEventListeners();
    });

    // ✅ LOAD STUDENTS FROM DATABASE
    async function loadStudentsFromDatabase(classInfo) {
      try {
        showLoadingState();
        
        const response = await fetch(`/api/attendance-students/${classInfo.stream}/sem${classInfo.semester}/${encodeURIComponent(classInfo.subject)}`);
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.students) {
            displayStudents(data.students);
            return;
          }
        }
        
        // Fallback
        const fallbackResponse = await fetch(`/api/students/${classInfo.stream}/sem${classInfo.semester}`);
        const fallbackData = await fallbackResponse.json();
        displayStudents(fallbackData.students || []);
        
      } catch (error) {
        console.error('Error loading students:', error);
        showErrorState('Failed to load students from database');
      }
    }

    // ✅ LOAD ALL SUBJECTS (for dropdown mode)
    async function loadAllSubjects() {
      try {
        const response = await fetch('/api/subjects/all');
        if (!response.ok) throw new Error('Failed to fetch subjects');
        
        const data = await response.json();
        const subjects = data.subjects || data || [];
        
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        subjects.forEach(subj => {
          const option = document.createElement('option');
          option.value = subj.name || subj.subjectName || subj;
          option.textContent = subj.name || subj.subjectName || subj;
          subjectSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading subjects:', error);
        subjectSelect.innerHTML = '<option value="">❌ Failed to load subjects</option>';
      }
    }

    // ✅ DISPLAY STUDENTS
    function displayStudents(students) {
      if (!students || students.length === 0) {
        studentsList.innerHTML = `
          <tr>
            <td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; border-right: none;">
              <i class="fas fa-users-slash" style="color: #d1d5db; font-size: 2rem; display: block; margin-bottom: 8px;"></i>
              No students found
            </td>
          </tr>
        `;
        updateCounts(0, 0);
        saveToLocalStorage();
        return;
      }
      
      const sortedStudents = students.sort((a, b) => {
        const aNum = parseInt(a.studentID);
        const bNum = parseInt(b.studentID);
        
        if (!isNaN(aNum) && !isNaN(bNum) && 
            a.studentID === aNum.toString() && 
            b.studentID === bNum.toString()) {
          return aNum - bNum;
        }
        
        return a.studentID.localeCompare(b.studentID, undefined, { numeric: true });
      });
      
      studentsList.innerHTML = sortedStudents.map((student, index) => `
        <tr>
          <td style="font-weight: 600;">${index + 1}</td>
          <td class="student-id">${student.studentID}</td>
          <td class="student-name">${student.name}</td>
          <td>
            <input 
              type="checkbox" 
              class="checkbox" 
              data-student-id="${student.studentID}" 
              data-student-name="${student.name}"
              value="${student.studentID}"
              checked 
            />
          </td>
        </tr>
      `).join('');

      updateCounts(students.length, 0);
      saveToLocalStorage();
    }

    // ✅ UTILITY FUNCTIONS
    function updateCounts(present, absent) {
      presentCountSpan.textContent = present;
      absentCountSpan.textContent = absent;
    }

    function showLoadingState() {
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" style="padding: 20px; text-align: center; color: #22c55e; border-right: none;">
            <i class="fas fa-spinner fa-spin"></i> Loading students from database...
          </td>
        </tr>
      `;
      updateCounts(0, 0);
    }

    function showErrorState(message) {
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" style="padding: 20px; text-align: center; color: #ef4444; border-right: none;">
            <i class="fas fa-exclamation-triangle"></i> ${message}
          </td>
        </tr>
      `;
      updateCounts(0, 0);
    }

    // ✅ EVENT LISTENERS
    function setupEventListeners() {
      // Event delegation for checkboxes
      studentsList.addEventListener('change', function(event) {
        if (event.target && event.target.matches('input[type="checkbox"]')) {
          const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
          const total = checkboxes.length;
          const present = Array.from(checkboxes).filter(cb => cb.checked).length;
          updateCounts(present, total - present);
          saveToLocalStorage();
        }
      });

      // Subject dropdown change (only for non-preselected)
      subjectSelect.addEventListener('change', async () => {
        if (!isPreSelectedSubject && subjectSelect.value) {
          try {
            const response = await fetch(`/api/students/subject/${encodeURIComponent(subjectSelect.value)}`);
            const data = await response.json();
            displayStudents(data.students || []);
          } catch (error) {
            showErrorState('Error loading students');
          }
        }
        saveToLocalStorage();
      });

      // Date change
      dateInput.addEventListener('change', () => {
        const selectedDate = dateInput.value;
        const today = new Date().toISOString().split('T')[0];
        
        if (selectedDate > today) {
          alert('⚠️ Future dates are not allowed!');
          dateInput.value = today;
        }
        
        saveToLocalStorage();
      });

      // Submit button
      setupSubmitButton();
    }

    // 🎉 SUCCESS CONFIRMATION DIALOG
function showSubmittedConfirmation(subject, date, presentStudents, totalStudents) {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 29, 57, 0.7); z-index: 10000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s ease;
  `;

  overlay.innerHTML = `
    <div style="
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 20px; 
      padding: 28px; 
      max-width: 340px; 
      width: 100%;
      box-shadow: 0 20px 40px rgba(10, 65, 116, 0.3); 
      text-align: center;
      border: 1px solid rgba(189, 216, 233, 0.4);
      position: relative;
      overflow: hidden;
      animation: slideUp 0.4s ease;
    ">
      <!-- Success Animation Circle -->
      <div style="
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--present), #66bb6a);
        margin: 0 auto 20px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        animation: successPulse 0.6s ease;
      ">
        <i class="fas fa-check" style="
          color: white; 
          font-size: 2.2rem;
          animation: checkMark 0.8s ease 0.2s both;
        "></i>
      </div>
      
      <!-- Title -->
      <h3 style="
        color: var(--navy-deep); 
        margin: 0 0 16px 0; 
        font-size: 1.3rem; 
        font-weight: 700;
        letter-spacing: -0.02em;
      ">Attendance Submitted!</h3>
      
      <!-- Success Details -->
      <div style="
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(102, 187, 106, 0.05) 100%);
        padding: 16px 20px; 
        border-radius: 12px; 
        margin-bottom: 20px;
        border: 1px solid rgba(76, 175, 80, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      ">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i class="fas fa-book" style="color: var(--steel-blue); font-size: 1rem; width: 18px;"></i>
          <span style="color: var(--navy-deep); font-weight: 600; font-size: 0.9rem;">${subject}</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <i class="fas fa-calendar-check" style="color: var(--steel-blue); font-size: 1rem; width: 18px;"></i>
          <span style="color: var(--navy-deep); font-weight: 500; font-size: 0.9rem;">${date}</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 12px;">
          <i class="fas fa-user-check" style="color: var(--present); font-size: 1rem; width: 18px;"></i>
          <span style="color: var(--present); font-weight: 700; font-size: 1rem;">
            ${presentStudents}/${totalStudents} Present
          </span>
        </div>
      </div>
      
      <!-- Success Message -->
      <p style="
        color: rgba(1, 29, 57, 0.7); 
        font-size: 0.85rem; 
        margin-bottom: 24px; 
        line-height: 1.5;
        font-weight: 500;
      ">
        ✨ Your attendance has been successfully recorded. You can submit again if needed.
      </p>
      
      <!-- OK Button -->
      <button id="okBtn" style="
        width: 100%;
        padding: 14px 20px; 
        border: none; 
        background: linear-gradient(135deg, var(--present), #66bb6a);
        color: white; 
        border-radius: 12px; 
        font-weight: 700; 
        cursor: pointer; 
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      ">
        <i class="fas fa-thumbs-up" style="margin-right: 8px;"></i>
        Perfect!
      </button>
    </div>
  `;

  // Add animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(30px) scale(0.9); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }
    
    @keyframes successPulse {
      0% { 
        transform: scale(0);
        opacity: 0;
      }
      50% { 
        transform: scale(1.1);
        opacity: 1;
      }
      100% { 
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes checkMark {
      0% { 
        transform: scale(0) rotate(-45deg);
        opacity: 0;
      }
      100% { 
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }
  `;
  document.head.appendChild(style);

  document.body.appendChild(overlay);

  // Button hover effect
  const okBtn = overlay.querySelector('#okBtn');
  okBtn.addEventListener('mouseenter', () => {
    okBtn.style.transform = 'translateY(-2px)';
    okBtn.style.boxShadow = '0 8px 25px rgba(76, 175, 80, 0.4)';
  });
  okBtn.addEventListener('mouseleave', () => {
    okBtn.style.transform = 'translateY(0)';
    okBtn.style.boxShadow = '0 6px 20px rgba(76, 175, 80, 0.3)';
  });

  // Event listeners
  okBtn.onclick = () => {
    // Check if we should redirect back to myclass.html
    const redirectPage = sessionStorage.getItem('redirectAfterAttendance');
    
    overlay.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => {
      overlay.remove();
      
      // If we came from myclass.html, redirect back there
      if (redirectPage === 'myclass.html') {
        sessionStorage.removeItem('redirectAfterAttendance'); // Clean up
        console.log('Redirecting back to class queue...');
        setTimeout(() => {
          window.location.href = 'myclass.html';
        }, 1000);
      }
    }, 300);
  };
  
  overlay.onclick = (e) => {
    if (e.target === overlay) {
      overlay.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => overlay.remove(), 300);
    }
  };

  // Auto close after 4 seconds
  setTimeout(() => {
    if (overlay.parentElement) {
      // Check if we should redirect back to myclass.html
      const redirectPage = sessionStorage.getItem('redirectAfterAttendance');
      
      overlay.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => {
        overlay.remove();
        
        // If we came from myclass.html, redirect back there
        if (redirectPage === 'myclass.html') {
          sessionStorage.removeItem('redirectAfterAttendance'); // Clean up
          console.log('Redirecting back to class queue...');
          setTimeout(() => {
            window.location.href = 'myclass.html';
          }, 1000);
        }
      }, 300);
    }
  }, 4000);
}

// 💬 ENHANCED CONFIRM DIALOG WITH CLEAN LAYOUT
function showConfirm(message, subject, date, totalStudents, presentStudents, absentStudents, onConfirm) {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 29, 57, 0.7); z-index: 10000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
    backdrop-filter: blur(5px);
  `;

  overlay.innerHTML = `
    <div style="
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-radius: 16px; 
      padding: 24px; 
      max-width: 320px; 
      width: 100%;
      box-shadow: 0 15px 35px rgba(10, 65, 116, 0.3); 
      text-align: left;
      border: 1px solid rgba(189, 216, 233, 0.4);
    ">
      <!-- Header -->
      <div style="text-align: center; margin-bottom: 20px;">
        <i class="fas fa-question-circle" style="color: var(--steel-blue); font-size: 2.5rem; margin-bottom: 12px;"></i>
        <h3 style="color: var(--navy-deep); margin: 0; font-size: 1.1rem; font-weight: 700;">Submit Attendance?</h3>
      </div>
      
      <!-- Details -->
      <div style="margin-bottom: 20px; line-height: 1.6;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i class="fas fa-book" style="color: var(--steel-blue); font-size: 1rem; width: 16px;"></i>
          <span style="color: var(--navy-deep); font-weight: 600; font-size: 0.9rem;">${subject}</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i class="fas fa-calendar-alt" style="color: var(--steel-blue); font-size: 1rem; width: 16px;"></i>
          <span style="color: var(--navy-deep); font-weight: 500; font-size: 0.9rem;">${date}</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i class="fas fa-users" style="color: var(--steel-blue); font-size: 1rem; width: 16px;"></i>
          <span style="color: var(--navy-deep); font-weight: 500; font-size: 0.9rem;">Total: ${totalStudents}</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <i class="fas fa-user-check" style="color: var(--present); font-size: 1rem; width: 16px;"></i>
          <span style="color: var(--present); font-weight: 600; font-size: 0.9rem;">Present: ${presentStudents}</span>
        </div>
        
        <div style="display: flex; align-items: center; gap: 10px;">
          <i class="fas fa-user-times" style="color: var(--absent); font-size: 1rem; width: 16px;"></i>
          <span style="color: var(--absent); font-weight: 600; font-size: 0.9rem;">Absent: ${absentStudents}</span>
        </div>
      </div>
      
      <!-- Note -->
      <div style="
        background: linear-gradient(135deg, rgba(123, 189, 232, 0.1) 0%, rgba(189, 216, 233, 0.05) 100%);
        padding: 10px 12px; border-radius: 8px; margin-bottom: 20px;
        border-left: 3px solid var(--light-blue);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      ">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-info-circle" style="color: var(--light-blue); font-size: 0.9rem;"></i>
          <span style="color: var(--navy-deep); font-size: 0.8rem; font-weight: 500;">Multiple submissions allowed</span>
        </div>
      </div>
      
      <!-- Buttons -->
      <div style="display: flex; gap: 12px;">
        <button id="cancelBtn" style="
          flex: 1; padding: 12px 16px; 
          border: 2px solid var(--steel-blue); 
          background: rgba(255, 255, 255, 0.9); 
          color: var(--steel-blue); 
          border-radius: 8px; 
          font-weight: 600; cursor: pointer; font-size: 0.9rem;
          transition: all 0.2s ease;
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        ">
          <i class="fas fa-times" style="margin-right: 6px;"></i>Cancel
        </button>
        
        <button id="confirmBtn" style="
          flex: 1; padding: 12px 16px; border: none; 
          background: linear-gradient(135deg, var(--navy-deep), var(--steel-blue)); 
          color: white; border-radius: 8px; 
          font-weight: 600; cursor: pointer; font-size: 0.9rem;
          transition: all 0.2s ease;
          box-shadow: 0 4px 12px rgba(10, 65, 116, 0.3);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        ">
          <i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Submit
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(overlay);

  // Button hover effects
  const cancelBtn = overlay.querySelector('#cancelBtn');
  const confirmBtn = overlay.querySelector('#confirmBtn');

  cancelBtn.addEventListener('mouseenter', () => {
    cancelBtn.style.background = 'var(--steel-blue)';
    cancelBtn.style.color = 'white';
  });
  cancelBtn.addEventListener('mouseleave', () => {
    cancelBtn.style.background = 'rgba(255, 255, 255, 0.9)';
    cancelBtn.style.color = 'var(--steel-blue)';
  });

  confirmBtn.addEventListener('mouseenter', () => {
    confirmBtn.style.transform = 'translateY(-1px)';
    confirmBtn.style.boxShadow = '0 6px 16px rgba(10, 65, 116, 0.4)';
  });
  confirmBtn.addEventListener('mouseleave', () => {
    confirmBtn.style.transform = 'translateY(0)';
    confirmBtn.style.boxShadow = '0 4px 12px rgba(10, 65, 116, 0.3)';
  });

  // Event listeners
  cancelBtn.onclick = () => overlay.remove();
  confirmBtn.onclick = () => {
    overlay.remove();
    onConfirm();
  };
  overlay.onclick = (e) => {
    if (e.target === overlay) overlay.remove();
  };
}

// ✅ UPDATED SUBMIT FUNCTION WITH SUCCESS CONFIRMATION
function setupSubmitButton() {
  if (submitBtn) {
    submitBtn.addEventListener("click", async () => {
      const subject = getSelectedSubject();
      const date = dateInput.value;

      // Validation
      if (!subject || !date) {
        showNotification("Please select date and subject", "error");
        return;
      }

      const today = new Date().toISOString().split("T")[0];
      if (date > today) {
        showNotification("Future dates are not allowed", "error");
        return;
      }

      const checkboxes = studentsList.querySelectorAll("input[type='checkbox']");
      const checkedBoxes = studentsList.querySelectorAll("input:checked");
      const totalStudents = checkboxes.length;
      const presentStudents = checkedBoxes.length;
      const absentStudents = totalStudents - presentStudents;

      if (totalStudents === 0) {
        showNotification("No students found for attendance", "error");
        return;
      }

      // Format date for display
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'short',
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });

      // Show enhanced confirm dialog
      showConfirm(
        "confirm",
        subject,
        formattedDate,
        totalStudents,
        presentStudents,
        absentStudents,
        async () => {
          try {
            // Set loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            const studentsPresent = Array.from(checkedBoxes).map(cb => 
              cb.dataset.studentId || cb.value
            );

            let apiUrl = '/api/attendance';
            if (currentClassInfo) {
              apiUrl = `/api/attendance/${currentClassInfo.stream}/sem${currentClassInfo.semester}/${encodeURIComponent(subject)}`;
            }

            const res = await fetch(apiUrl, {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify({ 
                date, subject, studentsPresent, totalStudents,
                presentCount: presentStudents, absentCount: absentStudents,
                classInfo: currentClassInfo, allowMultipleSubmissions: true
              })
            });

            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(`HTTP ${res.status}: ${errorText}`);
            }

            const result = await res.json();

            if (result.success !== false) {
              // 🎉 Show beautiful success confirmation
              showSubmittedConfirmation(subject, formattedDate, presentStudents, totalStudents);
              
              // Reset form
              clearLocalStorage();
              dateInput.value = new Date().toISOString().split("T")[0];
              
              if (!isPreSelectedSubject) {
                subjectSelect.value = "";
              }
              
              checkboxes.forEach(cb => cb.checked = false);
              updateCounts(0, 0);
              
            } else {
              showNotification("Submission failed: " + (result.message || "Unknown error"), "error");
            }

          } catch (err) {
            console.error("Submission error:", err);
            showNotification("Network error: " + err.message, "error");
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Attendance';
          }
        }
      );
    });
  }
}

  </script>
</body>
</html>
