<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark Attendance</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0fdf4;
      margin: 0;
      padding: 12px;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.1);
    }
    
    .header {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }
    
    .form-section {
      padding: 16px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .label {
      display: block;
      font-weight: 600;
      color: #15803d;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    
    .input, .select {
      width: 100%;
      padding: 10px;
      border: 2px solid #bbf7d0;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #15803d;
      background: #f7fee7;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .input:focus, .select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    /* ✅ NEW: Subject display styles */
    .subject-display {
      width: 100%;
      padding: 12px;
      border: 2px solid #22c55e;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #15803d;
      background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .subject-badge {
      background: #22c55e;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      background: #dcfce7;
      padding: 12px 16px;
      margin: 0;
      font-weight: 600;
      color: #15803d;
      font-size: 0.9rem;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #22c55e;
      color: white;
    }
    
    th {
      padding: 10px 6px;
      font-weight: 600;
      font-size: 0.85rem;
      text-align: center;
      border-right: 1px solid #16a34a;
    }
    
    th:last-child {
      border-right: none;
    }
    
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #dcfce7;
      border-right: 1px solid #dcfce7;
      font-size: 0.8rem;
      color: #15803d;
      text-align: center;
    }
    
    td:last-child {
      border-right: none;
    }
    
    .student-name {
      text-align: left !important;
      font-weight: 500;
    }
    
    .student-id {
      font-weight: 600;
      color: #059669;
    }
    
    tbody tr:nth-child(even) {
      background: #f7fee7;
    }
    
    tbody tr:hover {
      background: #ecfdf5;
    }
    
    .checkbox {
      width: 16px;
      height: 16px;
      accent-color: #22c55e;
      cursor: pointer;
    }
    
    .submit-section {
      padding: 16px;
    }
    
    .submit-btn {
      width: 100%;
      background: #22c55e;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background 0.2s, transform 0.1s;
    }
    
    .submit-btn:hover:not(:disabled) {
      background: #16a34a;
      transform: translateY(-1px);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fa-spin {
      animation: spin 1s linear infinite;
    }

    /* ✅ NEW: Class info card styles */
    .class-info-card {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      padding: 16px;
      margin: 16px 16px 0 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .class-info-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .class-info-details {
      font-size: 0.85rem;
      opacity: 0.9;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header with Back Button -->
    <div class="header">
      <button class="back-btn" onclick="window.location.href='myclass.html'">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="title">Mark Attendance</h1>
    </div>

    <!-- ✅ NEW: Class Info Card (shows when coming from myclass.html) -->
    <div id="classInfoCard" class="class-info-card hidden">
      <div class="class-info-title">
        <i class="fas fa-chalkboard-teacher"></i>
        <span id="classSubjectName">Loading...</span>
      </div>
      <div class="class-info-details">
        <span id="classStreamSem">Loading...</span>
        <span>•</span>
        <span id="classDate">Today</span>
      </div>
    </div>

    <!-- Form Section -->
    <div class="form-section">
      <div class="form-group">
        <label class="label">Date</label>
        <input type="date" id="date" class="input" />
      </div>

      <!-- ✅ ENHANCED: Subject Section (dropdown OR display) -->
      <div class="form-group">
        <label class="label">Subject</label>
        
        <!-- ✅ Subject Display (shown when pre-selected) -->
        <div id="subjectDisplay" class="subject-display hidden">
          <span id="selectedSubjectName">Loading...</span>
          <span class="subject-badge">SELECTED</span>
        </div>
        
        <!-- ✅ Subject Dropdown (shown when not pre-selected) -->
        <select id="subject" class="select">
          <option value="">Select Subject</option>
        </select>
      </div>
    </div>

    <!-- Stats (Present and Absent Counts) -->
    <div class="stats">
      <div class="stat-item">
        <i class="fas fa-user-check" style="color: #059669;"></i>
        Present: <span id="presentCount">0</span>
      </div>
      <div class="stat-item">
        <i class="fas fa-user-times" style="color: #dc2626;"></i>
        Absent: <span id="absentCount">0</span>
      </div>
    </div>

    <!-- Students Table -->
    <table>
      <thead>
        <tr>
          <th style="width: 10%;">#</th>
          <th style="width: 25%;">ID</th>
          <th style="width: 45%;">Name</th>
          <th style="width: 20%;">Present</th>
        </tr>
      </thead>
      <tbody id="students-list">
        <tr>
          <td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; border-right: none;">
            Loading students...
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Submit Section -->
    <div class="submit-section">
      <button id="submitAttendance" class="submit-btn">
        <i class="fas fa-paper-plane"></i>
        Submit Attendance
      </button>
    </div>
  </div>

  <script>
    let currentClassInfo = null;
    let isPreSelectedSubject = false;

    // DOM Elements
    const dateInput = document.getElementById('date');
    const subjectSelect = document.getElementById('subject');
    const subjectDisplay = document.getElementById('subjectDisplay');
    const selectedSubjectName = document.getElementById('selectedSubjectName');
    const studentsList = document.getElementById('students-list');
    const presentCountSpan = document.getElementById('presentCount');
    const absentCountSpan = document.getElementById('absentCount');
    const submitBtn = document.getElementById('submitAttendance');
    const classInfoCard = document.getElementById('classInfoCard');

    // ✅ ENHANCED PERSISTENCE
    function saveToLocalStorage() {
      const attendanceData = {
        date: dateInput.value,
        subject: getSelectedSubject(),
        students: [],
        presentCount: presentCountSpan.textContent,
        absentCount: absentCountSpan.textContent,
        classInfo: currentClassInfo,
        isPreSelected: isPreSelectedSubject,
        timestamp: new Date().toISOString()
      };

      const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        attendanceData.students.push({
          studentID: checkbox.dataset.studentId || checkbox.value,
          name: checkbox.dataset.studentName || 'Unknown',
          present: checkbox.checked
        });
      });

      localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
    }

    function loadFromLocalStorage() {
      const savedData = localStorage.getItem('attendanceData');
      if (savedData) {
        try {
          const attendanceData = JSON.parse(savedData);
          
          if (attendanceData.date) {
            dateInput.value = attendanceData.date;
          }
          
          if (attendanceData.classInfo && attendanceData.isPreSelected) {
            currentClassInfo = attendanceData.classInfo;
            isPreSelectedSubject = true;
            showPreSelectedSubject(currentClassInfo.subject);
            showClassInfo(currentClassInfo);
            loadStudentsFromDatabase(currentClassInfo);
          }
          
          // Restore student attendance
          setTimeout(() => {
            if (attendanceData.students && attendanceData.students.length > 0) {
              restoreStudentAttendance(attendanceData.students);
            }
          }, 1000);
          
        } catch (error) {
          console.error('Error loading from localStorage:', error);
        }
      }
    }

    function restoreStudentAttendance(savedStudents) {
      const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
      
      checkboxes.forEach(checkbox => {
        const studentID = checkbox.dataset.studentId || checkbox.value;
        const savedStudent = savedStudents.find(s => s.studentID === studentID);
        
        if (savedStudent) {
          checkbox.checked = savedStudent.present;
        }
      });
      
      const total = checkboxes.length;
      const present = Array.from(checkboxes).filter(cb => cb.checked).length;
      updateCounts(present, total - present);
    }

    function clearLocalStorage() {
      localStorage.removeItem('attendanceData');
    }

    // ✅ NEW: Get selected subject from either dropdown or pre-selected
    function getSelectedSubject() {
      if (isPreSelectedSubject && currentClassInfo) {
        return currentClassInfo.subject;
      }
      return subjectSelect.value;
    }

    // ✅ NEW: Show pre-selected subject (no dropdown)
    function showPreSelectedSubject(subjectName) {
      selectedSubjectName.textContent = subjectName;
      subjectDisplay.classList.remove('hidden');
      subjectSelect.classList.add('hidden');
      isPreSelectedSubject = true;
    }

    // ✅ NEW: Show dropdown for manual selection
    function showSubjectDropdown() {
      subjectDisplay.classList.add('hidden');
      subjectSelect.classList.remove('hidden');
      isPreSelectedSubject = false;
    }

    // ✅ NEW: Show class info card
    function showClassInfo(classInfo) {
      document.getElementById('classSubjectName').textContent = classInfo.subject;
      document.getElementById('classStreamSem').textContent = `${classInfo.stream} • Semester ${classInfo.semester}`;
      document.getElementById('classDate').textContent = new Date().toLocaleDateString();
      classInfoCard.classList.remove('hidden');
    }

    // ✅ MAIN INITIALIZATION
    document.addEventListener("DOMContentLoaded", async () => {
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      dateInput.value = today;
      dateInput.max = today;

      // ✅ Check for class info from myclass.html
      const selectedClassInfo = sessionStorage.getItem('selectedClass');
      if (selectedClassInfo) {
        try {
          currentClassInfo = JSON.parse(selectedClassInfo);
          console.log('🎯 Auto-loading class:', currentClassInfo);
          
          isPreSelectedSubject = true;
          showPreSelectedSubject(currentClassInfo.subject);
          showClassInfo(currentClassInfo);
          
          await loadStudentsFromDatabase(currentClassInfo);
          sessionStorage.removeItem('selectedClass');
        } catch (error) {
          console.error('❌ Error parsing class info:', error);
          showSubjectDropdown();
          await loadAllSubjects();
        }
      } else {
        // ✅ Check localStorage for persistence
        const savedData = localStorage.getItem('attendanceData');
        if (savedData) {
          loadFromLocalStorage();
        } else {
          showSubjectDropdown();
          await loadAllSubjects();
        }
      }

      setupEventListeners();
    });

    // ✅ LOAD STUDENTS FROM DATABASE
    async function loadStudentsFromDatabase(classInfo) {
      try {
        showLoadingState();
        
        const response = await fetch(`/api/attendance-students/${classInfo.stream}/sem${classInfo.semester}/${encodeURIComponent(classInfo.subject)}`);
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.students) {
            displayStudents(data.students);
            return;
          }
        }
        
        // Fallback
        const fallbackResponse = await fetch(`/api/students/${classInfo.stream}/sem${classInfo.semester}`);
        const fallbackData = await fallbackResponse.json();
        displayStudents(fallbackData.students || []);
        
      } catch (error) {
        console.error('Error loading students:', error);
        showErrorState('Failed to load students from database');
      }
    }

    // ✅ LOAD ALL SUBJECTS (for dropdown mode)
    async function loadAllSubjects() {
      try {
        const response = await fetch('/api/subjects/all');
        if (!response.ok) throw new Error('Failed to fetch subjects');
        
        const data = await response.json();
        const subjects = data.subjects || data || [];
        
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        subjects.forEach(subj => {
          const option = document.createElement('option');
          option.value = subj.name || subj.subjectName || subj;
          option.textContent = subj.name || subj.subjectName || subj;
          subjectSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading subjects:', error);
        subjectSelect.innerHTML = '<option value="">❌ Failed to load subjects</option>';
      }
    }

    // ✅ DISPLAY STUDENTS
    function displayStudents(students) {
      if (!students || students.length === 0) {
        studentsList.innerHTML = `
          <tr>
            <td colspan="4" style="padding: 20px; text-align: center; color: #6b7280; border-right: none;">
              <i class="fas fa-users-slash" style="color: #d1d5db; font-size: 2rem; display: block; margin-bottom: 8px;"></i>
              No students found
            </td>
          </tr>
        `;
        updateCounts(0, 0);
        saveToLocalStorage();
        return;
      }
      
      const sortedStudents = students.sort((a, b) => {
        const aNum = parseInt(a.studentID);
        const bNum = parseInt(b.studentID);
        
        if (!isNaN(aNum) && !isNaN(bNum) && 
            a.studentID === aNum.toString() && 
            b.studentID === bNum.toString()) {
          return aNum - bNum;
        }
        
        return a.studentID.localeCompare(b.studentID, undefined, { numeric: true });
      });
      
      studentsList.innerHTML = sortedStudents.map((student, index) => `
        <tr>
          <td style="font-weight: 600;">${index + 1}</td>
          <td class="student-id">${student.studentID}</td>
          <td class="student-name">${student.name}</td>
          <td>
            <input 
              type="checkbox" 
              class="checkbox" 
              data-student-id="${student.studentID}" 
              data-student-name="${student.name}"
              value="${student.studentID}"
              checked 
            />
          </td>
        </tr>
      `).join('');

      updateCounts(students.length, 0);
      saveToLocalStorage();
    }

    // ✅ UTILITY FUNCTIONS
    function updateCounts(present, absent) {
      presentCountSpan.textContent = present;
      absentCountSpan.textContent = absent;
    }

    function showLoadingState() {
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" style="padding: 20px; text-align: center; color: #22c55e; border-right: none;">
            <i class="fas fa-spinner fa-spin"></i> Loading students from database...
          </td>
        </tr>
      `;
      updateCounts(0, 0);
    }

    function showErrorState(message) {
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" style="padding: 20px; text-align: center; color: #ef4444; border-right: none;">
            <i class="fas fa-exclamation-triangle"></i> ${message}
          </td>
        </tr>
      `;
      updateCounts(0, 0);
    }

    // ✅ EVENT LISTENERS
    function setupEventListeners() {
      // Event delegation for checkboxes
      studentsList.addEventListener('change', function(event) {
        if (event.target && event.target.matches('input[type="checkbox"]')) {
          const checkboxes = studentsList.querySelectorAll('input[type="checkbox"]');
          const total = checkboxes.length;
          const present = Array.from(checkboxes).filter(cb => cb.checked).length;
          updateCounts(present, total - present);
          saveToLocalStorage();
        }
      });

      // Subject dropdown change (only for non-preselected)
      subjectSelect.addEventListener('change', async () => {
        if (!isPreSelectedSubject && subjectSelect.value) {
          try {
            const response = await fetch(`/api/students/subject/${encodeURIComponent(subjectSelect.value)}`);
            const data = await response.json();
            displayStudents(data.students || []);
          } catch (error) {
            showErrorState('Error loading students');
          }
        }
        saveToLocalStorage();
      });

      // Date change
      dateInput.addEventListener('change', () => {
        const selectedDate = dateInput.value;
        const today = new Date().toISOString().split('T')[0];
        
        if (selectedDate > today) {
          alert('⚠️ Future dates are not allowed!');
          dateInput.value = today;
        }
        
        saveToLocalStorage();
      });

      // Submit button
      setupSubmitButton();
    }

    // ✅ SUBMIT ATTENDANCE
    function setupSubmitButton() {
      if (submitBtn) {
        submitBtn.addEventListener("click", async () => {
          const subject = getSelectedSubject();
          const date = dateInput.value;
    
          if (!subject || !date) {
            alert("Please select both date and subject.");
            return;
          }
    
          const today = new Date().toISOString().split("T")[0];
          if (date > today) {
            alert("Future dates are not allowed.");
            return;
          }
    
          try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
            const checkboxes = studentsList.querySelectorAll("input[type='checkbox']");
            const checkedBoxes = studentsList.querySelectorAll("input:checked");
            const totalStudents = checkboxes.length;
            const presentStudents = checkedBoxes.length;
            const absentStudents = totalStudents - presentStudents;

            if (totalStudents === 0) {
              alert("No students found for attendance.");
              return;
            }
    
            const confirmMessage = `Submit Attendance?\n\nSubject: ${subject}\nDate: ${date}\n\nTotal Students: ${totalStudents}\nPresent: ${presentStudents}\nAbsent: ${absentStudents}\n\n✅ Multiple submissions allowed.`;
            
            if (!confirm(confirmMessage)) {
              alert("Attendance submission cancelled.");
              return;
            }
    
            const studentsPresent = Array.from(checkedBoxes).map(cb => 
              cb.dataset.studentId || cb.value
            );
    
            let apiUrl = '/api/attendance';
            if (currentClassInfo) {
              apiUrl = `/api/attendance/${currentClassInfo.stream}/sem${currentClassInfo.semester}/${encodeURIComponent(subject)}`;
            }
    
            const res = await fetch(apiUrl, {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify({ 
                date, 
                subject, 
                studentsPresent,
                totalStudents,
                presentCount: presentStudents,
                absentCount: absentStudents,
                classInfo: currentClassInfo,
                allowMultipleSubmissions: true
              })
            });

            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(`HTTP ${res.status}: ${errorText}`);
            }
    
            const result = await res.json();
    
            if (result.success !== false) {
              const successMessage = `✅ Attendance Submitted Successfully!\n\nSubject: ${subject}\nDate: ${date}\n\nPresent: ${presentStudents}/${totalStudents}\n\n✨ You can submit again if needed.`;
              
              alert(successMessage);
              
              clearLocalStorage();
              
              // Reset for new attendance
              dateInput.value = new Date().toISOString().split("T")[0];
              
              // If pre-selected, keep the subject; otherwise reset
              if (!isPreSelectedSubject) {
                subjectSelect.value = "";
              }
              
              checkboxes.forEach(cb => cb.checked = false);
              updateCounts(0, 0);
              
            } else {
              alert("Submission Failed: " + (result.message || "Unknown error occurred."));
            }
    
          } catch (err) {
            console.error("Submission error:", err);
            alert(`Network Error: Failed to submit attendance.\n\nError: ${err.message}`);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Attendance';
          }
        });
      }
    }
  </script>
</body>
</html>
