<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Panel</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="demo.css">

  <!-- Inline Styles -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            customBlue: '#007CBE',
            customYellow: '#FFF7AE',
            customOrange: '#E57A44',
            customPurple: '#251351',
          }
        }
      }
    }
  </script>
</head>

<body>
  <!-- Main Wrapper -->
  <div id="homePage">
    
    <!-- Header Section -->
    <header class="relative w-full px-5 py-6 text-white overflow-hidden flex items-center justify-center h-[200vh]">
      
      <!-- Toggle Button -->
      <div class="menu-icon cursor-pointer" onclick="toggleMenu()">
        <div class="line long bg-gray-800 h-1 w-6 mb-1"></div>
        <div class="line short bg-gray-800 h-1 w-4"></div>
      </div>

      <!-- User Icon -->
      <div class="absolute top-4 right-4 flex items-center space-x-2">
        <span class="text-sm font-medium text-indigo-700" id="userName"></span>
        <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User"
             class="w-8 h-8 rounded-full shadow-lg border border-indigo-300"/>
      </div>

      <!-- Side Menu -->
      <div id="mobileMenu" class="side-menu hidden fixed top-0 left-0 w-64 h-full bg-white shadow z-50 p-4 transition-transform transform -translate-x-full">
        <div class="mb-8">
          <div class="text-2xl font-bold text-indigo-600 flex items-center">
            <i class="fas fa-chalkboard-teacher mr-2"></i>
            Smart Panel
          </div>
          <div class="text-xs text-gray-500 mt-1">Teacher Dashboard</div>
        </div>
        
        <div class="user-profile flex flex-col items-center mb-8">
          <div class="relative mb-4">
            <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" 
                 class="w-20 h-20 rounded-full border-4 border-indigo-100 object-cover shadow-lg"/>
            <div class="absolute bottom-0 right-0 w-6 h-6 bg-green-400 rounded-full border-2 border-white"></div>
          </div>
          <span id="userName" class="font-semibold text-gray-800 text-lg"></span>
          <span id="userEmail" class="text-gray-500 text-sm mt-1"></span>
        </div>
        
        <ul class="space-y-4 text-black">
          <li>
            <button onclick="window.location.reload()" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition">
              <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fas fa-home text-sm"></i>
              </div>
              <span>Dashboard</span>
            </button>
          </li>
          <li>
            <a href="/auth.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-comments text-sm"></i>
            </div>
            <span>My class</span>
            </a>
          </li>
          
        
          <!-- ‚úÖ NEW: Promote Students Button -->
          <li>
            <a href="/promotion.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-user-graduate text-sm"></i>
              </div>
              <span>Promote Students</span>
            </a>
          </li>
          <li>
            <a href="/msg.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-comments text-sm"></i>
            </div>
            <span>WhatsApp</span>
            </a>
          </li>
          
          <li>
            <a href="/report.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-user-graduate text-sm"></i>
              </div>
              <span>Reports</span>
            </a>
          </li>
          
       
        </ul>
        
        <!-- Logout Button -->
        <div class="mt-auto pt-4">
          <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 text-red-500 transition">
            <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center text-red-500">
              <i class="fas fa-sign-out-alt text-sm"></i>
            </div>
            <span>Logout</span>
          </button>
        </div>
        
    </header>

    <div class="banner-wrapper">
      <div class="banner">
        <div class="banner-text">
          <div class="badge">MLA AHL</div>
          <h1>Smart Attendance System</h1>
          <p>Mark it. View it.</p>
             <P>Stay on track.</p>
        </div>
        <div class="banner-img">
          <img src="b1.png" 
         alt="Attendance Illustration" 
         class="w-40 sm:w-40 drop-shadow-lg" />
        </div>

        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
      </div>
    </div>

    <!-- Stream Section -->
    <div class="px-5 py-4">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-graduation-cap text-indigo-500 mr-2"></i>
        Select Academic Stream
      </h2>
      <div id="streamSection" class="grid grid-cols-2 gap-4">
        <!-- JS will populate stream cards here -->
      </div>
    </div>

  </div> <!-- End of #homePage -->

    <!-- Semester Section (initially hidden) -->
    <div id="semesterSection" class="hidden">
      <div class="max-w-[800px] w-full grid grid-cols-2 gap-6 px-6 py-6 mx-auto">
        
        <!-- JS will append semester cards here -->
      </div>
    </div>

    <div id="tabs" class="hidden">
      <!-- ‚úÖ MOBILE HEADER: Optimized spacing -->
      <header class="w-full bg-white shadow-sm border-b border-gray-200 px-3 py-3 mb-4">
        <div class="flex items-center justify-between">
          <!-- Left: Back Button -->
          <button onclick="backToSemesters()" class="w-8 h-8 rounded-full bg-gradient-to-r from-white to-blue-100 hover:from-blue-50 hover:to-blue-200 border border-blue-300 flex items-center justify-center transition-all duration-200 active:scale-95">
            <i class="fa-solid fa-angle-left text-blue-600 text-xs"></i>
          </button>
          
          
          <!-- Center: Stream & Semester -->
          <div class="flex items-center space-x-3 rounded-lg px-3 py-2">
            <div class="text-center">
              <p class="text-xs text-gray-500">Stream</p>
              <p id="currentStream" class="font-semibold text-indigo-700 text-xs leading-tight"></p>
            </div>
            <div class="w-px h-6 bg-gray-300"></div>
            <div class="text-center">
              <p class="text-xs text-gray-500">Sem</p>
              <p id="currentSemester" class="font-semibold text-blue-700 text-xs leading-tight"></p>
            </div>
          </div>
          
          <!-- Right: Home Button -->
          <button onclick="window.location.reload()" class="w-8 h-8 rounded-full bg-gradient-to-r from-white to-blue-100 hover:from-blue-50 hover:to-blue-200 border border-blue-300 flex items-center justify-center transition-all duration-200 active:scale-95">
            <i class="fas fa-home text-blue-600 text-sm"></i>
          </button>
          
        </div>
      </header>
      
      <!-- ‚úÖ TAB BUTTONS: Better spacing -->
      <div class="px-4 mb-6">
        <div class="flex bg-white rounded-full shadow-md p-1 max-w-sm mx-auto">
          <button onclick="showTab('markTab')" id="markBtn"
            class="tablinks flex-1 px-4 py-2 text-white bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full transition-all duration-300 shadow-md text-sm font-medium">
            Mark Attendance
          </button>
          <button onclick="showTab('viewTab')" id="viewBtn"
            class="tablinks flex-1 px-4 py-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-100 rounded-full transition-all duration-300 text-sm font-medium">
            View Attendance
          </button>
        </div>
      </div>
    </div>
    
    
    <div id="markTab" class="tabcontent hidden p-3 sm:p-4">
      <!-- ‚úÖ COMPACT: Title with responsive spacing -->
      <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-edit text-indigo-500 mr-2"></i>
        Mark Attendance
      </h3>
    
      <!-- ‚úÖ RESPONSIVE: Date and subject layout -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4 px-1">
        <!-- Date Input -->
        <div class="relative">
          <label class="block text-xs text-gray-600 mb-1">Date</label>
          <input 
            type="date" 
            id="date" 
            class="w-full p-2 text-sm border border-indigo-300 rounded-lg text-[#0f172a] bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" 
            onchange="checkDateWarnings()"
          />
          <div id="dateWarning" class="hidden mt-1 text-xs text-amber-600 flex items-center">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="dateWarningText"></span>
          </div>
        </div>
        
        <!-- Subject Select -->
        <div>
          <label class="block text-xs text-gray-600 mb-1">Subject</label>
          <select id="subject-mark" class="w-full px-3 py-2 text-sm bg-white text-[#0f172a] border border-indigo-300 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-indigo-400 transition duration-200">
            <option value="">-- Select Subject --</option>
          </select>
        </div>
      </div>
    
      <!-- ‚úÖ RESPONSIVE: Students table -->
      <div class="overflow-x-auto rounded-lg shadow mb-4">
        <table class="table-auto w-full border border-indigo-200 bg-white text-[#0f172a] rounded-lg overflow-hidden">
          <thead class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white">
            <tr>
              <th class="p-2 sm:p-3 border border-indigo-200 text-center text-xs sm:text-sm">#</th>
              <th class="p-2 sm:p-3 border border-indigo-200 text-center text-xs sm:text-sm">ID</th>
              <th class="p-2 sm:p-3 border border-indigo-200 text-left text-xs sm:text-sm">Name</th>
              <th class="p-2 sm:p-3 border border-indigo-200 text-center text-xs sm:text-sm">Present</th>
            </tr>
          </thead>
          <tbody id="students-list" class="text-xs sm:text-sm"></tbody>
        </table>
      </div>
    
      <!-- ‚úÖ RESPONSIVE: Submit button -->
      <div class="flex justify-center mt-4">
        <button id="submitAttendance" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-6 py-2 sm:px-8 sm:py-3 rounded-full font-medium hover:shadow-lg transition flex items-center text-sm sm:text-base">
          <i class="fas fa-paper-plane mr-2"></i> 
          <span class="hidden sm:inline">Submit Attendance</span>
          <span class="sm:hidden">Submit</span>
        </button>
      </div>
    </div>
    
    <div id="viewTab" class="tabcontent hidden p-2 sm:p-4">
      <!-- Mobile-optimized header -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-gray-800 flex items-center">
          <i class="fas fa-table text-indigo-500 mr-2 text-sm"></i>
          Register
        </h3>
      </div>
    
      <!-- Compact subject selection -->
      <div class="space-y-2 mb-4">
        <label for="subject-view" class="block text-xs text-gray-600 font-medium">Select Subject</label>
        <select id="subject-view" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
          <option value="">-- Select Subject --</option>
        </select>
        <button id="loadRegisterBtn" class="w-full sm:w-auto px-4 py-2 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-lg text-sm font-medium hover:from-indigo-600 hover:to-blue-600 transition-all">
          <i class="fas fa-search mr-2"></i>Load Attendance Register
        </button>
      </div>
    
      <!-- Register display -->
      <div id="registerTable" class="hidden">
        <!-- Action buttons -->
        <div class="flex justify-end gap-2 mb-3">
          <button id="saveChangesBtn" onclick="saveAttendanceChanges()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 bg-yellow-500 text-white rounded-lg text-xs sm:text-sm font-medium hidden hover:bg-yellow-600 transition-all">
            <i class="fas fa-save text-sm mr-1"></i>
            <span class="hidden sm:inline">Save Changes</span>
            <span class="sm:hidden text-xs">Save</span>
          </button>
          <button id="exportExcelBtn" onclick="exportToExcel()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 bg-green-600 text-white rounded-lg text-xs sm:text-sm font-medium hidden hover:bg-green-700 transition-all">
            <i class="fas fa-file-excel text-sm mr-1"></i>
            <span class="hidden sm:inline">Export Excel</span>
            <span class="sm:hidden text-xs">Export</span>
          </button>
        </div>
        
      
        <!-- ‚úÖ FIXED: Table with sticky student column -->
        <div class="rounded-lg shadow border border-indigo-200 overflow-hidden bg-white">
          <div class="overflow-x-auto relative">
            <table class="min-w-full text-xs sm:text-sm border-collapse">
              <thead class="bg-indigo-600 text-white sticky top-0 z-30" id="view-thead">
                <!-- Headers will be populated by JavaScript -->
              </thead>
              <tbody class="bg-white text-gray-800 divide-y divide-gray-100" id="view-tbody">
                <!-- Rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
    
        <!-- Mobile scroll hint -->
        <div class="mt-2 text-xs text-gray-500 text-center flex items-center justify-center gap-2">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Student column stays fixed ‚Ä¢ Scroll horizontally to view all dates</span>
        </div>
        
        <!-- ‚úÖ Stats summary -->
        <div class="mt-3 p-2 bg-gray-50 rounded-lg text-xs text-gray-600 grid grid-cols-2 sm:grid-cols-4 gap-2" id="attendanceStats">
          <!-- Stats will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    
    

<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  // Add this to your existing DOMContentLoaded event listener in your main page
document.addEventListener("DOMContentLoaded", () => {
  // Check if we're coming from myclass.html with a selected class
  const selectedClassInfo = sessionStorage.getItem('selectedClass');
  if (selectedClassInfo) {
    try {
      const classInfo = JSON.parse(selectedClassInfo);
      console.log('üéØ Auto-selecting class from myclass.html:', classInfo);
      
      // Clear the session storage
      sessionStorage.removeItem('selectedClass');
      
      // Auto-navigate to the selected stream and semester
      setTimeout(() => {
        autoSelectStreamAndSemester(classInfo);
      }, 500);
    } catch (error) {
      console.error('‚ùå Error parsing selected class info:', error);
    }
  }

  // Your existing initialization code continues here...
  addMenuClickListener();
  // ... rest of your existing code
});

// Add this new function to your main page JavaScript
async function autoSelectStreamAndSemester(classInfo) {
  const { stream, semester, subject } = classInfo;
  
  try {
    console.log(`üöÄ Auto-selecting: ${stream} Semester ${semester} - ${subject}`);
    
    // Update global variables
    selectedStream = stream;
    selectedSem = semester;
    
    // Update UI display
    updateCurrentSelectionDisplay(stream, semester);
    
    // Hide home page and show tabs
    document.getElementById("homePage").classList.add("hidden");
    semesterSection.classList.add("hidden");
    tabs.classList.remove("hidden");
    showTab("markTab");
    
    // Load subjects and students
    await loadSubjectsAndStudents(stream, semester);
    
    // Auto-select the subject after a brief delay
    setTimeout(() => {
      // Find and select the subject in the dropdown
      const subjectOption = Array.from(subjectMark.options).find(
        option => option.value === subject
      );
      
      if (subjectOption) {
        subjectMark.value = subject;
        subjectView.value = subject; // Sync both dropdowns
        
        // Trigger the change event to filter students
        subjectMark.dispatchEvent(new Event('change'));
        
        console.log(`‚úÖ Auto-selected subject: ${subject}`);
        
        // Show success message
        showAutoSelectMessage(stream, semester, subject);
      } else {
        console.warn(`‚ö†Ô∏è Subject "${subject}" not found in dropdown`);
        alert(`‚ö†Ô∏è Subject "${subject}" not found. Please select manually.`);
      }
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error auto-selecting class:', error);
    alert('‚ùå Error loading class data. Please try selecting manually.');
  }
}

// Add this helper function for success message
function showAutoSelectMessage(stream, semester, subject) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm';
  messageDiv.innerHTML = `
    <div class="flex items-center">
      <i class="fas fa-check-circle mr-2"></i>
      <div>
        <div class="font-semibold">Class Auto-Selected!</div>
        <div class="text-sm">${stream} Sem ${semester} - ${subject}</div>
      </div>
    </div>
  `;
  
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    if (document.body.contains(messageDiv)) {
      document.body.removeChild(messageDiv);
    }
  }, 4000);
}

// ‚úÖ DOM Element References
// ‚úÖ Global DOM elements
// ‚úÖ Global DOM elements
const streamSection = document.getElementById("streamSection");
const semesterSection = document.getElementById("semesterSection");
const tabs = document.getElementById("tabs");
const markTab = document.getElementById("markTab");
const viewTab = document.getElementById("viewTab");
const subjectMark = document.getElementById("subject-mark");
const subjectView = document.getElementById("subject-view");
const studentsList = document.getElementById("students-list");
const submitBtn = document.getElementById("submitAttendance");
const viewThead = document.getElementById("view-thead");
const viewTbody = document.getElementById("view-tbody");
const markBtn = document.getElementById("markBtn");
const viewBtn = document.getElementById("viewBtn");

// ‚úÖ SIMPLIFIED: Global variables (no section needed)
let selectedStream = "";
let selectedSem = "";

// ‚úÖ Flags to prevent duplicate event listeners
let subjectChangeListenerAdded = false;
let menuClickListenerAdded = false;

// ‚úÖ SIMPLIFIED: Function to update current selection display (no section)
function updateCurrentSelectionDisplay(stream, semester) {
  const currentStreamElement = document.getElementById('currentStream');
  const currentSemesterElement = document.getElementById('currentSemester');
  
  if (currentStreamElement) {
    currentStreamElement.textContent = stream;
    console.log(`‚úÖ Updated stream display: ${stream}`);
  }
  
  if (currentSemesterElement) {
    currentSemesterElement.textContent = `Semester ${semester}`;
    console.log(`‚úÖ Updated semester display: Semester ${semester}`);
  }
}

// ‚úÖ Function to clear selection display
function clearCurrentSelectionDisplay() {
  const currentStreamElement = document.getElementById('currentStream');
  const currentSemesterElement = document.getElementById('currentSemester');
  
  if (currentStreamElement) currentStreamElement.textContent = '';
  if (currentSemesterElement) currentSemesterElement.textContent = '';
  
  console.log('üßπ Cleared selection display');
}

// ‚úÖ Home navigation function
function goToStreamsHome() {
  console.log("üè† Starting home navigation");
  
  // Hide all sections
  const hideElements = ['markTab', 'viewTab', 'tabs', 'semesterSection'];
  hideElements.forEach(id => {
    const elem = document.getElementById(id);
    if (elem) {
      elem.style.display = 'none';
      elem.classList.add('hidden');
    }
  });
  
  // Show home page
  const homePage = document.getElementById('homePage');
  if (homePage) {
    homePage.style.display = 'block';
    homePage.classList.remove('hidden');
  }
  
  // Reset variables and display
  selectedStream = '';
  selectedSem = '';
  clearCurrentSelectionDisplay();
  
  // Clear form data
  ['subject-mark', 'subject-view', 'students-list'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      if (element.tagName === 'SELECT') {
        element.value = '';
      } else {
        element.innerHTML = '';
      }
    }
  });
  
  console.log("‚úÖ Home navigation completed");
}

// ‚úÖ SIMPLIFIED: Select stream function (no section logic)
function selectStream(stream, sem) {
  selectedStream = stream;
  selectedSem = sem;
  
  updateCurrentSelectionDisplay(stream, sem);
  
  semesterSection.classList.add("hidden");
  tabs.classList.remove("hidden");
  showTab("markTab");
  loadSubjectsAndStudents(stream, sem);
  
  console.log(`‚úÖ Selected: ${stream} - Semester ${sem}`);
}

// ‚úÖ Add menu click listener
function addMenuClickListener() {
  if (!menuClickListenerAdded) {
    document.addEventListener("click", (event) => {
      const menu = document.getElementById("mobileMenu");
      const toggle = document.querySelector(".menu-icon");
      if (menu && toggle && !menu.contains(event.target) && !toggle.contains(event.target)) {
        menu.classList.add("hidden");
        menu.classList.add("-translate-x-full");
      }
    });
    menuClickListenerAdded = true;
  }
}

// ‚úÖ Show tab function
function showTab(tabId) {
  markTab.classList.add("hidden");
  viewTab.classList.add("hidden");
  document.getElementById(tabId).classList.remove("hidden");
  
  document.getElementById('markBtn').className =
    "tablinks px-4 py-2 text-gray-600 hover:text-indigo-500 hover:bg-indigo-100 rounded-full transition-all duration-300";
  document.getElementById('viewBtn').className =
    "tablinks px-4 py-2 text-gray-600 hover:text-indigo-500 hover:bg-indigo-100 rounded-full transition-all duration-300";

  if (tabId === 'markTab') {
    document.getElementById('markBtn').className =
      "tablinks px-8 py-2 text-white bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full transition-all duration-300 shadow-md";
  } else {
    document.getElementById('viewBtn').className =
      "tablinks px-8 py-2 text-white bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full transition-all duration-300 shadow-md";
  }
}

// ‚úÖ FIXED: Load subjects and students function (no section mapping)
async function loadSubjectsAndStudents(stream, sem) {
  try {
    console.log(`üîÑ Loading data for: ${stream} Sem ${sem}`);
    
    // ‚úÖ FIXED: Use stream directly - NO MAPPING
    const baseUrl = '/api';
    const subjectsUrl = `${baseUrl}/subjects/${stream}/sem${sem}`;
    const studentsUrl = `${baseUrl}/students/${stream}/sem${sem}`;
    
    console.log(`üì° Subjects URL: ${subjectsUrl}`);
    console.log(`üì° Students URL: ${studentsUrl}`);
    
    // Load subjects and students in parallel
    const [subjectsRes, studentsRes] = await Promise.all([
      fetch(subjectsUrl),
      fetch(studentsUrl)
    ]);
    
    console.log(`üìä Subjects response status: ${subjectsRes.status}`);
    console.log(`üìä Students response status: ${studentsRes.status}`);
    
    if (!subjectsRes.ok) {
      console.error('‚ùå Subjects request failed:', subjectsRes.status, subjectsRes.statusText);
      throw new Error(`Failed to fetch subjects: ${subjectsRes.status}`);
    }
    
    if (!studentsRes.ok) {
      console.error('‚ùå Students request failed:', studentsRes.status, studentsRes.statusText);
      throw new Error(`Failed to fetch students: ${studentsRes.status}`);
    }
    
    const subjects = await subjectsRes.json();
    const students = await studentsRes.json();
    
    console.log('üìö Subjects data:', subjects);
    console.log('üë• Students data:', students);
    
    // Populate subjects dropdown
    populateSubjectDropdowns(subjects);
    
    // Populate students list
    populateStudentsList(students);
    
    const subjectCount = subjects.subjects ? subjects.subjects.length : (Array.isArray(subjects) ? subjects.length : subjects.count || 0);
    const studentCount = students.students ? students.students.length : (Array.isArray(students) ? students.length : students.count || 0);
    
    console.log(`‚úÖ Data loaded successfully: ${subjectCount} subjects, ${studentCount} students`);
    
    if (studentCount === 0) {
      console.warn('‚ö†Ô∏è No students found for this selection');
      alert(`No students found for ${stream} Semester ${sem}. Please check if students exist in the database.`);
    }
    
  } catch (error) {
    console.error('‚ùå Error loading data:', error);
    alert(`ERROR: Failed to load class data. ${error.message}`);
  }
}

// ‚úÖ Helper function to populate subject dropdowns
function populateSubjectDropdowns(subjects) {
  const subjectData = subjects.subjects || subjects;
  
  // Clear existing options
  if (subjectMark) subjectMark.innerHTML = '<option value="">-- Select Subject --</option>';
  if (subjectView) subjectView.innerHTML = '<option value="">-- Select Subject --</option>';
  
  if (Array.isArray(subjectData) && subjectData.length > 0) {
    subjectData.forEach(subject => {
      const subjectName = subject.subjectName || subject.name || subject;
      const option = `<option value="${subjectName}">${subjectName}</option>`;
      if (subjectMark) subjectMark.innerHTML += option;
      if (subjectView) subjectView.innerHTML += option;
    });
    console.log(`‚úÖ Populated ${subjectData.length} subjects`);
  } else {
    console.warn('‚ö†Ô∏è No subjects data found');
  }
}

// ‚úÖ Helper function to populate students list
function populateStudentsList(students) {
  if (!studentsList) {
    console.error('‚ùå Students list element not found');
    return;
  }
  
  const studentData = students.students || students;
  studentsList.innerHTML = '';
  
  if (Array.isArray(studentData) && studentData.length > 0) {
    studentData.forEach(student => {
      const studentItem = document.createElement('div');
      studentItem.className = 'flex items-center p-3 hover:bg-gray-50 rounded-lg transition-colors duration-200';
      
      const studentID = student.studentID || student.id || 'N/A';
      const studentName = student.name || 'Unknown';
      
      studentItem.innerHTML = `
        <input type="checkbox" value="${studentID}" class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500 mr-3">
        <div class="flex-1">
          <p class="font-medium text-gray-900">${studentName}</p>
          <p class="text-sm text-gray-500">${studentID}</p>
        </div>
      `;
      
      studentsList.appendChild(studentItem);
    });
    console.log(`‚úÖ Populated ${studentData.length} students`);
  } else {
    studentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No students found for this semester.</p>';
    console.warn('‚ö†Ô∏è No students data found');
  }
}

// ‚úÖ Navigation functions
function backToSemesters() {
  document.getElementById("markTab").classList.add("hidden");
  document.getElementById("viewTab").classList.add("hidden");
  document.getElementById("tabs").classList.add("hidden");
  document.getElementById("semesterSection").classList.remove("hidden");
}

// ‚úÖ Menu functions
window.toggleMenu = () => {
  const menu = document.getElementById("mobileMenu");
  if (menu) {
    menu.classList.toggle("hidden");
    menu.classList.toggle("-translate-x-full");
  }
};

// ‚úÖ MAIN DOM CONTENT LOADED EVENT
document.addEventListener("DOMContentLoaded", () => {
  addMenuClickListener();

  // ‚úÖ UPDATED: Streams with separate BCom Section B
  const streams = [
    {
      name: "BCA",
      icon: '<i class="fas fa-laptop-code text-indigo-500"></i>',
      color: "bg-indigo-100",
      textColor: "text-indigo-600"
    },
    {
      name: "BBA",
      icon: '<i class="fas fa-chart-line text-green-500"></i>',
      color: "bg-green-100",
      textColor: "text-green-600"
    },
    {
      name: "BCom",
      displayName: "BCom",
      icon: '<i class="fas fa-money-bill-wave text-yellow-500"></i>',
      color: "bg-yellow-100",
      textColor: "text-yellow-600"
    },
    {
      name: "BCom Section B",
      displayName: "BCom B",
      icon: '<i class="fas fa-money-bill-wave text-orange-500"></i>',
      color: "bg-purple-100",
      textColor: "text-purple-600",
      limitedSemesters: [5, 6] // Only show semesters 5 and 6
    },
    {
      name: "BCom-BDA",
      displayName: "BDA",
      icon: '<i class="fas fa-chart-bar text-purple-500"></i>',
      color: "bg-purple-100",
      textColor: "text-purple-600"
    },
    {
      name: "BCom A and F",
      icon: '<i class="fas fa-calculator text-blue-500"></i>',
      color: "bg-blue-100",
      textColor: "text-blue-600"
    }
  ];

  // Generate stream boxes
  streams.forEach((stream) => {
    const streamBox = document.createElement("div");
    streamBox.className = `bg-white rounded-xl p-5 shadow-sm border border-gray-200 hover:border-indigo-300 transition card-hover cursor-pointer`;

    const displayName = stream.displayName || stream.name;

    streamBox.innerHTML = `
      <div class="flex items-center">
        <div class="w-12 h-12 ${stream.color} rounded-lg flex items-center justify-center mr-4">
          ${stream.icon}
        </div>
        <div>
          <h3 class="font-semibold text-gray-800">${displayName}</h3>
          <p class="text-sm text-gray-500">${stream.limitedSemesters ? 'Advanced Semesters' : 'Bachelor\'s Degree'}</p>
        </div>
      </div>
      <div class="mt-4 flex justify-end">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${stream.color} ${stream.textColor}">
          Select <i class="fas fa-chevron-right ml-1 text-xs"></i>
        </span>
      </div>
    `;

    // Stream click handler
    streamBox.addEventListener("click", () => {
      console.log("üîç Stream clicked:", stream.name);
      
      selectedStream = stream.name;
      
      document.getElementById("homePage").classList.add("hidden");
      semesterSection.classList.remove("hidden");
      semesterSection.innerHTML = "";

      // Create header
      const header = document.createElement("header");
      header.className = "w-full bg-white shadow-md border-b border-gray-200 px-4 py-3 mb-0";
      header.innerHTML = `
        <div class="flex items-center justify-between max-w-7xl mx-auto">
          <button onclick="window.location.reload()"  class="w-8 h-8 rounded-full bg-gradient-to-r from-white to-blue-100 hover:from-blue-50 hover:to-blue-200 border border-blue-300 flex items-center justify-center transition-all duration-200 active:scale-95">
            <i class="fa-solid fa-angle-left text-blue-600 text-xs"></i>
          </button>
          <div class="flex items-center space-x-3">
            <div class="text-center">
              <p class="text-xs text-gray-500">Selected Stream</p>
              <p class="text-sm font-bold text-gray-800">${displayName}</p>
            </div>
          </div>
          <div class="w-8 h-8"></div>
        </div>
      `;

      const container = document.createElement("div");
      container.className = "min-h-screen bg-gray-50 px-4 py-6";

      semesterSection.appendChild(header);
      semesterSection.appendChild(container);

      const semesterGrid = document.createElement("div");
      semesterGrid.className = "max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 px-2 sm:px-4";

      const semesterColors = [
        { bg: 'bg-red-500', light: 'bg-red-50', border: 'border-red-200', text: 'text-red-600' },
        { bg: 'bg-blue-500', light: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-600' },
        { bg: 'bg-green-500', light: 'bg-green-50', border: 'border-green-200', text: 'text-green-600' },
        { bg: 'bg-purple-500', light: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-600' },
        { bg: 'bg-indigo-500', light: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-600' },
        { bg: 'bg-pink-500', light: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-600' }
      ];

      // ‚úÖ Generate semester cards based on stream type
      let semestersToShow;
      if (stream.limitedSemesters) {
        // BCom Section B shows only semesters 5 and 6
        semestersToShow = stream.limitedSemesters;
      } else {
        // All other streams show semesters 1-6
        semestersToShow = [1, 2, 3, 4, 5, 6];
      }

      semestersToShow.forEach((sem, index) => {
        const color = semesterColors[index];
        const semBox = document.createElement("div");
        
        semBox.className = `group bg-white rounded-xl p-4 sm:p-6 shadow-md border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer ${color.light} hover:${color.border}`;

        semBox.innerHTML = `
          <div class="flex items-center space-x-3 sm:space-x-4">
            <div class="flex-shrink-0">
              <div class="w-14 h-14 sm:w-16 sm:h-16 ${color.bg} rounded-xl flex items-center justify-center shadow-md group-hover:scale-110 transition-transform duration-300">
                <span class="text-xl sm:text-2xl font-bold text-white">${sem}</span>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-1">
                Semester ${sem}
              </h3>
              <p class="text-xs sm:text-sm text-gray-600 mb-2">
                ${stream.name === 'BCom Section B' ? 'Section B Stream' : (stream.name === 'BCom' ? 'Section A Stream' : stream.name + ' Program')}
              </p>
              <div class="flex items-center justify-end">
                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <i class="fas fa-arrow-right ${color.text} text-sm"></i>
                </div>
              </div>
            </div>
          </div>
        `;

        semBox.onclick = () => {
          console.log(`üìö Semester clicked: ${sem}`);
          selectStream(stream.name, sem);
        };

        semesterGrid.appendChild(semBox);
      });

      container.appendChild(semesterGrid);

      const footer = document.createElement("div");
      footer.className = "mt-8 text-center";
      footer.innerHTML = `
        <p class="text-sm text-gray-500">
          <i class="fas fa-graduation-cap mr-2"></i>
          Select a semester to manage attendance
        </p>
      `;

      container.appendChild(footer);
      
      console.log("‚úÖ Semester section created and shown");
    });

    streamSection.appendChild(streamBox);
  });

  // Set today's date as default
  const today = new Date().toISOString().split("T")[0];
  const dateInput = document.getElementById("date");
  if (dateInput) {
    dateInput.value = today;
    dateInput.max = today;
    
    dateInput.addEventListener('input', function() {
      const selectedDate = this.value;
      if (selectedDate > today) {
        alert('WARNING: Future dates are not allowed for attendance marking!');
        this.value = today;
      }
    });
  }
});

// ‚úÖ Make functions globally available
window.goToStreamsHome = goToStreamsHome;
window.updateCurrentSelectionDisplay = updateCurrentSelectionDisplay;
window.selectStream = selectStream;
window.showTab = showTab;
window.backToSemesters = backToSemesters;
window.loadSubjectsAndStudents = loadSubjectsAndStudents;



async function loadSubjectsAndStudents(stream, sem) {
  try {
    console.log(`üîÑ Loading data for: ${stream} Sem ${sem}`);
    
    // ‚úÖ Store globally for later use
    window.selectedStream = stream;
    window.selectedSem = sem;
    
    // ‚úÖ Fetch subjects with proper error handling
    const subjectsRes = await fetch(`/api/subjects/${stream}/sem${sem}`);
    
    if (!subjectsRes.ok) {
      throw new Error(`Failed to fetch subjects: ${subjectsRes.status} ${subjectsRes.statusText}`);
    }
    
    const subjectsData = await subjectsRes.json();
    console.log('üìö Subjects response:', subjectsData);
    
    // ‚úÖ Handle both response formats
    const subjects = subjectsData.subjects || subjectsData || [];
    
    // ‚úÖ FIXED: Populate subject dropdowns with language data attributes
    populateSubjectDropdowns(subjects);
    
    // ‚úÖ Load all students initially
    await loadAllStudents(stream, sem);
    
    // ‚úÖ FIXED: Setup subject filtering with language support
    setupSubjectFilteringListener(stream, sem);
    
    console.log(`‚úÖ Data loaded successfully: ${subjects.length} subjects`);
    
  } catch (error) {
    console.error("‚ùå Error loading data:", error);
    handleLoadingError(error, stream, sem);
  }
}

// ‚úÖ FIXED: Enhanced subject dropdown population with language attributes
function populateSubjectDropdowns(subjects) {
  // Clear dropdowns
  subjectMark.innerHTML = '<option value="">-- Select Subject --</option>';
  subjectView.innerHTML = '<option value="">-- Select Subject --</option>';
  
  if (!Array.isArray(subjects) || subjects.length === 0) {
    console.warn('‚ö†Ô∏è No subjects found');
    return;
  }
  
  subjects.forEach(sub => {
    const subjectName = sub.subjectName || sub.name || sub;
    
    const markOption = new Option(subjectName, subjectName);
    const viewOption = new Option(subjectName, subjectName);
    
    // ‚úÖ CRITICAL: Add data attributes for language subjects
    if (sub.isLanguageSubject || (sub.subjectType === 'LANGUAGE')) {
      markOption.setAttribute('data-type', 'LANGUAGE');
      markOption.setAttribute('data-language', sub.languageType);
      viewOption.setAttribute('data-type', 'LANGUAGE');  
      viewOption.setAttribute('data-language', sub.languageType);
      
      console.log(`üî§ Language subject: ${subjectName} (${sub.languageType})`);
    } else {
      markOption.setAttribute('data-type', 'CORE');
      viewOption.setAttribute('data-type', 'CORE');
    }
    
    subjectMark.appendChild(markOption);
    subjectView.appendChild(viewOption);
  });
  
  console.log(`‚úÖ Populated ${subjects.length} subjects with language attributes`);
}

// ‚úÖ Load all students initially
async function loadAllStudents(stream, sem) {
  try {
    const studentsRes = await fetch(`/api/students/${stream}/sem${sem}`);
    
    if (!studentsRes.ok) {
      throw new Error(`Failed to fetch students: ${studentsRes.status} ${studentsRes.statusText}`);
    }
    
    const studentsData = await studentsRes.json();
    console.log('üë• Students response:', studentsData);
    
    const students = studentsData.students || studentsData || [];
    displayStudents(students);
    
    console.log(`‚úÖ Loaded ${students.length} students initially`);
    
  } catch (error) {
    console.error("‚ùå Error loading students:", error);
    throw error;
  }
}

// ‚úÖ FIXED: Subject filtering listener with language support
function setupSubjectFilteringListener(stream, sem) {
  if (window.subjectChangeListenerAdded) return;
  
  subjectMark.addEventListener("change", async function(event) {
    const selectedSubject = event.target.value;
    const selectedOption = event.target.selectedOptions[0];
    
    if (!selectedSubject) {
      console.log("üîÑ No subject selected, showing all students");
      await loadAllStudents(stream, sem);
      return;
    }
    
    const subjectType = selectedOption.getAttribute('data-type');
    const languageType = selectedOption.getAttribute('data-language');
    
    console.log(`üéØ Subject selected: ${selectedSubject}`);
    console.log(`üìã Subject type: ${subjectType}`);
    if (languageType) console.log(`üî§ Language type: ${languageType}`);
    
    try {
      // Show loading state
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" class="p-6 text-center">
            <div class="flex items-center justify-center">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mr-3"></div>
              Loading ${languageType ? languageType + ' ' : ''}students...
            </div>
          </td>
        </tr>
      `;
      
      // ‚úÖ CRITICAL FIX: Use attendance-students API for language filtering
      const response = await fetch(`/api/attendance-students/${stream}/sem${sem}/${encodeURIComponent(selectedSubject)}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.message || 'Failed to get students');
      }
      
      const students = data.students || [];
      
      // ‚úÖ Display filtered students
      displayStudents(students);
      
      // ‚úÖ Show success message for language filtering
      if (subjectType === 'LANGUAGE' && languageType) {
        console.log(`‚úÖ Filtered to ${students.length} ${languageType} students`);
        
        if (students.length === 0) {
          studentsList.innerHTML = `
            <tr>
              <td colspan="4" class="p-6 text-center text-yellow-500">
                <i class="fas fa-info-circle text-3xl mb-2"></i>
                <p class="font-semibold">No ${languageType} Students Found</p>
                <p class="text-sm">No students have chosen ${languageType} as their language subject.</p>
              </td>
            </tr>
          `;
        }
      } else {
        console.log(`‚úÖ Showing ${students.length} total students`);
      }
      
    } catch (error) {
      console.error('‚ùå Error filtering students:', error);
      
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" class="p-6 text-center text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p class="font-semibold">Error Loading Students</p>
            <p class="text-sm">${error.message}</p>
            <button 
              onclick="loadAllStudents('${stream}', '${sem}')"
              class="mt-2 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
            >
              Show All Students
            </button>
          </td>
        </tr>
      `;
    }
  });
  
  // ‚úÖ Sync view dropdown with mark dropdown
  subjectView.addEventListener("change", async function(event) {
    const selectedSubject = event.target.value;
    
    if (selectedSubject) {
      subjectMark.value = selectedSubject;
      subjectMark.dispatchEvent(new Event('change'));
    } else {
      await loadAllStudents(stream, sem);
    }
  });
  
  window.subjectChangeListenerAdded = true;
  console.log("‚úÖ Subject filtering setup with language support");
}

// ‚úÖ Display students function
function displayStudents(students) {
  studentsList.innerHTML = '';
  
  if (!Array.isArray(students) || students.length === 0) {
    studentsList.innerHTML = `
      <tr>
        <td colspan="4" class="p-6 text-center text-gray-500">
          <i class="fas fa-users-slash text-4xl mb-3 text-gray-300"></i>
          <p class="font-semibold text-lg">No students found</p>
          <p class="text-sm">Please verify the data in your database.</p>
        </td>
      </tr>
    `;
    return;
  }
  
  students.forEach((student, index) => {
    const serialNumber = index + 1;
    const studentID = student.studentID || student.id || 'N/A';
    const studentName = student.name || 'Unknown';
    
    const tableRow = document.createElement('tr');
    tableRow.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-100 transition duration-200`;
    
    tableRow.innerHTML = `
      <td class="p-3 border border-gray-300 text-[#0f172a] font-medium text-center">
        ${serialNumber}
      </td>
      <td class="p-3 border border-gray-300 text-[#0f172a] font-medium">
        ${studentID}
      </td>
      <td class="p-3 border border-gray-300 text-[#0f172a]">
        ${studentName}
      </td>
      <td class="p-3 border border-gray-300 text-center">
        <input 
          type="checkbox" 
          value="${studentID}" 
          checked 
          class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-400 transition duration-200"
        />
      </td>
    `;
    
    studentsList.appendChild(tableRow);
  });
  
  console.log(`‚úÖ Displayed ${students.length} students`);
}

// ‚úÖ Error handling function
function handleLoadingError(error, stream, sem) {
  alert(`Error loading data for ${stream} Semester ${sem}: ${error.message}`);
  
  if (subjectMark) subjectMark.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
  if (subjectView) subjectView.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
  if (studentsList) {
    studentsList.innerHTML = `
      <tr>
        <td colspan="4" class="p-6 text-center text-red-500">
          <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
          <p class="font-semibold">Error loading data</p>
          <p class="text-sm">${error.message}</p>
          <button 
            onclick="loadSubjectsAndStudents('${stream}', '${sem}')" 
            class="mt-3 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
          >
            <i class="fas fa-redo mr-2"></i>
            Retry
          </button>
        </td>
      </tr>
    `;
  }
}

// ‚úÖ Enhanced helper functions
async function checkAttendanceExists(stream, sem, subject, date) {
  try {
    const response = await fetch(`/api/check-attendance/${stream}/sem${sem}/${encodeURIComponent(subject)}/${date}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const result = await response.json();
    return result.exists || false;
  } catch (error) {
    console.error("Error checking attendance:", error);
    return false;
  }
}

function isSunday(dateString) {
  const date = new Date(dateString);
  return date.getDay() === 0;
}

function isSaturday(dateString) {
  const date = new Date(dateString);
  return date.getDay() === 6;
}

function isWeekend(dateString) {
  return isSunday(dateString) || isSaturday(dateString);
}

// ‚úÖ FIXED: Enhanced Submit button with proper element selectors
if (submitBtn) {
  submitBtn.addEventListener("click", async () => {
    const subject = subjectMark.value;
    const dateInput = document.getElementById("date");
    const date = dateInput ? dateInput.value : '';

    // Basic validation
    if (!subject || !date) {
      showAlert("Missing Information", "Please fill in both Date and Subject.", "error");
      return;
    }

    // Date validation
    const today = new Date().toISOString().split("T")[0];
    if (date > today) {
      showAlert("Invalid Date", "Future dates are not allowed for attendance marking.", "error");
      return;
    }

    try {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Checking...';

      // Check if attendance exists
      const attendanceExists = await checkAttendanceExists(window.selectedStream, window.selectedSem, subject, date);
      
      if (attendanceExists) {
        const overwriteConfirm = await showConfirmDialog(
          "Attendance Already Exists",
          `Subject: ${subject}\nDate: ${date}\nClass: ${window.selectedStream} Semester ${window.selectedSem}\n\nAttendance has already been recorded.\nDo you want to OVERWRITE it?`,
          "warning"
        );
        
        if (!overwriteConfirm) {
          showAlert("Cancelled", "Attendance submission cancelled.", "info");
          return;
        }
      }

      // Weekend check
      if (isWeekend(date)) {
        const dayName = isSunday(date) ? "SUNDAY" : "SATURDAY";
        const weekendConfirm = await showConfirmDialog(
          "Weekend Alert",
          `Selected date (${date}) is a ${dayName}.\n\nAre you sure about weekend attendance?`,
          "warning"
        );
        
        if (!weekendConfirm) {
          showAlert("Cancelled", "Please select a different date.", "info");
          return;
        }
      }

      // Get student counts
      const checkboxes = studentsList.querySelectorAll("input[type='checkbox']");
      const checkedBoxes = studentsList.querySelectorAll("input:checked");
      const totalStudents = checkboxes.length;
      const presentStudents = checkedBoxes.length;
      const absentStudents = totalStudents - presentStudents;

      // Final confirmation
      const confirmMessage = `Subject: ${subject}\nDate: ${date}\nClass: ${window.selectedStream} Semester ${window.selectedSem}\n\nTotal Students: ${totalStudents}\nPresent: ${presentStudents}\nAbsent: ${absentStudents}\n\nWhatsApp notifications will be sent to parents.\n\nProceed?`;

      const finalConfirm = await showConfirmDialog("Confirm Submission", confirmMessage, "info");

      if (!finalConfirm) {
        showAlert("Cancelled", "Attendance submission cancelled.", "info");
        return;
      }

      // Prepare data
      const studentsPresent = Array.from(checkedBoxes).map(cb => cb.value);

      // Submit attendance
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
      
      const res = await fetch(
        `/api/attendance/${window.selectedStream}/sem${window.selectedSem}/${encodeURIComponent(subject)}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ date, subject, studentsPresent })
        }
      );

      const result = await res.json();

      if (res.ok) {
        const { summary } = result;
        const successMessage = `‚úÖ Attendance Submitted Successfully!\n\nSubject: ${subject}\nDate: ${date}\n\nTotal Students: ${summary?.totalStudents || totalStudents}\nPresent: ${summary?.presentStudents || presentStudents}\nAbsent: ${summary?.absentStudents || absentStudents}`;
        
        showAlert("Success", successMessage, "success");
        
        // Reset form
        subjectMark.value = "";
        if (dateInput) dateInput.value = new Date().toISOString().split("T")[0];
        
        // Reload all students
        await loadAllStudents(window.selectedStream, window.selectedSem);
        
      } else {
        showAlert("Submission Failed", result.message || "Unknown error occurred.", "error");
      }

    } catch (err) {
      console.error("Submission error:", err);
      showAlert("Network Error", "Failed to submit attendance. Please check your connection.", "error");
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="check-icon"></span> Submit Attendance';
    }
  });
}

// ‚úÖ Alert functions
function showAlert(title, message, type = "info") {
  const prefixes = {
    success: "‚úÖ SUCCESS: ",
    error: "‚ùå ERROR: ",
    warning: "‚ö†Ô∏è WARNING: ",
    info: "‚ÑπÔ∏è INFO: "
  };
  
  alert(`${prefixes[type]}${title}\n\n${message}`);
}

async function showConfirmDialog(title, message, type = "info") {
  const prefixes = {
    success: "‚úÖ CONFIRM: ",
    error: "‚ùå CONFIRM: ",
    warning: "‚ö†Ô∏è CONFIRM: ",
    info: "‚ùì CONFIRM: "
  };
  
  return confirm(`${prefixes[type]}${title}\n\n${message}`);
}

// ‚úÖ Make functions globally available
window.goToStreamsHome = goToStreamsHome;
window.updateCurrentSelectionDisplay = updateCurrentSelectionDisplay;
window.selectStream = selectStream;
window.showTab = showTab;
window.backToSemesters = backToSemesters;
window.loadSubjectsAndStudents = loadSubjectsAndStudents;
window.loadAllStudents = loadAllStudents;
window.checkAttendanceExists = checkAttendanceExists;
window.showAlert = showAlert;
window.showConfirmDialog = showConfirmDialog;

console.log("‚úÖ Complete attendance system loaded with language subject filtering");
// ‚úÖ FIXED: Save Attendance Changes - Single Message Only
async function saveAttendanceChanges() {
  const subject = subjectView.value;
  const saveBtn = document.getElementById("saveChangesBtn");

  if (!subject) {
    showAlert("Missing Subject", "Please select a subject.", "error");
    return;
  }

  try {
    // Show loading state
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

    const confirmUpdate = await showConfirmDialog(
      "Confirm Update",
      `Subject: ${subject}\n\nThis will overwrite the existing attendance data.\nAre you sure you want to continue?`,
      "warning"
    );

    if (!confirmUpdate) {
      showAlert("Cancelled", "Update cancelled.", "info");
      return;
    }

    const rows = document.querySelectorAll("#view-tbody tr");
    
    // Get actual date values from data-date attributes
    const dateHeaders = Array.from(document.querySelectorAll("#view-thead th[data-date]"))
      .map(th => th.dataset.date)
      .filter(date => date && date !== 'undefined' && date !== 'null');

    console.log(`üìÖ Found ${dateHeaders.length} date headers:`, dateHeaders);

    if (dateHeaders.length === 0) {
      showAlert("No Dates", "No valid date columns found. Please reload the register.", "error");
      return;
    }

    // Initialize attendance map with actual dates
    const attendanceMap = {};
    dateHeaders.forEach(date => (attendanceMap[date] = []));

    // Process each row with proper checkbox mapping
    rows.forEach((row, rowIndex) => {
      const studentID = row.dataset.studentId;
      
      if (!studentID) {
        console.warn(`‚ö†Ô∏è Row ${rowIndex} missing studentId`);
        return;
      }

      // Get checkboxes that have data-date attributes
      const checkboxes = row.querySelectorAll("input[type='checkbox'][data-date]");
      
      checkboxes.forEach(cb => {
        const cbDate = cb.dataset.date;
        
        if (cb.checked && cbDate && attendanceMap.hasOwnProperty(cbDate)) {
          attendanceMap[cbDate].push(studentID);
        }
      });
    });

    console.log(`üìä Attendance data to save:`, attendanceMap);

    // Validate attendance data
    const invalidDates = Object.keys(attendanceMap).filter(dateStr => {
      const date = new Date(dateStr);
      return isNaN(date.getTime()) || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr);
    });

    if (invalidDates.length > 0) {
      showAlert("Invalid Dates", `Found invalid date formats: ${invalidDates.join(', ')}`, "error");
      return;
    }

    // Send to server
    const res = await fetch(`/api/update-attendance/${selectedStream}/sem${selectedSem}/${encodeURIComponent(subject)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ attendanceMap })
    });

    let result;
    try {
      result = await res.json();
    } catch (parseError) {
      console.error("‚ùå JSON Parse Error:", parseError);
      throw new Error("Invalid response from server");
    }

    console.log(`üìä Server response:`, result);

    if (res.ok && result.success) {
      // ‚úÖ FIXED: Single success message with reload info
      const totalDates = Object.keys(attendanceMap).length;
      const totalEntries = Object.values(attendanceMap).reduce((sum, arr) => sum + arr.length, 0);
      
      showAlert("Success", `‚úÖ Attendance updated successfully!\n\nUpdated: ${totalDates} dates\nTotal entries: ${totalEntries}\n\nRegister will refresh automatically.`, "success");
      
      // Hide save button and reset its state
      saveBtn.classList.add("hidden");
      saveBtn.classList.remove("animate-pulse", "bg-yellow-500", "hover:bg-yellow-600");
      saveBtn.classList.add("bg-yellow-500", "hover:bg-yellow-600");
      
      // ‚úÖ CRITICAL FIX: Silent reload without showing another success message
      console.log("üîÑ Silently refreshing register...");
      await silentReloadRegister(subject);
      console.log("‚úÖ Register refreshed silently");
      
    } else {
      const errorMsg = result.message || result.error || "Unknown error occurred.";
      showAlert("Update Failed", errorMsg, "error");
    }

  } catch (err) {
    console.error("‚ùå Update error:", err);
    showAlert("Network Error", `Failed to update attendance: ${err.message}`, "error");
  } finally {
    // Reset button state
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Save Changes';
  }
}

// ‚úÖ NEW: Silent reload function without success message
async function silentReloadRegister(subject) {
  try {
    console.log(`üîÑ Silent reload for: ${subject}`);

    const res = await fetch(`/api/attendance-register/${selectedStream}/sem${selectedSem}/${encodeURIComponent(subject)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const data = await res.json();
    console.log('üìä Silent reload response:', data);
    
    // ‚úÖ Handle both old and new response formats
    let students, attendanceMap, subjectInfo;
    
    if (data.success && data.data) {
      // New format
      ({ students, attendanceMap, subjectInfo } = data.data);
    } else if (data.students && data.attendanceMap) {
      // Old format
      ({ students, attendanceMap } = data);
      subjectInfo = data.subjectInfo;
    } else {
      throw new Error(data.message || 'Invalid response format');
    }

    const dates = Object.keys(attendanceMap).sort();

    console.log(`‚úÖ Silent reload: ${students.length} students, ${dates.length} dates`);

    if (students.length === 0) {
      console.warn('‚ö†Ô∏è No students found in silent reload');
      return;
    }

    // ‚úÖ Re-render table silently
    await renderAttendanceTableSilently(students, dates, attendanceMap);

  } catch (error) {
    console.error("‚ùå Silent reload failed:", error);
    // Don't show error to user, just log it
  }
}

// ‚úÖ NEW: Silent table rendering without messages
async function renderAttendanceTableSilently(students, dates, attendanceMap) {
  if (!viewThead || !viewTbody) {
    console.error('‚ùå Table elements not found');
    return;
  }

  // Create table header
  viewThead.innerHTML = `
    <tr class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white">
      <th class="p-3 text-center font-bold text-sm">#</th>
      <th class="p-3 text-left font-bold text-sm">Student ID</th>
      <th class="p-3 text-left font-bold text-sm">Name</th>
      ${dates.map(d => {
        const dateObj = new Date(d);
        const displayDate = dateObj.toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'});
        const title = dateObj.toLocaleDateString('en-IN', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
        
        return `<th class="p-2 text-center font-semibold text-xs min-w-12" data-date="${d}" title="${title}">${displayDate}</th>`;
      }).join('')}
      
      <th class="p-3 text-center font-bold bg-gray-700 text-xs">Total</th>
      <th class="p-3 text-center font-bold bg-blue-700 text-xs">Present</th>
      <th class="p-3 text-center font-bold bg-green-700 text-xs">%</th>
    </tr>
  `;

  // ‚úÖ CRITICAL FIX: Create table body with proper DOM structure and dataset
  viewTbody.innerHTML = "";
  
  students.forEach((stu, index) => {
    let attended = 0;
    const row = [];

    // Basic columns
    row.push(`<td class="p-3 text-center font-medium">${index + 1}</td>`);
    row.push(`
      <td class="p-3 font-medium">
        <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-md whitespace-nowrap">${stu.studentID}</span>
      </td>
    `);
    row.push(`
      <td class="p-3 font-medium">
        <span class="text-gray-800 text-sm">${stu.name}</span>
      </td>
    `);

    // Attendance columns
    dates.forEach(date => {
      const present = attendanceMap[date]?.includes(stu.studentID);
      if (present) attended++;
      
      row.push(`
        <td class="p-2 text-center">
          <input 
            type="checkbox" 
            ${present ? "checked" : ""} 
            data-date="${date}"
            data-student-id="${stu.studentID}"
            class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-400 transition duration-200"
            onchange="markUnsavedChanges()"
          />
        </td>
      `);
    });

    const total = dates.length;
    const percentage = total ? ((attended / total) * 100).toFixed(1) : "0.0";
    const percentClass = percentage < 75 ? 'text-red-600 bg-red-50' : 
                        percentage >= 85 ? 'text-green-600 bg-green-50' : 
                        'text-yellow-600 bg-yellow-50';

    // Summary columns
    row.push(`<td class="p-3 text-center font-semibold text-gray-700 bg-gray-50">${total}</td>`);
    row.push(`<td class="p-3 text-center font-semibold text-blue-600 bg-blue-50">${attended}</td>`);
    row.push(`<td class="p-3 text-center font-bold ${percentClass} rounded-md">${percentage}%</td>`);

    // ‚úÖ CRITICAL FIX: Create row element properly with dataset
    const tr = document.createElement('tr');
    tr.className = `hover:bg-indigo-50 transition duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
    tr.dataset.studentId = stu.studentID; // ‚úÖ This is crucial for saving
    tr.innerHTML = row.join("");
    
    viewTbody.appendChild(tr);
  });

  console.log(`‚úÖ Table rendered silently with ${students.length} students`);
}

// ‚úÖ FIXED: Enhanced alert and confirmation functions
function showAlert(title, message, type = "info") {
  const prefixes = {
    success: "‚úÖ SUCCESS: ",
    error: "‚ùå ERROR: ",
    warning: "‚ö†Ô∏è WARNING: ",
    info: "‚ÑπÔ∏è INFO: "
  };
  
  alert(`${prefixes[type]}${title}\n\n${message}`);
}

async function showConfirmDialog(title, message, type = "info") {
  const prefixes = {
    success: "‚úÖ CONFIRM: ",
    error: "‚ùå CONFIRM: ",
    warning: "‚ö†Ô∏è CONFIRM: ",
    info: "‚ùì CONFIRM: "
  };
  
  return confirm(`${prefixes[type]}${title}\n\n${message}`);
}

// ‚úÖ FIXED: Subject view change listener
if (subjectView) {
  subjectView.addEventListener("change", () => {
    const subject = subjectView.value;
    const registerTable = document.getElementById("registerTable");
    const saveBtn = document.getElementById("saveChangesBtn");
    const exportExcelBtn = document.getElementById("exportExcelBtn");

    if (registerTable) registerTable.classList.add("hidden");
    if (saveBtn) saveBtn.classList.add("hidden");
    if (exportExcelBtn) exportExcelBtn.classList.add("hidden");
  });
}

// ‚úÖ FIXED: Load Register Button - Proper response handling
document.getElementById("loadRegisterBtn").addEventListener("click", async () => {
  const subject = subjectView.value;
  const registerTable = document.getElementById("registerTable");
  const saveBtn = document.getElementById("saveChangesBtn");
  const exportExcelBtn = document.getElementById("exportExcelBtn");
  const loadBtn = document.getElementById("loadRegisterBtn");

  if (!subject) {
    showAlert("Missing Subject", "Please select a subject.", "error");
    return;
  }

  try {
    // Show loading state
    loadBtn.disabled = true;
    loadBtn.innerHTML = '<span class="loading-spinner"></span> Loading...';

    console.log(`üìä Loading register for: ${subject}`);

    const res = await fetch(`/api/attendance-register/${selectedStream}/sem${selectedSem}/${encodeURIComponent(subject)}`);
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const data = await res.json();
    console.log('üìä Register response:', data);

    // ‚úÖ Handle both old and new response formats
    let students, attendanceMap, subjectInfo;
    
    if (data.success && data.data) {
      // New format
      ({ students, attendanceMap, subjectInfo } = data.data);
    } else if (data.students && data.attendanceMap) {
      // Old format
      ({ students, attendanceMap } = data);
      subjectInfo = data.subjectInfo;
    } else {
      throw new Error(data.message || 'Failed to load register');
    }

    const dates = Object.keys(attendanceMap).sort();

    console.log(`‚úÖ Loaded: ${students.length} students, ${dates.length} dates`);

    if (students.length === 0) {
      const message = subjectInfo?.isLanguageSubject ? 
        `No students found who chose ${subjectInfo.languageType} language` :
        'No students found for this subject';
      showAlert("No Students", message, "warning");
      return;
    }

    // ‚úÖ Render table properly
    await renderAttendanceTableSilently(students, dates, attendanceMap);

    // Show UI elements
    if (registerTable) registerTable.classList.remove("hidden");
    if (saveBtn) saveBtn.classList.remove("hidden");
    if (exportExcelBtn) exportExcelBtn.classList.remove("hidden");

    // ‚úÖ Show single success message
    const avgAttendance = students.length > 0 ?
      (students.reduce((sum, stu) => {
        const attendedCount = dates.filter(date => attendanceMap[date]?.includes(stu.studentID)).length;
        return sum + (dates.length > 0 ? (attendedCount / dates.length) * 100 : 0);
      }, 0) / students.length).toFixed(1) : 0;

    let successMessage = `Register loaded successfully!\n\n`;
    successMessage += `Subject: ${subject}\n`;
    if (subjectInfo?.isLanguageSubject) {
      successMessage += `Language: ${subjectInfo.languageType} students only\n`;
    }
    successMessage += `Students: ${students.length}\n`;
    successMessage += `Days: ${dates.length}\n`;
    successMessage += `Average Attendance: ${avgAttendance}%`;

    showAlert("Success", successMessage, "success");

  } catch (err) {
    console.error("Error loading attendance register:", err);
    showAlert("Loading Error", `Failed to load register: ${err.message}`, "error");
  } finally {
    // Reset button state
    loadBtn.disabled = false;
    loadBtn.innerHTML = '<i class="fas fa-table mr-2"></i>Load Register';
  }
});

// ‚úÖ FIXED: Helper function to mark unsaved changes
function markUnsavedChanges() {
  const saveBtn = document.getElementById("saveChangesBtn");
  if (saveBtn) {
    saveBtn.classList.remove("hidden");
    saveBtn.classList.add("animate-pulse", "bg-red-500", "hover:bg-red-600");
    saveBtn.classList.remove("bg-yellow-500", "hover:bg-yellow-600", "bg-indigo-500", "hover:bg-indigo-600");
    saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Save Changes *';
  }
}


// ‚úÖ Make functions globally available
window.saveAttendanceChanges = saveAttendanceChanges;
window.silentReloadRegister = silentReloadRegister;
window.renderAttendanceTableSilently = renderAttendanceTableSilently;
window.showAlert = showAlert;
window.showConfirmDialog = showConfirmDialog;
window.markUnsavedChanges = markUnsavedChanges;

console.log("‚úÖ Fixed attendance system - no more double messages");

  // ‚úÖ FIXED: Excel export without CloudFlare dependency
function initializeExcelExport() {
  const exportExcelBtn = document.getElementById("exportExcelBtn");
  
  if (!exportExcelBtn) {
    console.warn("‚ö†Ô∏è Export Excel button not found");
    return;
  }

  exportExcelBtn.addEventListener("click", async () => {
    console.log("üöÄ Excel export started");
    
    const originalText = exportExcelBtn.innerHTML;
    exportExcelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
    exportExcelBtn.disabled = true;

    try {
      // ‚úÖ Check for XLSX library (without requiring CloudFlare)
      if (typeof XLSX === 'undefined') {
        // ‚úÖ Alternative: Create CSV instead of Excel
        console.log("üìÑ XLSX not available, creating CSV export instead");
        await exportToCSV();
        return;
      }
      console.log("‚úÖ XLSX library found");

      // ‚úÖ Find table
      const table = document.querySelector("#registerTable table") || 
                   document.querySelector("#registerTable") ||
                   document.querySelector("table");
      
      if (!table) {
        throw new Error("No attendance table found. Please load the register first.");
      }

      // ‚úÖ Check for data
      const tbody = table.querySelector("tbody");
      const rows = tbody ? tbody.querySelectorAll("tr") : [];
      
      if (rows.length === 0) {
        throw new Error("No student data found. Please load attendance register first.");
      }

      // ‚úÖ Get subject info
      const subject = (window.subjectView && subjectView.value) ? subjectView.value : "Attendance";
      const stream = window.selectedStream || "Unknown";
      const sem = window.selectedSem || "0";

      // ‚úÖ Process table data
      const studentStats = [];
      const processedData = [];
      
      // Create header row
      const headerRow = ["#", "Student ID", "Name"];
      const dateHeaders = table.querySelectorAll("th[data-date]");
      
      dateHeaders.forEach(header => {
        if (header.dataset.date) {
          const date = new Date(header.dataset.date);
          if (!isNaN(date.getTime())) {
            headerRow.push(date.toLocaleDateString('en-GB', {
              day: '2-digit',
              month: '2-digit',
              year: '2-digit'
            }));
          }
        }
      });
      
      headerRow.push("Total", "Present", "Percentage");
      processedData.push(headerRow);

      // Process student rows
      rows.forEach((row, rowIndex) => {
        try {
          const cells = row.querySelectorAll("td");
          if (cells.length < 3) return;

          let studentID = `Student_${rowIndex + 1}`;
          let studentName = "Unknown";
          let attended = 0;
          let totalDays = 0;

          // Extract student info
          if (cells[1]) {
            const span = cells.querySelector('span');
            studentID = span ? span.textContent.trim() : cells.textContent.trim();
          }
          
          if (cells) {
            const span = cells.querySelector('span');
            studentName = span ? span.textContent.trim() : cells.textContent.trim();
          }

          // Create data row
          const dataRow = [rowIndex + 1, studentID, studentName];

          // Process checkboxes
          const checkboxes = row.querySelectorAll("input[type='checkbox']");
          checkboxes.forEach(checkbox => {
            totalDays++;
            const isPresent = checkbox.checked;
            if (isPresent) attended++;
            dataRow.push(isPresent ? "Present" : "Absent");
          });

          // Calculate percentage
          const percentage = totalDays > 0 ? (attended / totalDays) * 100 : 0;
          
          dataRow.push(totalDays, attended, `${percentage.toFixed(1)}%`);
          processedData.push(dataRow);

          studentStats.push({
            studentID,
            studentName,
            totalDays,
            attended,
            percentage: percentage.toFixed(1)
          });

        } catch (e) {
          console.warn(`‚ö†Ô∏è Error processing row ${rowIndex}:`, e);
        }
      });

      if (studentStats.length === 0) {
        throw new Error("No valid student data found.");
      }

      // ‚úÖ Create Excel workbook
      const ws = XLSX.utils.aoa_to_sheet(processedData);
      
      // Set column widths
      ws['!cols'] = [
        { wch: 5 },  // #
        { wch: 15 }, // Student ID
        { wch: 25 }, // Name
        ...Array(dateHeaders.length).fill({ wch: 10 }), // Dates
        { wch: 8 },  // Total
        { wch: 10 }, // Present
        { wch: 10 }  // %
      ];

      const wb = XLSX.utils.book_new();
      const sheetName = `${subject.substring(0, 15)}_Attendance`.substring(0, 31);
      XLSX.utils.book_append_sheet(wb, ws, sheetName);

      // ‚úÖ Generate filename
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-GB').replace(/\//g, '-');
      const timeStr = now.toLocaleTimeString('en-GB', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit' 
      }).replace(/:/g, '');
      
      const filename = `${subject.replace(/[^\w]/g, '_')}_${stream.replace(/\s/g, '_')}_S${sem}_${dateStr}_${timeStr}.xlsx`;

      // ‚úÖ Download file
      XLSX.writeFile(wb, filename);

      // ‚úÖ Success message
      const avgAttendance = studentStats.length > 0 ? 
        (studentStats.reduce((sum, s) => sum + parseFloat(s.percentage), 0) / studentStats.length).toFixed(1) : '0.0';
      
      showAlert("Export Success", `‚úÖ Excel exported successfully!\n\nüìö Subject: ${subject}\nüìä Students: ${studentStats.length}\nüìà Average: ${avgAttendance}%\nüìÅ File: ${filename}`, "success");

    } catch (error) {
      console.error("‚ùå Excel export error:", error);
      
      // ‚úÖ Fallback to CSV if Excel fails
      console.log("üìÑ Falling back to CSV export");
      await exportToCSV();
      
    } finally {
      exportExcelBtn.innerHTML = originalText;
      exportExcelBtn.disabled = false;
    }
  });

  // ‚úÖ CSV Export Fallback Function
  async function exportToCSV() {
    try {
      const table = document.querySelector("#registerTable table");
      if (!table) throw new Error("No table found");

      const rows = table.querySelectorAll("tbody tr");
      if (rows.length === 0) throw new Error("No data found");

      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add headers
      csvContent += "#,Student ID,Name";
      const dateHeaders = table.querySelectorAll("th[data-date]");
      dateHeaders.forEach(header => {
        if (header.dataset.date) {
          const date = new Date(header.dataset.date);
          csvContent += "," + date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: '2-digit'
          });
        }
      });
      csvContent += ",Total,Present,Percentage\n";

      // Add data rows
      rows.forEach((row, index) => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 3) return;

        let studentID = cells[1] ? cells[1].textContent.trim() : `Student_${index + 1}`;
        let studentName = cells ? cells.textContent.trim() : "Unknown";
        let attended = 0;
        let totalDays = 0;

        // Clean student info
        studentID = studentID.replace(/,/g, ' ');
        studentName = studentName.replace(/,/g, ' ');

        let rowData = `${index + 1},"${studentID}","${studentName}"`;

        // Process checkboxes
        const checkboxes = row.querySelectorAll("input[type='checkbox']");
        checkboxes.forEach(checkbox => {
          totalDays++;
          const isPresent = checkbox.checked;
          if (isPresent) attended++;
          rowData += "," + (isPresent ? "Present" : "Absent");
        });

        const percentage = totalDays > 0 ? (attended / totalDays) * 100 : 0;
        rowData += `,${totalDays},${attended},${percentage.toFixed(1)}%\n`;
        
        csvContent += rowData;
      });

      // ‚úÖ Download CSV
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      
      const subject = (window.subjectView && subjectView.value) ? subjectView.value : "Attendance";
      const stream = window.selectedStream || "Unknown";
      const sem = window.selectedSem || "0";
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-GB').replace(/\//g, '-');
      
      const filename = `${subject.replace(/[^\w]/g, '_')}_${stream.replace(/\s/g, '_')}_S${sem}_${dateStr}.csv`;
      link.setAttribute("download", filename);
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showAlert("CSV Export Success", `‚úÖ Data exported as CSV!\n\nüìö Subject: ${subject}\nüìÅ File: ${filename}`, "success");

    } catch (error) {
      console.error("‚ùå CSV export error:", error);
      showAlert("Export Error", `‚ùå Export failed: ${error.message}`, "error");
    }
  }
}

// ‚úÖ Initialize export
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeExcelExport);
} else {
  initializeExcelExport();
}

console.log("‚úÖ Excel/CSV export initialized (no external CDN required)");

  // Subject management functionality
  let subjectsToAdd = [];
  
  // Add subject to list with validation
  function addSubjectToList() {
    const subjectInput = document.getElementById('newSubject');
    const subjectName = subjectInput.value.trim();
    
    if (!subjectName) {
      alert('‚ùå Subject name cannot be empty');
      return;
    }
    
    if (subjectName.length < 2) {
      alert('‚ùå Subject name must be at least 2 characters long');
      return;
    }
    
    if (subjectsToAdd.some(s => s.toLowerCase() === subjectName.toLowerCase())) {
      alert('‚ö†Ô∏è Subject already added to the list');
      return;
    }
    
    subjectsToAdd.push(subjectName);
    updateSubjectsList();
    subjectInput.value = '';
    subjectInput.focus();
    
    console.log('üìö Subject added to list:', subjectName);
    console.log('üìö Current subjects list:', subjectsToAdd);
  }
  
  // Update subjects list display
  function updateSubjectsList() {
    const listDiv = document.getElementById('subjectsList');
    
    if (subjectsToAdd.length === 0) {
      listDiv.innerHTML = '<p class="text-gray-500 text-center py-8 text-lg">üìö No subjects added yet</p>';
      return;
    }
    
    listDiv.innerHTML = subjectsToAdd.map((subject, index) => `
      <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl border border-blue-200 hover:bg-blue-100 transition-all">
        <span class="font-semibold text-gray-800 text-lg">${subject}</span>
        <button onclick="removeSubject(${index})" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-100 transition-all">
          <i class="fas fa-trash text-lg"></i>
        </button>
      </div>
    `).join('');
  }
  
  // Remove subject from list
  function removeSubject(index) {
    const subjectName = subjectsToAdd[index];
    subjectsToAdd.splice(index, 1);
    updateSubjectsList();
    console.log('üóëÔ∏è Subject removed:', subjectName);
  }
  
  // Enhanced: Save all subjects with comprehensive error handling
  async function saveAllSubjects() {
    console.log('üíæ Starting to save subjects...');
    console.log('üìö Subjects to save:', subjectsToAdd);
    console.log('üéì Stream:', promotionStream);
    console.log('üìÖ Semester:', promotionSemester);
    
    // Validation checks
    if (subjectsToAdd.length === 0) {
      alert('‚ùå No subjects to save. Please add at least one subject.');
      return;
    }
    
    if (!promotionStream || !promotionSemester) {
      alert('‚ùå Please select stream and semester first from the promotion section');
      return;
    }
    
    // Confirm before saving
    const confirmSave = confirm(`üíæ Save ${subjectsToAdd.length} subjects for ${promotionStream} Semester ${promotionSemester}?
  
  Subjects to be added:
  ${subjectsToAdd.map(s => `‚Ä¢ ${s}`).join('\n')}
  
  Continue?`);
    
    if (!confirmSave) {
      return;
    }
    
    // Show loading state
    const saveButton = document.querySelector('button[onclick="saveAllSubjects()"]');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    saveButton.disabled = true;
    
    try {
      console.log('üåê Making API request to:', `/api/setup-subjects/${promotionStream}/sem${promotionSemester}`);
      
      const response = await fetch(`/api/setup-subjects/${promotionStream}/sem${promotionSemester}`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ 
          subjects: subjectsToAdd 
        })
      });
      
      console.log('üì° Response status:', response.status);
      console.log('üì° Response ok:', response.ok);
      
      const result = await response.json();
      console.log('üì¶ Response data:', result);
      
      if (response.ok && result.success) {
        // Success
        let successMessage = `‚úÖ Subjects Setup Complete!\n\n`;
        successMessage += `Stream: ${result.stream}\n`;
        successMessage += `Semester: ${result.semester}\n`;
        successMessage += `Successfully Added: ${result.added}/${result.total}\n\n`;
        
        if (result.results) {
          const successful = result.results.filter(r => r.success);
          const failed = result.results.filter(r => !r.success);
          
          if (successful.length > 0) {
            successMessage += `‚úÖ Successfully Added:\n${successful.map(s => `‚Ä¢ ${s.subjectName}`).join('\n')}\n\n`;
          }
          
          if (failed.length > 0) {
            successMessage += `‚ö†Ô∏è Failed to Add:\n${failed.map(s => `‚Ä¢ ${s.subjectName} (${s.error})`).join('\n')}`;
          }
        }
        
        alert(successMessage);
        
        // Clear the list
        subjectsToAdd = [];
        updateSubjectsList();
        
      } else {
        // API returned error
        throw new Error(result.message || 'Unknown server error');
      }
      
    } catch (error) {
      console.error('‚ùå Error saving subjects:', error);
      
      let errorMessage = '‚ùå Failed to save subjects!\n\n';
      
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        errorMessage += 'Network Error: Unable to connect to server.\nPlease check your internet connection.';
      } else if (error.message.includes('404')) {
        errorMessage += 'API Route Not Found: The backend route might not be set up correctly.';
      } else if (error.message.includes('500')) {
        errorMessage += 'Server Error: Database or server configuration issue.';
      } else {
        errorMessage += `Error: ${error.message}`;
      }
      
      errorMessage += `\n\nDebugging Info:
  ‚Ä¢ Stream: ${promotionStream}
  ‚Ä¢ Semester: ${promotionSemester}
  ‚Ä¢ Subjects Count: ${subjectsToAdd.length}
  ‚Ä¢ Subjects: ${subjectsToAdd.join(', ')}`;
      
      alert(errorMessage);
      
    } finally {
      // Restore button state
      saveButton.innerHTML = originalText;
      saveButton.disabled = false;
    }
  }
  
  // Add Enter key support for adding subjects
  document.addEventListener('DOMContentLoaded', function() {
    const subjectInput = document.getElementById('newSubject');
    if (subjectInput) {
      subjectInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addSubjectToList();
        }
      });
    }
    
    // Initialize subjects list
    updateSubjectsList();
  });
  
</script>
<script type="module">
  // ‚úÖ Import configuration from separate config file
  import { firebaseConfig, AUTHORIZED_TEACHERS } from './firebase-config.js';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // ‚úÖ Use imported configuration
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let authStateChecked = false;

  function showAuthLoading() {
    const loadingScreen = document.getElementById('authLoadingScreen');
    const mainContent = document.getElementById('mainContent');
    
    if (loadingScreen) loadingScreen.style.display = 'flex';
    if (mainContent) mainContent.style.display = 'none';
    
    console.log('üîÑ Checking authentication state...');
  }

  function hideAuthLoading() {
    const loadingScreen = document.getElementById('authLoadingScreen');
    const mainContent = document.getElementById('mainContent');
    
    if (loadingScreen) loadingScreen.style.display = 'none';
    if (mainContent) mainContent.style.display = 'block';
  }

  function isAuthorizedUser(email) {
    return email && AUTHORIZED_TEACHERS.includes(email.toLowerCase());
  }

  onAuthStateChanged(auth, (user) => {
    console.log('üîê Auth state changed:', {
      user: !!user,
      email: user?.email,
      authStateChecked: authStateChecked
    });

    authStateChecked = true;

    if (user) {
      const email = user.email;
      
      if (!email) {
        console.error('‚ùå User has no email, redirecting to login');
        window.location.href = "login.html";
        return;
      }

      if (!isAuthorizedUser(email)) {
        console.error('‚ùå Unauthorized user:', email);
        signOut(auth).then(() => {
          window.location.href = "login.html";
        });
        return;
      }

      console.log('‚úÖ User authenticated successfully:', email);
      updateUserInterface(user, email);
      hideAuthLoading();

    } else {
      console.log('‚ùå No authenticated user, redirecting to login');
      setTimeout(() => {
        window.location.href = "login.html";
      }, 100);
    }
  });

  function updateUserInterface(user, email) {
    try {
      const userName = localStorage.getItem("userName") || user.displayName || email.split('@')[0];
      const avatarURL = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=8b5cf6&color=fff&size=64`;
      
      const userNameElement = document.getElementById("userName");
      const userEmailElement = document.getElementById("userEmail");
      const profilePicElement = document.getElementById("profilePic");
      
      if (userNameElement) userNameElement.textContent = userName;
      if (userEmailElement) userEmailElement.textContent = email;
      if (profilePicElement) {
        profilePicElement.src = avatarURL;
        profilePicElement.onerror = () => {
          profilePicElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><rect width="64" height="64" fill="%238b5cf6"/><text x="50%" y="50%" fill="white" text-anchor="middle" dy=".3em" font-family="Arial" font-size="24">üë®‚Äçüè´</text></svg>';
        };
      }

      localStorage.setItem("userName", userName);
      localStorage.setItem("userEmail", email);

    } catch (error) {
      console.error('‚ùå Error updating UI:', error);
    }
  }

  window.logout = async () => {
    try {
      console.log('üëã Logging out user...');
      await signOut(auth);
      localStorage.clear();
      window.location.href = "login.html";
    } catch (error) {
      console.error('‚ùå Logout error:', error);
      localStorage.clear();
      window.location.href = "login.html";
    }
  };

  // Initialize
  showAuthLoading();

  // Timeout fallback
  setTimeout(() => {
    if (!authStateChecked) {
      console.warn('‚ö†Ô∏è Auth state check timeout, redirecting to login');
      window.location.href = "login.html";
    }
  }, 10000);

  console.log('üõ°Ô∏è Main page auth system initialized');
  function goToStreamsHome() {
    console.log('üè† Home button clicked'); // Debug log
    
    try {
      // Hide all attendance sections
      const elementsToHide = ['markTab', 'viewTab', 'tabs', 'semesterSection'];
      elementsToHide.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.classList.add('hidden');
          console.log(`‚úÖ Hidden: ${id}`);
        } else {
          console.log(`‚ùå Element not found: ${id}`);
        }
      });
      
      // Show home page
      const homePage = document.getElementById('homePage');
      if (homePage) {
        homePage.classList.remove('hidden');
        homePage.style.display = 'block'; // Ensure it's visible
        console.log('‚úÖ Home page shown');
      } else {
        console.log('‚ùå Home page element not found');
      }
      
      // Reset global variables
      selectedStream = '';
      selectedSem = '';
      
      // Clear form inputs safely
      const elementsToReset = [
        'subject-mark',
        'subject-view', 
        'students-list',
        'date'
      ];
      
      elementsToReset.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.tagName === 'SELECT' || element.tagName === 'INPUT') {
            element.value = '';
          } else {
            element.innerHTML = '';
          }
        }
      });
      
      // Reset date to today
      const dateInput = document.getElementById('date');
      if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
      
      console.log('üéâ Successfully navigated to home');
      
    } catch (error) {
      console.error('‚ùå Error in goToStreamsHome:', error);
      alert('Error navigating to home. Check console for details.');
    }
  }
  
</script>



</body>
</html>
