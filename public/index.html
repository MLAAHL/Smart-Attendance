<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Panel</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="demo.css">

  <!-- Inline Styles -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            customBlue: '#007CBE',
            customYellow: '#FFF7AE',
            customOrange: '#E57A44',
            customPurple: '#251351',
          }
        }
      }
    }
  </script>
</head>

<body>
  <!-- Main Wrapper -->
  <div id="homePage">
    
    <!-- Header Section -->
    <header class="relative w-full px-5 py-6 text-white overflow-hidden flex items-center justify-center h-[200vh]">
      
      <!-- Toggle Button -->
      <div class="menu-icon cursor-pointer" onclick="toggleMenu()">
        <div class="line long bg-gray-800 h-1 w-6 mb-1"></div>
        <div class="line short bg-gray-800 h-1 w-4"></div>
      </div>

      <!-- User Icon -->
      <div class="absolute top-4 right-4 flex items-center space-x-2">
        <span class="text-sm font-medium text-indigo-700" id="userName"></span>
        <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User"
             class="w-8 h-8 rounded-full shadow-lg border border-indigo-300"/>
      </div>

      <!-- Side Menu -->
      <div id="mobileMenu" class="side-menu hidden fixed top-0 left-0 w-64 h-full bg-white shadow z-50 p-4 transition-transform transform -translate-x-full">
        <div class="mb-8">
          <div class="text-2xl font-bold text-indigo-600 flex items-center">
            <i class="fas fa-chalkboard-teacher mr-2"></i>
            Smart Panel
          </div>
          <div class="text-xs text-gray-500 mt-1">Teacher Dashboard</div>
        </div>
        
        <div class="user-profile flex flex-col items-center mb-8">
          <div class="relative mb-4">
            <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" 
                 class="w-20 h-20 rounded-full border-4 border-indigo-100 object-cover shadow-lg"/>
            <div class="absolute bottom-0 right-0 w-6 h-6 bg-green-400 rounded-full border-2 border-white"></div>
          </div>
          <span id="userName" class="font-semibold text-gray-800 text-lg"></span>
          <span id="userEmail" class="text-gray-500 text-sm mt-1"></span>
        </div>
        
        <ul class="space-y-4 text-black">
          <li>
            <button onclick="goToHome()" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition">
              <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fas fa-home text-sm"></i>
              </div>
              <span>Dashboard</span>
            </button>
          </li>
          
          <li>
            <button onclick="alert('Classes')" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition">
              <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fas fa-users text-sm"></i>
              </div>
              <span>My Classes</span>
            </button>
          </li>
        
          <!-- ✅ NEW: Promote Students Button -->
          <li>
            <a href="/promotion.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-user-graduate text-sm"></i>
              </div>
              <span>Promote Students</span>
            </a>
          </li>
          <li>
            <a href="/msg.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-comments text-sm"></i>
            </div>
            <span>WhatsApp</span>
            </a>
          </li>
          
          <li>
            <a href="/report.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-purple-50 text-gray-700 hover:text-purple-600 transition block">
              <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                <i class="fas fa-user-graduate text-sm"></i>
              </div>
              <span>Reports</span>
            </a>
          </li>
          
          <li>
            <button onclick="alert('Settings')" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-indigo-50 text-gray-700 hover:text-indigo-600 transition">
              <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600">
                <i class="fas fa-cog text-sm"></i>
              </div>
              <span>Settings</span>
            </button>
          </li>
        </ul>
        
        <!-- Logout Button -->
        <div class="mt-auto pt-4">
          <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 text-red-500 transition">
            <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center text-red-500">
              <i class="fas fa-sign-out-alt text-sm"></i>
            </div>
            <span>Logout</span>
          </button>
        </div>
        
    </header>

    <div class="banner-wrapper">
      <div class="banner">
        <div class="banner-text">
          <div class="badge">MLA AHL</div>
          <h1>Smart Attendance System</h1>
          <p>Mark it. View it. Stay on track.</p>
        </div>
        <div class="banner-img">
          <img src="illu.png" 
         alt="Attendance Illustration" 
         class="w-40 sm:w-40 drop-shadow-lg" />
        </div>

        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
      </div>
    </div>

    <!-- Stream Section -->
    <div class="px-5 py-4">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-graduation-cap text-indigo-500 mr-2"></i>
        Select Academic Stream
      </h2>
      <div id="streamSection" class="grid grid-cols-2 gap-4">
        <!-- JS will populate stream cards here -->
      </div>
    </div>

  </div> <!-- End of #homePage -->

    <!-- Semester Section (initially hidden) -->
    <div id="semesterSection" class="hidden">
      <div class="max-w-[800px] w-full grid grid-cols-2 gap-6 px-6 py-6 mx-auto">
        
        <!-- JS will append semester cards here -->
      </div>
    </div>

    <div id="tabs" class="hidden">
      <!-- ✅ MOBILE HEADER: Optimized spacing -->
      <header class="w-full bg-white shadow-sm border-b border-gray-200 px-3 py-3 mb-4">
        <div class="flex items-center justify-between">
          <!-- Left: Back Button -->
          <button onclick="backToSemesters()" class="w-8 h-8 rounded-full bg-gradient-to-r from-white to-blue-100 hover:from-blue-50 hover:to-blue-200 border border-blue-300 flex items-center justify-center transition-all duration-200 active:scale-95">
            <i class="fa-solid fa-angle-left text-blue-600 text-xs"></i>
          </button>
          
          
          <!-- Center: Stream & Semester -->
          <div class="flex items-center space-x-3 rounded-lg px-3 py-2">
            <div class="text-center">
              <p class="text-xs text-gray-500">Stream</p>
              <p id="currentStream" class="font-semibold text-indigo-700 text-xs leading-tight"></p>
            </div>
            <div class="w-px h-6 bg-gray-300"></div>
            <div class="text-center">
              <p class="text-xs text-gray-500">Sem</p>
              <p id="currentSemester" class="font-semibold text-blue-700 text-xs leading-tight"></p>
            </div>
          </div>
          
          <!-- Right: Home Button -->
          <button onclick="window.location.reload()" class="w-8 h-8 rounded-full bg-gradient-to-r from-white to-blue-100 hover:from-blue-50 hover:to-blue-200 border border-blue-300 flex items-center justify-center transition-all duration-200 active:scale-95">
            <i class="fas fa-home text-blue-600 text-sm"></i>
          </button>
          
        </div>
      </header>
      
      <!-- ✅ TAB BUTTONS: Better spacing -->
      <div class="px-4 mb-6">
        <div class="flex bg-white rounded-full shadow-md p-1 max-w-sm mx-auto">
          <button onclick="showTab('markTab')" id="markBtn"
            class="tablinks flex-1 px-4 py-2 text-white bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full transition-all duration-300 shadow-md text-sm font-medium">
            Mark Attendance
          </button>
          <button onclick="showTab('viewTab')" id="viewBtn"
            class="tablinks flex-1 px-4 py-2 text-gray-600 hover:text-indigo-600 hover:bg-indigo-100 rounded-full transition-all duration-300 text-sm font-medium">
            View Attendance
          </button>
        </div>
      </div>
    </div>
    
    
    <div id="markTab" class="tabcontent hidden p-3 sm:p-4">
      <!-- ✅ COMPACT: Title with responsive spacing -->
      <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 flex items-center">
        <i class="fas fa-edit text-indigo-500 mr-2"></i>
        Mark Attendance
      </h3>
    
      <!-- ✅ RESPONSIVE: Date and subject layout -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4 px-1">
        <!-- Date Input -->
        <div class="relative">
          <label class="block text-xs text-gray-600 mb-1">Date</label>
          <input 
            type="date" 
            id="date" 
            class="w-full p-2 text-sm border border-indigo-300 rounded-lg text-[#0f172a] bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" 
            onchange="checkDateWarnings()"
          />
          <div id="dateWarning" class="hidden mt-1 text-xs text-amber-600 flex items-center">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            <span id="dateWarningText"></span>
          </div>
        </div>
        
        <!-- Subject Select -->
        <div>
          <label class="block text-xs text-gray-600 mb-1">Subject</label>
          <select id="subject-mark" class="w-full px-3 py-2 text-sm bg-white text-[#0f172a] border border-indigo-300 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-indigo-400 transition duration-200">
            <option value="">-- Select Subject --</option>
          </select>
        </div>
      </div>
    
      <!-- ✅ RESPONSIVE: Students table -->
      <div class="overflow-x-auto rounded-lg shadow mb-4">
        <table class="table-auto w-full border border-indigo-200 bg-white text-[#0f172a] rounded-lg overflow-hidden">
          <thead class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white">
            <tr>
              <th class="p-2 sm:p-3 border border-indigo-200 text-center text-xs sm:text-sm">#</th>
              <th class="p-2 sm:p-3 border border-indigo-200 text-center text-xs sm:text-sm">ID</th>
              <th class="p-2 sm:p-3 border border-indigo-200 text-left text-xs sm:text-sm">Name</th>
              <th class="p-2 sm:p-3 border border-indigo-200 text-center text-xs sm:text-sm">Present</th>
            </tr>
          </thead>
          <tbody id="students-list" class="text-xs sm:text-sm"></tbody>
        </table>
      </div>
    
      <!-- ✅ RESPONSIVE: Submit button -->
      <div class="flex justify-center mt-4">
        <button id="submitAttendance" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-6 py-2 sm:px-8 sm:py-3 rounded-full font-medium hover:shadow-lg transition flex items-center text-sm sm:text-base">
          <i class="fas fa-paper-plane mr-2"></i> 
          <span class="hidden sm:inline">Submit Attendance</span>
          <span class="sm:hidden">Submit</span>
        </button>
      </div>
    </div>
    
    <div id="viewTab" class="tabcontent hidden p-2 sm:p-4">
      <!-- Mobile-optimized header -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-gray-800 flex items-center">
          <i class="fas fa-table text-indigo-500 mr-2 text-sm"></i>
          Register
        </h3>
      </div>
    
      <!-- Compact subject selection -->
      <div class="space-y-2 mb-4">
        <label for="subject-view" class="block text-xs text-gray-600 font-medium">Select Subject</label>
        <select id="subject-view" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white text-gray-800">
          <option value="">-- Select Subject --</option>
        </select>
        <button id="loadRegisterBtn" class="w-full sm:w-auto px-4 py-2 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-lg text-sm font-medium hover:from-indigo-600 hover:to-blue-600 transition-all">
          <i class="fas fa-search mr-2"></i>Load Attendance Register
        </button>
      </div>
    
      <!-- Register display -->
      <div id="registerTable" class="hidden">
        <!-- Action buttons -->
        <div class="flex justify-end gap-2 mb-3">
          <button id="saveChangesBtn" onclick="saveAttendanceChanges()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 bg-yellow-500 text-white rounded-lg text-xs sm:text-sm font-medium hidden hover:bg-yellow-600 transition-all">
            <i class="fas fa-save text-sm mr-1"></i>
            <span class="hidden sm:inline">Save Changes</span>
            <span class="sm:hidden text-xs">Save</span>
          </button>
          <button id="exportExcelBtn" onclick="exportToExcel()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 bg-green-600 text-white rounded-lg text-xs sm:text-sm font-medium hidden hover:bg-green-700 transition-all">
            <i class="fas fa-file-excel text-sm mr-1"></i>
            <span class="hidden sm:inline">Export Excel</span>
            <span class="sm:hidden text-xs">Export</span>
          </button>
        </div>
        
      
        <!-- ✅ FIXED: Table with sticky student column -->
        <div class="rounded-lg shadow border border-indigo-200 overflow-hidden bg-white">
          <div class="overflow-x-auto relative">
            <table class="min-w-full text-xs sm:text-sm border-collapse">
              <thead class="bg-indigo-600 text-white sticky top-0 z-30" id="view-thead">
                <!-- Headers will be populated by JavaScript -->
              </thead>
              <tbody class="bg-white text-gray-800 divide-y divide-gray-100" id="view-tbody">
                <!-- Rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
    
        <!-- Mobile scroll hint -->
        <div class="mt-2 text-xs text-gray-500 text-center flex items-center justify-center gap-2">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Student column stays fixed • Scroll horizontally to view all dates</span>
        </div>
        
        <!-- ✅ Stats summary -->
        <div class="mt-3 p-2 bg-gray-50 rounded-lg text-xs text-gray-600 grid grid-cols-2 sm:grid-cols-4 gap-2" id="attendanceStats">
          <!-- Stats will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    
    

<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ✅ DOM Element References
// ✅ Global DOM elements
// ✅ Global DOM elements
const streamSection = document.getElementById("streamSection");
const semesterSection = document.getElementById("semesterSection");
const tabs = document.getElementById("tabs");
const markTab = document.getElementById("markTab");
const viewTab = document.getElementById("viewTab");
const subjectMark = document.getElementById("subject-mark");
const subjectView = document.getElementById("subject-view");
const studentsList = document.getElementById("students-list");
const submitBtn = document.getElementById("submitAttendance");
const viewThead = document.getElementById("view-thead");
const viewTbody = document.getElementById("view-tbody");
const markBtn = document.getElementById("markBtn");
const viewBtn = document.getElementById("viewBtn");

// ✅ SIMPLIFIED: Global variables (no section needed)
let selectedStream = "";
let selectedSem = "";

// ✅ Flags to prevent duplicate event listeners
let subjectChangeListenerAdded = false;
let menuClickListenerAdded = false;

// ✅ SIMPLIFIED: Function to update current selection display (no section)
function updateCurrentSelectionDisplay(stream, semester) {
  const currentStreamElement = document.getElementById('currentStream');
  const currentSemesterElement = document.getElementById('currentSemester');
  
  if (currentStreamElement) {
    currentStreamElement.textContent = stream;
    console.log(`✅ Updated stream display: ${stream}`);
  }
  
  if (currentSemesterElement) {
    currentSemesterElement.textContent = `Semester ${semester}`;
    console.log(`✅ Updated semester display: Semester ${semester}`);
  }
}

// ✅ Function to clear selection display
function clearCurrentSelectionDisplay() {
  const currentStreamElement = document.getElementById('currentStream');
  const currentSemesterElement = document.getElementById('currentSemester');
  
  if (currentStreamElement) currentStreamElement.textContent = '';
  if (currentSemesterElement) currentSemesterElement.textContent = '';
  
  console.log('🧹 Cleared selection display');
}

// ✅ Home navigation function
function goToStreamsHome() {
  console.log("🏠 Starting home navigation");
  
  // Hide all sections
  const hideElements = ['markTab', 'viewTab', 'tabs', 'semesterSection'];
  hideElements.forEach(id => {
    const elem = document.getElementById(id);
    if (elem) {
      elem.style.display = 'none';
      elem.classList.add('hidden');
    }
  });
  
  // Show home page
  const homePage = document.getElementById('homePage');
  if (homePage) {
    homePage.style.display = 'block';
    homePage.classList.remove('hidden');
  }
  
  // Reset variables and display
  selectedStream = '';
  selectedSem = '';
  clearCurrentSelectionDisplay();
  
  // Clear form data
  ['subject-mark', 'subject-view', 'students-list'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      if (element.tagName === 'SELECT') {
        element.value = '';
      } else {
        element.innerHTML = '';
      }
    }
  });
  
  console.log("✅ Home navigation completed");
}

// ✅ SIMPLIFIED: Select stream function (no section logic)
function selectStream(stream, sem) {
  selectedStream = stream;
  selectedSem = sem;
  
  updateCurrentSelectionDisplay(stream, sem);
  
  semesterSection.classList.add("hidden");
  tabs.classList.remove("hidden");
  showTab("markTab");
  loadSubjectsAndStudents(stream, sem);
  
  console.log(`✅ Selected: ${stream} - Semester ${sem}`);
}

// ✅ Add menu click listener
function addMenuClickListener() {
  if (!menuClickListenerAdded) {
    document.addEventListener("click", (event) => {
      const menu = document.getElementById("mobileMenu");
      const toggle = document.querySelector(".menu-icon");
      if (menu && toggle && !menu.contains(event.target) && !toggle.contains(event.target)) {
        menu.classList.add("hidden");
        menu.classList.add("-translate-x-full");
      }
    });
    menuClickListenerAdded = true;
  }
}

// ✅ Show tab function
function showTab(tabId) {
  markTab.classList.add("hidden");
  viewTab.classList.add("hidden");
  document.getElementById(tabId).classList.remove("hidden");
  
  document.getElementById('markBtn').className =
    "tablinks px-4 py-2 text-gray-600 hover:text-indigo-500 hover:bg-indigo-100 rounded-full transition-all duration-300";
  document.getElementById('viewBtn').className =
    "tablinks px-4 py-2 text-gray-600 hover:text-indigo-500 hover:bg-indigo-100 rounded-full transition-all duration-300";

  if (tabId === 'markTab') {
    document.getElementById('markBtn').className =
      "tablinks px-8 py-2 text-white bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full transition-all duration-300 shadow-md";
  } else {
    document.getElementById('viewBtn').className =
      "tablinks px-8 py-2 text-white bg-gradient-to-r from-indigo-500 to-blue-500 rounded-full transition-all duration-300 shadow-md";
  }
}

// ✅ FIXED: Load subjects and students function (no section mapping)
async function loadSubjectsAndStudents(stream, sem) {
  try {
    console.log(`🔄 Loading data for: ${stream} Sem ${sem}`);
    
    // ✅ FIXED: Use stream directly - NO MAPPING
    const baseUrl = '/api';
    const subjectsUrl = `${baseUrl}/subjects/${stream}/sem${sem}`;
    const studentsUrl = `${baseUrl}/students/${stream}/sem${sem}`;
    
    console.log(`📡 Subjects URL: ${subjectsUrl}`);
    console.log(`📡 Students URL: ${studentsUrl}`);
    
    // Load subjects and students in parallel
    const [subjectsRes, studentsRes] = await Promise.all([
      fetch(subjectsUrl),
      fetch(studentsUrl)
    ]);
    
    console.log(`📊 Subjects response status: ${subjectsRes.status}`);
    console.log(`📊 Students response status: ${studentsRes.status}`);
    
    if (!subjectsRes.ok) {
      console.error('❌ Subjects request failed:', subjectsRes.status, subjectsRes.statusText);
      throw new Error(`Failed to fetch subjects: ${subjectsRes.status}`);
    }
    
    if (!studentsRes.ok) {
      console.error('❌ Students request failed:', studentsRes.status, studentsRes.statusText);
      throw new Error(`Failed to fetch students: ${studentsRes.status}`);
    }
    
    const subjects = await subjectsRes.json();
    const students = await studentsRes.json();
    
    console.log('📚 Subjects data:', subjects);
    console.log('👥 Students data:', students);
    
    // Populate subjects dropdown
    populateSubjectDropdowns(subjects);
    
    // Populate students list
    populateStudentsList(students);
    
    const subjectCount = subjects.subjects ? subjects.subjects.length : (Array.isArray(subjects) ? subjects.length : subjects.count || 0);
    const studentCount = students.students ? students.students.length : (Array.isArray(students) ? students.length : students.count || 0);
    
    console.log(`✅ Data loaded successfully: ${subjectCount} subjects, ${studentCount} students`);
    
    if (studentCount === 0) {
      console.warn('⚠️ No students found for this selection');
      alert(`No students found for ${stream} Semester ${sem}. Please check if students exist in the database.`);
    }
    
  } catch (error) {
    console.error('❌ Error loading data:', error);
    alert(`ERROR: Failed to load class data. ${error.message}`);
  }
}

// ✅ Helper function to populate subject dropdowns
function populateSubjectDropdowns(subjects) {
  const subjectData = subjects.subjects || subjects;
  
  // Clear existing options
  if (subjectMark) subjectMark.innerHTML = '<option value="">-- Select Subject --</option>';
  if (subjectView) subjectView.innerHTML = '<option value="">-- Select Subject --</option>';
  
  if (Array.isArray(subjectData) && subjectData.length > 0) {
    subjectData.forEach(subject => {
      const subjectName = subject.subjectName || subject.name || subject;
      const option = `<option value="${subjectName}">${subjectName}</option>`;
      if (subjectMark) subjectMark.innerHTML += option;
      if (subjectView) subjectView.innerHTML += option;
    });
    console.log(`✅ Populated ${subjectData.length} subjects`);
  } else {
    console.warn('⚠️ No subjects data found');
  }
}

// ✅ Helper function to populate students list
function populateStudentsList(students) {
  if (!studentsList) {
    console.error('❌ Students list element not found');
    return;
  }
  
  const studentData = students.students || students;
  studentsList.innerHTML = '';
  
  if (Array.isArray(studentData) && studentData.length > 0) {
    studentData.forEach(student => {
      const studentItem = document.createElement('div');
      studentItem.className = 'flex items-center p-3 hover:bg-gray-50 rounded-lg transition-colors duration-200';
      
      const studentID = student.studentID || student.id || 'N/A';
      const studentName = student.name || 'Unknown';
      
      studentItem.innerHTML = `
        <input type="checkbox" value="${studentID}" class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500 mr-3">
        <div class="flex-1">
          <p class="font-medium text-gray-900">${studentName}</p>
          <p class="text-sm text-gray-500">${studentID}</p>
        </div>
      `;
      
      studentsList.appendChild(studentItem);
    });
    console.log(`✅ Populated ${studentData.length} students`);
  } else {
    studentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No students found for this semester.</p>';
    console.warn('⚠️ No students data found');
  }
}

// ✅ Navigation functions
function backToSemesters() {
  document.getElementById("markTab").classList.add("hidden");
  document.getElementById("viewTab").classList.add("hidden");
  document.getElementById("tabs").classList.add("hidden");
  document.getElementById("semesterSection").classList.remove("hidden");
}

// ✅ Menu functions
window.toggleMenu = () => {
  const menu = document.getElementById("mobileMenu");
  if (menu) {
    menu.classList.toggle("hidden");
    menu.classList.toggle("-translate-x-full");
  }
};

// ✅ MAIN DOM CONTENT LOADED EVENT
document.addEventListener("DOMContentLoaded", () => {
  addMenuClickListener();

  // ✅ UPDATED: Streams with separate BCom Section B
  const streams = [
    {
      name: "BCA",
      icon: '<i class="fas fa-laptop-code text-indigo-500"></i>',
      color: "bg-indigo-100",
      textColor: "text-indigo-600"
    },
    {
      name: "BBA",
      icon: '<i class="fas fa-chart-line text-green-500"></i>',
      color: "bg-green-100",
      textColor: "text-green-600"
    },
    {
      name: "BCom",
      displayName: "BCom",
      icon: '<i class="fas fa-money-bill-wave text-yellow-500"></i>',
      color: "bg-yellow-100",
      textColor: "text-yellow-600"
    },
    {
      name: "BCom Section B",
      displayName: "BCom B",
      icon: '<i class="fas fa-money-bill-wave text-orange-500"></i>',
      color: "bg-orange-100",
      textColor: "text-orange-600",
      limitedSemesters: [5, 6] // Only show semesters 5 and 6
    },
    {
      name: "BCom-BDA",
      displayName: "BDA",
      icon: '<i class="fas fa-chart-bar text-purple-500"></i>',
      color: "bg-purple-100",
      textColor: "text-purple-600"
    },
    {
      name: "BCom A&F",
      icon: '<i class="fas fa-calculator text-blue-500"></i>',
      color: "bg-blue-100",
      textColor: "text-blue-600"
    }
  ];

  // Generate stream boxes
  streams.forEach((stream) => {
    const streamBox = document.createElement("div");
    streamBox.className = `bg-white rounded-xl p-5 shadow-sm border border-gray-200 hover:border-indigo-300 transition card-hover cursor-pointer`;

    const displayName = stream.displayName || stream.name;

    streamBox.innerHTML = `
      <div class="flex items-center">
        <div class="w-12 h-12 ${stream.color} rounded-lg flex items-center justify-center mr-4">
          ${stream.icon}
        </div>
        <div>
          <h3 class="font-semibold text-gray-800">${displayName}</h3>
          <p class="text-sm text-gray-500">${stream.limitedSemesters ? 'Advanced Semesters' : 'Bachelor\'s Degree'}</p>
        </div>
      </div>
      <div class="mt-4 flex justify-end">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${stream.color} ${stream.textColor}">
          Select <i class="fas fa-chevron-right ml-1 text-xs"></i>
        </span>
      </div>
    `;

    // Stream click handler
    streamBox.addEventListener("click", () => {
      console.log("🔍 Stream clicked:", stream.name);
      
      selectedStream = stream.name;
      
      document.getElementById("homePage").classList.add("hidden");
      semesterSection.classList.remove("hidden");
      semesterSection.innerHTML = "";

      // Create header
      const header = document.createElement("header");
      header.className = "w-full bg-white shadow-md border-b border-gray-200 px-4 py-3 mb-0";
      header.innerHTML = `
        <div class="flex items-center justify-between max-w-7xl mx-auto">
          <button onclick="goToStreamsHome()" class="w-8 h-8 rounded-full bg-gradient-to-r from-white to-blue-100 hover:from-blue-50 hover:to-blue-200 border border-blue-300 flex items-center justify-center transition-all duration-200 active:scale-95">
            <i class="fa-solid fa-angle-left text-blue-600 text-xs"></i>
          </button>
          <div class="flex items-center space-x-3">
            <div class="text-center">
              <p class="text-xs text-gray-500">Selected Stream</p>
              <p class="text-sm font-bold text-gray-800">${displayName}</p>
            </div>
          </div>
          <div class="w-8 h-8"></div>
        </div>
      `;

      const container = document.createElement("div");
      container.className = "min-h-screen bg-gray-50 px-4 py-6";

      semesterSection.appendChild(header);
      semesterSection.appendChild(container);

      const semesterGrid = document.createElement("div");
      semesterGrid.className = "max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 px-2 sm:px-4";

      const semesterColors = [
        { bg: 'bg-red-500', light: 'bg-red-50', border: 'border-red-200', text: 'text-red-600' },
        { bg: 'bg-blue-500', light: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-600' },
        { bg: 'bg-green-500', light: 'bg-green-50', border: 'border-green-200', text: 'text-green-600' },
        { bg: 'bg-purple-500', light: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-600' },
        { bg: 'bg-indigo-500', light: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-600' },
        { bg: 'bg-pink-500', light: 'bg-pink-50', border: 'border-pink-200', text: 'text-pink-600' }
      ];

      // ✅ Generate semester cards based on stream type
      let semestersToShow;
      if (stream.limitedSemesters) {
        // BCom Section B shows only semesters 5 and 6
        semestersToShow = stream.limitedSemesters;
      } else {
        // All other streams show semesters 1-6
        semestersToShow = [1, 2, 3, 4, 5, 6];
      }

      semestersToShow.forEach((sem, index) => {
        const color = semesterColors[index];
        const semBox = document.createElement("div");
        
        semBox.className = `group bg-white rounded-xl p-4 sm:p-6 shadow-md border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer ${color.light} hover:${color.border}`;

        semBox.innerHTML = `
          <div class="flex items-center space-x-3 sm:space-x-4">
            <div class="flex-shrink-0">
              <div class="w-14 h-14 sm:w-16 sm:h-16 ${color.bg} rounded-xl flex items-center justify-center shadow-md group-hover:scale-110 transition-transform duration-300">
                <span class="text-xl sm:text-2xl font-bold text-white">${sem}</span>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-1">
                Semester ${sem}
              </h3>
              <p class="text-xs sm:text-sm text-gray-600 mb-2">
                ${stream.name === 'BCom Section B' ? 'Section B Stream' : (stream.name === 'BCom' ? 'Section A Stream' : stream.name + ' Program')}
              </p>
              <div class="flex items-center justify-end">
                <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <i class="fas fa-arrow-right ${color.text} text-sm"></i>
                </div>
              </div>
            </div>
          </div>
        `;

        semBox.onclick = () => {
          console.log(`📚 Semester clicked: ${sem}`);
          selectStream(stream.name, sem);
        };

        semesterGrid.appendChild(semBox);
      });

      container.appendChild(semesterGrid);

      const footer = document.createElement("div");
      footer.className = "mt-8 text-center";
      footer.innerHTML = `
        <p class="text-sm text-gray-500">
          <i class="fas fa-graduation-cap mr-2"></i>
          Select a semester to manage attendance
        </p>
      `;

      container.appendChild(footer);
      
      console.log("✅ Semester section created and shown");
    });

    streamSection.appendChild(streamBox);
  });

  // Set today's date as default
  const today = new Date().toISOString().split("T")[0];
  const dateInput = document.getElementById("date");
  if (dateInput) {
    dateInput.value = today;
    dateInput.max = today;
    
    dateInput.addEventListener('input', function() {
      const selectedDate = this.value;
      if (selectedDate > today) {
        alert('WARNING: Future dates are not allowed for attendance marking!');
        this.value = today;
      }
    });
  }
});

// ✅ Make functions globally available
window.goToStreamsHome = goToStreamsHome;
window.updateCurrentSelectionDisplay = updateCurrentSelectionDisplay;
window.selectStream = selectStream;
window.showTab = showTab;
window.backToSemesters = backToSemesters;
window.loadSubjectsAndStudents = loadSubjectsAndStudents;




async function loadSubjectsAndStudents(stream, sem) {
  try {
    console.log(`🔄 Loading data for: ${stream} Sem ${sem}`);
    
    // ✅ FIXED: Fetch subjects with proper error handling
    const subjectsRes = await fetch(`/api/subjects/${stream}/sem${sem}`);
    
    if (!subjectsRes.ok) {
      throw new Error(`Failed to fetch subjects: ${subjectsRes.status} ${subjectsRes.statusText}`);
    }
    
    const subjectsData = await subjectsRes.json();
    console.log('📚 Subjects response:', subjectsData);
    
    // ✅ FIXED: Handle both response formats
    const subjects = subjectsData.subjects || subjectsData || [];
    
    // Clear and populate subject dropdowns
    subjectMark.innerHTML = '<option value="">-- Select Subject --</option>';
    subjectView.innerHTML = '<option value="">-- Select Subject --</option>';
    
    if (Array.isArray(subjects) && subjects.length > 0) {
      subjects.forEach(sub => {
        const subjectName = sub.subjectName || sub.name || sub;
        const markOption = new Option(subjectName, subjectName);
        const viewOption = new Option(subjectName, subjectName);
        subjectMark.appendChild(markOption);
        subjectView.appendChild(viewOption);
      });
      console.log(`✅ Populated ${subjects.length} subjects`);
    } else {
      console.warn('⚠️ No subjects found');
    }
    
    // ✅ FIXED: Prevent multiple event listeners
    if (!window.subjectChangeListenerAdded) {
      subjectMark.addEventListener("change", () => {
        const selectedSubject = subjectMark.value;
        if (selectedSubject) {
          const confirmSub = confirm(`📚 Confirm subject: "${selectedSubject}" for marking attendance?`);
          if (!confirmSub) subjectMark.value = "";
        }
      });
      window.subjectChangeListenerAdded = true;
    }
    
    // ✅ FIXED: Fetch students with proper error handling
    const studentsRes = await fetch(`/api/students/${stream}/sem${sem}`);
    
    if (!studentsRes.ok) {
      throw new Error(`Failed to fetch students: ${studentsRes.status} ${studentsRes.statusText}`);
    }
    
    const studentsData = await studentsRes.json();
    console.log('👥 Students response:', studentsData);
    
    // ✅ FIXED: Handle both response formats
    const students = studentsData.students || studentsData || [];
    
    // Clear students list
    studentsList.innerHTML = '';
    
    if (Array.isArray(students) && students.length > 0) {
      students.forEach((student, index) => {
        const serialNumber = index + 1;
        const studentID = student.studentID || student.id || 'N/A';
        const studentName = student.name || 'Unknown';
        
        // ✅ FIXED: Create table row properly
        const tableRow = document.createElement('tr');
        tableRow.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-100 transition duration-200`;
        
        tableRow.innerHTML = `
          <td class="p-3 border border-gray-300 text-[#0f172a] font-medium text-center">
            ${serialNumber}
          </td>
          <td class="p-3 border border-gray-300 text-[#0f172a] font-medium">
            ${studentID}
          </td>
          <td class="p-3 border border-gray-300 text-[#0f172a]">
            ${studentName}
          </td>
          <td class="p-3 border border-gray-300 text-center">
            <input 
              type="checkbox" 
              value="${studentID}" 
              checked 
              class="form-checkbox h-5 w-5 text-indigo-600 rounded focus:ring-indigo-400 transition duration-200"
            />
          </td>
        `;
        
        studentsList.appendChild(tableRow);
      });
      
      console.log(`✅ Populated ${students.length} students`);
    } else {
      // ✅ Show message when no students found
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" class="p-6 text-center text-gray-500">
            <i class="fas fa-users-slash text-4xl mb-2 text-gray-300"></i>
            <p>No students found for ${stream} Semester ${sem}</p>
            <p class="text-sm">Please check if students exist in the database.</p>
          </td>
        </tr>
      `;
      console.warn('⚠️ No students found');
    }
    
    // ✅ Show summary
    const subjectCount = subjects.length;
    const studentCount = students.length;
    console.log(`✅ Data loaded successfully: ${subjectCount} subjects, ${studentCount} students`);
    
    // ✅ Optional: Show alert if no data found
    if (subjectCount === 0 && studentCount === 0) {
      alert(`No data found for ${stream} Semester ${sem}. Please check if the collection exists.`);
    }
    
  } catch (error) {
    console.error("❌ Error loading data:", error);
    
    // ✅ Show user-friendly error message
    alert(`Error loading data for ${stream} Semester ${sem}: ${error.message}`);
    
    // ✅ Clear UI on error
    if (subjectMark) subjectMark.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
    if (subjectView) subjectView.innerHTML = '<option value="">-- Error Loading Subjects --</option>';
    if (studentsList) {
      studentsList.innerHTML = `
        <tr>
          <td colspan="4" class="p-6 text-center text-red-500">
            <i class="fas fa-exclamation-triangle text-4xl mb-2"></i>
            <p>Error loading students: ${error.message}</p>
          </td>
        </tr>
      `;
    }
  }
}

// ✅ FIXED: Make functions globally available
window.goToStreamsHome = goToStreamsHome;
window.updateCurrentSelectionDisplay = updateCurrentSelectionDisplay;
window.selectStream = selectStream;
window.showTab = showTab;
window.backToSemesters = backToSemesters;
window.loadSubjectsAndStudents = loadSubjectsAndStudents;

  

  // Enhanced helper functions
  // Enhanced attendance existence check with better error handling
async function checkAttendanceExists(stream, sem, subject, date) {
  try {
    const response = await fetch(`/api/check-attendance/${stream}/sem${sem}/${subject}/${date}`);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const result = await response.json();
    return result.exists || false;
  } catch (error) {
    console.error("Error checking attendance:", error);
    return false;
  }
}

// Enhanced date validation
function isSunday(dateString) {
  const date = new Date(dateString);
  return date.getDay() === 0;
}

function isSaturday(dateString) {
  const date = new Date(dateString);
  return date.getDay() === 6;
}

function isWeekend(dateString) {
  return isSunday(dateString) || isSaturday(dateString);
}

// Enhanced Submit button with improved validation and confirmations
submitBtn.addEventListener("click", async () => {
  const subject = subjectMark.value;
  const date = document.getElementById("date").value;

  // Basic validation
  if (!subject || !date) {
    showAlert("Missing Information", "Please fill in both Date and Subject.", "error");
    return;
  }

  // Date validation - prevent future dates
  const today = new Date().toISOString().split("T")[0];
  if (date > today) {
    showAlert("Invalid Date", "Future dates are not allowed for attendance marking.", "error");
    return;
  }

  try {
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Checking...';

    // Check if attendance already exists
    const attendanceExists = await checkAttendanceExists(selectedStream, selectedSem, subject, date);
    
    if (attendanceExists) {
      const overwriteConfirm = await showConfirmDialog(
        "Attendance Already Exists",
        `Subject: ${subject}\nDate: ${date}\nClass: ${selectedStream} Semester ${selectedSem}\n\nAttendance has already been recorded for this subject and date.\nDo you want to OVERWRITE the existing attendance?\n\nWARNING: This will send new WhatsApp notifications to parents.`,
        "warning"
      );
      
      if (!overwriteConfirm) {
        showAlert("Cancelled", "Attendance submission cancelled.", "info");
        return;
      }
    }

    // Check for weekend
    if (isWeekend(date)) {
      const dayName = isSunday(date) ? "SUNDAY" : "SATURDAY";
      const weekendConfirm = await showConfirmDialog(
        "Weekend Alert",
        `The selected date (${date}) falls on a ${dayName}.\n\nAre you sure you want to mark attendance for a weekend?\nThis is unusual for regular classes.`,
        "warning"
      );
      
      if (!weekendConfirm) {
        showAlert("Cancelled", "Please select a different date.", "info");
        return;
      }
    }

    // Final confirmation with student count
    const totalStudents = document.querySelectorAll("#students-list input[type='checkbox']").length;
    const presentStudents = document.querySelectorAll("#students-list input:checked").length;
    const absentStudents = totalStudents - presentStudents;

    const finalConfirm = await showConfirmDialog(
      "Confirm Submission",
      `Subject: ${subject}\nDate: ${date}\nClass: ${selectedStream} Semester ${selectedSem}\n\nTotal Students: ${totalStudents}\nPresent: ${presentStudents}\nAbsent: ${absentStudents}\n\nWhatsApp notifications will be sent to parents of absent students.\n\nDo you want to proceed?`,
      "info"
    );

    if (!finalConfirm) {
      showAlert("Cancelled", "Attendance submission cancelled.", "info");
      return;
    }

    // Prepare data
    const studentsPresent = Array.from(
      document.querySelectorAll("#students-list input:checked")
    ).map(cb => cb.value);

    // Submit attendance
    submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
    
    const res = await fetch(
      `/api/attendance/${selectedStream}/sem${selectedSem}/${subject}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ date, subject, studentsPresent })
      }
    );

    const result = await res.json();

    if (res.ok) {
      // Enhanced success message
      const { summary } = result;
      const successMessage = `Attendance Submitted Successfully!\n\nSummary:\nTotal Students: ${summary?.totalStudents || totalStudents}\nPresent: ${summary?.presentStudents || presentStudents}\nAbsent: ${summary?.absentStudents || absentStudents}\nWhatsApp Sent: ${summary?.whatsappSent || 'N/A'}${summary?.whatsappFailed > 0 ? `\nWhatsApp Failed: ${summary.whatsappFailed}` : ''}`;
      
      showAlert("Success", successMessage, "success");
      
      // Reset form
      subjectMark.value = "";
      document.getElementById("date").value = new Date().toISOString().split("T")[0];
      
    } else {
      showAlert("Submission Failed", result.message || "Unknown error occurred.", "error");
    }

  } catch (err) {
    console.error("Submission error:", err);
    showAlert("Network Error", "Failed to submit attendance. Please check your connection and try again.", "error");
  } finally {
    // Reset button state
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span class="check-icon"></span> Submit Attendance';
  }
});

// Enhanced save attendance changes function
async function saveAttendanceChanges() {
  const subject = subjectView.value;
  const saveBtn = document.getElementById("saveChangesBtn");

  if (!subject) {
    showAlert("Missing Subject", "Please select a subject.", "error");
    return;
  }

  try {
    // Show loading state
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';

    const confirmUpdate = await showConfirmDialog(
      "Confirm Update",
      `Subject: ${subject}\n\nThis will overwrite the existing attendance data.\nAre you sure you want to continue?`,
      "warning"
    );

    if (!confirmUpdate) {
      showAlert("Cancelled", "Update cancelled.", "info");
      return;
    }

    const rows = document.querySelectorAll("#view-tbody tr");
    const headers = Array.from(document.querySelectorAll("#view-thead th"))
      .slice(2, -3)
      .map(th => th.textContent.trim());

    const attendanceMap = {};
    headers.forEach(date => (attendanceMap[date] = []));

    rows.forEach(row => {
      const studentID = row.dataset.studentId;
      const checkboxes = row.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach((cb, i) => {
        if (cb.checked) attendanceMap[headers[i]].push(studentID);
      });
    });

    const res = await fetch(`/api/update-attendance/${selectedStream}/sem${selectedSem}/${subject}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ attendanceMap })
    });

    const result = await res.json();

    if (res.ok) {
      showAlert("Success", "Attendance updated successfully.", "success");
      saveBtn.classList.add("hidden");
      subjectView.dispatchEvent(new Event("change"));
    } else {
      showAlert("Update Failed", result.message || "Unknown error occurred.", "error");
    }

  } catch (err) {
    console.error("Update error:", err);
    showAlert("Network Error", "Failed to update attendance. Please try again.", "error");
  } finally {
    // Reset button state
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<span class="save-icon"></span> Save Changes';
  }
}

// Clean alert and confirmation functions
function showAlert(title, message, type = "info") {
  const prefixes = {
    success: "SUCCESS: ",
    error: "ERROR: ",
    warning: "WARNING: ",
    info: "INFO: "
  };
  
  alert(`${prefixes[type]}${title}\n\n${message}`);
}

async function showConfirmDialog(title, message, type = "info") {
  const prefixes = {
    success: "SUCCESS: ",
    error: "ERROR: ",
    warning: "WARNING: ",
    info: "CONFIRM: "
  };
  
  return confirm(`${prefixes[type]}${title}\n\n${message}`);
}

// Make functions globally available
window.checkAttendanceExists = checkAttendanceExists;
window.saveAttendanceChanges = saveAttendanceChanges;
window.showAlert = showAlert;
window.showConfirmDialog = showConfirmDialog;

  
subjectView.addEventListener("change", () => {
  const subject = subjectView.value;
  const registerTable = document.getElementById("registerTable");
  const saveBtn = document.getElementById("saveChangesBtn");
  const exportExcelBtn = document.getElementById("exportExcelBtn");

  registerTable.classList.add("hidden");
  saveBtn.classList.add("hidden");
  if (exportExcelBtn) exportExcelBtn.classList.add("hidden");
});

document.getElementById("loadRegisterBtn").addEventListener("click", async () => {
  const subject = subjectView.value;
  const registerTable = document.getElementById("registerTable");
  const saveBtn = document.getElementById("saveChangesBtn");
  const exportExcelBtn = document.getElementById("exportExcelBtn");
  const loadBtn = document.getElementById("loadRegisterBtn");

  if (!subject) {
    alert("ERROR: Please select a subject.");
    return;
  }

  try {
    // Show loading state
    loadBtn.disabled = true;
    loadBtn.innerHTML = '<span class="loading-spinner"></span> Loading...';

    const res = await fetch(`/api/attendance-register/${selectedStream}/sem${selectedSem}/${subject}`);
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const { students, attendanceMap } = await res.json();
    const dates = Object.keys(attendanceMap).sort();

    // Create table header
    viewThead.innerHTML = `
    <tr class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white">
      <th class="p-3 text-center font-bold text-sm">#</th>
      <th class="p-3 text-left font-bold text-sm sticky-student-id-header">Student ID</th>
      <th class="p-3 text-left font-bold text-sm">Name</th>
      ${dates.map(d => {
        const dateObj = new Date(d);
        const displayDate = dateObj.toLocaleDateString('en-GB').replace(/\//g, '-');
        const title = dateObj.toLocaleDateString('en-IN', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
        
        return `<th class="p-2 text-center font-semibold text-xs min-w-12" data-date="${d}" title="${title}">${displayDate}</th>`;
      }).join('')}
      
      <th class="p-3 text-center font-bold bg-gray-700 text-xs">Total</th>
      <th class="p-3 text-center font-bold bg-blue-700 text-xs">Present</th>
      <th class="p-3 text-center font-bold bg-green-700 text-xs">%</th>
    </tr>
  `;

    // Create table body
    viewTbody.innerHTML = "";
    students.forEach((stu, index) => {
      let attended = 0;
      const row = [];

      // Serial Number Column
      row.push(`<td class="p-3 text-center font-medium">${index + 1}</td>`);

      // Student ID Column
     // Student ID Column (Sticky/Fixed)
row.push(`
<td class="p-3 font-medium sticky-student-id">
  <span class="text-xs font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-md whitespace-nowrap">${stu.studentID}</span>
</td>
`);


      // Student Name Column
      row.push(`
        <td class="p-3 font-medium">
          <span class="text-gray-800 text-sm">${stu.name}</span>
        </td>
      `);

      // Attendance columns
      dates.forEach(date => {
        const present = attendanceMap[date]?.includes(stu.studentID);
        if (present) attended++;
        row.push(`
          <td class="p-2 text-center">
            <input 
              type="checkbox" 
              ${present ? "checked" : ""} 
              data-date="${date}"
              class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-400 transition duration-200"
              onchange="markUnsavedChanges()"
            />
          </td>
        `);
      });

      const total = dates.length;
      const percentage = total ? ((attended / total) * 100).toFixed(1) : "0.0";
      const percentClass = percentage < 75 ? 'text-red-600 bg-red-50' : 
                          percentage >= 85 ? 'text-green-600 bg-green-50' : 
                          'text-yellow-600 bg-yellow-50';

      // Summary columns
      row.push(`<td class="p-3 text-center font-semibold text-gray-700 bg-gray-50">${total}</td>`);
      row.push(`<td class="p-3 text-center font-semibold text-blue-600 bg-blue-50">${attended}</td>`);
      row.push(`<td class="p-3 text-center font-bold ${percentClass} rounded-md">${percentage}%</td>`);

      viewTbody.innerHTML += `
        <tr class="hover:bg-indigo-50 transition duration-200">
          ${row.join("")}
        </tr>
      `;
    });

    registerTable.classList.remove("hidden");
    saveBtn.classList.remove("hidden");
    if (exportExcelBtn) exportExcelBtn.classList.remove("hidden");

    // Show success message
    const totalStudents = students.length;
    const avgAttendance = students.length > 0 ?
      (students.reduce((sum, stu) => {
        const attendedCount = dates.filter(date => attendanceMap[date]?.includes(stu.studentID)).length;
        return sum + (dates.length > 0 ? (attendedCount / dates.length) * 100 : 0);
      }, 0) / students.length).toFixed(1) : 0;

    alert(`SUCCESS: Register loaded successfully!\n\nStudents: ${totalStudents}\nDays: ${dates.length}\nAverage Attendance: ${avgAttendance}%`);

  } catch (err) {
    console.error("Error loading attendance register:", err);
    alert("ERROR: Something went wrong while loading the register. Please try again.");
  } finally {
    // Reset button state
    loadBtn.disabled = false;
    loadBtn.innerHTML = 'Load Register';
  }
});

// Helper function to mark unsaved changes
function markUnsavedChanges() {
  const saveBtn = document.getElementById("saveChangesBtn");
  if (saveBtn) {
    saveBtn.classList.remove("hidden");
    saveBtn.classList.add("animate-pulse", "bg-orange-500", "hover:bg-orange-600");
    saveBtn.classList.remove("bg-indigo-500", "hover:bg-indigo-600");
    saveBtn.innerHTML = 'Save Changes *';
  }
}

  
  // Excel export functionality
  const exportExcelBtn = document.getElementById("exportExcelBtn");
  
  if (exportExcelBtn) {
    exportExcelBtn.addEventListener("click", () => {
      const table = document.querySelector("#registerTable table");
      if (!table) {
        alert("No table found to export!");
        return;
      }
  
      const originalText = exportExcelBtn.innerHTML;
      exportExcelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
      exportExcelBtn.disabled = true;
  
      try {
        const clonedTable = table.cloneNode(true);
        
        // Process headers and dates
        const headerRows = clonedTable.querySelectorAll("thead tr");
        
        // Update subject header row
        if (headerRows[0]) {
          const subjectCell = headerRows.querySelector("th");
          if (subjectCell) {
            subjectCell.textContent = `${subjectView.value} - ${selectedStream} Semester ${selectedSem}`;
            subjectCell.style.fontWeight = 'bold';
            subjectCell.style.fontSize = '16px';
            subjectCell.style.textAlign = 'center';
            subjectCell.style.backgroundColor = '#4F46E5';
            subjectCell.style.color = 'white';
          }
        }
        
        // Show only date without day name
        if (headerRows[1]) {
          const dateHeaders = headerRows[1].querySelectorAll("th");
          dateHeaders.forEach((cell, index) => {
            if (index > 1 && cell.dataset?.date) {
              const date = new Date(cell.dataset.date);
              if (!isNaN(date.getTime())) {
                // Show only DD/MM/YY format without day name
                cell.textContent = date.toLocaleDateString('en-IN', {
                  day: '2-digit',
                  month: '2-digit',
                  year: '2-digit'
                });
              }
            }
          });
        }
  
        // Process data rows with enhanced formatting
        const rows = clonedTable.querySelectorAll("tbody tr");
        const studentStats = [];
        
        rows.forEach((row, rowIndex) => {
          const cells = row.querySelectorAll("td");
          let attended = 0;
          let totalDays = 0;
          
          // Extract student info
          const studentIDElement = cells[0]?.querySelector('span:last-child');
          const studentNameElement = cells[1]?.querySelector('span:last-child');
          
          const studentID = studentIDElement?.textContent?.trim() || `Student ${rowIndex + 1}`;
          const studentName = studentNameElement?.textContent?.trim() || 'Unknown';
  
          // Clean up student ID and name cells for Excel
          if (cells[0]) {
            cells[0].textContent = studentID;
            cells.style.fontWeight = 'bold';
            cells.style.textAlign = 'center';
          }
          if (cells[1]) {
            cells[1].textContent = studentName;
            cells[1].style.textAlign = 'left';
          }
  
          // Process attendance cells - show "Present"/"Absent"
          cells.forEach((cell, cellIndex) => {
            const checkbox = cell.querySelector("input[type='checkbox']");
            
            if (checkbox) {
              totalDays++;
              const isPresent = checkbox.checked;
              if (isPresent) attended++;
              
              // Show "Present" or "Absent" instead of tick marks
              cell.textContent = isPresent ? "Present" : "Absent";
              cell.style.textAlign = 'center';
              cell.style.fontWeight = 'bold';
              
              // Color coding for better visibility
              if (isPresent) {
                cell.style.color = 'green';
                cell.style.backgroundColor = '#f0f9ff';
              } else {
                cell.style.color = 'red';
                cell.style.backgroundColor = '#fef2f2';
              }
            }
          });
  
          // Calculate percentage properly for 100%
          const percentage = totalDays > 0 ? ((attended / totalDays) * 100) : 0;
          
          studentStats.push({
            studentID,
            studentName,
            totalDays,
            attended,
            percentage: percentage.toFixed(1)
          });
  
          // Clean up and format summary cells
          const totalCell = cells[cells.length - 3]; // Total classes
          const attendedCell = cells[cells.length - 2]; // Attended classes
          const percentCell = cells[cells.length - 1]; // Percentage
  
          if (totalCell) {
            totalCell.textContent = totalDays;
            totalCell.style.fontWeight = 'bold';
            totalCell.style.textAlign = 'center';
            totalCell.style.backgroundColor = '#f3f4f6';
          }
          
          if (attendedCell) {
            attendedCell.textContent = attended;
            attendedCell.style.fontWeight = 'bold';
            attendedCell.style.textAlign = 'center';
            attendedCell.style.color = 'green';
            attendedCell.style.backgroundColor = '#f0f9ff';
          }
          
          if (percentCell) {
            // Show percentage out of 100% with proper formatting
            const percentText = `${percentage.toFixed(1)}%`;
            percentCell.textContent = percentText;
            percentCell.style.fontWeight = 'bold';
            percentCell.style.textAlign = 'center';
            
            // Color coding based on percentage ranges
            if (percentage >= 90) {
              percentCell.style.color = 'green';
              percentCell.style.backgroundColor = '#f0f9ff';
            } else if (percentage >= 75) {
              percentCell.style.color = 'orange';
              percentCell.style.backgroundColor = '#fffbeb';
            } else {
              percentCell.style.color = 'red';
              percentCell.style.backgroundColor = '#fef2f2';
            }
          }
        });
  
        // Generate filename and export
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-IN').replace(/\//g, '-');
        const timeStr = now.toLocaleTimeString('en-IN', { 
          hour12: false, 
          hour: '2-digit', 
          minute: '2-digit' 
        }).replace(/:/g, '');
        
        const filename = `${subjectView.value.replace(/[^\w\s]/g, '').replace(/\s+/g, '_')}_${selectedStream}_S${selectedSem}_${dateStr}_${timeStr}.xlsx`;
        
        // Create valid sheet name (max 31 characters)
        const cleanSubject = subjectView.value.replace(/[^\w\s]/g, '').replace(/\s+/g, '_');
        const sheetName = `${cleanSubject.substring(0, 20)}_${selectedStream}`.substring(0, 31);
        
        // Create workbook with enhanced formatting
        const wb = XLSX.utils.table_to_book(clonedTable, { sheet: sheetName });
        
        // Add some styling to the worksheet
        const ws = wb.Sheets[sheetName];
        
        // Set column widths for better readability
        const colWidths = [
          { wch: 15 }, // Student ID
          { wch: 25 }, // Student Name
          ...Array(studentStats[0]?.totalDays || 0).fill({ wch: 10 }), // Date columns
          { wch: 8 },  // Total
          { wch: 10 }, // Attended  
          { wch: 10 }  // Percentage
        ];
        ws['!cols'] = colWidths;
        
        // Export the file
        XLSX.writeFile(wb, filename);
        
        // Success notification with detailed stats
        const avgAttendance = studentStats.length > 0 ? 
          (studentStats.reduce((sum, s) => sum + parseFloat(s.percentage), 0) / studentStats.length).toFixed(1) : 0;
        
        const excellentStudents = studentStats.filter(s => parseFloat(s.percentage) >= 90).length;
        const goodStudents = studentStats.filter(s => parseFloat(s.percentage) >= 75 && parseFloat(s.percentage) < 90).length;
        const needImprovementStudents = studentStats.filter(s => parseFloat(s.percentage) < 75).length;
        
        const successMsg = `✅ Excel exported successfully!
  
  📚 Subject: ${subjectView.value}
  📊 Statistics:
  • Total Students: ${studentStats.length}
  • Total Classes: ${studentStats[0]?.totalDays || 0}
  • Average Attendance: ${avgAttendance}%
  
  📈 Performance Breakdown:
  • Excellent (≥90%): ${excellentStudents} students
  • Good (75-89%): ${goodStudents} students  
  • Need Improvement (<75%): ${needImprovementStudents} students
  
  📁 File: ${filename}
  
  ✨ Export Features:
  • Shows "Present"/"Absent" (not tick marks)
  • Date format: DD/MM/YY only
  • Percentage calculated out of 100%
  • Color-coded cells for easy reading`;
        
        if (typeof showNotification === 'function') {
          showNotification(successMsg, 'success');
        } else {
          alert(successMsg);
        }
  
        console.log(`📊 Excel Export Completed:
        - File: ${filename}
        - Sheet: ${sheetName}
        - Students: ${studentStats.length}
        - Classes: ${studentStats[0]?.totalDays || 0}
        - Average Attendance: ${avgAttendance}%
        - Performance: ${excellentStudents} excellent, ${goodStudents} good, ${needImprovementStudents} need improvement`);
        
      } catch (error) {
        console.error('❌ Error exporting Excel:', error);
        alert('❌ Error exporting Excel file: ' + error.message);
      } finally {
        exportExcelBtn.innerHTML = originalText;
        exportExcelBtn.disabled = false;
      }
    });
  }
  
  // Subject management functionality
  let subjectsToAdd = [];
  
  // Add subject to list with validation
  function addSubjectToList() {
    const subjectInput = document.getElementById('newSubject');
    const subjectName = subjectInput.value.trim();
    
    if (!subjectName) {
      alert('❌ Subject name cannot be empty');
      return;
    }
    
    if (subjectName.length < 2) {
      alert('❌ Subject name must be at least 2 characters long');
      return;
    }
    
    if (subjectsToAdd.some(s => s.toLowerCase() === subjectName.toLowerCase())) {
      alert('⚠️ Subject already added to the list');
      return;
    }
    
    subjectsToAdd.push(subjectName);
    updateSubjectsList();
    subjectInput.value = '';
    subjectInput.focus();
    
    console.log('📚 Subject added to list:', subjectName);
    console.log('📚 Current subjects list:', subjectsToAdd);
  }
  
  // Update subjects list display
  function updateSubjectsList() {
    const listDiv = document.getElementById('subjectsList');
    
    if (subjectsToAdd.length === 0) {
      listDiv.innerHTML = '<p class="text-gray-500 text-center py-8 text-lg">📚 No subjects added yet</p>';
      return;
    }
    
    listDiv.innerHTML = subjectsToAdd.map((subject, index) => `
      <div class="flex justify-between items-center p-4 bg-blue-50 rounded-xl border border-blue-200 hover:bg-blue-100 transition-all">
        <span class="font-semibold text-gray-800 text-lg">${subject}</span>
        <button onclick="removeSubject(${index})" class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-100 transition-all">
          <i class="fas fa-trash text-lg"></i>
        </button>
      </div>
    `).join('');
  }
  
  // Remove subject from list
  function removeSubject(index) {
    const subjectName = subjectsToAdd[index];
    subjectsToAdd.splice(index, 1);
    updateSubjectsList();
    console.log('🗑️ Subject removed:', subjectName);
  }
  
  // Enhanced: Save all subjects with comprehensive error handling
  async function saveAllSubjects() {
    console.log('💾 Starting to save subjects...');
    console.log('📚 Subjects to save:', subjectsToAdd);
    console.log('🎓 Stream:', promotionStream);
    console.log('📅 Semester:', promotionSemester);
    
    // Validation checks
    if (subjectsToAdd.length === 0) {
      alert('❌ No subjects to save. Please add at least one subject.');
      return;
    }
    
    if (!promotionStream || !promotionSemester) {
      alert('❌ Please select stream and semester first from the promotion section');
      return;
    }
    
    // Confirm before saving
    const confirmSave = confirm(`💾 Save ${subjectsToAdd.length} subjects for ${promotionStream} Semester ${promotionSemester}?
  
  Subjects to be added:
  ${subjectsToAdd.map(s => `• ${s}`).join('\n')}
  
  Continue?`);
    
    if (!confirmSave) {
      return;
    }
    
    // Show loading state
    const saveButton = document.querySelector('button[onclick="saveAllSubjects()"]');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    saveButton.disabled = true;
    
    try {
      console.log('🌐 Making API request to:', `/api/setup-subjects/${promotionStream}/sem${promotionSemester}`);
      
      const response = await fetch(`/api/setup-subjects/${promotionStream}/sem${promotionSemester}`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ 
          subjects: subjectsToAdd 
        })
      });
      
      console.log('📡 Response status:', response.status);
      console.log('📡 Response ok:', response.ok);
      
      const result = await response.json();
      console.log('📦 Response data:', result);
      
      if (response.ok && result.success) {
        // Success
        let successMessage = `✅ Subjects Setup Complete!\n\n`;
        successMessage += `Stream: ${result.stream}\n`;
        successMessage += `Semester: ${result.semester}\n`;
        successMessage += `Successfully Added: ${result.added}/${result.total}\n\n`;
        
        if (result.results) {
          const successful = result.results.filter(r => r.success);
          const failed = result.results.filter(r => !r.success);
          
          if (successful.length > 0) {
            successMessage += `✅ Successfully Added:\n${successful.map(s => `• ${s.subjectName}`).join('\n')}\n\n`;
          }
          
          if (failed.length > 0) {
            successMessage += `⚠️ Failed to Add:\n${failed.map(s => `• ${s.subjectName} (${s.error})`).join('\n')}`;
          }
        }
        
        alert(successMessage);
        
        // Clear the list
        subjectsToAdd = [];
        updateSubjectsList();
        
      } else {
        // API returned error
        throw new Error(result.message || 'Unknown server error');
      }
      
    } catch (error) {
      console.error('❌ Error saving subjects:', error);
      
      let errorMessage = '❌ Failed to save subjects!\n\n';
      
      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        errorMessage += 'Network Error: Unable to connect to server.\nPlease check your internet connection.';
      } else if (error.message.includes('404')) {
        errorMessage += 'API Route Not Found: The backend route might not be set up correctly.';
      } else if (error.message.includes('500')) {
        errorMessage += 'Server Error: Database or server configuration issue.';
      } else {
        errorMessage += `Error: ${error.message}`;
      }
      
      errorMessage += `\n\nDebugging Info:
  • Stream: ${promotionStream}
  • Semester: ${promotionSemester}
  • Subjects Count: ${subjectsToAdd.length}
  • Subjects: ${subjectsToAdd.join(', ')}`;
      
      alert(errorMessage);
      
    } finally {
      // Restore button state
      saveButton.innerHTML = originalText;
      saveButton.disabled = false;
    }
  }
  
  // Add Enter key support for adding subjects
  document.addEventListener('DOMContentLoaded', function() {
    const subjectInput = document.getElementById('newSubject');
    if (subjectInput) {
      subjectInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addSubjectToList();
        }
      });
    }
    
    // Initialize subjects list
    updateSubjectsList();
  });
  
</script>
<script type="module">
  // ✅ Import configuration from separate config file
  import { firebaseConfig, AUTHORIZED_TEACHERS } from './firebase-config.js';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // ✅ Use imported configuration
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  let authStateChecked = false;

  function showAuthLoading() {
    const loadingScreen = document.getElementById('authLoadingScreen');
    const mainContent = document.getElementById('mainContent');
    
    if (loadingScreen) loadingScreen.style.display = 'flex';
    if (mainContent) mainContent.style.display = 'none';
    
    console.log('🔄 Checking authentication state...');
  }

  function hideAuthLoading() {
    const loadingScreen = document.getElementById('authLoadingScreen');
    const mainContent = document.getElementById('mainContent');
    
    if (loadingScreen) loadingScreen.style.display = 'none';
    if (mainContent) mainContent.style.display = 'block';
  }

  function isAuthorizedUser(email) {
    return email && AUTHORIZED_TEACHERS.includes(email.toLowerCase());
  }

  onAuthStateChanged(auth, (user) => {
    console.log('🔐 Auth state changed:', {
      user: !!user,
      email: user?.email,
      authStateChecked: authStateChecked
    });

    authStateChecked = true;

    if (user) {
      const email = user.email;
      
      if (!email) {
        console.error('❌ User has no email, redirecting to login');
        window.location.href = "login.html";
        return;
      }

      if (!isAuthorizedUser(email)) {
        console.error('❌ Unauthorized user:', email);
        signOut(auth).then(() => {
          window.location.href = "login.html";
        });
        return;
      }

      console.log('✅ User authenticated successfully:', email);
      updateUserInterface(user, email);
      hideAuthLoading();

    } else {
      console.log('❌ No authenticated user, redirecting to login');
      setTimeout(() => {
        window.location.href = "login.html";
      }, 100);
    }
  });

  function updateUserInterface(user, email) {
    try {
      const userName = localStorage.getItem("userName") || user.displayName || email.split('@')[0];
      const avatarURL = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=8b5cf6&color=fff&size=64`;
      
      const userNameElement = document.getElementById("userName");
      const userEmailElement = document.getElementById("userEmail");
      const profilePicElement = document.getElementById("profilePic");
      
      if (userNameElement) userNameElement.textContent = userName;
      if (userEmailElement) userEmailElement.textContent = email;
      if (profilePicElement) {
        profilePicElement.src = avatarURL;
        profilePicElement.onerror = () => {
          profilePicElement.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><rect width="64" height="64" fill="%238b5cf6"/><text x="50%" y="50%" fill="white" text-anchor="middle" dy=".3em" font-family="Arial" font-size="24">👨‍🏫</text></svg>';
        };
      }

      localStorage.setItem("userName", userName);
      localStorage.setItem("userEmail", email);

    } catch (error) {
      console.error('❌ Error updating UI:', error);
    }
  }

  window.logout = async () => {
    try {
      console.log('👋 Logging out user...');
      await signOut(auth);
      localStorage.clear();
      window.location.href = "login.html";
    } catch (error) {
      console.error('❌ Logout error:', error);
      localStorage.clear();
      window.location.href = "login.html";
    }
  };

  // Initialize
  showAuthLoading();

  // Timeout fallback
  setTimeout(() => {
    if (!authStateChecked) {
      console.warn('⚠️ Auth state check timeout, redirecting to login');
      window.location.href = "login.html";
    }
  }, 10000);

  console.log('🛡️ Main page auth system initialized');
  function goToStreamsHome() {
    console.log('🏠 Home button clicked'); // Debug log
    
    try {
      // Hide all attendance sections
      const elementsToHide = ['markTab', 'viewTab', 'tabs', 'semesterSection'];
      elementsToHide.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.classList.add('hidden');
          console.log(`✅ Hidden: ${id}`);
        } else {
          console.log(`❌ Element not found: ${id}`);
        }
      });
      
      // Show home page
      const homePage = document.getElementById('homePage');
      if (homePage) {
        homePage.classList.remove('hidden');
        homePage.style.display = 'block'; // Ensure it's visible
        console.log('✅ Home page shown');
      } else {
        console.log('❌ Home page element not found');
      }
      
      // Reset global variables
      selectedStream = '';
      selectedSem = '';
      
      // Clear form inputs safely
      const elementsToReset = [
        'subject-mark',
        'subject-view', 
        'students-list',
        'date'
      ];
      
      elementsToReset.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (element.tagName === 'SELECT' || element.tagName === 'INPUT') {
            element.value = '';
          } else {
            element.innerHTML = '';
          }
        }
      });
      
      // Reset date to today
      const dateInput = document.getElementById('date');
      if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
      
      console.log('🎉 Successfully navigated to home');
      
    } catch (error) {
      console.error('❌ Error in goToStreamsHome:', error);
      alert('Error navigating to home. Check console for details.');
    }
  }
  
</script>



</body>
</html>
