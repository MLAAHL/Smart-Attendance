<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Attendance Report</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <!-- SheetJS for Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #060D0C 0%, #2A3B36 100%);
      min-height: 100vh;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #060D0C;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .percentage-excellent { color: #10b981; font-weight: bold; }
    .percentage-good { color: #f59e0b; font-weight: bold; }
    .percentage-poor { color: #ef4444; font-weight: bold; }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success { background: #10b981; }
    .notification.error { background: #ef4444; }
    .notification.warning { background: #f59e0b; }
    .notification.info { background: #3b82f6; }
  </style>
</head>

<body>
  <div class="min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header -->
      <div class="text-center mb-12 animate-fade-in">
        <!-- Back Button -->
        <div class="flex justify-start mb-6">
          <button onclick="window.location.href='myclass.html'" class="inline-flex items-center px-4 py-2 rounded-lg transition-all duration-200 hover:scale-105 backdrop-blur-sm border" style="background-color: rgba(240, 237, 229, 0.1); color: #F0EDE5; border-color: rgba(240, 237, 229, 0.2);" onmouseover="this.style.backgroundColor='rgba(240, 237, 229, 0.2)'" onmouseout="this.style.backgroundColor='rgba(240, 237, 229, 0.1)'">
            <i class="fas fa-arrow-left mr-2"></i>
            <span class="font-medium">Back to Classes</span>
          </button>
        </div>
        
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full shadow-lg mb-6" style="background-color: #F0EDE5;">
          <i class="fas fa-chart-bar text-3xl" style="color: #060D0C;"></i>
        </div>
        <h1 class="text-4xl font-bold mb-4" style="color: #F0EDE5;">Student Attendance Report</h1>
        <p class="text-xl max-w-2xl mx-auto" style="color: #F0EDE5; opacity: 0.8;">
          View attendance percentage for each student in each subject
        </p>
      </div>

      <!-- Filter Panel -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover animate-fade-in">
        <h2 class="text-2xl font-bold mb-6" style="color: #060D0C;">
          <i class="fas fa-filter mr-3" style="color: #060D0C;"></i>Generate Report
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  
          <!-- Academic Stream Selection -->
          <div class="space-y-4">
            <label class="block text-sm font-bold text-slate-700 mb-4">
              <i class="fas fa-university mr-2" style="color: #060D0C;"></i>Academic Stream
            </label>
            <select id="reportStream" class="w-full px-4 py-4 border-2 rounded-xl focus:ring-4 transition-all text-lg" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
              <option value="">Select Academic Stream</option>
              <option value="BCA">BCA - Computer Applications</option>
              <option value="BBA">BBA - Business Administration</option>
              <option value="BCom">BCom - Commerce (Section A)</option>
              <option value="BCom Section B">BCom Section B - Commerce</option>
              <option value="BCom-BDA">BCom-BDA - Big Data Analytics</option>
              <option value="BCom A and F">BCom A&F - Accounting & Finance</option>
            </select>
          </div>
          
          <!-- Semester Selection -->
          <div class="space-y-4">
            <label class="block text-sm font-bold text-slate-700 mb-4">
              <i class="fas fa-layer-group mr-2" style="color: #060D0C;"></i>Semester Level
            </label>
            <select id="reportSemester" class="w-full px-4 py-4 border-2 rounded-xl focus:ring-4 transition-all text-lg" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
              <option value="">Select Semester</option>
              <option value="1">First Semester</option>
              <option value="2">Second Semester</option>
              <option value="3">Third Semester</option>
              <option value="4">Fourth Semester</option>
              <option value="5">Fifth Semester</option>
              <option value="6">Sixth Semester</option>
            </select>
          </div>
          
          <div class="flex items-end">
            <button onclick="generateReport()" id="generateBtn" class="w-full text-white px-8 py-4 rounded-xl transition-all duration-300 font-semibold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" style="background: linear-gradient(to right, #060D0C, #2A3B36);" onmouseover="this.style.background='linear-gradient(to right, #2A3B36, #060D0C)'" onmouseout="this.style.background='linear-gradient(to right, #060D0C, #2A3B36)'" disabled>
              <i class="fas fa-chart-line mr-2"></i>Generate Report
            </button>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div id="reportResults" class="hidden animate-fade-in">
        
        <!-- Export Button -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 text-center">
          <button onclick="exportToExcel()" class="text-white px-6 py-3 rounded-lg transition-all font-semibold mr-4" style="background-color: #060D0C;" onmouseover="this.style.backgroundColor='#2A3B36'" onmouseout="this.style.backgroundColor='#060D0C'">
            <i class="fas fa-file-excel mr-2"></i>Export to Excel
          </button>
          <button onclick="printReport()" class="text-white px-6 py-3 rounded-lg transition-all font-semibold" style="background-color: #2A3B36;" onmouseover="this.style.backgroundColor='#060D0C'" onmouseout="this.style.backgroundColor='#2A3B36'">
            <i class="fas fa-print mr-2"></i>Print Report
          </button>
        </div>

        <!-- Report Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold mb-6 text-center" style="color: #060D0C;" id="reportTitle">Student Attendance Report</h2>
            <p style="color: #8B9B8F;" id="reportInfo">Generated on: <span id="reportDate"></span></p>
          </div>
          
          <!-- Summary Stats -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="summaryCards">
            <!-- Dynamic summary cards -->
          </div>
        </div>

        <!-- Subject Headers -->
        <div class="text-white rounded-t-2xl p-6" style="background: linear-gradient(to right, #060D0C, #2A3B36);">
          <h3 class="text-2xl font-bold text-center">üìö Subjects</h3>
          <div id="subjectHeaders" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-4">
            <!-- Dynamic subject headers -->
          </div>
        </div>

        <!-- Report Table -->
        <div class="bg-white rounded-b-2xl shadow-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table id="reportTable" class="w-full">
              <thead class="bg-gray-50">
                <tr id="tableHeader">
                  <th class="p-4 text-left font-semibold" style="color: #060D0C;">Student ID</th>
                  <th class="p-4 text-left font-semibold" style="color: #060D0C;">Student Name</th>
                  <!-- Dynamic subject columns -->
                </tr>
              </thead>
              <tbody id="tableBody">
                <!-- Dynamic student data -->
              </tbody>
            </table>
          </div>
        </div>
        
      </div>

    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <script>
    // Global variables
    let currentReportData = null;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìä Student Attendance Report System initialized');
    });
    
    // Generate Report
    async function generateReport() {
      const stream = document.getElementById('reportStream').value;
      const semester = document.getElementById('reportSemester').value;
      
      if (!stream || !semester) {
        showNotification('‚ùå Please select both Stream and Semester', 'error');
        return;
      }
      
      const generateBtn = document.getElementById('generateBtn');
      const originalText = generateBtn.innerHTML;
      generateBtn.innerHTML = '<div class="loading-spinner"></div>Generating Report...';
      generateBtn.disabled = true;
      
      try {
        console.log(`üìä Generating report for ${stream} Semester ${semester}`);
        
        const response = await fetch(`/api/reports/student-subject-report/${stream}/sem${semester}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Server responded with ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Failed to generate report');
        }
        
        currentReportData = data;
        displayReport(data);
        document.getElementById('reportResults').classList.remove('hidden');
        
        showNotification(`‚úÖ Report generated successfully! Found ${data.totalStudents} students`, 'success');
        
        // Scroll to results
        document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Error generating report:', error);
        showNotification('‚ùå Error: ' + error.message, 'error');
      } finally {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
      }
    }
    
    // Display Report
    function displayReport(data) {
      // Update report title and info
      document.getElementById('reportTitle').textContent = `${data.stream} Semester ${data.semester} - Attendance Report`;
      document.getElementById('reportDate').textContent = data.reportDate;
      
      // Display summary cards
      displaySummaryCards(data);
      
      // Display subject headers
      displaySubjectHeaders(data.subjects);
      
      // Display report table
      displayReportTable(data);
    }
    
    // Display Summary Cards
    function displaySummaryCards(data) {
      const summaryCards = document.getElementById('summaryCards');
      
      // Calculate average attendance
      let totalPercentage = 0;
      let totalEntries = 0;
      
      data.students.forEach(student => {
        Object.values(student.subjects).forEach(subject => {
          totalPercentage += subject.percentage;
          totalEntries++;
        });
      });
      
      const avgAttendance = totalEntries > 0 ? (totalPercentage / totalEntries).toFixed(1) : 0;
      
      summaryCards.innerHTML = `
        <div class="text-center p-6 bg-blue-50 rounded-lg">
          <div class="text-3xl font-bold text-blue-600 mb-2">${data.totalStudents}</div>
          <div class="text-sm text-blue-700">Total Students</div>
        </div>
        
        <div class="text-center p-6 bg-green-50 rounded-lg">
          <div class="text-3xl font-bold text-green-600 mb-2">${data.totalSubjects}</div>
          <div class="text-sm text-green-700">Total Subjects</div>
        </div>
        
        <div class="text-center p-6 bg-purple-50 rounded-lg">
          <div class="text-3xl font-bold text-purple-600 mb-2">${avgAttendance}%</div>
          <div class="text-sm text-purple-700">Average Attendance</div>
        </div>
      `;
    }
    
    // Display Subject Headers
    function displaySubjectHeaders(subjects) {
      const subjectHeaders = document.getElementById('subjectHeaders');
      
      if (subjects.length === 0) {
        subjectHeaders.innerHTML = '<div class="col-span-full text-center text-white opacity-75">No subjects found</div>';
        return;
      }
      
      subjectHeaders.innerHTML = subjects.map(subject => `
        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
          <div class="font-semibold text-sm">${subject}</div>
        </div>
      `).join('');
    }
    
    // Display Report Table - Show Only Percentage
    function displayReportTable(data) {
      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');
      
      // Build table header
      let headerHTML = `
        <th class="p-4 text-left font-semibold text-gray-700">Student ID</th>
        <th class="p-4 text-left font-semibold text-gray-700">Student Name</th>
      `;
      
      data.subjects.forEach(subject => {
        headerHTML += `<th class="p-4 text-center font-semibold text-gray-700">${subject}</th>`;
      });
      
      tableHeader.innerHTML = headerHTML;
      
      // Build table body - ONLY PERCENTAGE
      let bodyHTML = '';
      
      if (data.students.length === 0) {
        bodyHTML = `
          <tr>
            <td colspan="${data.subjects.length + 2}" class="p-8 text-center text-gray-500">
              <i class="fas fa-users text-4xl mb-4 block"></i>
              No student data available
            </td>
          </tr>
        `;
      } else {
        data.students.forEach((student, index) => {
          const bgColor = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          
          let rowHTML = `
            <tr class="${bgColor} hover:bg-blue-50">
              <td class="p-4 font-medium text-gray-800">${student.studentID}</td>
              <td class="p-4 text-gray-800">${student.name}</td>
          `;
          
          data.subjects.forEach(subject => {
            const subjectData = student.subjects[subject];
            if (subjectData) {
              const percentage = subjectData.percentage;
              const percentageClass = getPercentageClass(percentage);
              
              rowHTML += `
                <td class="p-4 text-center">
                  <div class="${percentageClass}">${percentage}%</div>
                </td>
              `;
            } else {
              rowHTML += `
                <td class="p-4 text-center">
                  <div class="text-gray-400">N/A</div>
                </td>
              `;
            }
          });
          
          rowHTML += '</tr>';
          bodyHTML += rowHTML;
        });
      }
      
      tableBody.innerHTML = bodyHTML;
    }
    
    // Get Percentage Color Class
    function getPercentageClass(percentage) {
      if (percentage >= 85) return 'percentage-excellent';
      if (percentage >= 75) return 'percentage-good';
      return 'percentage-poor';
    }
    
    // Export to Excel - Only Percentage
    function exportToExcel() {
      if (!currentReportData) {
        showNotification('‚ùå Please generate a report first', 'error');
        return;
      }
    
      const wb = XLSX.utils.book_new();
      
      // Prepare data for Excel
      const excelData = [];
      
      // Header row
      const headers = ['Student ID', 'Student Name', ...currentReportData.subjects];
      excelData.push(headers);
      
      // Data rows - ONLY PERCENTAGE
      currentReportData.students.forEach(student => {
        const row = [student.studentID, student.name];
        currentReportData.subjects.forEach(subject => {
          const subjectData = student.subjects[subject];
          if (subjectData) {
            row.push(`${subjectData.percentage}%`);
          } else {
            row.push('N/A');
          }
        });
        excelData.push(row);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      XLSX.utils.book_append_sheet(wb, ws, 'Attendance Report');
      
      const filename = `Attendance_Report_${currentReportData.stream}_S${currentReportData.semester}_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, filename);
      
      showNotification(`‚úÖ Report exported to ${filename}`, 'success');
    }
    
    // Print Report
    function printReport() {
      if (!currentReportData) {
        showNotification('‚ùå Please generate a report first', 'error');
        return;
      }
      
      // Create print-only content with just the table
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Student Attendance Report</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              margin: 20px;
              background: white;
            }
            table { 
              width: 100%; 
              border-collapse: collapse; 
              margin: 20px 0;
            }
            th, td { 
              border: 1px solid #ddd; 
              padding: 12px; 
              text-align: left; 
            }
            th { 
              background-color: #f5f5f5; 
              font-weight: bold; 
              text-align: center;
            }
            .percentage-excellent { color: #10b981; font-weight: bold; }
            .percentage-good { color: #f59e0b; font-weight: bold; }
            .percentage-poor { color: #ef4444; font-weight: bold; }
            .student-id { font-weight: bold; }
            .center { text-align: center; }
            .print-title { 
              text-align: center; 
              font-size: 18px; 
              font-weight: bold; 
              margin-bottom: 20px; 
            }
          </style>
        </head>
        <body>
          <div class="print-title">
            ${currentReportData.stream} Semester ${currentReportData.semester} - Attendance Report<br>
            <small>Generated on: ${currentReportData.reportDate}</small>
          </div>
          
          <table>
            <thead>
              <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                ${currentReportData.subjects.map(subject => `<th>${subject}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${currentReportData.students.map((student, index) => `
                <tr style="${index % 2 === 0 ? 'background-color: #f9f9f9;' : ''}">
                  <td class="student-id">${student.studentID}</td>
                  <td>${student.name}</td>
                  ${currentReportData.subjects.map(subject => {
                    const subjectData = student.subjects[subject];
                    if (subjectData) {
                      const percentage = subjectData.percentage;
                      const percentageClass = getPercentageClass(percentage);
                      return `<td class="center ${percentageClass}">${percentage}%</td>`;
                    } else {
                      return `<td class="center">N/A</td>`;
                    }
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
        </html>
      `;
      
      // Create new window and print
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
      
      showNotification('üìÑ Print dialog opened', 'info');
    }
    
    // Show Notification
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer') || document.body;
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" style="margin-left: 16px; color: white; background: none; border: none; font-size: 16px; cursor: pointer;">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      container.appendChild(notification);
      
      // Show notification
      setTimeout(() => notification.classList.add('show'), 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        generateReport();
      }
      
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        if (currentReportData) exportToExcel();
      }
      
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        if (currentReportData) printReport();
      }
    });
    
  </script>
    
</body>
</html>
