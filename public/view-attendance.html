<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Attendance - Smart Attendance</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="demo.css">

  <!-- Inline Styles -->
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(125deg, #F0EDE5 0%, #E8E3D8 95%);
      background-size: cover;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    .glass {
      background: rgba(255,255,255,0.14);
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
      backdrop-filter: blur(13px);
      -webkit-backdrop-filter: blur(13px);
      border-radius: 1.4rem;
      border: 1.8px solid rgba(255,255,255,0.18);
    }
    
    /* Checkbox styling for edit mode - matching index.html and overriding Tailwind */
    .checkbox {
      width: 16px !important;
      height: 16px !important;
      accent-color: #2A3B36 !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      appearance: auto !important;
      -webkit-appearance: auto !important;
      -moz-appearance: auto !important;
      display: inline-block !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
      margin: 0 !important;
      padding: 0 !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.25rem !important;
      background-color: white !important;
    }

    .checkbox:hover {
      transform: scale(1.1) !important;
    }

    .checkbox:checked {
      background-color: #2A3B36 !important;
      border-color: #2A3B36 !important;
    }
    
    /* Enhanced checkbox styling (alternative) */
    .attendance-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #8B9B8F;
      border-radius: 6px;
      background-color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      margin: 0;
      padding: 0;
      display: inline-block;
      vertical-align: middle;
    }
    
    .attendance-checkbox:checked {
      background-color: #2A3B36;
      border-color: #2A3B36;
      color: white;
    }
    
    .attendance-checkbox:checked::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 14px;
      line-height: 1;
    }
    
    .attendance-checkbox:hover {
      border-color: #2A3B36;
      box-shadow: 0 0 0 3px rgba(42, 59, 54, 0.1);
      transform: scale(1.05);
    }
    
    .attendance-checkbox:focus {
      outline: none;
      border-color: #2A3B36;
      box-shadow: 0 0 0 3px rgba(42, 59, 54, 0.2);
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            customDark: '#060D0C',
            customLight: '#F0EDE5',
            customAccent: '#2A3B36',
            customMuted: '#8B9B8F',
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen">
  
  <div class="p-2 sm:p-4">
    <div id="viewTab" class="tabcontent p-2 sm:p-4">
      <!-- Mobile-optimized header -->
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold flex items-center" style="color: #060D0C;">
          <i class="fas fa-table mr-2 text-sm" style="color: #060D0C;"></i>
          Register
        </h3>
        <!-- Back to My Class button -->
        <button onclick="window.location.href='myclass.html'" class="px-3 py-1 text-xs rounded-lg transition-all" style="background-color: #F0EDE5; color: #060D0C; border: 1px solid #8B9B8F;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='#F0EDE5'">
          <i class="fas fa-arrow-left mr-1"></i>My Class
        </button>
      </div>
    
      <!-- Stream/Semester/Subject selection -->
      <div class="space-y-3 mb-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label for="streamSelect" class="block text-xs font-medium mb-1" style="color: #8B9B8F;">Select Stream</label>
            <select id="streamSelect" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
              <option value="">-- Select Stream --</option>
            </select>
          </div>
          <div>
            <label for="semesterSelect" class="block text-xs font-medium mb-1" style="color: #8B9B8F;">Select Semester</label>
            <select id="semesterSelect" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
              <option value="">-- Select Semester --</option>
            </select>
          </div>
        </div>
        <div>
          <label for="subjectSelect" class="block text-xs font-medium mb-1" style="color: #8B9B8F;">Select Subject</label>
          <select id="subjectSelect" class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" style="border-color: #8B9B8F; color: #060D0C;" onfocus="this.style.borderColor='#2A3B36'" onblur="this.style.borderColor='#8B9B8F'">
            <option value="">-- Select Subject --</option>
          </select>
        </div>
        <button id="loadRegisterBtn" class="w-full sm:w-auto px-4 py-2 text-white rounded-lg text-sm font-medium transition-all" style="background: linear-gradient(to right, #060D0C, #2A3B36);" onmouseover="this.style.background='linear-gradient(to right, #2A3B36, #060D0C)'" onmouseout="this.style.background='linear-gradient(to right, #060D0C, #2A3B36)'">
          <i class="fas fa-search mr-2"></i>Load Attendance Register
        </button>
      </div>

      <!-- Register display -->
      <div id="registerTable" class="hidden">
        <!-- View mode selector -->
        <div class="bg-white rounded-lg p-4 mb-4 border" style="border-color: #F0EDE5;">
          <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
            <div class="flex-1">
              <label class="block text-xs font-medium mb-2" style="color: #8B9B8F;">View Mode</label>
              <div class="flex gap-2">
                <button id="fullRegisterBtn" class="px-3 py-2 text-xs font-medium rounded-lg transition-all" style="background-color: #2A3B36; color: white;">
                  <i class="fas fa-table mr-1"></i>Full Register
                </button>
                <button id="singleDateBtn" class="px-3 py-2 text-xs font-medium rounded-lg transition-all" style="background-color: #F0EDE5; color: #060D0C;">
                  <i class="fas fa-calendar-day mr-1"></i>Single Date
                </button>
              </div>
            </div>
            <div id="dateSelector" class="flex-1 hidden">
              <label for="specificDateInput" class="block text-xs font-medium mb-2" style="color: #8B9B8F;">Select Date</label>
              <input 
                type="date" 
                id="specificDateInput" 
                class="w-full p-2 text-sm border rounded-lg focus:ring-2 bg-white" 
                style="border-color: #8B9B8F; color: #060D0C;" 
                onfocus="this.style.borderColor='#2A3B36'" 
                onblur="this.style.borderColor='#8B9B8F'"
              />
              <div id="dateValidationMessage" class="text-xs mt-1 hidden">
                <span id="attendanceStatus" class="flex items-center gap-1">
                  <i class="fas fa-info-circle"></i>
                  <span id="statusText">Select a date to check attendance</span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="flex justify-end gap-2 mb-3">
          <button id="editAttendanceBtn" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-white rounded-lg text-xs sm:text-sm font-medium hidden transition-all" style="background-color: #2A3B36;" onmouseover="this.style.backgroundColor='#060D0C'" onmouseout="this.style.backgroundColor='#2A3B36'">
            <i class="fas fa-edit text-sm mr-1"></i>
            <span class="hidden sm:inline">Edit Attendance</span>
            <span class="sm:hidden text-xs">Edit</span>
          </button>
          <button id="saveAttendanceBtn" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-white rounded-lg text-xs sm:text-sm font-medium hidden transition-all" style="background-color: #2A3B36;" onmouseover="this.style.backgroundColor='#060D0C'" onmouseout="this.style.backgroundColor='#2A3B36'">
            <i class="fas fa-save text-sm mr-1"></i>
            <span class="hidden sm:inline">Save Changes</span>
            <span class="sm:hidden text-xs">Save</span>
          </button>
          <button id="cancelEditBtn" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-white rounded-lg text-xs sm:text-sm font-medium hidden transition-all" style="background-color: #8B9B8F;" onmouseover="this.style.backgroundColor='#060D0C'" onmouseout="this.style.backgroundColor='#8B9B8F'">
            <i class="fas fa-times text-sm mr-1"></i>
            <span class="hidden sm:inline">Cancel</span>
            <span class="sm:hidden text-xs">Cancel</span>
          </button>
          <button id="exportExcelBtn" onclick="exportToExcel()" class="flex-1 sm:flex-none px-2 sm:px-3 py-2 text-white rounded-lg text-xs sm:text-sm font-medium hidden transition-all" style="background-color: #060D0C;" onmouseover="this.style.backgroundColor='#2A3B36'" onmouseout="this.style.backgroundColor='#060D0C'">
            <i class="fas fa-file-excel text-sm mr-1"></i>
            <span class="hidden sm:inline">Export Excel</span>
            <span class="sm:hidden text-xs">Export</span>
          </button>
        </div>
        
        <!-- Table with sticky student column -->
        <div class="rounded-lg shadow border overflow-hidden bg-white" style="border-color: #8B9B8F;">
          <div class="overflow-x-auto relative">
            <table class="min-w-full text-xs sm:text-sm border-collapse">
              <thead class="text-white sticky top-0 z-30" style="background-color: #060D0C;" id="view-thead">
                <!-- Headers will be populated by JavaScript -->
              </thead>
              <tbody class="bg-white divide-y" style="color: #060D0C; border-color: #F0EDE5;" id="view-tbody">
                <!-- Rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
    
        <!-- Mobile scroll hint -->
        <div class="mt-2 text-xs text-center flex items-center justify-center gap-2" style="color: #8B9B8F;">
          <i class="fas fa-arrows-alt-h"></i>
          <span>Student column stays fixed ‚Ä¢ Scroll horizontally to view all dates</span>
        </div>
        
        <!-- Stats summary -->
        <div class="mt-3 p-2 rounded-lg text-xs grid grid-cols-2 sm:grid-cols-4 gap-2" style="background-color: #F0EDE5; color: #060D0C;" id="attendanceStats">
          <!-- Stats will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Include XLSX library for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    // Global variables
    const streams = [
      { name: 'BCA', semesters: [1,2,3,4,5,6] },
      { name: 'BBA', semesters: [1,2,3,4,5,6] },
      { name: 'BCOM', semesters: [1,2,3,4,5,6] },
      { name: 'BCOM SECTION B', semesters: [1,2,3,4,5,6] },
      { name: 'BCOM-BDA', semesters: [1,2,3,4,5,6] },
      { name: 'BCOM A AND F', semesters: [1,2,3,4,5,6] },
    ];

    // DOM element references
    const streamSelect = document.getElementById('streamSelect');
    const semesterSelect = document.getElementById('semesterSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const loadRegisterBtn = document.getElementById('loadRegisterBtn');
    const registerTable = document.getElementById('registerTable');
    const viewThead = document.getElementById('view-thead');
    const viewTbody = document.getElementById('view-tbody');
    const attendanceStats = document.getElementById('attendanceStats');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    const editAttendanceBtn = document.getElementById('editAttendanceBtn');
    const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    
    // Date selector elements
    const fullRegisterBtn = document.getElementById('fullRegisterBtn');
    const singleDateBtn = document.getElementById('singleDateBtn');
    const dateSelector = document.getElementById('dateSelector');
    const specificDateInput = document.getElementById('specificDateInput');
    const dateValidationMessage = document.getElementById('dateValidationMessage');
    const attendanceStatus = document.getElementById('attendanceStatus');
    const statusText = document.getElementById('statusText');

    // Current register data
    let currentStudents = [];
    let currentDates = [];
    let currentAttendanceMap = {};
    let currentSubject = '';
    let currentStream = '';
    let currentSemester = '';
    let isEditMode = false;
    let originalAttendanceMap = {};
    
    // Date selector state
    let isFullRegisterView = true;
    let selectedDate = '';

    // Toggle between full register and single date view
    function toggleViewMode(isFullRegister) {
      isFullRegisterView = isFullRegister;
      
      if (isFullRegister) {
        // Full register view
        fullRegisterBtn.style.backgroundColor = '#2A3B36';
        fullRegisterBtn.style.color = 'white';
        singleDateBtn.style.backgroundColor = '#F0EDE5';
        singleDateBtn.style.color = '#060D0C';
        dateSelector.classList.add('hidden');
        selectedDate = '';
        
        console.log('üìä Switched to full register view');
        
        // Re-render table in full register mode if data is available
        if (currentStudents.length > 0 && currentDates.length > 0) {
          console.log('üîÑ Re-rendering table for full register view');
          renderAttendanceTable(currentStudents, currentDates, currentAttendanceMap);
        }
      } else {
        // Single date view
        fullRegisterBtn.style.backgroundColor = '#F0EDE5';
        fullRegisterBtn.style.color = '#060D0C';
        singleDateBtn.style.backgroundColor = '#2A3B36';
        singleDateBtn.style.color = 'white';
        dateSelector.classList.remove('hidden');
        
        // Set date input limits and default value
        setDateInputLimits();
        
        console.log('üìÖ Switched to single date view');
        
        // Trigger date selection if a date is already selected or use default
        if (selectedDate) {
          console.log('üîÑ Re-rendering table for selected date:', selectedDate);
          onDateSelect();
        }
      }
    }
    
    // Set date input limits and default value
    function setDateInputLimits() {
      if (currentDates.length > 0) {
        // Set min and max based on available attendance dates for guidance
        const sortedDates = [...currentDates].sort();
        const minDate = sortedDates[0];
        const maxDate = sortedDates[sortedDates.length - 1];
        
        // Don't restrict the calendar, but show guidance
        dateValidationMessage.classList.remove('hidden');
        statusText.textContent = `Select any date to check attendance`;
        attendanceStatus.style.color = '#8B9B8F';
        
        // Set a reasonable default to the latest attendance date
        specificDateInput.value = maxDate;
        selectedDate = maxDate;
        
        console.log(`üìÖ Date input ready. Attendance available from ${minDate} to ${maxDate}`);
      } else {
        dateValidationMessage.classList.remove('hidden');
        statusText.textContent = `No attendance data available`;
        attendanceStatus.style.color = '#ef4444';
      }
    }
    
    // Handle specific date selection
    function onDateSelect() {
      selectedDate = specificDateInput.value;
      console.log('üìÖ Selected date:', selectedDate);
      
      if (!selectedDate) {
        dateValidationMessage.classList.add('hidden');
        return;
      }
      
      // Check if attendance exists for this date
      const hasAttendance = currentAttendanceMap[selectedDate];
      const attendanceExists = hasAttendance !== undefined;
      
      dateValidationMessage.classList.remove('hidden');
      
      if (attendanceExists) {
        // Attendance was marked on this date
        const presentCount = hasAttendance.length;
        const totalStudents = currentStudents.length;
        statusText.textContent = `Attendance marked: ${presentCount}/${totalStudents} students present`;
        attendanceStatus.style.color = '#22c55e';
        attendanceStatus.querySelector('i').className = 'fas fa-check-circle';
        
        // Render table with attendance data
        if (currentStudents.length > 0) {
          renderAttendanceTable(currentStudents, currentDates, currentAttendanceMap);
        }
      } else {
        // No attendance marked on this date
        statusText.textContent = `Attendance not marked on this day`;
        attendanceStatus.style.color = '#ef4444';
        attendanceStatus.querySelector('i').className = 'fas fa-exclamation-circle';
        
        // Render table showing "no attendance marked"
        renderNoAttendanceTable();
      }
    }
    
    // Render table when no attendance is marked for selected date
    function renderNoAttendanceTable() {
      if (!viewThead || !viewTbody) return;
      
      const selectedDateObj = new Date(selectedDate);
      const formattedDate = selectedDateObj.toLocaleDateString('en-IN', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      // Create header
      viewThead.innerHTML = `
        <tr>
          <th class="p-3 text-center font-bold text-sm">#</th>
          <th class="p-3 text-left font-bold text-sm">Student ID</th>
          <th class="p-3 text-left font-bold text-sm">Name</th>
          <th class="p-3 text-center font-bold text-sm">Status (${formattedDate})</th>
        </tr>
      `;
      
      // Sort students by ID
      const sortedStudents = currentStudents.sort((a, b) => {
        const aNum = parseInt(a.studentID);
        const bNum = parseInt(b.studentID);
        
        if (!isNaN(aNum) && !isNaN(bNum) && 
            a.studentID === aNum.toString() && 
            b.studentID === bNum.toString()) {
          return aNum - bNum;
        }
        
        return a.studentID.localeCompare(b.studentID, undefined, {
          numeric: true,
          sensitivity: 'base'
        });
      });
      
      // Create body with "no attendance" message
      viewTbody.innerHTML = sortedStudents.map((stu, index) => `
        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
          <td class="p-3 text-center font-medium">${index + 1}</td>
          <td class="p-3 font-medium">
            <span class="text-xs font-bold px-2 py-1 rounded-md whitespace-nowrap" style="color: #060D0C; background-color: #F0EDE5;">${stu.studentID}</span>
          </td>
          <td class="p-3 font-medium">
            <span class="text-sm" style="color: #060D0C;">${stu.name}</span>
          </td>
          <td class="p-3 text-center">
            <div class="flex items-center justify-center gap-2">
              <i class="fas fa-calendar-times text-gray-400"></i>
              <span class="text-sm text-gray-500">Attendance not marked</span>
            </div>
          </td>
        </tr>
      `).join('');
      
      console.log(`üìÖ Rendered no-attendance table for ${selectedDate}`);
    }
    function showAlert(title, message, type) {
      const prefixes = {
        success: "‚úÖ ",
        error: "‚ùå ",
        warning: "‚ö†Ô∏è ",
        info: "‚ÑπÔ∏è "
      };
      alert(`${prefixes[type]}${title}\n\n${message}`);
    }

    // Populate streams
    function populateStreams() {
      streamSelect.innerHTML = '<option value="">-- Select Stream --</option>' + 
        streams.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    }

    // Populate semesters based on stream
    function populateSemesters(streamName) {
      const stream = streams.find(s => s.name === streamName);
      semesterSelect.innerHTML = '<option value="">-- Select Semester --</option>' + 
        (stream ? stream.semesters.map(n => `<option value="${n}">Sem ${n}</option>`).join('') : '');
      subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
      hideRegister();
    }

    // Load subjects from API
    async function loadSubjects(stream, sem) {
      subjectSelect.innerHTML = '<option value="">Loading...</option>';
      try {
        const res = await fetch(`/api/subjects/${encodeURIComponent(stream)}/sem${sem}`);
        const data = await res.json();
        if (!data.success) throw new Error('Failed to load subjects');
        const subjects = data.subjects || [];
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>' + 
          subjects.map(s => `<option value="${s.subjectName}">${s.subjectName}</option>`).join('');
      } catch (e) {
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        showAlert('Loading Error', 'Failed to load subjects', 'error');
      }
    }

    // Hide register
    function hideRegister() {
      registerTable.classList.add('hidden');
      exportExcelBtn.classList.add('hidden');
      editAttendanceBtn.classList.add('hidden');
      saveAttendanceBtn.classList.add('hidden');
      cancelEditBtn.classList.add('hidden');
      isEditMode = false;
    }

    // Load attendance register - main function matching index.html
    async function loadAttendanceRegister() {
      const stream = streamSelect.value;
      const sem = semesterSelect.value;
      const subject = subjectSelect.value;
      
      if (!stream || !sem || !subject) {
        showAlert('Missing Information', 'Please select stream, semester and subject', 'error');
        return;
      }

      try {
        loadRegisterBtn.disabled = true;
        loadRegisterBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';

        console.log(`üìä Loading register for: ${subject}`);
        
        const res = await fetch(`/api/attendance-register/${encodeURIComponent(stream)}/sem${sem}/${encodeURIComponent(subject)}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        console.log('üìä Register response:', data);

        let students, attendanceMap, subjectInfo;
        
        if (data.success && data.data) {
          ({ students, attendanceMap, subjectInfo } = data.data);
        } else if (data.students && data.attendanceMap) {
          ({ students, attendanceMap } = data);
          subjectInfo = data.subjectInfo;
        } else {
          throw new Error(data.message || 'Failed to load register');
        }

        const dates = Object.keys(attendanceMap).sort();

        console.log(`‚úÖ Loaded: ${students.length} students, ${dates.length} dates`);

        if (students.length === 0) {
          const message = subjectInfo?.isLanguageSubject ? 
            `No students found who chose ${subjectInfo.languageType} language` :
            'No students found for this subject';
          showAlert("No Students", message, "warning");
          return;
        }

        // Store current data for export
        currentStudents = students;
        currentDates = dates;
        currentAttendanceMap = attendanceMap;
        currentSubject = subject;
        currentStream = stream;
        currentSemester = sem;

        await renderAttendanceTable(students, dates, attendanceMap);

        registerTable.classList.remove("hidden");
        exportExcelBtn.classList.remove("hidden");
        editAttendanceBtn.classList.remove("hidden");
        
        // Initialize date selector if in single date mode
        if (!isFullRegisterView) {
          setDateInputLimits();
          // Trigger date selection if a date is already selected
          if (selectedDate) {
            onDateSelect();
          }
        }

        // Calculate stats
        updateAttendanceStats(students, dates, attendanceMap);

        const avgAttendance = students.length > 0 ?
          (students.reduce((sum, stu) => {
            const attendedCount = dates.filter(date => attendanceMap[date]?.includes(stu.studentID)).length;
            return sum + (dates.length > 0 ? (attendedCount / dates.length) * 100 : 0);
          }, 0) / students.length).toFixed(1) : 0;

        let successMessage = `Register loaded successfully!\n\n`;
        successMessage += `Subject: ${subject}\n`;
        if (subjectInfo?.isLanguageSubject) {
          successMessage += `Language: ${subjectInfo.languageType} students only\n`;
        }
        successMessage += `Students: ${students.length}\n`;
        successMessage += `Days: ${dates.length}\n`;
        successMessage += `Average Attendance: ${avgAttendance}%`;

        showAlert("Success", successMessage, "success");

      } catch (err) {
        console.error("Error loading attendance register:", err);
        showAlert("Loading Error", `Failed to load register: ${err.message}`, "error");
      } finally {
        loadRegisterBtn.disabled = false;
        loadRegisterBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Load Attendance Register';
      }
    }

    // Render attendance table matching index.html style
    async function renderAttendanceTable(students, dates, attendanceMap) {
      console.log('üèóÔ∏è Rendering attendance table. Edit mode:', isEditMode);
      console.log('üìä Students:', students.length, 'Dates:', dates.length);
      console.log('üìÖ View mode - Full Register:', isFullRegisterView, 'Selected Date:', selectedDate);
      
      // Determine which dates to show based on view mode
      let displayDates = dates;
      if (!isFullRegisterView && selectedDate) {
        displayDates = [selectedDate];
        console.log('üìÖ Showing single date:', selectedDate);
      } else if (!isFullRegisterView && !selectedDate) {
        console.log('üìÖ Single date mode but no date selected');
        showAlert('Select Date', 'Please select a date to view attendance.', 'info');
        return;
      }
      
      // Critical check: If no dates, we can't render checkboxes
      if (displayDates.length === 0) {
        console.error('‚ùå CRITICAL: No dates available - this will result in no checkboxes!');
        console.log('üí° This is likely why checkboxes are not appearing');
        
        if (isEditMode) {
          showAlert('No Attendance Data', 'No attendance records found for this subject. You need to mark attendance first using the "Mark Attendance" page before you can edit it here.', 'warning');
          
          // Create a sample table showing students but explaining no data
          viewThead.innerHTML = `
            <tr>
              <th class="p-3 text-center font-bold text-sm">#</th>
              <th class="p-3 text-left font-bold text-sm">Student ID</th>
              <th class="p-3 text-left font-bold text-sm">Name</th>
              <th class="p-3 text-center font-bold text-sm">Status</th>
            </tr>
          `;
          
          viewTbody.innerHTML = students.map((stu, index) => `
            <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
              <td class="p-3 text-center font-medium">${index + 1}</td>
              <td class="p-3 font-medium">
                <span class="text-xs font-bold px-2 py-1 rounded-md whitespace-nowrap" style="color: #060D0C; background-color: #F0EDE5;">${stu.studentID}</span>
              </td>
              <td class="p-3 font-medium">
                <span class="text-sm" style="color: #060D0C;">${stu.name}</span>
              </td>
              <td class="p-3 text-center text-gray-500">
                <i class="fas fa-info-circle"></i> No attendance data
              </td>
            </tr>
          `).join('');
          
          return; // Exit early
        }
      }
      
      if (!viewThead || !viewTbody) {
        console.error('‚ùå Table elements not found');
        return;
      }

      // Sort students by Student ID
      const sortedStudents = students.sort((a, b) => {
        const aNum = parseInt(a.studentID);
        const bNum = parseInt(b.studentID);
        
        if (!isNaN(aNum) && !isNaN(bNum) && 
            a.studentID === aNum.toString() && 
            b.studentID === bNum.toString()) {
          return aNum - bNum;
        }
        
        return a.studentID.localeCompare(b.studentID, undefined, {
          numeric: true,
          sensitivity: 'base'
        });
      });

      // Create table header based on view mode
      if (isFullRegisterView) {
        // Full register view - show all dates
        viewThead.innerHTML = `
          <tr>
            <th class="p-3 text-center font-bold text-sm">#</th>
            <th class="p-3 text-left font-bold text-sm">Student ID</th>
            <th class="p-3 text-left font-bold text-sm">Name</th>
            ${displayDates.map(d => {
              const dateObj = new Date(d);
              const displayDate = dateObj.toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'});
              const title = dateObj.toLocaleDateString('en-IN', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
              });
              
              return `<th class="p-2 text-center font-semibold text-xs min-w-12" data-date="${d}" title="${title}">${displayDate}</th>`;
            }).join('')}
            
            <th class="p-3 text-center font-bold text-xs" style="background-color: #2A3B36;">Total</th>
            <th class="p-3 text-center font-bold text-xs" style="background-color: #060D0C;">Present</th>
            <th class="p-3 text-center font-bold text-xs" style="background-color: #2A3B36;">%</th>
          </tr>
        `;
      } else {
        // Single date view - show just attendance status
        const dateObj = new Date(selectedDate);
        const formattedDate = dateObj.toLocaleDateString('en-IN', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        viewThead.innerHTML = `
          <tr>
            <th class="p-3 text-center font-bold text-sm">#</th>
            <th class="p-3 text-left font-bold text-sm">Student ID</th>
            <th class="p-3 text-left font-bold text-sm">Name</th>
            <th class="p-3 text-center font-bold text-sm">Attendance (${formattedDate})</th>
          </tr>
        `;
      }

      // Create table body
      viewTbody.innerHTML = "";
      
      sortedStudents.forEach((stu, index) => {
        let attended = 0;
        const row = [];

        row.push(`<td class="p-3 text-center font-medium">${index + 1}</td>`);
        row.push(`
          <td class="p-3 font-medium">
            <span class="text-xs font-bold px-2 py-1 rounded-md whitespace-nowrap" style="color: #060D0C; background-color: #F0EDE5;">${stu.studentID}</span>
          </td>
        `);
        row.push(`
          <td class="p-3 font-medium">
            <span class="text-sm" style="color: #060D0C;">${stu.name}</span>
          </td>
        `);

        if (isFullRegisterView) {
          // Full register view - show all dates
          displayDates.forEach(date => {
            const present = attendanceMap[date]?.includes(stu.studentID);
            if (present) attended++;
            
            console.log(`üîç Processing date ${date} for student ${stu.studentID}, present: ${present}, isEditMode: ${isEditMode}`);
            
            if (isEditMode) {
              // Edit mode: show checkboxes (matching index.html structure)
              console.log(`üìã Creating checkbox for student ${stu.studentID} on date ${date}, present: ${present}`);
              row.push(`
                <td class="p-2 text-center">
                  <input 
                    type="checkbox" 
                    class="checkbox" 
                    data-date="${date}"
                    data-student-id="${stu.studentID}"
                    value="${stu.studentID}"
                    ${present ? "checked" : ""}
                  />
                </td>
              `);
            } else {
              // View mode: show icons
              console.log(`üëÅÔ∏è Creating icon for student ${stu.studentID} on date ${date}, present: ${present}`);
              row.push(`
                <td class="p-2 text-center">
                  <span class="text-lg">${present ? '‚úÖ' : '‚ùå'}</span>
                </td>
              `);
            }
          });

          // Add summary columns for full register view
          const total = displayDates.length;
          const percentage = total ? ((attended / total) * 100).toFixed(1) : "0.0";
          const percentClass = percentage < 75 ? 'color: #ef4444; background-color: #fef2f2;' : 
                              percentage >= 85 ? 'color: #22c55e; background-color: #f0fdf4;' : 
                              'color: #eab308; background-color: #fefce8;';

          row.push(`<td class="p-3 text-center font-semibold" style="color: #060D0C; background-color: #F0EDE5;">${total}</td>`);
          row.push(`<td class="p-3 text-center font-semibold" style="color: #060D0C; background-color: #F0EDE5;">${attended}</td>`);
          row.push(`<td class="p-3 text-center font-bold rounded-md" style="${percentClass}">${percentage}%</td>`);
        } else {
          // Single date view - show just attendance status for selected date
          const present = attendanceMap[selectedDate]?.includes(stu.studentID);
          
          if (isEditMode) {
            // Edit mode: show checkbox for single date
            row.push(`
              <td class="p-3 text-center">
                <div class="flex items-center justify-center gap-2">
                  <input 
                    type="checkbox" 
                    class="checkbox" 
                    data-date="${selectedDate}"
                    data-student-id="${stu.studentID}"
                    value="${stu.studentID}"
                    ${present ? "checked" : ""}
                  />
                  <span class="text-sm">${present ? 'Present' : 'Absent'}</span>
                </div>
              </td>
            `);
          } else {
            // View mode: show status for single date
            row.push(`
              <td class="p-3 text-center">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-2xl">${present ? '‚úÖ' : '‚ùå'}</span>
                  <span class="text-sm font-medium ${present ? 'text-green-600' : 'text-red-600'}">${present ? 'Present' : 'Absent'}</span>
                </div>
              </td>
            `);
          }
        }

        const tr = document.createElement('tr');
        tr.className = `transition duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
        tr.style.borderColor = '#F0EDE5';
        tr.dataset.studentId = stu.studentID;
        tr.innerHTML = row.join("");
        
        // Add hover effect
        tr.onmouseover = () => tr.style.backgroundColor = '#F0EDE5';
        tr.onmouseout = () => tr.style.backgroundColor = index % 2 === 0 ? 'white' : '#f9fafb';
        
        viewTbody.appendChild(tr);
      });

      console.log(`‚úÖ Table rendered with ${sortedStudents.length} students (sorted by Student ID)`);
      
      // Add event delegation for checkboxes
      if (isEditMode) {
        // Remove existing event listeners to avoid duplicates
        viewTbody.removeEventListener('change', handleCheckboxChange);
        viewTbody.addEventListener('change', handleCheckboxChange);
      }
      
      // Debug: Count checkboxes after rendering
      if (isEditMode) {
        setTimeout(() => {
          const checkboxes = viewTbody.querySelectorAll('.checkbox');
          const allInputs = viewTbody.querySelectorAll('input');
          console.log(`üîç Debug after render - Found ${checkboxes.length} .checkbox elements`);
          console.log(`üîç Debug after render - Found ${allInputs.length} input elements total`);
          if (checkboxes.length === 0 && allInputs.length === 0) {
            console.error('‚ùå NO CHECKBOXES FOUND! This indicates a rendering issue.');
            console.log('üìä isEditMode:', isEditMode);
            console.log('üèóÔ∏è Table HTML sample:', viewTbody.innerHTML.substring(0, 500));
            
            // Emergency fallback: Force re-render
            console.log('üö® Attempting emergency fallback...');
            forceCheckboxRender();
          } else {
            console.log('‚úÖ Checkboxes successfully rendered!');
          }
        }, 100);
      }
    }
    
    // Event handler for checkbox changes
    function handleCheckboxChange(event) {
      if (event.target.classList.contains('checkbox')) {
        markUnsavedChanges();
      }
    }
    
    // Emergency fallback function
    function forceCheckboxRender() {
      if (!isEditMode || !currentStudents || !currentDates) return;
      
      console.log('üîß Force rendering checkboxes...');
      const rows = viewTbody.querySelectorAll('tr');
      
      rows.forEach((row, studentIndex) => {
        const student = currentStudents[studentIndex];
        if (!student) return;
        
        const cells = row.querySelectorAll('td');
        const dateCells = Array.from(cells).slice(3, 3 + currentDates.length); // Skip first 3 columns
        
        dateCells.forEach((cell, dateIndex) => {
          const date = currentDates[dateIndex];
          const present = currentAttendanceMap[date]?.includes(student.studentID);
          
          cell.innerHTML = `
            <input 
              type="checkbox" 
              class="checkbox" 
              data-date="${date}"
              data-student-id="${student.studentID}"
              value="${student.studentID}"
              ${present ? "checked" : ""}
            />
          `;
        });
      });
      
      setTimeout(() => {
        const checkboxes = viewTbody.querySelectorAll('.checkbox');
        console.log(`üîß After fallback: Found ${checkboxes.length} checkboxes`);
      }, 50);
    }

    // Toggle edit mode
    function toggleEditMode() {
      isEditMode = !isEditMode;
      console.log('üîÑ Toggling edit mode. New state:', isEditMode);
      
      // Debug: Check data availability
      console.log('üìä Data check before render:');
      console.log('  currentStudents:', currentStudents ? currentStudents.length : 'null/undefined');
      console.log('  currentDates:', currentDates ? currentDates.length : 'null/undefined');
      console.log('  currentAttendanceMap:', currentAttendanceMap ? Object.keys(currentAttendanceMap).length : 'null/undefined');
      
      if (!currentStudents || !currentDates || !currentAttendanceMap) {
        console.error('‚ùå Cannot toggle edit mode - missing data!');
        showAlert('Error', 'Please load attendance data first before entering edit mode.', 'error');
        isEditMode = !isEditMode; // Revert the toggle
        return;
      }
      
      if (isEditMode) {
        // Entering edit mode
        console.log('üìù Entering edit mode');
        originalAttendanceMap = JSON.parse(JSON.stringify(currentAttendanceMap)); // Deep copy
        editAttendanceBtn.classList.add('hidden');
        saveAttendanceBtn.classList.remove('hidden');
        cancelEditBtn.classList.remove('hidden');
        exportExcelBtn.classList.add('hidden');
        
        // Re-render table with checkboxes
        console.log('üîÑ About to render table in EDIT mode with data:', {
          students: currentStudents.length,
          dates: currentDates.length,
          attendanceKeys: Object.keys(currentAttendanceMap).length
        });
        renderAttendanceTable(currentStudents, currentDates, currentAttendanceMap);
        
        showAlert('Edit Mode', 'You can now edit attendance by checking/unchecking boxes. Click Save to save changes or Cancel to discard.', 'info');
      } else {
        // Exiting edit mode
        console.log('üëÅÔ∏è Exiting edit mode');
        editAttendanceBtn.classList.remove('hidden');
        saveAttendanceBtn.classList.add('hidden');
        cancelEditBtn.classList.add('hidden');
        exportExcelBtn.classList.remove('hidden');
        
        // Re-render table in view mode
        renderAttendanceTable(currentStudents, currentDates, currentAttendanceMap);
      }
    }

    // Mark unsaved changes - make globally available
    function markUnsavedChanges() {
      console.log('üíæ Marking unsaved changes');
      // Visual indication that there are unsaved changes
      saveAttendanceBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      saveAttendanceBtn.innerHTML = '<i class="fas fa-save text-sm mr-1"></i><span class="hidden sm:inline">Save Changes*</span><span class="sm:hidden text-xs">Save*</span>';
    }
    
    // Make function globally available
    window.markUnsavedChanges = markUnsavedChanges;

    // Save attendance changes
    async function saveAttendanceChanges() {
      console.log('üíæ Save function called, isEditMode:', isEditMode);
      
      if (!isEditMode) {
        console.log('‚ùå Not in edit mode, returning early');
        return;
      }
      
      try {
        console.log('üîÑ Starting save process...');
        saveAttendanceBtn.disabled = true;
        saveAttendanceBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i><span class="hidden sm:inline">Saving...</span><span class="sm:hidden text-xs">Saving...</span>';

        // Collect updated attendance data
        const updatedAttendanceMap = {};
        currentDates.forEach(date => {
          updatedAttendanceMap[date] = [];
        });

        // Get all checkboxes and build attendance map
        const checkboxes = viewTbody.querySelectorAll('.checkbox, .attendance-checkbox');
        console.log(`üìã Found ${checkboxes.length} checkboxes to process`);
        
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            const date = checkbox.dataset.date;
            const studentId = checkbox.dataset.studentId;
            if (!updatedAttendanceMap[date]) {
              updatedAttendanceMap[date] = [];
            }
            updatedAttendanceMap[date].push(studentId);
          }
        });
        
        console.log('üìä Updated attendance map:', updatedAttendanceMap);

        // Send to server using the existing update-attendance endpoint
        console.log(`üåê Sending to API: /api/update-attendance/${currentStream}/sem${currentSemester}/${currentSubject}`);
        const response = await fetch(`/api/update-attendance/${encodeURIComponent(currentStream)}/sem${currentSemester}/${encodeURIComponent(currentSubject)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            attendanceMap: updatedAttendanceMap
          })
        });

        const result = await response.json();
        console.log('üíæ Save response:', result);

        if (response.ok && result.success) {
          console.log('‚úÖ Save successful, exiting edit mode...');
          
          // Update current data
          currentAttendanceMap = updatedAttendanceMap;
          
          // Exit edit mode properly - don't call toggleEditMode as it will toggle again
          isEditMode = false;
          console.log('üìù Set isEditMode to false');
          
          // Manually update UI to view mode
          editAttendanceBtn.classList.remove('hidden');
          saveAttendanceBtn.classList.add('hidden');
          cancelEditBtn.classList.add('hidden');
          exportExcelBtn.classList.remove('hidden');
          console.log('üéØ Updated UI buttons for view mode');
          
          // Re-render table in view mode
          renderAttendanceTable(currentStudents, currentDates, currentAttendanceMap);
          console.log('üîÑ Re-rendered table in view mode');
          
          // Update stats
          updateAttendanceStats(currentStudents, currentDates, currentAttendanceMap);
          
          showAlert('Success', 'Attendance changes saved successfully!', 'success');
          console.log('‚úÖ Save process completed successfully');
        } else {
          console.error('‚ùå Save failed:', result);
          throw new Error(result.message || 'Failed to save changes');
        }

      } catch (error) {
        console.error('Save error:', error);
        showAlert('Save Error', `Failed to save changes: ${error.message}`, 'error');
      } finally {
        saveAttendanceBtn.disabled = false;
        saveAttendanceBtn.style.background = '';
        saveAttendanceBtn.innerHTML = '<i class="fas fa-save text-sm mr-1"></i><span class="hidden sm:inline">Save Changes</span><span class="sm:hidden text-xs">Save</span>';
      }
    }

    // Cancel edit mode
    function cancelEditMode() {
      if (!isEditMode) return;
      
      const confirmCancel = confirm('Are you sure you want to cancel? All unsaved changes will be lost.');
      if (!confirmCancel) return;
      
      // Restore original data
      currentAttendanceMap = originalAttendanceMap;
      
      // Exit edit mode
      isEditMode = false;
      toggleEditMode();
      
      showAlert('Cancelled', 'Edit mode cancelled. No changes were saved.', 'info');
    }

    // Update attendance stats
    function updateAttendanceStats(students, dates, attendanceMap) {
      if (!attendanceStats || !students.length || !dates.length) return;

      let totalPresent = 0;
      let totalPossible = students.length * dates.length;
      let above75 = 0;
      let below75 = 0;

      students.forEach(stu => {
        const attended = dates.filter(date => attendanceMap[date]?.includes(stu.studentID)).length;
        totalPresent += attended;
        const percentage = (attended / dates.length) * 100;
        if (percentage >= 75) above75++; else below75++;
      });

      const overallPercentage = ((totalPresent / totalPossible) * 100).toFixed(1);

      attendanceStats.innerHTML = `
        <div class="text-center">
          <div class="font-semibold">${students.length}</div>
          <div class="text-xs">Students</div>
        </div>
        <div class="text-center">
          <div class="font-semibold">${dates.length}</div>
          <div class="text-xs">Days</div>
        </div>
        <div class="text-center">
          <div class="font-semibold">${overallPercentage}%</div>
          <div class="text-xs">Overall</div>
        </div>
        <div class="text-center">
          <div class="font-semibold">${above75}/${below75}</div>
          <div class="text-xs">Above/Below 75%</div>
        </div>
      `;
    }

    // Excel export function matching index.html
    async function exportToExcel() {
      console.log("üöÄ Excel export started");
      
      const originalText = exportExcelBtn.innerHTML;
      exportExcelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
      exportExcelBtn.disabled = true;

      try {
        if (typeof XLSX === 'undefined') {
          throw new Error("XLSX library not loaded");
        }
        
        const table = document.querySelector("#registerTable table");
        
        if (!table) {
          throw new Error("No attendance table found. Please load the register first.");
        }

        const tbody = table.querySelector("tbody");
        const rows = tbody ? tbody.querySelectorAll("tr") : [];
        
        if (rows.length === 0) {
          throw new Error("No student data found. Please load attendance register first.");
        }

        const processedData = [];
        
        const headerRow = ["#", "Student ID", "Name"];
        const dateHeaders = table.querySelectorAll("th[data-date]");
        
        dateHeaders.forEach(header => {
          if (header.dataset.date) {
            const date = new Date(header.dataset.date);
            if (!isNaN(date.getTime())) {
              headerRow.push(date.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: '2-digit'
              }));
            }
          }
        });
        
        headerRow.push("Total", "Present", "Percentage");
        processedData.push(headerRow);

        rows.forEach((row, rowIndex) => {
          try {
            const cells = row.querySelectorAll("td");
            if (cells.length < 3) return;

            let studentID = `Student_${rowIndex + 1}`;
            let studentName = "Unknown";
            let attended = 0;
            let totalDays = 0;

            if (cells[1]) {
              const span = cells[1].querySelector('span');
              studentID = span ? span.textContent.trim() : cells[1].textContent.trim();
            }
            
            if (cells[2]) {
              const span = cells[2].querySelector('span');
              studentName = span ? span.textContent.trim() : cells[2].textContent.trim();
            }

            const dataRow = [rowIndex + 1, studentID, studentName];

            // Count attendance from the current data
            currentDates.forEach(date => {
              totalDays++;
              const isPresent = currentAttendanceMap[date]?.includes(studentID);
              if (isPresent) attended++;
              dataRow.push(isPresent ? "Present" : "Absent");
            });

            const percentage = totalDays > 0 ? (attended / totalDays) * 100 : 0;
            
            dataRow.push(totalDays, attended, `${percentage.toFixed(1)}%`);
            processedData.push(dataRow);

          } catch (e) {
            console.warn(`‚ö†Ô∏è Error processing row ${rowIndex}:`, e);
          }
        });

        if (processedData.length <= 1) {
          throw new Error("No valid student data found.");
        }

        const ws = XLSX.utils.aoa_to_sheet(processedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Attendance");

        const fileName = `Attendance_${currentStream}_Sem${currentSemester}_${currentSubject}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        XLSX.writeFile(wb, fileName);
        
        showAlert("Export Success", `Attendance data exported successfully as ${fileName}`, "success");

      } catch (error) {
        console.error("‚ùå Export error:", error);
        showAlert("Export Error", `Failed to export: ${error.message}`, "error");
      } finally {
        exportExcelBtn.innerHTML = originalText;
        exportExcelBtn.disabled = false;
      }
    }

    // Event listeners
    streamSelect.addEventListener('change', () => {
      subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
      hideRegister();
      if (streamSelect.value) {
        populateSemesters(streamSelect.value);
      } else {
        semesterSelect.innerHTML = '<option value="">-- Select Semester --</option>';
      }
    });

    semesterSelect.addEventListener('change', () => {
      subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
      hideRegister();
      if (streamSelect.value && semesterSelect.value) {
        loadSubjects(streamSelect.value, semesterSelect.value);
      }
    });

    subjectSelect.addEventListener('change', () => {
      hideRegister();
    });

    loadRegisterBtn.addEventListener('click', loadAttendanceRegister);
    editAttendanceBtn.addEventListener('click', toggleEditMode);
    saveAttendanceBtn.addEventListener('click', saveAttendanceChanges);
    cancelEditBtn.addEventListener('click', cancelEditMode);
    
    // Date selector event listeners
    fullRegisterBtn.addEventListener('click', () => toggleViewMode(true));
    singleDateBtn.addEventListener('click', () => toggleViewMode(false));
    specificDateInput.addEventListener('change', onDateSelect);

    // Initialize
    populateStreams();
    
    console.log("‚úÖ View Attendance page loaded successfully");
  </script>

</body>
</html>
