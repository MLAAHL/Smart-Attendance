<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Class Queue - Teacher Panel</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { firebaseConfig } from './firebase-config.js';
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // Make auth and signOut available globally
    window.auth = auth;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    
    console.log('âœ… Firebase initialized successfully');
  </script>
  
  <!-- Note: All Firebase users are now allowed to access the system -->

  <style>
    * {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(125deg, #F0EDE5 0%, #E8E3D8 95%);
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(6, 13, 12, 0.08), transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(42, 59, 54, 0.08), transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(139, 155, 143, 0.08), transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    .glass-header {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-primary {
      background: linear-gradient(135deg, #060D0C 0%, #2A3B36 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .btn-secondary:hover {
      background: rgba(102, 126, 234, 0.1);
      border-color: rgba(102, 126, 234, 0.6);
      transform: translateY(-1px);
    }
    
    .loading-spinner {
      border: 3px solid rgba(102, 126, 234, 0.2);
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .queue-item {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(0);
    }
    
    .queue-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .queue-item.removing {
      transform: translateX(100%) scale(0.8);
      opacity: 0;
    }

    .form-input {
      transition: all 0.3s ease;
      border: 2px solid rgba(102, 126, 234, 0.2);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .form-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      outline: none;
      transform: translateY(-1px);
    }

    .back-button {
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-3px);
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .slide-in {
      animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .floating-badge {
      animation: float 3s ease-in-out infinite;
    }

    /* Enhanced Menu Icon Styles with Animation */
    .menu-icon {
      cursor: pointer;
      transition: transform 0.2s ease;
      padding: 8px;
      border-radius: 6px;
    }

    .menu-icon:hover {
      transform: scale(1.1);
      background-color: rgba(0, 0, 0, 0.05);
    }

    .menu-icon:active {
      transform: scale(0.95);
    }

    .menu-icon .line {
      transition: all 0.3s ease;
      border-radius: 2px;
    }

    /* Hamburger menu styling and animation - MAXIMUM VISIBILITY */
    .menu-icon {
      display: flex;
      flex-direction: column;
      justify-content: center;
      width: 28px;
      height: 22px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 3px;
      border-radius: 4px;
      position: relative;
    }
    
    .menu-icon:hover {
      background-color: rgba(6, 13, 12, 0.1);
    }
    
    .menu-icon .line {
      height: 4px !important;
      background: #000000 !important;
      background-image: linear-gradient(135deg, #000000 0%, #333333 100%) !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
      transform-origin: center !important;
      opacity: 1 !important;
      border-radius: 2px !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
      display: block !important;
      visibility: visible !important;
      position: relative !important;
      z-index: 10 !important;
      border: 1px solid #000000 !important;
    }
    
    /* Additional fallback styling */
    .menu-icon .line::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000000;
      border-radius: 2px;
    }
    
    .menu-icon .line.long {
      width: 24px !important;
      margin-bottom: 5px !important;
    }
    
    .menu-icon .line.short {
      width: 18px !important;
      margin-left: auto !important;
    }

    /* Hamburger animation when menu is open */
    .menu-icon.active .line.long {
      transform: rotate(45deg) translate(4px, 4px) !important;
      width: 22px !important;
    }

    .menu-icon.active .line.short {
      transform: rotate(-45deg) translate(4px, -4px) !important;
      width: 22px !important;
      margin-left: 0 !important;
    }

    /* Enhanced Side Menu Styles */
    .side-menu {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Backdrop transition */
    #menuBackdrop {
      transition: opacity 0.3s ease;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    /* Stream container hover effects */
    .stream-container {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stream-container:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }

    /* Modern scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #060D0C, #2A3B36);
      border-radius: 10px;
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      .mobile-only { display: block !important; }
      .desktop-only { display: none !important; }
    }

    @media (min-width: 641px) {
      .mobile-only { display: none !important; }
      .desktop-only { display: block !important; }
    }
  </style>
</head>

<body>
  <!-- Compact Mobile Header -->
  <header class="glass-header sticky top-0 z-50 mx-3 mt-3 rounded-xl">
    <div class="flex items-center justify-between p-3">
      <!-- Hamburger Menu Button -->
      <div class="menu-icon cursor-pointer">
        <div class="line long"></div>
        <div class="line short"></div>
      </div>

      <!-- Back Button for Form -->
      <button id="backButtonForm" onclick="showHomePage()" class="back-button w-10 h-10 rounded-lg flex items-center justify-center text-gray-700 hidden">
        <i class="fas fa-arrow-left"></i>
      </button>

      <!-- Compact Logo & Title -->
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #060D0C 0%, #2A3B36 100%);">
          <i class="fas fa-list-ol" style="color: #F0EDE5;"></i>
        </div>
        <div>
          <h1 class="text-base font-bold" style="color: #060D0C;">smart classes</h1>
          <p class="text-xs" style="color: #8B9B8F;">Teacher Panel</p>
        </div>
      </div>

      <!-- Compact User Avatar -->
      <div class="relative">
        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #060D0C 0%, #2A3B36 100%);">
          <i class="fas fa-user-graduate text-sm" style="color: #F0EDE5;"></i>
        </div>
        <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full border-2 border-white pulse-animation"></div>
      </div>
    </div>
  </header>

  <!-- Menu Backdrop Overlay -->
  <div id="menuBackdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

  <!-- Side Menu -->
  <div id="mobileMenu" class="side-menu hidden fixed top-0 left-0 w-64 h-full shadow z-50 transition-transform transform -translate-x-full overflow-y-auto" style="background-color: #F0EDE5;">
    <div class="flex flex-col h-full p-4">
      <!-- Close button -->
      <div class="flex justify-end mb-4">
        <button id="menuCloseBtn" class="p-2 rounded-lg transition" style="color: #8B9B8F;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='transparent'">
          <i class="fas fa-times" style="color: #8B9B8F;"></i>
        </button>
      </div>
      
      <div class="mb-8">
          <div class="text-2xl font-bold flex items-center" style="color: #060D0C;">
          <i class="fas fa-chalkboard-teacher mr-2"></i>
          Smart Panel
        </div>
      <div class="text-xs mt-1" style="color: #8B9B8F;">Teacher Dashboard</div>
    </div>
    
    <div class="user-profile flex flex-col items-center mb-8">
      <div class="relative mb-4">
        <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" 
             class="w-20 h-20 rounded-full border-4 object-cover shadow-lg" style="border-color: #F0EDE5;"/>
        <div class="absolute bottom-0 right-0 w-6 h-6 bg-green-400 rounded-full border-2 border-white"></div>
      </div>
      <span id="userName" class="font-semibold text-lg" style="color: #060D0C;"></span>
      <span id="userEmail" class="text-sm mt-1" style="color: #8B9B8F;"></span>
    </div>
    
    <ul class="space-y-4 text-black">
      <li>
        <a href="myclass.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="background-color: #F0EDE5; color: #060D0C;">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #E8E3D8; color: #060D0C;">
            <i class="fas fa-chalkboard-teacher text-sm"></i>
          </div>
          <span>My Class</span>
        </a>
      </li>
      <li>
        <a href="promotion.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='transparent'">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #E8E3D8; color: #060D0C;">
            <i class="fas fa-user-graduate text-sm"></i>
          </div>
          <span>Promote Students</span>
        </a>
      </li>
      <li>
        <a href="msg.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='transparent'">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #E8E3D8; color: #060D0C;">
            <i class="fas fa-comments text-sm"></i>
          </div>
          <span>WhatsApp</span>
        </a>
      </li>
      <li>
        <a href="report.html" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='transparent'">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #E8E3D8; color: #060D0C;">
            <i class="fas fa-chart-bar text-sm"></i>
          </div>
          <span>Reports</span>
        </a>
      </li>
      <li>
        <button onclick="viewAttendance()" class="w-full text-left flex items-center gap-3 px-4 py-3 rounded-xl transition block" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='transparent'">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #E8E3D8; color: #060D0C;">
            <i class="fas fa-eye text-sm"></i>
          </div>
          <span>View Attendance</span>
        </button>
      </li>
    </ul>
    
    <!-- Logout Button -->
    <div class="mt-auto pt-4">
      <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition" style="color: #060D0C;" onmouseover="this.style.backgroundColor='#E8E3D8'" onmouseout="this.style.backgroundColor='transparent'">
        <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #E8E3D8; color: #060D0C;">
          <i class="fas fa-sign-out-alt text-sm"></i>
        </div>
        <span>Logout</span>
      </button>
    </div>
    </div> <!-- Close flex container -->
  </div>

  <!-- Enhanced Main Content with Three Sections -->
  <main class="px-3 pb-6 max-w-md mx-auto">
    <!-- Home Page -->
    <div id="homePage" class="slide-in">
      
      <!-- Tab Navigation -->
      <div class="glass-card rounded-2xl p-1 mb-4 mt-4">
        <div class="flex rounded-xl" style="background-color: #F0EDE5;">
          <button onclick="showSection('todaySection')" id="todayTab" class="flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all duration-300" style="background-color: #060D0C; color: #F0EDE5;">
            Today's Subjects
          </button>
          <button onclick="showSection('subjectsSection')" id="subjectsTab" class="flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all duration-300" style="color: #8B9B8F;">
            Your Subjects
          </button>
          <button onclick="showSection('completedSection')" id="completedTab" class="flex-1 px-3 py-2 text-xs font-medium rounded-lg transition-all duration-300" style="color: #8B9B8F;">
            Completed
          </button>
        </div>
      </div>

      <!-- Today's Subjects Section (Current Queue) -->
      <div id="todaySection" class="section-content">
        <div class="glass-card rounded-2xl p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold" style="color: #060D0C;">Today's Queue</h2>
              <p class="text-sm" style="color: #8B9B8F;">Ready for attendance</p>
            </div>
            <div class="text-center">
              <div class="w-10 h-10 rounded-lg flex items-center justify-center floating-badge" style="background: linear-gradient(135deg, #060D0C 0%, #2A3B36 100%);">
                <span class="text-sm font-bold" style="color: #F0EDE5;" id="queueCount">0</span>
              </div>
            </div>
          </div>
          
          <div id="emptyQueuePrompt" class="text-center py-6">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3" style="background-color: #F0EDE5;">
              <i class="fas fa-calendar-day text-lg" style="color: #060D0C;"></i>
            </div>
            <h3 class="text-base font-bold mb-2" style="color: #060D0C;">No Classes Today</h3>
            <p class="text-sm mb-4" style="color: #8B9B8F;">Add subjects from "Your Subjects" to get started</p>
          </div>
          
          <div id="queueList" class="space-y-3">
            <!-- Queue items populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Your Subjects Section -->
      <div id="subjectsSection" class="section-content hidden">
        <div class="glass-card rounded-2xl p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold" style="color: #060D0C;">Your Subjects</h2>
              <p class="text-sm" style="color: #8B9B8F;">Manage your subjects</p>
            </div>
            <button onclick="showCreateSubjectForm()" class="px-3 py-2 rounded-lg font-medium text-sm transition-all duration-300" style="background-color: #060D0C; color: #F0EDE5;">
              <i class="fas fa-plus mr-1"></i>Create
            </button>
          </div>
          
          <div id="emptySubjectsPrompt" class="text-center py-6">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3" style="background-color: #F0EDE5;">
              <i class="fas fa-book text-lg" style="color: #060D0C;"></i>
            </div>
            <h3 class="text-base font-bold mb-2" style="color: #060D0C;">No Subjects Created</h3>
            <p class="text-sm mb-4" style="color: #8B9B8F;">Create your first subject to get started</p>
            <button onclick="showCreateSubjectForm()" class="px-4 py-2 rounded-lg font-medium text-sm transition-all duration-300" style="background-color: #060D0C; color: #F0EDE5;">
              <i class="fas fa-plus mr-2"></i>Create Subject
            </button>
          </div>
          
          <div id="subjectsList" class="space-y-3">
            <!-- Created subjects populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Completed Section -->
      <div id="completedSection" class="section-content hidden">
        <div class="glass-card rounded-2xl p-4 mb-4">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-bold" style="color: #060D0C;">Completed Classes</h2>
              <p class="text-sm" style="color: #8B9B8F;">Successfully processed</p>
            </div>
            <div class="text-center">
              <div class="w-10 h-10 rounded-lg flex items-center justify-center floating-badge" style="background-color: #F0EDE5;">
                <span class="text-sm font-bold" style="color: #060D0C;" id="completedCount">0</span>
              </div>
            </div>
          </div>
          
          <div id="emptyCompletedPrompt" class="text-center py-6">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3" style="background-color: #F0EDE5;">
              <i class="fas fa-check-circle text-lg" style="color: #060D0C;"></i>
            </div>
            <h3 class="text-base font-bold mb-2" style="color: #060D0C;">No Completed Classes</h3>
            <p class="text-sm" style="color: #8B9B8F;">Completed classes will appear here</p>
          </div>
          
          <div id="completedList" class="space-y-3">
            <!-- Completed items populated by JavaScript -->
          </div>
        </div>
      </div>

    </div>

    <!-- Create Subject Form -->
    <div id="createSubjectPage" class="hidden slide-in">
      <div class="glass-card rounded-2xl p-4 mt-4">
        <div class="text-center mb-6">
          <div class="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3" style="background: linear-gradient(135deg, #F0EDE5 0%, #E8E3D8 100%);">
            <i class="fas fa-book-plus text-lg" style="color: #060D0C;"></i>
          </div>
          <h2 class="text-lg font-bold mb-1" style="color: #060D0C;">Create New Subject</h2>
          <p class="text-sm" style="color: #8B9B8F;">Add a subject to your collection</p>
        </div>

        <form id="createSubjectForm" class="space-y-4">
          <!-- Stream Selection -->
          <div>
            <label class="block text-sm font-bold mb-3" style="color: #060D0C;">
              <i class="fas fa-graduation-cap mr-2" style="color: #060D0C;"></i>
              Academic Stream
            </label>
            <div id="createStreamContainer" class="space-y-2">
              <!-- Stream cards will be populated by JavaScript -->
            </div>
            <input type="hidden" id="createSelectedStream" required>
          </div>

          <!-- Semester Selection -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              <i class="fas fa-calendar-alt mr-2" style="color: #060D0C;"></i>
              Semester
            </label>
            <select id="createSemester" required class="w-full px-3 py-3 form-input rounded-xl font-medium" style="color: #060D0C; border-color: #8B9B8F;">
              <option value="">Select semester</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
            </select>
          </div>

          <!-- Subject Selection -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              <i class="fas fa-book-open mr-2" style="color: #060D0C;"></i>
              Subject
            </label>
            <div class="relative">
              <select id="createSubject" required class="w-full px-3 py-3 form-input rounded-xl text-gray-800 font-medium" disabled>
                <option value="">Select stream & semester first</option>
              </select>
              <div id="createSubjectLoader" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
                <div class="loading-spinner"></div>
              </div>
            </div>
            <p id="createSubjectHelp" class="text-xs text-gray-500 mt-1 ml-1">Choose stream and semester to load subjects</p>
          </div>

          <!-- Action Buttons -->
          <div class="flex space-x-3 pt-2">
            <button type="button" onclick="cancelCreateSubject()" class="flex-1 px-4 py-3 rounded-xl font-medium transition-all duration-300" style="color: #8B9B8F; border: 1px solid #8B9B8F;">
              Cancel
            </button>
            <button type="submit" id="createSubjectBtn" class="flex-1 px-4 py-3 rounded-xl font-bold text-white transition-all duration-300" style="background: linear-gradient(135deg, #060D0C 0%, #2A3B36 100%);">
              <i class="fas fa-plus mr-2"></i>
              Add to Library
            </button>
          </div>
        </form>
      </div>

      <!-- Compact Info Card -->
      <div class="glass-card rounded-2xl p-4 mt-4 border-l-4" style="border-left-color: #060D0C;">
        <div class="flex items-start">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 mt-1" style="background-color: #F0EDE5;">
            <i class="fas fa-lightbulb" style="color: #060D0C;"></i>
          </div>
          <div>
            <h4 class="font-bold text-gray-800 mb-2">Subject Library</h4>
            <ul class="space-y-2 text-gray-600 text-sm">
              <li class="flex items-center">
                <div class="w-1.5 h-1.5 rounded-full mr-2" style="background-color: #060D0C;"></div>
                <span>Select from available subjects in database</span>
              </li>
              <li class="flex items-center">
                <div class="w-1.5 h-1.5 rounded-full mr-2" style="background-color: #060D0C;"></div>
                <span>Build your personal subject library</span>
              </li>
              <li class="flex items-center">
                <div class="w-1.5 h-1.5 rounded-full mr-2" style="background-color: #060D0C;"></div>
                <span>Add to queue whenever needed</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Add Class Form with Stream Containers -->
    <div id="addClassPage" class="hidden slide-in">
      <div class="glass-card rounded-2xl p-4 mt-4">
        <div class="text-center mb-6">
          <div class="w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3" style="background: linear-gradient(135deg, #F0EDE5 0%, #E8E3D8 100%);">
            <i class="fas fa-plus text-lg" style="color: #060D0C;"></i>
          </div>
          <h2 class="text-lg font-bold mb-1" style="color: #060D0C;">Add New Class</h2>
          <p class="text-sm" style="color: #8B9B8F;">Select class details for your queue</p>
        </div>

        <form id="addClassForm" class="space-y-4">
          <!-- Enhanced Stream Selection with Visual Cards -->
          <div>
            <label class="block text-sm font-bold mb-3" style="color: #060D0C;">
              <i class="fas fa-graduation-cap mr-2" style="color: #060D0C;"></i>
              Academic Stream
            </label>
            <div id="streamContainer" class="space-y-2">
              <!-- Stream cards will be populated by JavaScript -->
            </div>
            <input type="hidden" id="selectedStream" required>
          </div>

          <!-- Semester Selection -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              <i class="fas fa-calendar-alt mr-2" style="color: #060D0C;"></i>
              Semester
            </label>
            <select id="semester" required class="w-full px-3 py-3 form-input rounded-xl font-medium" style="color: #060D0C; border-color: #8B9B8F;">
              <option value="">Select semester</option>
              <option value="1">Semester 1</option>
              <option value="2">Semester 2</option>
              <option value="3">Semester 3</option>
              <option value="4">Semester 4</option>
              <option value="5">Semester 5</option>
              <option value="6">Semester 6</option>
            </select>
          </div>

          <!-- Subject Selection -->
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              <i class="fas fa-book-open mr-2" style="color: #060D0C;"></i>
              Subject
            </label>
            <div class="relative">
              <select id="subject" required class="w-full px-3 py-3 form-input rounded-xl text-gray-800 font-medium" disabled>
                <option value="">Select stream & semester first</option>
              </select>
              <div id="subjectLoader" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2">
                <div class="loading-spinner"></div>
              </div>
            </div>
            <p id="subjectHelp" class="text-xs text-gray-500 mt-1 ml-1">Choose stream and semester to load subjects</p>
          </div>

          <!-- Submit Button -->
          <button type="submit" id="addBtn" class="w-full btn-primary text-white px-6 py-3 rounded-xl font-bold shadow-xl disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fas fa-plus mr-2"></i>
            Add to Queue
          </button>
        </form>
      </div>

      <!-- Compact Info Card -->
      <div class="glass-card rounded-2xl p-4 mt-4 border-l-4" style="border-left-color: #060D0C;">
        <div class="flex items-start">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3 mt-1" style="background-color: #F0EDE5;">
            <i class="fas fa-lightbulb" style="color: #060D0C;"></i>
          </div>
          <div>
            <h4 class="font-bold text-gray-800 mb-2">How it works</h4>
            <ul class="space-y-2 text-gray-600 text-sm">
              <li class="flex items-center">
                <div class="w-1.5 h-1.5 rounded-full mr-2" style="background-color: #060D0C;"></div>
                <span>Classes are added to your queue</span>
              </li>
              <li class="flex items-center">
                <div class="w-1.5 h-1.5 rounded-full mr-2" style="background-color: #060D0C;"></div>
                <span>Take attendance to complete them</span>
              </li>
              <li class="flex items-center">
                <div class="w-1.5 h-1.5 rounded-full mr-2" style="background-color: #060D0C;"></div>
                <span>Queue resets daily</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Test if JavaScript is working
    console.log('ðŸš€ JavaScript loaded successfully');
    
    // Enhanced Toggle Menu Function - Handle menu, backdrop, and hamburger animation
    function toggleMenu() {
      console.log('ðŸ”„ toggleMenu called');
      const menu = document.getElementById("mobileMenu");
      const backdrop = document.getElementById("menuBackdrop");
      const menuIcon = document.querySelector('.menu-icon');
      
      console.log('ðŸ“± Menu element:', menu);
      console.log('ðŸ“± Backdrop element:', backdrop);
      console.log('ðŸ“± Menu icon element:', menuIcon);
      
      if (!menu || !backdrop) {
        console.error('âŒ Menu or backdrop element not found');
        return;
      }
      
      const isHidden = menu.classList.contains('hidden');
      console.log('ðŸ“± Current state - menu hidden:', isHidden);
      
      if (isHidden) {
        // Show menu
        console.log('ðŸ“± Opening menu');
        menu.classList.remove('hidden');
        // Force reflow to ensure hidden class is removed before transform
        menu.offsetHeight;
        menu.classList.remove('-translate-x-full');
        backdrop.classList.remove('hidden');
        if (menuIcon) menuIcon.classList.add('active');
        console.log('ðŸ“± Menu opened');
      } else {
        // Hide menu
        console.log('ðŸ“± Closing menu');
        menu.classList.add('-translate-x-full');
        backdrop.classList.add('hidden');
        if (menuIcon) menuIcon.classList.remove('active');
        
        // Wait for animation to complete before hiding
        setTimeout(() => {
          if (menu.classList.contains('-translate-x-full')) {
            menu.classList.add('hidden');
            console.log('ðŸ“± Menu hidden after animation');
          }
        }, 300);
        console.log('ðŸ“± Menu closing');
      }
    }
    
    // Make it globally available
    window.toggleMenu = toggleMenu;
    console.log('âœ… toggleMenu function assigned to window');

    // Enhanced streams configuration based on your structure - LUXE NOIR Theme
    const streams = [
      {
        name: "BCA",
        icon: '<i class="fas fa-laptop-code" style="color: #060D0C;"></i>',
        color: "bg-gray-100",
        textColor: "text-gray-800",
        borderColor: "border-gray-500",
        luxeColor: "#060D0C"
      },
      {
        name: "BBA",
        icon: '<i class="fas fa-chart-line" style="color: #2A3B36;"></i>',
        color: "bg-gray-100",
        textColor: "text-gray-800",
        borderColor: "border-gray-500",
        luxeColor: "#2A3B36"
      },
      {
        name: "BCom",
        displayName: "BCom",
        icon: '<i class="fas fa-money-bill-wave" style="color: #060D0C;"></i>',
        color: "bg-gray-100",
        textColor: "text-gray-800",
        borderColor: "border-gray-500",
        luxeColor: "#060D0C"
      },
      {
        name: "BCom Section B",
        displayName: "BCom B",
        icon: '<i class="fas fa-money-bill-wave" style="color: #2A3B36;"></i>',
        color: "bg-gray-100",
        textColor: "text-gray-800",
        borderColor: "border-gray-500",
        limitedSemesters: [5, 6],
        luxeColor: "#2A3B36"
      },
      {
        name: "BCom-BDA",
        displayName: "BDA",
        icon: '<i class="fas fa-chart-bar" style="color: #060D0C;"></i>',
        color: "bg-gray-100",
        textColor: "text-gray-800",
        borderColor: "border-gray-500",
        luxeColor: "#060D0C"
      },
      {
        name: "BCom A and F",
        icon: '<i class="fas fa-calculator" style="color: #2A3B36;"></i>',
        color: "bg-gray-100",
        textColor: "text-gray-800",
        borderColor: "border-gray-500",
        luxeColor: "#2A3B36"
      }
    ];

    // Global variables
    let attendanceQueue = [];
    let createdSubjects = [];
    let completedClasses = [];
    let selectedStreamData = null;
    let createSelectedStreamData = null;
    let currentSection = 'todaySection';
    let userData = {
      userName: 'Teacher',
      userEmail: 'teacher@school.edu',
      firebaseUid: null
    };

    // Update user data when authenticated
    function updateUserData(user) {
      if (user) {
        userData = {
          userName: user.displayName || user.email?.split('@')[0] || 'Teacher',
          userEmail: user.email || 'teacher@school.edu',
          firebaseUid: user.uid
        };
      }
    }

    // API base URL
    const API_BASE_URL = '/api';

    // ============================================================================
    // TEACHER DATABASE FUNCTIONS
    // ============================================================================

    // Create or update teacher profile in database
    async function saveTeacherProfile() {
      try {
        if (!userData.firebaseUid) {
          console.log('No Firebase UID available - skipping database teacher profile creation');
          return { success: true, message: 'Skipped - no Firebase UID' };
        }

        console.log('Saving teacher profile:', {
          firebaseUid: userData.firebaseUid,
          name: userData.userName,
          email: userData.userEmail
        });

        if (!userData.firebaseUid || userData.firebaseUid === 'null' || userData.firebaseUid === '') {
          throw new Error('Invalid Firebase UID: ' + userData.firebaseUid);
        }

        const response = await fetch(`${API_BASE_URL}/teacher/profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            firebaseUid: userData.firebaseUid,
            name: userData.userName,
            email: userData.userEmail
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          console.log('âœ… Teacher profile saved successfully:', result.teacher);
          return result.teacher;
        } else {
          console.error('âŒ Failed to save teacher profile:', result.message);
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('âŒ Error saving teacher profile:', error);
        throw error;
      }
    }

    // Get teacher profile from database
    async function getTeacherProfile() {
      try {
        let response;
        
        if (userData.firebaseUid) {
          // Use Firebase UID for Firebase authenticated users
          response = await fetch(`${API_BASE_URL}/teacher/profile/${userData.firebaseUid}`);
        } else if (userData.userEmail) {
          // Use email for localStorage authenticated users
          response = await fetch(`${API_BASE_URL}/teacher/profile/email/${encodeURIComponent(userData.userEmail)}`);
        } else {
          console.warn('No identifier available for teacher lookup');
          return null;
        }

        const result = await response.json();
        
        if (result.success) {
          return result.teacher;
        } else {
          console.log('Teacher profile not found, will create new one');
          return null;
        }
      } catch (error) {
        console.error('Error fetching teacher profile:', error);
        return null;
      }
    }

    // Save created subject to database
    async function saveCreatedSubject(subjectData) {
      try {
        let apiUrl;
        
        if (userData.firebaseUid) {
          // Use Firebase UID for Firebase authenticated users
          apiUrl = `${API_BASE_URL}/teacher/${userData.firebaseUid}/subjects`;
        } else if (userData.userEmail) {
          // Use email for localStorage authenticated users
          apiUrl = `${API_BASE_URL}/teacher/email/${encodeURIComponent(userData.userEmail)}/subjects`;
        } else {
          console.warn('No identifier available for saving subject');
          return false;
        }

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(subjectData)
        });

        const result = await response.json();
        
        if (result.success) {
          console.log('Subject saved to database successfully');
          return true;
        } else {
          console.error('Failed to save subject:', result.message);
          return false;
        }
      } catch (error) {
        console.error('Error saving subject:', error);
        return false;
      }
    }

    // Load teacher's created subjects from database
    async function loadCreatedSubjects() {
      try {
        const teacher = await getTeacherProfile();
        if (teacher && teacher.createdSubjects) {
          return teacher.createdSubjects;
        }
        return [];
      } catch (error) {
        console.error('Error loading created subjects:', error);
        return [];
      }
    }

    // Initialize teacher in database
    async function initializeTeacherInDatabase() {
      try {
        // Save/update teacher profile
        const teacherProfile = await saveTeacherProfile();
        
        // Check if we have a valid teacher profile or if we're continuing offline
        if (!teacherProfile || typeof teacherProfile === 'string') {
          console.log('Database initialization skipped - continuing offline');
          return true; // Continue without database operations
        }
        
        // Load any existing created subjects only if we have a valid profile
        if (userData.firebaseUid) {
          const createdSubjects = await loadCreatedSubjects();
          console.log(`Loaded ${createdSubjects.length} created subjects`);
        }
        
        return true;
      } catch (error) {
        console.error('Error initializing teacher in database:', error);
        // Don't throw error - continue offline
        console.log('Database connection issue (continuing offline)');
        return true;
      }
    }

    // DOM Elements
    const elements = {
      homePage: document.getElementById('homePage'),
      addClassPage: document.getElementById('addClassPage'),
      backButtonHome: document.getElementById('backButtonHome'),
      backButtonForm: document.getElementById('backButtonForm'),
      streamContainer: document.getElementById('streamContainer'),
      selectedStream: document.getElementById('selectedStream'),
      semesterSelect: document.getElementById('semester'),
      subjectSelect: document.getElementById('subject'),
      subjectLoader: document.getElementById('subjectLoader'),
      subjectHelp: document.getElementById('subjectHelp'),
      addBtn: document.getElementById('addBtn')
    };

    // Database API functions (same as before)
    async function saveQueueToDatabase(queueData) {
      try {
        const response = await fetch(`${API_BASE_URL}/queue`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            teacherId: userData.userName,
            firebaseUid: userData.firebaseUid,
            queueData: queueData,
            timestamp: new Date().toISOString()
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          console.log('ðŸ’¾ Queue saved to database successfully');
          return result;
        } else {
          throw new Error(result.message || 'Failed to save queue');
        }
      } catch (error) {
        console.error('Error saving to database:', error);
        localStorage.setItem('attendanceQueue', JSON.stringify(queueData));
        showNotification('Saved locally (database error)', 'warning');
        return null;
      }
    }

    async function loadQueueFromDatabase() {
      try {
        const identifier = userData.firebaseUid || userData.userName;
        const response = await fetch(`${API_BASE_URL}/queue/${identifier}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 404) {
            console.log('Teacher not found in database, initializing empty queue');
            attendanceQueue = [];
            return { queueData: [] };
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success) {
          attendanceQueue = result.queueData || [];
          console.log(`ðŸ“¥ Loaded ${attendanceQueue.length} items from database`);
          
          // Update localStorage with database data
          localStorage.setItem('attendanceQueue', JSON.stringify(attendanceQueue));
          
          return result;
        } else {
          throw new Error(result.message || 'Failed to load queue');
        }
      } catch (error) {
        console.error('Error loading from database:', error);
        throw error; // Re-throw to trigger fallback in calling function
      }
    }

    async function deleteQueueItemFromDatabase(itemId) {
      try {
        const response = await fetch(`${API_BASE_URL}/queue/item/${itemId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            teacherId: userData.userName,
            firebaseUid: userData.firebaseUid
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          console.log('ðŸ—‘ï¸ Queue item deleted from database successfully');
          return result;
        } else {
          throw new Error(result.message || 'Failed to delete queue item');
        }
      } catch (error) {
        console.error('Error deleting from database:', error);
        return null;
      }
    }

    // Create stream selection cards
    function createStreamCards() {
      if (!elements.streamContainer) return;
      
      elements.streamContainer.innerHTML = streams.map(stream => `
        <div class="stream-container glass-card rounded-xl p-3 cursor-pointer border-2 border-transparent hover:${stream.borderColor}" 
             onclick="selectStream('${stream.name}')" 
             data-stream="${stream.name}">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 ${stream.color} rounded-lg flex items-center justify-center">
              ${stream.icon}
            </div>
            <div class="flex-1">
              <h4 class="font-bold ${stream.textColor}">${stream.displayName || stream.name}</h4>
              <p class="text-xs text-gray-500">${stream.limitedSemesters ? 'Sem ' + stream.limitedSemesters.join(', ') + ' only' : 'All semesters'}</p>
            </div>
            <div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center">
              <div class="w-3 h-3 ${stream.color} rounded-full opacity-0 transition-opacity" data-check="${stream.name}"></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Select stream function
    function selectStream(streamName) {
      // Remove previous selection
      document.querySelectorAll('.stream-container').forEach(card => {
        card.classList.remove('ring-2', 'ring-offset-2');
        const streamData = streams.find(s => s.name === card.dataset.stream);
        if (streamData) {
          card.classList.remove(`ring-${streamData.borderColor.split('-')[1]}-500`);
        }
      });
      
      document.querySelectorAll('[data-check]').forEach(check => {
        check.classList.add('opacity-0');
      });

      // Add selection to clicked card
      const selectedCard = document.querySelector(`[data-stream="${streamName}"]`);
      const streamData = streams.find(s => s.name === streamName);
      
      if (selectedCard && streamData) {
        selectedCard.classList.add('ring-2', 'ring-offset-2', `ring-${streamData.borderColor.split('-')[1]}-500`);
        document.querySelector(`[data-check="${streamName}"]`).classList.remove('opacity-0');
      }

      // Update selected stream
      selectedStreamData = streamData;
      elements.selectedStream.value = streamName;
      
      // Update semesters based on selection
      updateSemesters();
      
      // Reset subject selection
      elements.subjectSelect.innerHTML = '<option value="">Select semester first</option>';
      elements.subjectSelect.disabled = true;
      elements.addBtn.disabled = true;
    }

    // Update semester options based on stream selection
    function updateSemesters() {
      const semesterSelect = elements.semesterSelect;
      
      // Clear existing options
      semesterSelect.innerHTML = '<option value="">Select semester</option>';
      
      if (selectedStreamData && selectedStreamData.limitedSemesters) {
        // Add only limited semesters
        selectedStreamData.limitedSemesters.forEach(sem => {
          const option = document.createElement('option');
          option.value = sem;
          option.textContent = `Semester ${sem}`;
          semesterSelect.appendChild(option);
        });
      } else {
        // Add all semesters
        for (let i = 1; i <= 6; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `Semester ${i}`;
          semesterSelect.appendChild(option);
        }
      }
    }

    function checkNewDay() {
      const today = new Date().toDateString();
      const lastClear = localStorage.getItem('lastClearDate');
      
      if (lastClear !== today) {
        localStorage.setItem('lastClearDate', today);
      }
    }

    // ============================================================================
    // SECTION MANAGEMENT
    // ============================================================================
    
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.section-content').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Show selected section
      document.getElementById(sectionId).classList.remove('hidden');
      currentSection = sectionId;
      
      // Update tab buttons
      document.querySelectorAll('#todayTab, #subjectsTab, #completedTab').forEach(tab => {
        tab.style.backgroundColor = 'transparent';
        tab.style.color = '#8B9B8F';
      });
      
      // Highlight active tab
      const activeTabMap = {
        'todaySection': 'todayTab',
        'subjectsSection': 'subjectsTab', 
        'completedSection': 'completedTab'
      };
      
      const activeTab = document.getElementById(activeTabMap[sectionId]);
      if (activeTab) {
        activeTab.style.backgroundColor = '#060D0C';
        activeTab.style.color = '#F0EDE5';
      }
      
      // Update displays based on section
      if (sectionId === 'todaySection') {
        updateQueueDisplay();
      } else if (sectionId === 'subjectsSection') {
        updateSubjectsDisplay();
      } else if (sectionId === 'completedSection') {
        updateCompletedDisplay();
      }
    }

    // Page navigation
    function showHomePage() {
      elements.homePage.classList.remove('hidden');
      elements.addClassPage.classList.add('hidden');
      
      const createSubjectPage = document.getElementById('createSubjectPage');
      if (createSubjectPage) {
        createSubjectPage.classList.add('hidden');
      }
      
      elements.backButtonHome.classList.remove('hidden');
      elements.backButtonForm.classList.add('hidden');
      elements.homePage.classList.add('slide-in');
      showSection(currentSection);
    }

    function showAddClassForm() {
      elements.homePage.classList.add('hidden');
      elements.addClassPage.classList.remove('hidden');
      
      const createSubjectPage = document.getElementById('createSubjectPage');
      if (createSubjectPage) {
        createSubjectPage.classList.add('hidden');
      }
      
      elements.backButtonHome.classList.add('hidden');
      elements.backButtonForm.classList.remove('hidden');
      elements.addClassPage.classList.add('slide-in');
      resetForm();
    }

    function showCreateSubjectForm() {
      elements.homePage.classList.add('hidden');
      elements.addClassPage.classList.add('hidden');
      
      const createSubjectPage = document.getElementById('createSubjectPage');
      if (createSubjectPage) {
        createSubjectPage.classList.remove('hidden');
        createSubjectPage.classList.add('slide-in');
      } else {
        console.error('âŒ createSubjectPage element not found!');
        return;
      }
      
      elements.backButtonHome.classList.add('hidden');
      elements.backButtonForm.classList.remove('hidden');
      resetCreateForm();
      createStreamCards();
    }

    function cancelCreateSubject() {
      showHomePage();
    }

    // ============================================================================
    // DISPLAY FUNCTIONS
    // ============================================================================
    
    function updateQueueDisplay() {
      const emptyQueuePrompt = document.getElementById('emptyQueuePrompt');
      const queueList = document.getElementById('queueList');

      if (!emptyQueuePrompt || !queueList) {
        console.warn('Queue DOM elements not found, retrying...');
        setTimeout(updateQueueDisplay, 100);
        return;
      }

      document.getElementById('queueCount').textContent = attendanceQueue.length;

      if (attendanceQueue.length === 0) {
        emptyQueuePrompt.classList.remove('hidden');
        queueList.innerHTML = '';
      } else {
        emptyQueuePrompt.classList.add('hidden');
        
        queueList.innerHTML = attendanceQueue.map((item, index) => {
          const streamData = streams.find(s => s.name === item.stream) || streams[0];
          return `
            <div class="queue-item glass-card rounded-2xl border-l-4 ${streamData.borderColor} p-4" data-id="${item.id}">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-start">
                  <div class="w-8 h-8 bg-white bg-opacity-80 rounded-lg flex items-center justify-center mr-3">
                    <span class="font-bold text-sm" style="color: #060D0C;">${index + 1}</span>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center mb-2">
                      <div class="w-6 h-6 ${streamData.color} rounded mr-2 flex items-center justify-center">
                        ${streamData.icon}
                      </div>
                      <h3 class="font-bold text-gray-800">${item.subject}</h3>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-2">
                      <span class="${streamData.color} ${streamData.textColor} px-2 py-1 rounded-lg text-xs font-semibold">${streamData.displayName || item.stream}</span>
                      <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-lg text-xs font-semibold">Sem ${item.semester}</span>
                    </div>
                    <p class="text-gray-500 text-xs">Added: ${item.timeAdded}</p>
                  </div>
                </div>
              </div>
              <div class="flex space-x-2">
                <button onclick="takeAttendance(${item.id})" class="w-full text-white px-4 py-2 rounded-lg font-medium transition-all duration-300 shadow-lg" style="background: linear-gradient(to right, #060D0C, #2A3B36);" onmouseover="this.style.background='linear-gradient(to right, #2A3B36, #060D0C)'" onmouseout="this.style.background='linear-gradient(to right, #060D0C, #2A3B36)'">
                  <i class="fas fa-user-check mr-2"></i>
                  Attend
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function updateSubjectsDisplay() {
      const emptySubjectsPrompt = document.getElementById('emptySubjectsPrompt');
      const subjectsList = document.getElementById('subjectsList');

      if (!emptySubjectsPrompt || !subjectsList) {
        console.warn('Subjects DOM elements not found');
        return;
      }

      if (createdSubjects.length === 0) {
        emptySubjectsPrompt.classList.remove('hidden');
        subjectsList.innerHTML = '';
      } else {
        emptySubjectsPrompt.classList.add('hidden');
        
        subjectsList.innerHTML = createdSubjects.map(subject => {
          const streamData = streams.find(s => s.name === subject.stream) || streams[0];
          return `
            <div class="glass-card rounded-2xl border-l-4 ${streamData.borderColor} p-4" data-subject-id="${subject.id}">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-start flex-1">
                  <div class="w-8 h-8 ${streamData.color} rounded-lg flex items-center justify-center mr-3">
                    ${streamData.icon}
                  </div>
                  <div class="flex-1">
                    <h3 class="font-bold text-gray-800 mb-1">${subject.subjectName}</h3>
                    ${subject.subjectCode ? `<p class="text-xs text-gray-500 mb-2">${subject.subjectCode}</p>` : ''}
                    <div class="flex flex-wrap gap-1">
                      <span class="${streamData.color} ${streamData.textColor} px-2 py-1 rounded-lg text-xs font-semibold">${streamData.displayName || subject.stream}</span>
                      <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-lg text-xs font-semibold">Sem ${subject.semester}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex space-x-2">
                <button onclick="addSubjectToQueue('${subject.id}')" class="flex-1 text-white px-3 py-2 rounded-lg font-medium text-sm transition-all duration-300" style="background: linear-gradient(to right, #060D0C, #2A3B36);">
                  <i class="fas fa-plus mr-2"></i>Add to Queue
                </button>
                <button onclick="deleteSubject('${subject.id}')" class="px-3 py-2 rounded-lg font-medium text-sm transition-all duration-300" style="color: #8B9B8F; border: 1px solid #8B9B8F;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function updateCompletedDisplay() {
      const emptyCompletedPrompt = document.getElementById('emptyCompletedPrompt');
      const completedList = document.getElementById('completedList');

      if (!emptyCompletedPrompt || !completedList) {
        console.warn('Completed DOM elements not found');
        return;
      }

      document.getElementById('completedCount').textContent = completedClasses.length;

      if (completedClasses.length === 0) {
        emptyCompletedPrompt.classList.remove('hidden');
        completedList.innerHTML = '';
      } else {
        emptyCompletedPrompt.classList.add('hidden');
        
        completedList.innerHTML = completedClasses.map(item => {
          const streamData = streams.find(s => s.name === item.stream) || streams[0];
          return `
            <div class="rounded-lg p-3" style="background: linear-gradient(to right, #F0EDE5, #E8E3D8); border-left: 4px solid #060D0C;">
              <div class="flex items-center">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center mr-3" style="background-color: #E8E3D8;">
                  <i class="fas fa-check text-sm" style="color: #060D0C;"></i>
                </div>
                <div class="flex-1">
                  <div class="flex items-center mb-1">
                    <div class="w-4 h-4 ${streamData.color} rounded mr-1 flex items-center justify-center">
                      ${streamData.icon}
                    </div>
                    <h4 class="font-bold text-gray-800 text-sm">${item.subject}</h4>
                  </div>
                  <p class="text-xs text-gray-600 mb-1">${streamData.displayName || item.stream} â€¢ Sem ${item.semester}</p>
                  <p class="text-xs font-semibold" style="color: #060D0C;">Completed: ${item.completedTime}</p>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    async function onSemesterChange() {
      const semester = elements.semesterSelect?.value;
      
      if (!elements.subjectSelect || !selectedStreamData) return;
      
      elements.subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
      elements.subjectSelect.disabled = true;
      elements.addBtn.disabled = true;
      
      if (!semester) {
        elements.subjectSelect.innerHTML = '<option value="">Select semester first</option>';
        elements.subjectHelp.textContent = 'Choose semester to load subjects';
        elements.subjectHelp.className = 'text-xs text-gray-500 mt-1 ml-1';
        return;
      }

      await loadSubjects(selectedStreamData.name, semester);
    }

    async function loadSubjects(stream, semester) {
      try {
        elements.subjectLoader.classList.remove('hidden');
        elements.subjectSelect.innerHTML = '<option value="">Loading...</option>';
        elements.subjectHelp.textContent = 'Loading subjects...';
        elements.subjectHelp.className = 'text-xs text-blue-600 mt-1 ml-1 font-medium';
        
        const response = await fetch(`/api/subjects/${stream}/sem${semester}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        const subjects = data.subjects || data || [];
        
        elements.subjectLoader.classList.add('hidden');
        
        if (!Array.isArray(subjects) || subjects.length === 0) {
          elements.subjectSelect.innerHTML = '<option value="">No subjects found</option>';
          elements.subjectHelp.textContent = 'No subjects available';
          elements.subjectHelp.className = 'text-xs text-yellow-600 mt-1 ml-1 font-medium';
          return;
        }
        
        elements.subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        subjects.forEach(subject => {
          const subjectName = subject.subjectName || subject.name || subject;
          const option = document.createElement('option');
          option.value = subjectName;
          option.textContent = subjectName;
          if (subject.isLanguageSubject || subject.subjectType === 'LANGUAGE') {
            option.textContent += ` (${subject.languageType})`;
          }
          elements.subjectSelect.appendChild(option);
        });
        
        elements.subjectSelect.disabled = false;
        elements.addBtn.disabled = false;
        elements.subjectHelp.textContent = `${subjects.length} subjects available`;
        elements.subjectHelp.className = 'text-xs text-green-600 mt-1 ml-1 font-medium';
        
      } catch (error) {
        elements.subjectLoader.classList.add('hidden');
        elements.subjectSelect.innerHTML = '<option value="">Error loading</option>';
        elements.subjectHelp.textContent = 'Failed to load subjects';
        elements.subjectHelp.className = 'text-xs text-red-500 mt-1 ml-1 font-medium';
      }
    }

    async function handleAddToQueue(e) {
      e.preventDefault();
      
      const stream = elements.selectedStream?.value;
      const semester = elements.semesterSelect?.value;
      const subject = elements.subjectSelect?.value;

      if (!stream || !semester || !subject) {
        showNotification('Please fill all fields', 'error');
        return;
      }

      const duplicate = attendanceQueue.find(item => 
        item.stream === stream && item.semester === semester && item.subject === subject
      );

      if (duplicate) {
        showNotification('Class already in queue', 'warning');
        return;
      }

      const queueItem = {
        id: Date.now(),
        stream,
        semester,
        subject,
        timeAdded: new Date().toLocaleTimeString(),
        dateAdded: new Date().toDateString(),
        teacherId: userData.userName
      };

      // Create subject data for database storage
      const subjectData = {
        subjectId: `${stream.toLowerCase()}_${semester}_${subject.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}`,
        subjectName: subject,
        subjectCode: subject.toUpperCase().replace(/\s+/g, '_'),
        streamId: `${stream.toLowerCase()}_stream`,
        streamName: stream,
        semesterNumber: parseInt(semester),
        status: 'active',
        studentCount: 0,
        students: [],
        iaTests: [],
        createdAt: new Date(),
        updatedAt: new Date()
      };

      // Save to local queue first
      attendanceQueue.push(queueItem);
      
      // Save to localStorage immediately for persistence
      localStorage.setItem('attendanceQueue', JSON.stringify(attendanceQueue));
      
      // Force immediate display update
      updateQueueDisplay();
      
      // Try to save to database (this might fail, but that's ok)
      try {
        await saveQueueToDatabase(attendanceQueue);
      } catch (error) {
        console.log('Database save failed, using localStorage');
      }

      // Save created subject to teacher's database record
      const subjectSaved = await saveCreatedSubject(subjectData);
      
      if (subjectSaved) {
        showNotification('Class added & saved to database! ðŸŽ‰', 'success');
      } else {
        showNotification('Class added to queue (database save failed)', 'warning');
      }
      
      resetForm();
      
      // Navigate to home page first
      showHomePage();
      
      // Multiple display updates to ensure reliability
      setTimeout(() => {
        updateQueueDisplay();
        
        // Additional fallback update
        setTimeout(() => {
          updateQueueDisplay();
          
          // Show success animation for the newly added item
          const newItemElement = document.querySelector(`[data-id="${queueItem.id}"]`);
          if (newItemElement) {
            newItemElement.classList.add('animate-pulse');
            newItemElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
              newItemElement.classList.remove('animate-pulse');
            }, 2000);
          }
        }, 100);
      }, 50);
    }

    // ============================================================================
    // SUBJECT MANAGEMENT FUNCTIONS
    // ============================================================================

    function createStreamCards() {
      const container = document.getElementById('createStreamContainer');
      if (!container) return;
      
      container.innerHTML = streams.map(stream => `
        <div class="stream-container glass-card rounded-xl p-3 cursor-pointer border-2 border-transparent hover:${stream.borderColor}" 
             onclick="selectCreateStream('${stream.name}')" 
             data-stream="${stream.name}">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 ${stream.color} rounded-lg flex items-center justify-center">
              ${stream.icon}
            </div>
            <div class="flex-1">
              <h4 class="font-bold ${stream.textColor}">${stream.displayName || stream.name}</h4>
              <p class="text-xs text-gray-500">${stream.limitedSemesters ? 'Sem ' + stream.limitedSemesters.join(', ') + ' only' : 'All semesters'}</p>
            </div>
            <div class="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center">
              <div class="w-3 h-3 ${stream.color} rounded-full opacity-0 transition-opacity" data-check="${stream.name}"></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function selectCreateStream(streamName) {
      // Remove previous selection
      document.querySelectorAll('#createStreamContainer .stream-container').forEach(card => {
        card.classList.remove('ring-2', 'ring-offset-2');
        const streamData = streams.find(s => s.name === card.dataset.stream);
        if (streamData) {
          card.classList.remove(`ring-${streamData.borderColor.split('-')[1]}-500`);
        }
      });
      
      document.querySelectorAll('#createStreamContainer [data-check]').forEach(check => {
        check.classList.add('opacity-0');
      });

      // Add selection to clicked card
      const selectedCard = document.querySelector(`#createStreamContainer [data-stream="${streamName}"]`);
      const streamData = streams.find(s => s.name === streamName);
      
      if (selectedCard && streamData) {
        selectedCard.classList.add('ring-2', 'ring-offset-2', `ring-${streamData.borderColor.split('-')[1]}-500`);
        document.querySelector(`#createStreamContainer [data-check="${streamName}"]`).classList.remove('opacity-0');
      }

      // Update selected stream
      createSelectedStreamData = streamData;
      document.getElementById('createSelectedStream').value = streamName;
    }

    function resetCreateForm() {
      createSelectedStreamData = null;
      document.getElementById('createSelectedStream').value = '';
      document.getElementById('createSemester').value = '';
      
      const createSubject = document.getElementById('createSubject');
      const createSubjectHelp = document.getElementById('createSubjectHelp');
      
      if (createSubject) {
        createSubject.innerHTML = '<option value="">Select stream & semester first</option>';
        createSubject.disabled = true;
      }
      
      if (createSubjectHelp) {
        createSubjectHelp.textContent = 'Choose stream and semester to load subjects';
        createSubjectHelp.className = 'text-xs text-gray-500 mt-1 ml-1';
      }
      
      // Remove visual selection
      document.querySelectorAll('#createStreamContainer .stream-container').forEach(card => {
        card.classList.remove('ring-2', 'ring-offset-2');
        const streamData = streams.find(s => s.name === card.dataset.stream);
        if (streamData) {
          card.classList.remove(`ring-${streamData.borderColor.split('-')[1]}-500`);
        }
      });
      
      document.querySelectorAll('#createStreamContainer [data-check]').forEach(check => {
        check.classList.add('opacity-0');
      });
    }

    async function onCreateSemesterChange() {
      const semester = document.getElementById('createSemester')?.value;
      const createSubject = document.getElementById('createSubject');
      const createSubjectHelp = document.getElementById('createSubjectHelp');
      
      if (!createSubject || !createSelectedStreamData) return;
      
      createSubject.innerHTML = '<option value="">-- Select Subject --</option>';
      createSubject.disabled = true;
      
      if (!semester) {
        createSubject.innerHTML = '<option value="">Select semester first</option>';
        createSubjectHelp.textContent = 'Choose semester to load subjects';
        createSubjectHelp.className = 'text-xs text-gray-500 mt-1 ml-1';
        return;
      }

      await loadCreateSubjects(createSelectedStreamData.name, semester);
    }

    async function loadCreateSubjects(stream, semester) {
      const createSubject = document.getElementById('createSubject');
      const createSubjectLoader = document.getElementById('createSubjectLoader');
      const createSubjectHelp = document.getElementById('createSubjectHelp');
      
      try {
        createSubjectLoader.classList.remove('hidden');
        createSubject.innerHTML = '<option value="">Loading...</option>';
        createSubjectHelp.textContent = 'Loading subjects...';
        createSubjectHelp.className = 'text-xs text-blue-600 mt-1 ml-1 font-medium';
        
        const response = await fetch(`/api/subjects/${stream}/sem${semester}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        const subjects = data.subjects || data || [];
        
        createSubjectLoader.classList.add('hidden');
        
        if (!Array.isArray(subjects) || subjects.length === 0) {
          createSubject.innerHTML = '<option value="">No subjects found</option>';
          createSubjectHelp.textContent = 'No subjects available';
          createSubjectHelp.className = 'text-xs text-yellow-600 mt-1 ml-1 font-medium';
          return;
        }
        
        createSubject.innerHTML = '<option value="">-- Select Subject --</option>';
        subjects.forEach(subject => {
          const subjectName = subject.subjectName || subject.name || subject;
          const option = document.createElement('option');
          option.value = subjectName;
          option.textContent = subjectName;
          if (subject.isLanguageSubject || subject.subjectType === 'LANGUAGE') {
            option.textContent += ` (${subject.languageType})`;
            option.setAttribute('data-type', 'LANGUAGE');
            option.setAttribute('data-language', subject.languageType);
          } else {
            option.setAttribute('data-type', 'CORE');
          }
          createSubject.appendChild(option);
        });
        
        createSubject.disabled = false;
        createSubjectHelp.textContent = `${subjects.length} subjects available`;
        createSubjectHelp.className = 'text-xs text-green-600 mt-1 ml-1 font-medium';
        
      } catch (error) {
        createSubjectLoader.classList.add('hidden');
        createSubject.innerHTML = '<option value="">Error loading</option>';
        createSubjectHelp.textContent = 'Failed to load subjects';
        createSubjectHelp.className = 'text-xs text-red-500 mt-1 ml-1 font-medium';
      }
    }

    async function handleCreateSubject(e) {
      e.preventDefault();
      
      const stream = document.getElementById('createSelectedStream').value;
      const semester = document.getElementById('createSemester').value;
      const subjectSelect = document.getElementById('createSubject');
      const subjectName = subjectSelect?.value?.trim();

      if (!stream || !semester || !subjectName) {
        showNotification('Please select all required fields', 'error');
        return;
      }

      // Check for duplicate
      const duplicate = createdSubjects.find(subject => 
        subject.stream === stream && 
        subject.semester === semester && 
        subject.subjectName.toLowerCase() === subjectName.toLowerCase()
      );

      if (duplicate) {
        showNotification('Subject already exists in your library', 'warning');
        return;
      }

      // Get additional subject data from the selected option
      const selectedOption = subjectSelect.selectedOptions[0];
      const subjectType = selectedOption?.getAttribute('data-type') || 'CORE';
      const languageType = selectedOption?.getAttribute('data-language');

      const subjectData = {
        id: Date.now().toString(),
        subjectName,
        subjectCode: subjectName.toUpperCase().replace(/\s+/g, '_'),
        stream,
        semester: parseInt(semester),
        subjectType,
        languageType,
        createdAt: new Date().toISOString(),
        teacherId: userData.userName,
        firebaseUid: userData.firebaseUid
      };

      // Add to local array
      createdSubjects.push(subjectData);
      
      // Save to localStorage
      localStorage.setItem('createdSubjects', JSON.stringify(createdSubjects));
      
      // Try to save to database
      try {
        await saveSubjectToDatabase(subjectData);
        showNotification('âœ… Subject added to your library!', 'success');
      } catch (error) {
        console.log('Database save failed, using localStorage');
        showNotification('Subject added locally', 'warning');
      }
      
      // Update the subjects display immediately
      updateSubjectsDisplay();
      
      // Reset form and go back
      resetCreateForm();
      showHomePage();
      showSection('subjectsSection');
    }

    async function addSubjectToQueue(subjectId) {
      const subject = createdSubjects.find(s => s.id === subjectId);
      if (!subject) return;

      // Check if already in queue
      const duplicate = attendanceQueue.find(item => 
        item.stream === subject.stream && 
        item.semester === subject.semester && 
        item.subject === subject.subjectName
      );

      if (duplicate) {
        showNotification('Subject already in today\'s queue', 'warning');
        return;
      }

      const queueItem = {
        id: Date.now(),
        stream: subject.stream,
        semester: subject.semester,
        subject: subject.subjectName,
        timeAdded: new Date().toLocaleTimeString(),
        dateAdded: new Date().toDateString(),
        teacherId: userData.userName,
        fromCreatedSubject: true
      };

      // Add to queue
      attendanceQueue.push(queueItem);
      
      // Save to localStorage
      localStorage.setItem('attendanceQueue', JSON.stringify(attendanceQueue));
      
      // Try to save to database
      try {
        await saveQueueToDatabase(attendanceQueue);
      } catch (error) {
        console.log('Database save failed, using localStorage');
      }

      showNotification('âœ… Added to today\'s queue!', 'success');
      
      // Update display and switch to today's section
      updateQueueDisplay();
      showSection('todaySection');
    }

    async function deleteSubject(subjectId) {
      const subject = createdSubjects.find(s => s.id === subjectId);
      if (!subject) return;

      if (!confirm(`Delete "${subject.subjectName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      // Remove from local array
      createdSubjects = createdSubjects.filter(s => s.id !== subjectId);
      
      // Update localStorage
      localStorage.setItem('createdSubjects', JSON.stringify(createdSubjects));
      
      // Try to delete from database
      try {
        await deleteSubjectFromDatabase(subjectId);
        showNotification('âœ… Subject deleted successfully', 'success');
      } catch (error) {
        console.log('Database deletion failed');
        showNotification('Subject deleted locally', 'warning');
      }
      
      // Update display
      updateSubjectsDisplay();
    }

    // ============================================================================
    // DATABASE FUNCTIONS FOR SUBJECTS
    // ============================================================================

    async function saveSubjectToDatabase(subjectData) {
      try {
        const response = await fetch(`${API_BASE_URL}/teacher/subjects`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            teacherId: userData.userEmail || userData.userName,
            firebaseUid: userData.firebaseUid,
            subject: subjectData
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          console.log('ðŸ’¾ Subject saved to database successfully');
          return result;
        } else {
          throw new Error(result.message || 'Failed to save subject');
        }
      } catch (error) {
        console.error('Error saving subject to database:', error);
        throw error;
      }
    }

    async function loadSubjectsFromDatabase() {
      try {
        // Use firebaseUid first, then userEmail, then userName as fallback
        const identifier = userData.firebaseUid || userData.userEmail || userData.userName;
        console.log(`ðŸ” Loading subjects for identifier: "${identifier}" (firebaseUid: ${userData.firebaseUid}, userEmail: ${userData.userEmail}, userName: ${userData.userName})`);
        const response = await fetch(`${API_BASE_URL}/teacher/${encodeURIComponent(identifier)}/subjects`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 404) {
            console.log('No subjects found in database');
            return [];
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success) {
          const databaseSubjects = result.subjects || [];
          console.log(`ðŸ“¥ Loaded ${databaseSubjects.length} subjects from database`);
          
          // Merge with any local subjects that might not be in database yet
          const localSubjects = JSON.parse(localStorage.getItem('createdSubjects') || '[]');
          const mergedSubjects = [...databaseSubjects];
          
          // Add any local subjects that aren't in database
          localSubjects.forEach(localSubject => {
            const existsInDb = databaseSubjects.find(dbSubject => 
              dbSubject.id === localSubject.id || 
              (dbSubject.subjectName === localSubject.subjectName && 
               dbSubject.stream === localSubject.stream && 
               dbSubject.semester === localSubject.semester)
            );
            if (!existsInDb) {
              mergedSubjects.push(localSubject);
            }
          });
          
          createdSubjects = mergedSubjects;
          console.log(`ðŸ“¥ Final merged subjects: ${createdSubjects.length} (${databaseSubjects.length} from DB + ${mergedSubjects.length - databaseSubjects.length} local)`);
          
          // Update localStorage with merged data
          localStorage.setItem('createdSubjects', JSON.stringify(createdSubjects));
          
          return createdSubjects;
        } else {
          throw new Error(result.message || 'Failed to load subjects');
        }
      } catch (error) {
        console.error('Error loading subjects from database:', error);
        throw error;
      }
    }

    async function loadCompletedFromDatabase() {
      try {
        // Use firebaseUid first, then userEmail, then userName as fallback
        const identifier = userData.firebaseUid || userData.userEmail || userData.userName;
        console.log(`ðŸ” Loading completed classes for identifier: "${identifier}" (firebaseUid: ${userData.firebaseUid}, userEmail: ${userData.userEmail}, userName: ${userData.userName})`);
        const response = await fetch(`${API_BASE_URL}/teacher/${encodeURIComponent(identifier)}/completed`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          if (response.status === 404) {
            console.log('No completed classes found in database');
            return [];
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        if (result.success) {
          completedClasses = result.completedClasses || [];
          console.log(`ðŸ“¥ Loaded ${completedClasses.length} completed classes from database`);
          
          // Update localStorage
          localStorage.setItem('completedClasses', JSON.stringify(completedClasses));
          
          return completedClasses;
        } else {
          throw new Error(result.message || 'Failed to load completed classes');
        }
      } catch (error) {
        console.error('Error loading completed classes from database:', error);
        throw error;
      }
    }

    async function saveCompletedToDatabase(completedClass) {
      try {
        const response = await fetch(`${API_BASE_URL}/teacher/completed`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            teacherId: userData.userEmail || userData.userName,
            firebaseUid: userData.firebaseUid,
            completedClass: completedClass
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          console.log('ðŸ’¾ Completed class saved to database successfully');
          return result;
        } else {
          throw new Error(result.message || 'Failed to save completed class');
        }
      } catch (error) {
        console.error('Error saving completed class to database:', error);
        throw error;
      }
    }

    async function deleteSubjectFromDatabase(subjectId) {
      try {
        const response = await fetch(`${API_BASE_URL}/teacher/subjects/${subjectId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            teacherId: userData.userEmail || userData.userName,
            firebaseUid: userData.firebaseUid
          })
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          console.log('ðŸ—‘ï¸ Subject deleted from database successfully');
          return result;
        } else {
          throw new Error(result.message || 'Failed to delete subject');
        }
      } catch (error) {
        console.error('Error deleting subject from database:', error);
        throw error;
      }
    }

    async function takeAttendance(itemId) {
      const item = attendanceQueue.find(q => q.id == itemId);
      if (!item) return;

      // Show loading state
      const queueElement = document.querySelector(`[data-id="${itemId}"]`);
      const attendButton = queueElement?.querySelector('button');
      if (attendButton) {
        attendButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
        attendButton.disabled = true;
      }

      try {
        // Remove from queue immediately (optimistic update)
        attendanceQueue = attendanceQueue.filter(q => q.id != itemId);
        
        // Add to completed classes
        const completedItem = { 
          ...item, 
          completedTime: new Date().toLocaleTimeString(),
          completedDate: new Date().toDateString()
        };
        completedClasses.push(completedItem);
        
        // Update localStorage immediately
        localStorage.setItem('attendanceQueue', JSON.stringify(attendanceQueue));
        localStorage.setItem('completedClasses', JSON.stringify(completedClasses));
        
        // Try to save completed class to database
        try {
          await saveCompletedToDatabase(completedItem);
        } catch (error) {
          console.log('Database save failed for completed class:', error);
        }
        
        // Update display immediately
        updateQueueDisplay();
        
        // Try to update database (but don't wait for it)
        deleteQueueItemFromDatabase(itemId).catch(error => {
          console.log('Database deletion failed:', error);
        });
        
        saveQueueToDatabase(attendanceQueue).catch(error => {
          console.log('Database save failed:', error);
        });
        
        // Create class info object for attendance page
        const classInfo = {
          stream: item.stream,
          semester: parseInt(item.semester),
          subject: item.subject,
          autoSelect: true,
          teacherId: userData.userName,
          teacherEmail: userData.userEmail
        };
        
        // Store class info in sessionStorage for index.html to pick up
        sessionStorage.setItem('selectedClass', JSON.stringify(classInfo));
        showNotification('âœ… Class removed from queue! Redirecting...', 'success');
        
        // Short delay for user feedback, then redirect
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 800);
        
      } catch (error) {
        console.error('Error in takeAttendance:', error);
        showNotification('âŒ Error processing request', 'error');
        
        // Restore button state
        if (attendButton) {
          attendButton.innerHTML = '<i class="fas fa-user-check mr-2"></i>Attend';
          attendButton.disabled = false;
        }
      }
    }

    async function removeFromQueue(itemId) {
      const item = attendanceQueue.find(q => q.id == itemId);
      if (!item) return;
      
      if (confirm(`Remove "${item.subject}"?`)) {
        const queueElement = document.querySelector(`[data-id="${itemId}"]`);
        if (queueElement) {
          queueElement.classList.add('removing');
          setTimeout(async () => {
            attendanceQueue = attendanceQueue.filter(q => q.id != itemId);
            
            // Update localStorage immediately
            localStorage.setItem('attendanceQueue', JSON.stringify(attendanceQueue));
            
            // Try to delete from database first
            try {
              const deleteResult = await deleteQueueItemFromDatabase(itemId);
              if (deleteResult && deleteResult.success) {
                // If database deletion was successful, use the updated queue data from server
                attendanceQueue = deleteResult.queueData || attendanceQueue;
                localStorage.setItem('attendanceQueue', JSON.stringify(attendanceQueue));
                showNotification('Class removed from database', 'success');
              } else {
                // Fallback: save the updated queue to database
                await saveQueueToDatabase(attendanceQueue);
                showNotification('Class removed (saved to database)', 'success');
              }
            } catch (error) {
              console.log('Database update failed, using localStorage only');
              showNotification('Class removed locally', 'warning');
            }
            
            updateQueueDisplay();
          }, 400);
        }
      }
    }

    function resetForm() {
      // Reset stream selection
      selectedStreamData = null;
      elements.selectedStream.value = '';
      
      // Remove visual selection
      document.querySelectorAll('.stream-container').forEach(card => {
        card.classList.remove('ring-2', 'ring-offset-2');
        const streamData = streams.find(s => s.name === card.dataset.stream);
        if (streamData) {
          card.classList.remove(`ring-${streamData.borderColor.split('-')[1]}-500`);
        }
      });
      
      document.querySelectorAll('[data-check]').forEach(check => {
        check.classList.add('opacity-0');
      });

      // Reset selects
      if (elements.semesterSelect) elements.semesterSelect.value = '';
      if (elements.subjectSelect) {
        elements.subjectSelect.innerHTML = '<option value="">Select stream & semester first</option>';
        elements.subjectSelect.disabled = true;
      }
      if (elements.addBtn) elements.addBtn.disabled = true;
      if (elements.subjectHelp) {
        elements.subjectHelp.textContent = 'Choose stream and semester first';
        elements.subjectHelp.className = 'text-xs text-gray-500 mt-1 ml-1';
      }
    }

    function showNotification(message, type) {
      const colors = {
        success: 'from-green-500 to-green-600',
        error: 'from-red-500 to-red-600',
        warning: 'from-yellow-500 to-yellow-600'
      };

      const icons = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle'
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-3 left-3 bg-gradient-to-r ${colors[type]} text-white p-3 rounded-xl shadow-xl z-50 transform transition-all duration-500 translate-y-full backdrop-blur-sm border border-white border-opacity-20`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-${icons[type]} mr-2"></i>
          <span class="font-semibold text-sm flex-1">${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.remove('translate-y-full'), 100);
      setTimeout(() => {
        notification.classList.add('translate-y-full');
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 500);
      }, 3000);
    }

    // Toggle Menu Function moved to top of script for immediate availability

    // View Attendance Function
    window.viewAttendance = async () => {
      try {
        console.log('ðŸ” Preparing to view attendance with full access...');

        // Store teacher info if needed later
        sessionStorage.setItem('teacherViewMode', 'true');
        sessionStorage.setItem('teacherInfo', JSON.stringify({
          name: userData.userName,
          email: userData.userEmail,
          firebaseUid: userData.firebaseUid
        }));

        showNotification('ðŸ”„ Opening View Attendance...', 'info');

        const menu = document.getElementById("mobileMenu");
        if (menu) menu.classList.add('hidden');

        // Navigate directly to dedicated page
        setTimeout(() => {
          window.location.href = 'view-attendance.html';
        }, 200);
      } catch (error) {
        console.error('âŒ Error preparing attendance view:', error);
        showNotification('âŒ Failed to load attendance view', 'error');
      }
    };

    // Logout Function
    async function logout() {
      try {
        // Clear both localStorage and sessionStorage
        localStorage.clear();
        sessionStorage.clear();
        
        // If using Firebase auth, sign out
        if (typeof auth !== 'undefined' && typeof signOut !== 'undefined') {
          await signOut(auth);
        }
        
        showNotification('Logged out successfully! ðŸ‘‹', 'success');
        
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      } catch (error) {
        console.error('Logout error:', error);
        showNotification('Logout failed. Please try again.', 'error');
      }
    }

    // Load user info into menu
    function loadUserInfo() {
      // Check both localStorage and sessionStorage for user data
      const userName = localStorage.getItem('userName') || sessionStorage.getItem('userName') || 'Teacher';
      const userEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail') || 'teacher@mla.edu';
      const firebaseUid = localStorage.getItem('firebaseUid') || sessionStorage.getItem('firebaseUid') || null;
      
      console.log('Retrieved user data from storage:', {
        userName,
        userEmail,
        firebaseUid,
        hasFirebaseUid: !!firebaseUid,
        firebaseUidType: typeof firebaseUid
      });
      
      // Update global userData object
      userData.userName = userName;
      userData.userEmail = userEmail;
      userData.firebaseUid = firebaseUid;
      
      const userNameElement = document.getElementById('userName');
      const userEmailElement = document.getElementById('userEmail');
      
      if (userNameElement) userNameElement.textContent = userName;
      if (userEmailElement) userEmailElement.textContent = userEmail;
    }

    // Initialize user info when page loads with authentication check
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ðŸ”„ Page loaded, checking authentication...');
      
      // Enhanced authentication check - allows all Firebase users
      function isAuthorizedUser(email) {
        if (!email) {
          console.log('âŒ No email provided');
          return false;
        }
        // Allow all users with valid email addresses
        const isValidEmail = email.includes('@') && email.includes('.');
        console.log(`ðŸ“§ Email ${email} is ${isValidEmail ? 'valid' : 'invalid'}`);
        return isValidEmail;
      }

      // Add small delay to ensure localStorage is ready
      await new Promise(resolve => setTimeout(resolve, 100));
      
      let isAuthenticated = false;
      
      // Check localStorage/sessionStorage authentication
      const storedAuth = localStorage.getItem('isAuthenticated') || sessionStorage.getItem('isAuthenticated');
      const userEmail = localStorage.getItem('userEmail') || sessionStorage.getItem('userEmail');
      const userName = localStorage.getItem('userName') || sessionStorage.getItem('userName');
      
      console.log('ðŸ” Storage check:', {
        storedAuth,
        userEmail,
        userName,
        localStorage_keys: Object.keys(localStorage),
        sessionStorage_keys: Object.keys(sessionStorage)
      });
      
      if (storedAuth === 'true' && userEmail) {
        if (isAuthorizedUser(userEmail)) {
          isAuthenticated = true;
          userData.userEmail = userEmail;
          userData.userName = userName || 'Teacher';
          console.log('âœ… User authenticated via storage:', userEmail);
        } else {
          console.log('âŒ User email not in authorized list:', userEmail);
        }
      } else {
        console.log('âŒ Missing authentication data:', { storedAuth, userEmail });
      }

      if (!isAuthenticated) {
        console.log('âŒ Authentication failed, redirecting to login in 2 seconds...');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return;
      }

      // User is authenticated, initialize app
      console.log('ðŸš€ Initializing app for user:', userData.userEmail);
      
      try {
        console.log('Initializing teacher in database...');
        await initializeTeacherInDatabase();
        console.log('Teacher initialized successfully');
      } catch (error) {
        console.error('Error initializing teacher:', error);
        showNotification('Database connection issue (continuing offline)', 'warning');
      }

      checkNewDay();
      
      try {
        console.log('ðŸ”„ Loading queue from database...');
        await loadQueueFromDatabase();
        console.log('âœ… Queue loaded from database successfully');
        updateQueueDisplay();
      } catch (error) {
        console.log('âš ï¸ Database load failed, trying localStorage fallback');
        attendanceQueue = JSON.parse(localStorage.getItem('attendanceQueue') || '[]');
        updateQueueDisplay();
      }

      // Load subjects from database or localStorage
      try {
        console.log('ðŸ”„ Loading subjects from database...');
        await loadSubjectsFromDatabase();
        console.log('âœ… Subjects loaded from database successfully');
        updateSubjectsDisplay(); // Update display after loading
      } catch (error) {
        console.log('âš ï¸ Database load failed, trying localStorage fallback');
        createdSubjects = JSON.parse(localStorage.getItem('createdSubjects') || '[]');
        updateSubjectsDisplay(); // Update display after fallback
      }

      // Load completed classes from database or localStorage
      try {
        console.log('ðŸ”„ Loading completed classes from database...');
        await loadCompletedFromDatabase();
        console.log('âœ… Completed classes loaded from database successfully');
      } catch (error) {
        console.log('âš ï¸ Database load failed, trying localStorage fallback');
        completedClasses = JSON.parse(localStorage.getItem('completedClasses') || '[]');
      }
      
      createStreamCards();

      // Set up event listeners
      if (elements.semesterSelect) elements.semesterSelect.addEventListener('change', onSemesterChange);
      if (document.getElementById('addClassForm')) document.getElementById('addClassForm').addEventListener('submit', handleAddToQueue);
      if (document.getElementById('createSubjectForm')) document.getElementById('createSubjectForm').addEventListener('submit', handleCreateSubject);
      if (document.getElementById('createSemester')) document.getElementById('createSemester').addEventListener('change', onCreateSemesterChange);

      loadUserInfo();
      
      // Ensure teacher profile exists in database
      if (userData.firebaseUid) {
        console.log('Initializing teacher in database...');
        await saveTeacherProfile();
      }
      
      console.log('âœ… App initialization completed successfully');
      
      // Setup menu event handlers
      setupMenuEventHandlers();
    });
    
    // Setup menu event handlers function
    function setupMenuEventHandlers() {
      const menuButton = document.querySelector('.menu-icon');
      const menuBackdrop = document.getElementById('menuBackdrop');
      const menuCloseBtn = document.getElementById('menuCloseBtn');
      
      // Remove any existing event listeners to prevent duplicates
      if (menuButton) {
        // Clone node to remove all event listeners
        const newMenuButton = menuButton.cloneNode(true);
        menuButton.parentNode.replaceChild(newMenuButton, menuButton);
        
        console.log('ðŸ”§ Setting up menu button click handler');
        newMenuButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ðŸ–±ï¸ Menu button clicked');
          toggleMenu();
        });
      } else {
        console.error('âŒ Menu button not found');
      }
      
      // Setup backdrop click handler
      if (menuBackdrop) {
        menuBackdrop.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ðŸ–±ï¸ Backdrop clicked');
          toggleMenu();
        });
      }
      
      // Setup close button click handler
      if (menuCloseBtn) {
        menuCloseBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ðŸ–±ï¸ Close button clicked');
          toggleMenu();
        });
      }
      
      // Setup keyboard handler for Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const menu = document.getElementById("mobileMenu");
          if (menu && !menu.classList.contains('hidden')) {
            console.log('âŒ¨ï¸ Escape key pressed, closing menu');
            toggleMenu();
          }
        }
      });
      
      console.log('âœ… All menu event handlers setup completed');
    }
  </script>
</body>
</html>
