<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manual WhatsApp Messaging System</title>
  
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .animate-fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.connected {
      background-color: #10b981;
      animation: pulse-green 2s infinite;
    }

    .status-indicator.disconnected {
      background-color: #ef4444;
    }

    .status-indicator.loading {
      background-color: #f59e0b;
      animation: pulse-orange 1s infinite;
    }

    @keyframes pulse-green {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes pulse-orange {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background-color: #10b981;
      color: white;
    }

    .notification.error {
      background-color: #ef4444;
      color: white;
    }

    .notification.info {
      background-color: #3b82f6;
      color: white;
    }

    .notification.warning {
      background-color: #f59e0b;
      color: white;
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .stats-card:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
    }

    .message-full-day {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border-left: 4px solid #ef4444;
    }

    .message-partial-day {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-left: 4px solid #f59e0b;
    }

    .message-preview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-line;
      max-height: 200px;
      overflow-y: auto;
      color: #374151;
    }

    .quick-action-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .quick-action-card:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .date-input::-webkit-calendar-picker-indicator {
      cursor: pointer;
      border-radius: 4px;
      margin-right: 2px;
      opacity: 0.6;
      filter: invert(1);
    }

    .date-input::-webkit-calendar-picker-indicator:hover {
      opacity: 1;
    }

    /* Alert modal styles */
    .alert-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .alert-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 500px;
      margin: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div class="min-h-screen py-8 px-4">
    <div class="max-w-7xl mx-auto">
      
      <!-- Header -->
      <div class="text-center mb-12 animate-fade-in">
        <!-- Back Button -->
        <div class="flex justify-start mb-6">
          <a href="myclass.html" class="inline-flex items-center px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-200 hover:scale-105 backdrop-blur-sm border border-white/20">
            <i class="fas fa-arrow-left mr-2"></i>
            <span class="font-medium">Back to Classes</span>
          </a>
        </div>
      
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-6">
          <i class="fas fa-paper-plane text-3xl text-purple-600"></i>
        </div>
        <h1 class="text-4xl font-bold text-white mb-4">Manual WhatsApp Messaging System</h1>
        <p class="text-xl text-purple-100 max-w-3xl mx-auto">
          Send consolidated absence notifications to parents on-demand - anytime, any date, any semester
        </p>
      </div>
      
        
        <!-- System Status -->
        <div class="mt-6 inline-flex items-center bg-white bg-opacity-20 rounded-lg px-4 py-2">
          <span class="status-indicator" id="systemStatus"></span>
          <span class="text-white text-sm" id="systemStatusText">Checking system status...</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-fade-in">
        
        <div class="quick-action-card bg-white rounded-2xl p-6 text-center shadow-lg" onclick="setTodayDate()">
          <div class="text-3xl text-blue-600 mb-4">
            <i class="fas fa-calendar-day"></i>
          </div>
          <h3 class="font-bold text-gray-800 mb-2">Today's Messages</h3>
          <p class="text-sm text-gray-600">Set date to today</p>
        </div>
        
        <div class="quick-action-card bg-white rounded-2xl p-6 text-center shadow-lg" onclick="setYesterdayDate()">
          <div class="text-3xl text-orange-600 mb-4">
            <i class="fas fa-calendar-minus"></i>
          </div>
          <h3 class="font-bold text-gray-800 mb-2">Yesterday's Messages</h3>
          <p class="text-sm text-gray-600">Set date to yesterday</p>
        </div>
        
        <div class="quick-action-card bg-white rounded-2xl p-6 text-center shadow-lg" onclick="clearForm()">
          <div class="text-3xl text-gray-600 mb-4">
            <i class="fas fa-eraser"></i>
          </div>
          <h3 class="font-bold text-gray-800 mb-2">Clear Form</h3>
          <p class="text-sm text-gray-600">Reset all selections</p>
        </div>
        
      </div>

      <!-- Main Messaging Panel -->
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8 card-hover animate-fade-in">
        <div class="flex items-center mb-8">
          <div class="w-12 h-12 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-lg mr-4">
            <i class="fas fa-paper-plane"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Send WhatsApp Messages</h2>
            <p class="text-gray-600">Select stream, semester, and date to send consolidated absence notifications</p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  
          <!-- Academic Stream Selection -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-university mr-2 text-purple-600"></i>Academic Stream
            </label>
            <select id="messagingStream" onchange="validateForm()" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all text-lg">
              <option value="">-- Select Stream --</option>
              <option value="BCA">BCA - Computer Applications</option>
              <option value="BBA">BBA - Business Administration</option>
              <option value="BCom">BCom - Commerce (Section A)</option>
              <option value="BCom Section B">BCom Section B - Commerce</option>
              <option value="BCom-BDA">BCom-BDA - Big Data Analytics</option>
              <option value="BCom A and F">BCom A&F - Accounting & Finance</option>
            </select>
          </div>
          
          <!-- Semester Selection -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-layer-group mr-2 text-purple-600"></i>Semester
            </label>
            <select id="messagingSemester" onchange="validateForm()" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all text-lg">
              <option value="">-- Select Semester --</option>
              <option value="1">First Semester</option>
              <option value="2">Second Semester</option>
              <option value="3">Third Semester</option>
              <option value="4">Fourth Semester</option>
              <option value="5">Fifth Semester</option>
              <option value="6">Sixth Semester</option>
            </select>
          </div>
          
          
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              <i class="fas fa-clock mr-2 text-purple-600"></i>Date
            </label>
            <input type="date" id="messagingDate" onchange="validateForm()" class="date-input w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all text-lg">
          </div>
          
          <div class="flex items-end">
            <button onclick="previewMessages()" id="previewBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 font-semibold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i class="fas fa-eye mr-2"></i>Preview
            </button>
          </div>
        </div>
        
        <!-- Send Button -->
        <div class="text-center">
          <button onclick="sendMessages()" id="sendBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-12 py-4 rounded-xl hover:from-green-600 hover:to-green-700 transition-all duration-300 font-semibold text-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <i class="fas fa-paper-plane mr-3"></i>Send WhatsApp Messages Now
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultsSection" class="hidden animate-fade-in">
        
        <!-- Statistics Cards -->
        <div id="statsCards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <!-- Stats will be loaded here -->
        </div>

        <!-- Main Results -->
        <div id="resultsContent" class="space-y-8">
          <!-- Results will be displayed here -->
        </div>
        
      </div>

      <!-- Footer -->
      <div class="text-center mt-16 text-white animate-fade-in">
        <p class="text-lg opacity-75">© 2025 MLA ACADEMY OF HIGHER LEARNING</p>
      </div>

    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <script>
    // Global variables
    let isLoading = false;
    let currentPreviewData = null;

    // Initialize system
    document.addEventListener('DOMContentLoaded', function() {
      initializeSystem();
    });

    function initializeSystem() {
      // Set today's date as default
      setTodayDate();
      
      // Check server connection
      checkServerConnection();
      
      // Validate form initially
      validateForm();
      
      console.log('📱 Manual WhatsApp Messaging System initialized');
    }

    // System status management
    function updateSystemStatus(status, message) {
      const indicator = document.getElementById('systemStatus');
      const text = document.getElementById('systemStatusText');
      
      if (indicator && text) {
        indicator.className = `status-indicator ${status}`;
        text.textContent = message;
      }
    }

    // Server connection check
    async function checkServerConnectionDebug() {
      console.log('🔍 Starting server connection check...');
      
      try {
        // ✅ Check if endpoint exists first
        console.log('📡 Testing basic connectivity...');
        
        const response = await fetch('/api/promotion-options', {
          method: 'HEAD', // Just check if endpoint exists
          cache: 'no-cache'
        });
        
        console.log('📊 Response details:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          type: response.type,
          url: response.url,
          headers: Object.fromEntries(response.headers.entries())
        });
        
        if (response.ok) {
          // Now try GET request
          const fullResponse = await fetch('/api/promotion-options');
          console.log('📄 Full response:', fullResponse);
          
          updateSystemStatus('connected', 'Server connected - Ready for messaging');
          showNotification('✅ Server connected successfully', 'success');
        } else {
          console.error('❌ Server returned error:', response.status, response.statusText);
          updateSystemStatus('disconnected', `Server error: ${response.status}`);
          showNotification(`❌ Server error: ${response.status} ${response.statusText}`, 'error');
        }
        
      } catch (error) {
        console.error('❌ Fetch failed completely:', error);
        console.error('Error type:', error.constructor.name);
        console.error('Error message:', error.message);
        
        updateSystemStatus('disconnected', 'Connection failed');
        showNotification(`❌ Connection failed: ${error.message}`, 'error');
      }
    }
    

    // Validation
    function validateForm() {
      const stream = document.getElementById('messagingStream').value;
      const semester = document.getElementById('messagingSemester').value;
      const date = document.getElementById('messagingDate').value;
      
      const previewBtn = document.getElementById('previewBtn');
      const sendBtn = document.getElementById('sendBtn');
      
      const isValid = stream && semester && date;
      
      if (previewBtn) previewBtn.disabled = !isValid;
      if (sendBtn) sendBtn.disabled = !isValid || !currentPreviewData;
      
      return isValid ? { stream, semester, date } : null;
    }

    // Quick date setters
    function setTodayDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('messagingDate').value = today;
      validateForm();
      showNotification('📅 Date set to today', 'info');
    }

    function setYesterdayDate() {
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      document.getElementById('messagingDate').value = yesterday.toISOString().split('T')[0];
      validateForm();
      showNotification('📅 Date set to yesterday', 'info');
    }

    function clearForm() {
      document.getElementById('messagingStream').value = '';
      document.getElementById('messagingSemester').value = '';
      document.getElementById('messagingDate').value = '';
      
      const resultsSection = document.getElementById('resultsSection');
      if (resultsSection) resultsSection.classList.add('hidden');
      
      currentPreviewData = null;
      validateForm();
      showNotification('🧹 Form cleared', 'info');
    }

    // ENHANCED: Preview messages with already sent check
    async function previewMessages() {
      const inputs = validateForm();
      if (!inputs) {
        showNotification('❌ Please fill in all fields', 'error');
        return;
      }
      
      const { stream, semester, date } = inputs;
      
      if (isLoading) return;
      isLoading = true;
      
      const previewBtn = document.getElementById('previewBtn');
      const originalText = previewBtn.innerHTML;
      previewBtn.innerHTML = '<div class="loading-spinner"></div>Loading Preview...';
      previewBtn.disabled = true;
      
      updateSystemStatus('loading', 'Loading message preview...');
      
      try {
        const response = await fetch(`/api/daily-absence-summary/${stream}/sem${semester}/${date}`);
        
        if (response.ok) {
          const data = await response.json();
          currentPreviewData = data;
          displayPreview(data);
          updateSystemStatus('connected', 'Preview loaded successfully');
          
          // Check if messages were already sent
          if (data.messageStatus && data.messageStatus.alreadySent) {
            showNotification('⚠️ Messages already sent for this date!', 'warning');
          } else {
            showNotification('✅ Preview loaded successfully', 'success');
          }
          
          // Enable send button
          const sendBtn = document.getElementById('sendBtn');
          if (sendBtn) sendBtn.disabled = false;
        } else {
          // Fallback: Check if students exist first
          const studentsResponse = await fetch(`/api/students/${stream}/sem${semester}`);
          
          if (!studentsResponse.ok) {
            if (studentsResponse.status === 404) {
              throw new Error('No students found for this stream and semester');
            } else {
              throw new Error(`Server error: ${studentsResponse.status}`);
            }
          }
          
          const studentsData = await studentsResponse.json();
          
          // Create mock preview data
          const mockPreviewData = {
            success: true,
            date: new Date(date).toLocaleDateString('en-IN', {
              day: '2-digit',
              month: '2-digit', 
              year: 'numeric'
            }),
            stream: stream.toUpperCase(),
            semester: semester,
            summary: {
              totalStudents: studentsData.length,
              totalSubjects: 0,
              subjectsWithAttendance: 0,
              studentsToNotify: 0,
              fullDayAbsent: 0,
              partialDayAbsent: 0,
              studentsPresent: studentsData.length
            },
            absenceSummary: studentsData.map(student => ({
              studentID: student.studentID,
              studentName: student.name,
              parentPhone: student.parentPhone,
              absentSubjects: [],
              absentSubjectCount: 0,
              isFullDayAbsent: false,
              messageType: 'present',
              willReceiveMessage: false
            })),
            subjectsWithAttendance: [],
            consolidatedMessaging: {
              totalMessagesToSend: 0,
              fullDayMessages: 0,
              partialDayMessages: 0
            },
            messageStatus: {
              alreadySent: false,
              note: "No messages sent yet for this date. Ready to send messages."
            }
          };
          
          currentPreviewData = mockPreviewData;
          displayPreview(mockPreviewData);
          updateSystemStatus('connected', 'Preview loaded (using student data)');
          showNotification('✅ Preview loaded - Click "Send Messages Now" to check actual attendance', 'success');
          
          // Enable send button
          const sendBtn = document.getElementById('sendBtn');
          if (sendBtn) sendBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error loading preview:', error);
        updateSystemStatus('disconnected', 'Failed to load preview');
        showNotification('❌ Error loading preview: ' + error.message, 'error');
        currentPreviewData = null;
      } finally {
        previewBtn.innerHTML = originalText;
        previewBtn.disabled = false;
        isLoading = false;
      }
    }
// ✅ ENHANCED: Display preview with message status and better formatting
function displayPreview(data) {
  const resultsSection = document.getElementById('resultsSection');
  const statsCards = document.getElementById('statsCards');
  const resultsContent = document.getElementById('resultsContent');
  
  if (!resultsSection || !statsCards || !resultsContent) {
    console.error('Required DOM elements not found');
    return;
  }
  
  // Show results section with animation
  resultsSection.classList.remove('hidden');
  resultsSection.classList.add('slide-in');
  
  // ✅ Enhanced statistics cards with better styling
  statsCards.innerHTML = `
    <div class="stats-card bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl p-6 text-center shadow-xl transform hover:scale-105 transition-all duration-300">
      <div class="text-4xl font-bold mb-2">${data.summary.totalStudents}</div>
      <div class="text-sm opacity-90">Total Students</div>
      <div class="mt-2">
        <i class="fas fa-users text-2xl opacity-75"></i>
      </div>
    </div>
    
    <div class="stats-card bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-2xl p-6 text-center shadow-xl transform hover:scale-105 transition-all duration-300">
      <div class="text-4xl font-bold mb-2">${data.summary.studentsToNotify}</div>
      <div class="text-sm opacity-90">Will Get Messages</div>
      <div class="mt-2">
        <i class="fas fa-paper-plane text-2xl opacity-75"></i>
      </div>
    </div>
    
    <div class="stats-card bg-gradient-to-br from-red-500 to-red-600 text-white rounded-2xl p-6 text-center shadow-xl transform hover:scale-105 transition-all duration-300">
      <div class="text-4xl font-bold mb-2">${data.summary.fullDayAbsent}</div>
      <div class="text-sm opacity-90">Full Day Absent</div>
      <div class="mt-2">
        <i class="fas fa-exclamation-triangle text-2xl opacity-75"></i>
      </div>
    </div>
    
    <div class="stats-card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-2xl p-6 text-center shadow-xl transform hover:scale-105 transition-all duration-300">
      <div class="text-4xl font-bold mb-2">${data.summary.partialDayAbsent}</div>
      <div class="text-sm opacity-90">Partial Day Absent</div>
      <div class="mt-2">
        <i class="fas fa-clock text-2xl opacity-75"></i>
      </div>
    </div>
  `;
  
  // ✅ Enhanced message status alert
  let messageStatusAlert = '';
  if (data.messageStatus && data.messageStatus.alreadySent) {
    const timeSinceSent = data.messageStatus.timeSinceSent || 'Unknown time ago';
    const successRate = data.messageStatus.successRate || '0';
    
    messageStatusAlert = `
      <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border-l-4 border-orange-400 rounded-r-xl p-6 mb-6 shadow-lg">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
              <i class="fas fa-exclamation-triangle text-orange-500 text-xl"></i>
            </div>
          </div>
          <div class="ml-4 flex-1">
            <h3 class="text-xl font-bold text-orange-800 mb-3">
              ⚠️ Messages Already Sent Today!
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="bg-white bg-opacity-60 rounded-lg p-3">
                <div class="text-sm text-orange-700 mb-1">
                  <strong>📅 Sent:</strong> ${timeSinceSent}
                </div>
                <div class="text-xs text-orange-600">
                  ${new Date(data.messageStatus.sentAt).toLocaleString()}
                </div>
              </div>
              <div class="bg-white bg-opacity-60 rounded-lg p-3">
                <div class="text-sm text-orange-700">
                  <strong>📊 Success Rate:</strong> ${successRate}%
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
              <div class="text-center">
                <div class="font-semibold text-orange-800">${data.messageStatus.messagesSent}</div>
                <div class="text-xs text-orange-600">Sent</div>
              </div>
              <div class="text-center">
                <div class="font-semibold text-orange-800">${data.messageStatus.messagesFailed || 0}</div>
                <div class="text-xs text-orange-600">Failed</div>
              </div>
              <div class="text-center">
                <div class="font-semibold text-orange-800">${data.messageStatus.fullDayAbsentCount || 0}</div>
                <div class="text-xs text-orange-600">Full Day</div>
              </div>
              <div class="text-center">
                <div class="font-semibold text-orange-800">${data.messageStatus.partialDayAbsentCount || 0}</div>
                <div class="text-xs text-orange-600">Partial</div>
              </div>
            </div>
            <div class="bg-white bg-opacity-60 rounded-lg p-3 mb-4">
              <div class="text-sm text-orange-700">
                <strong>📚 Subjects:</strong> ${data.messageStatus.subjectsIncluded?.join(', ') || 'N/A'}
              </div>
            </div>
            <div class="bg-orange-100 rounded-lg p-3">
              <p class="text-sm text-orange-800 font-semibold flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                Clicking "Send Messages Now" will ask if you want to send duplicate messages.
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  // ✅ Enhanced preview content display
  if (data.summary.studentsToNotify > 0) {
    const studentsToShow = data.absenceSummary.filter(s => s.willReceiveMessage);
    
    resultsContent.innerHTML = messageStatusAlert + `
      <div class="bg-white rounded-2xl shadow-2xl p-8 border border-gray-100">
        <div class="flex items-center justify-between mb-6">
          <h4 class="text-2xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-eye mr-3 text-blue-600"></i>
            Message Preview for ${data.date}
          </h4>
          <div class="flex items-center space-x-2 text-sm text-gray-500">
            <i class="fas fa-calendar-alt"></i>
            <span>${data.stream} • Semester ${data.semester}</span>
          </div>
        </div>
        
        <!-- ✅ Enhanced attendance summary -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6 mb-8">
          <h5 class="font-bold text-blue-800 mb-4 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Attendance Summary
          </h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white bg-opacity-70 rounded-lg p-4">
              <div class="text-blue-700 space-y-2">
                <div class="flex justify-between">
                  <span class="font-medium">📚 Subjects with attendance:</span>
                  <span class="font-semibold">${data.subjectsWithAttendance.length}</span>
                </div>
                <div class="text-xs text-blue-600">
                  ${data.subjectsWithAttendance.join(', ')}
                </div>
              </div>
            </div>
            <div class="bg-white bg-opacity-70 rounded-lg p-4">
              <div class="text-blue-700 space-y-2">
                <div class="flex justify-between">
                  <span class="font-medium">📱 Messages to send:</span>
                  <span class="font-semibold">${data.consolidatedMessaging?.totalMessagesToSend || data.summary.studentsToNotify}</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span>🔴 Full day: ${data.summary.fullDayAbsent}</span>
                  <span>🟡 Partial: ${data.summary.partialDayAbsent}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ✅ Enhanced student list with better organization -->
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <h5 class="text-lg font-bold text-gray-800">Students Receiving Messages:</h5>
            <div class="text-sm text-gray-600">
              Showing ${Math.min(studentsToShow.length, 10)} of ${studentsToShow.length}
            </div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
            ${studentsToShow.slice(0, 10).map((student, index) => `
              <div class="student-card ${student.isFullDayAbsent ? 'full-day-absent' : 'partial-day-absent'} bg-white rounded-xl border-2 ${student.isFullDayAbsent ? 'border-red-200 hover:border-red-300' : 'border-yellow-200 hover:border-yellow-300'} p-5 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                
                <!-- Student Header -->
                <div class="flex justify-between items-start mb-4">
                  <div class="flex-1">
                    <div class="flex items-center mb-2">
                      <div class="w-8 h-8 bg-gradient-to-r ${student.isFullDayAbsent ? 'from-red-500 to-red-600' : 'from-yellow-500 to-yellow-600'} rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                        ${index + 1}
                      </div>
                      <div>
                        <div class="font-bold text-gray-800 text-lg">${student.studentID}</div>
                        <div class="text-sm text-gray-600">${student.studentName}</div>
                      </div>
                    </div>
                    <div class="flex items-center text-xs text-gray-500">
                      <i class="fas fa-phone mr-1"></i>
                      ${student.parentPhone || 'No phone number'}
                    </div>
                  </div>
                  
                  <!-- Status Badge -->
                  <div class="text-center">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${student.isFullDayAbsent ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                      ${student.isFullDayAbsent ? '🔴 Full Day' : `🟡 ${student.absentSubjectCount} subject(s)`}
                    </span>
                    ${student.attendancePercentage ? `
                      <div class="text-xs text-gray-500 mt-1">
                        ${student.attendancePercentage}% present
                      </div>
                    ` : ''}
                  </div>
                </div>
                
                <!-- Absence Details -->
                ${!student.isFullDayAbsent && student.absentSubjects.length > 0 ? `
                  <div class="bg-yellow-50 rounded-lg p-3 mb-4 border border-yellow-200">
                    <div class="text-xs font-semibold text-yellow-800 mb-2">
                      <i class="fas fa-exclamation-triangle mr-1"></i>
                      Absent in:
                    </div>
                    <div class="flex flex-wrap gap-1">
                      ${student.absentSubjects.map(subject => `
                        <span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded text-xs font-medium">
                          ${subject}
                        </span>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
                
                <!-- Message Preview -->
                <details class="mt-4">
                  <summary class="text-sm text-blue-600 cursor-pointer hover:text-blue-800 font-medium flex items-center">
                    <i class="fas fa-eye mr-2"></i>
                    Preview WhatsApp Message
                    <i class="fas fa-chevron-down ml-auto transition-transform duration-200"></i>
                  </summary>
                  <div class="message-preview mt-3 bg-gray-50 rounded-lg p-4 border-l-4 ${student.isFullDayAbsent ? 'border-red-500' : 'border-yellow-500'}">
                    <div class="text-sm text-gray-700 whitespace-pre-line font-mono leading-relaxed">
${student.isFullDayAbsent ? 
`🚨 *FULL DAY ABSENCE ALERT*

Dear Parent/Guardian,

Your child *${student.studentName}* (ID: ${student.studentID}) was *ABSENT FOR THE ENTIRE DAY* on ${data.date}.

📚 *Academic Details:*
• Stream: ${data.stream}
• Semester: ${data.semester}
• Total Classes Missed: ${student.absentSubjectCount}

📞 Please contact the school office if this information is incorrect.

🏫 *MLA Academy of Higher Learning*
Smart Attendance System` :
`⚠️ *PARTIAL ABSENCE ALERT*

Dear Parent/Guardian,

Your child *${student.studentName}* (ID: ${student.studentID}) was *ABSENT* for specific classes on ${data.date}.

📚 *Missing Classes:*
${student.absentSubjects.map((subj, i) => `${i + 1}. ${subj}`).join('\n')}

📊 *Details:*
• Stream: ${data.stream}
• Semester: ${data.semester}
• Classes Missed: ${student.absentSubjectCount}

📞 Please contact school if incorrect.

🏫 *MLA Academy of Higher Learning*
Smart Attendance System`}
                    </div>
                  </div>
                </details>
              </div>
            `).join('')}
            
            ${studentsToShow.length > 10 ? `
              <div class="col-span-full text-center p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                <p class="text-gray-600 mb-2">
                  <i class="fas fa-plus-circle mr-2"></i>
                  ${studentsToShow.length - 10} more students will receive messages
                </p>
                <button onclick="showAllStudents()" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                  View All Students
                </button>
              </div>
            ` : ''}
          </div>
        </div>
        
        <!-- ✅ Enhanced ready-to-send indicator -->
        <div class="mt-8 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
              </div>
              <div>
                <p class="text-green-800 font-bold text-lg">
                  Ready to Send Messages
                </p>
                <p class="text-green-600 text-sm">
                  ${data.consolidatedMessaging?.totalMessagesToSend || data.summary.studentsToNotify} consolidated WhatsApp messages
                </p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold text-green-700">
                ${data.consolidatedMessaging?.totalMessagesToSend || data.summary.studentsToNotify}
              </div>
              <div class="text-xs text-green-600">Messages</div>
            </div>
          </div>
        </div>
      </div>
    `;
  } else {
    // ✅ Enhanced perfect attendance display
    const attendanceRate = data.summary.overallAttendanceRate || '100%';
    
    resultsContent.innerHTML = messageStatusAlert + `
      <div class="bg-white rounded-2xl shadow-2xl p-8 text-center border border-gray-100">
        <div class="mb-8">
          <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
            <i class="fas fa-trophy text-white text-4xl"></i>
          </div>
          <h4 class="text-3xl font-bold text-gray-800 mb-4">🎉 Perfect Attendance!</h4>
          <p class="text-xl text-gray-600 mb-2">
            All students were present on ${data.date}
          </p>
          <p class="text-lg text-green-600 font-semibold">
            No absence messages needed today!
          </p>
        </div>
        
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-8">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-users text-green-600 text-2xl"></i>
              </div>
              <div class="text-3xl font-bold text-green-700">${data.summary.totalStudents}</div>
              <div class="text-sm text-green-600 font-medium">Total Students</div>
            </div>
            <div class="text-center">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-book text-green-600 text-2xl"></i>
              </div>
              <div class="text-3xl font-bold text-green-700">${data.summary.subjectsWithAttendance}</div>
              <div class="text-sm text-green-600 font-medium">Subjects Marked</div>
            </div>
            <div class="text-center">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-chart-line text-green-600 text-2xl"></i>
              </div>
              <div class="text-3xl font-bold text-green-700">${attendanceRate}</div>
              <div class="text-sm text-green-600 font-medium">Attendance Rate</div>
            </div>
          </div>
          
          <div class="mt-6 pt-6 border-t border-green-200">
            <p class="text-green-700 font-medium mb-2">
              <i class="fas fa-star mr-2 text-yellow-500"></i>
              Excellent work by all students and teachers!
            </p>
            <div class="text-sm text-green-600">
              Subjects with perfect attendance: <strong>${data.subjectsWithAttendance.join(', ')}</strong>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}

// ✅ ENHANCED: Send messages with comprehensive duplicate handling
async function sendMessages() {
  const inputs = validateForm();
  if (!inputs) {
    showNotification('❌ Please fill in all fields correctly', 'error');
    return;
  }
  
  if (!currentPreviewData) {
    showNotification('❌ Please preview messages first to verify the data', 'error');
    return;
  }
  
  const { stream, semester, date } = inputs;
  
  if (isLoading) {
    showNotification('⏳ Please wait for the current operation to complete', 'warning');
    return;
  }
  
  isLoading = true;
  
  const sendBtn = document.getElementById('sendBtn');
  const originalText = sendBtn.innerHTML;
  
  try {
    // ✅ Enhanced loading states
    sendBtn.innerHTML = '<div class="loading-spinner"></div>Checking message status...';
    sendBtn.disabled = true;
    
    updateSystemStatus('loading', 'Checking if messages were already sent...');
    
    const response = await fetch(`/api/send-absence-messages/${stream}/sem${semester}/${date}`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        forceResend: false,
        source: 'manual_trigger',
        timestamp: new Date().toISOString()
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // ✅ Handle already sent scenario
      if (result.alreadySent) {
        const confirmResult = await showDuplicateMessageDialog(result);
        
        if (confirmResult === 'resend') {
          // User confirmed to resend - call with forceResend
          await sendMessagesWithForce(stream, semester, date);
        } else if (confirmResult === 'view') {
          // User wants to view previous results
          displayAlreadySentResults(result);
          updateSystemStatus('connected', 'Showing previous message results');
          showNotification('📋 Showing previous message sending results', 'info');
        } else {
          // User cancelled
          updateSystemStatus('connected', 'Message sending cancelled by user');
          showNotification('❌ Message sending cancelled', 'info');
        }
      } else {
        // ✅ Normal send - messages were sent successfully
        displaySendResults(result);
        updateSystemStatus('connected', 'Messages sent successfully');
        
        const successMessage = result.summary.messagesFailed > 0
          ? `⚠️ Sent ${result.summary.messagesSent} messages with ${result.summary.messagesFailed} failures`
          : `✅ Successfully sent all ${result.summary.messagesSent} messages!`;
        
        showNotification(successMessage, result.summary.messagesFailed > 0 ? 'warning' : 'success');
        
        // ✅ Auto-refresh preview data
        setTimeout(() => {
          loadPreview();
        }, 2000);
      }
    } else {
      throw new Error(result.message || `Server error: ${response.status}`);
    }
  } catch (error) {
    console.error('❌ Error sending messages:', error);
    updateSystemStatus('disconnected', 'Failed to send messages');
    
    let errorMessage = 'Unknown error occurred';
    if (error.message.includes('Failed to fetch')) {
      errorMessage = 'Network connection failed. Please check your internet connection.';
    } else if (error.message.includes('500')) {
      errorMessage = 'Server error. Please try again later or contact support.';
    } else {
      errorMessage = error.message;
    }
    
    showNotification(`❌ Error: ${errorMessage}`, 'error');
  } finally {
    sendBtn.innerHTML = originalText;
    sendBtn.disabled = false;
    isLoading = false;
  }
}

// ✅ NEW: Enhanced duplicate message dialog
async function showDuplicateMessageDialog(data) {
  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    modal.innerHTML = `
      <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6 rounded-t-2xl">
          <div class="flex items-center">
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
              <i class="fas fa-exclamation-triangle text-2xl"></i>
            </div>
            <div>
              <h3 class="text-xl font-bold">Messages Already Sent Today!</h3>
              <p class="text-orange-100 text-sm">Duplicate message confirmation required</p>
            </div>
          </div>
        </div>
        
        <!-- Content -->
        <div class="p-6">
          <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6">
            <h4 class="font-semibold text-orange-800 mb-3">Previous Send Summary:</h4>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <strong>📅 Date:</strong> ${data.previousSendInfo.date}<br>
                <strong>🏫 Stream:</strong> ${data.previousSendInfo.stream}<br>
                <strong>📚 Semester:</strong> ${data.previousSendInfo.semester}
              </div>
              <div>
                <strong>⏰ Sent:</strong> ${data.previousSendInfo.lastSentAgo}<br>
                <strong>✅ Success:</strong> ${data.previousSendInfo.messagesSent}<br>
                <strong>❌ Failed:</strong> ${data.previousSendInfo.messagesFailed}
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
            <h4 class="font-semibold text-blue-800 mb-2">
              <i class="fas fa-info-circle mr-2"></i>
              What happens if you continue?
            </h4>
            <ul class="text-blue-700 text-sm space-y-1">
              <li>• Parents will receive <strong>duplicate messages</strong></li>
              <li>• This may cause confusion or annoyance</li>
              <li>• Use only if the previous send had errors</li>
              <li>• Consider contacting parents directly instead</li>
            </ul>
          </div>
          
          <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
            <h4 class="font-semibold text-yellow-800 mb-2">
              <i class="fas fa-lightbulb mr-2"></i>
              Subjects included in previous send:
            </h4>
            <div class="text-yellow-700 text-sm">
              ${data.previousSendInfo.subjectsIncluded.join(', ')}
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex flex-col sm:flex-row gap-3">
          <button id="cancelBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 px-4 rounded-xl font-semibold transition-colors">
            ❌ Cancel
          </button>
          <button id="viewBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors">
            📋 View Previous Results
          </button>
          <button id="resendBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors">
            🔄 Send Duplicate Messages
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listeners
    document.getElementById('cancelBtn').onclick = () => {
      document.body.removeChild(modal);
      resolve('cancel');
    };
    
    document.getElementById('viewBtn').onclick = () => {
      document.body.removeChild(modal);
      resolve('view');
    };
    
    document.getElementById('resendBtn').onclick = () => {
      document.body.removeChild(modal);
      resolve('resend');
    };
    
    // Close on backdrop click
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
        resolve('cancel');
      }
    };
  });
}

// ✅ NEW: Send messages with force resend
async function sendMessagesWithForce(stream, semester, date) {
  const sendBtn = document.getElementById('sendBtn');
  const originalText = sendBtn.innerHTML;
  
  try {
    sendBtn.innerHTML = '<div class="loading-spinner"></div>Force sending messages...';
    sendBtn.disabled = true;
    
    updateSystemStatus('loading', 'Force sending messages...');
    
    const response = await fetch(`/api/send-absence-messages/${stream}/sem${semester}/${date}`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        forceResend: true,
        source: 'manual_force_trigger',
        reason: 'User confirmed duplicate send',
        timestamp: new Date().toISOString()
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      displaySendResults(result);
      updateSystemStatus('connected', 'Force send completed');
      
      const message = result.summary.messagesFailed > 0
        ? `⚠️ Force sent ${result.summary.messagesSent} messages with ${result.summary.messagesFailed} failures`
        : `✅ Successfully force sent all ${result.summary.messagesSent} messages!`;
      
      showNotification(message, result.summary.messagesFailed > 0 ? 'warning' : 'success');
      
      // Auto-refresh preview data
      setTimeout(() => loadPreview(), 2000);
    } else {
      throw new Error(result.message || 'Force send failed');
    }
  } catch (error) {
    console.error('❌ Error in force send:', error);
    updateSystemStatus('disconnected', 'Force send failed');
    showNotification(`❌ Force send error: ${error.message}`, 'error');
  } finally {
    sendBtn.innerHTML = originalText;
    sendBtn.disabled = false;
  }
}

// ✅ NEW: Display already sent results
function displayAlreadySentResults(data) {
  const resultsContent = document.getElementById('resultsContent');
  if (!resultsContent) return;
  
  resultsContent.innerHTML = `
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <h4 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-history mr-3 text-blue-600"></i>
        Previous Message Results
      </h4>
      
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-700">${data.previousSendInfo.messagesSent}</div>
            <div class="text-sm text-blue-600">Messages Sent</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-red-700">${data.previousSendInfo.messagesFailed}</div>
            <div class="text-sm text-red-600">Messages Failed</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-700">${data.previousSendInfo.totalStudentsNotified}</div>
            <div class="text-sm text-green-600">Students Notified</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-700">${((data.previousSendInfo.messagesSent / (data.previousSendInfo.messagesSent + data.previousSendInfo.messagesFailed)) * 100).toFixed(1)}%</div>
            <div class="text-sm text-purple-600">Success Rate</div>
          </div>
        </div>
      </div>
      
      <div class="text-center text-gray-600">
        <p class="mb-2">Messages were sent on <strong>${data.previousSendInfo.date}</strong></p>
        <p class="text-sm">at ${new Date(data.previousSendInfo.sentAt).toLocaleString()}</p>
      </div>
    </div>
  `;
}

// ✅ NEW: Display send results
function displaySendResults(data) {
  const resultsContent = document.getElementById('resultsContent');
  if (!resultsContent) return;
  
  const successRate = data.summary.successRate || ((data.summary.messagesSent / (data.summary.messagesSent + data.summary.messagesFailed)) * 100).toFixed(1);
  
  resultsContent.innerHTML = `
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <h4 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-paper-plane mr-3 text-green-600"></i>
        Message Sending Results
      </h4>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="text-center bg-green-50 rounded-xl p-4">
          <div class="text-3xl font-bold text-green-700">${data.summary.messagesSent}</div>
          <div class="text-sm text-green-600">Successfully Sent</div>
        </div>
        <div class="text-center bg-red-50 rounded-xl p-4">
          <div class="text-3xl font-bold text-red-700">${data.summary.messagesFailed}</div>
          <div class="text-sm text-red-600">Failed to Send</div>
        </div>
        <div class="text-center bg-blue-50 rounded-xl p-4">
          <div class="text-3xl font-bold text-blue-700">${data.summary.studentsToNotify}</div>
          <div class="text-sm text-blue-600">Total Students</div>
        </div>
        <div class="text-center bg-purple-50 rounded-xl p-4">
          <div class="text-3xl font-bold text-purple-700">${successRate}%</div>
          <div class="text-sm text-purple-600">Success Rate</div>
        </div>
      </div>
      
      ${data.summary.messagesFailed > 0 ? `
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
          <h5 class="font-semibold text-yellow-800 mb-2">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Some Messages Failed
          </h5>
          <p class="text-yellow-700 text-sm">
            ${data.summary.messagesFailed} messages could not be delivered. This may be due to invalid phone numbers or network issues.
          </p>
        </div>
      ` : ''}
      
      <div class="bg-gray-50 rounded-xl p-6">
        <h5 class="font-semibold text-gray-800 mb-4">Summary:</h5>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <p><strong>Date:</strong> ${data.date}</p>
            <p><strong>Stream:</strong> ${data.stream}</p>
            <p><strong>Semester:</strong> ${data.semester}</p>
          </div>
          <div>
            <p><strong>Full Day Absent:</strong> ${data.summary.fullDayAbsent}</p>
            <p><strong>Partial Day Absent:</strong> ${data.summary.partialDayAbsent}</p>
            <p><strong>Subjects:</strong> ${data.subjectsIncluded.join(', ')}</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ✅ NEW: Show all students function
function showAllStudents() {
  if (!currentPreviewData || !currentPreviewData.absenceSummary) return;
  
  const studentsToShow = currentPreviewData.absenceSummary.filter(s => s.willReceiveMessage);
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
  
  modal.innerHTML = `
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-t-2xl">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold">All Students Receiving Messages</h3>
          <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-colors">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
          ${studentsToShow.map((student, index) => `
            <div class="border rounded-lg p-4 ${student.isFullDayAbsent ? 'border-red-200 bg-red-50' : 'border-yellow-200 bg-yellow-50'}">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="font-bold">${student.studentID}</div>
                  <div class="text-sm text-gray-600">${student.studentName}</div>
                  <div class="text-xs text-gray-500">${student.parentPhone}</div>
                </div>
                <span class="text-xs font-semibold px-2 py-1 rounded ${student.isFullDayAbsent ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800'}">
                  ${student.isFullDayAbsent ? 'Full Day' : `${student.absentSubjectCount} subjects`}
                </span>
              </div>
              ${!student.isFullDayAbsent ? `
                <div class="text-xs text-gray-600">
                  <strong>Absent:</strong> ${student.absentSubjects.join(', ')}
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}


    // NEW: Force send messages (for resending)
    async function sendMessagesForce(stream, semester, date) {
      const sendBtn = document.getElementById('sendBtn');
      const originalText = sendBtn.innerHTML;
      sendBtn.innerHTML = '<div class="loading-spinner"></div>Force Sending Messages...';
      sendBtn.disabled = true;
      
      updateSystemStatus('loading', 'Force sending WhatsApp messages...');
      
      try {
        const response = await fetch(`/api/send-absence-messages/${stream}/sem${semester}/${date}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ forceResend: true })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          displaySendResults(result);
          updateSystemStatus('connected', 'Messages force sent successfully');
          showNotification(`✅ Force sent ${result.summary.messagesSent} messages!`, 'success');
        } else {
          throw new Error(result.message || 'Failed to force send messages');
        }
      } catch (error) {
        console.error('Error force sending messages:', error);
        updateSystemStatus('disconnected', 'Failed to force send messages');
        showNotification('❌ Error force sending messages: ' + error.message, 'error');
      } finally {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
      }
    }

    // NEW: Display already sent results
    function displayAlreadySentResults(result) {
      const resultsContent = document.getElementById('resultsContent');
      if (!resultsContent) return;
      
      const info = result.previousSendInfo;
      
      resultsContent.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h4 class="text-2xl font-bold text-orange-800 mb-6">
            <i class="fas fa-info-circle mr-3 text-orange-600"></i>Messages Already Sent Today!
          </h4>
          
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-6">
            <h5 class="font-semibold text-orange-800 mb-3">
              <i class="fas fa-clock mr-2"></i>Previous Send Information:
            </h5>
            <div class="text-orange-700 space-y-2">
              <p><strong>Date:</strong> ${info.date}</p>
              <p><strong>Stream:</strong> ${info.stream} Semester ${info.semester}</p>
              <p><strong>Messages Sent:</strong> ${info.messagesSent}</p>
              <p><strong>Messages Failed:</strong> ${info.messagesFailed}</p>
              <p><strong>Students Notified:</strong> ${info.totalStudentsNotified}</p>
              <p><strong>Subjects Included:</strong> ${info.subjectsIncluded.join(', ')}</p>
              <p><strong>Sent At:</strong> ${new Date(info.sentAt).toLocaleString()}</p>
              <p><strong>Sent By:</strong> ${info.sentBy || 'Manual'}</p>
            </div>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h5 class="font-semibold text-blue-800 mb-3">
              <i class="fas fa-lightbulb mr-2"></i>What This Means:
            </h5>
            <div class="text-blue-700 space-y-2">
              <p>• WhatsApp messages have already been sent to parents for this date</p>
              <p>• Sending again would create duplicate notifications</p>
              <p>• Parents have already been informed about absences</p>
              <p>• The system prevents accidental duplicate messages</p>
            </div>
          </div>
          
          <div class="text-center space-x-4">
            <button onclick="clearForm()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-300 font-semibold">
              <i class="fas fa-plus mr-2"></i>Send Messages for Different Date
            </button>
            
            <button onclick="forceResendConfirm()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-8 py-3 rounded-xl hover:from-orange-600 hover:to-orange-700 transition-all duration-300 font-semibold">
              <i class="fas fa-redo mr-2"></i>Force Resend Anyway
            </button>
          </div>
        </div>
      `;
    }

    // NEW: Confirm force resend
    function forceResendConfirm() {
      const inputs = validateForm();
      if (!inputs) return;
      
      const { stream, semester, date } = inputs;
      
      const confirmMsg = `⚠️ FORCE RESEND CONFIRMATION

This will send DUPLICATE WhatsApp messages to parents!

Are you absolutely sure you want to:
• Send messages again for ${stream} Semester ${semester}
• On date: ${date}
• Even though messages were already sent today?

Parents will receive duplicate notifications.

Continue with force resend?`;

      if (confirm(confirmMsg)) {
        sendMessagesForce(stream, semester, date);
      }
    }

    // Display send results
    function displaySendResults(result) {
      const resultsContent = document.getElementById('resultsContent');
      if (!resultsContent) return;
      
      const successRate = result.summary.messagesSent + result.summary.messagesFailed > 0 ? 
        ((result.summary.messagesSent / (result.summary.messagesSent + result.summary.messagesFailed)) * 100).toFixed(1) : 0;
      
      resultsContent.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <h4 class="text-2xl font-bold text-green-800 mb-6">
            <i class="fas fa-check-circle mr-3 text-green-600"></i>Messages Sent Successfully!
          </h4>
          
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="stats-card rounded-xl p-6 text-center border-l-4 border-green-500">
              <div class="text-3xl font-bold text-green-600 mb-2">${result.summary.messagesSent}</div>
              <div class="text-sm text-gray-600">Messages Sent</div>
            </div>
            
            <div class="stats-card rounded-xl p-6 text-center border-l-4 border-red-500">
              <div class="text-3xl font-bold text-red-600 mb-2">${result.summary.messagesFailed}</div>
              <div class="text-sm text-gray-600">Failed</div>
            </div>
            
            <div class="stats-card rounded-xl p-6 text-center border-l-4 border-purple-500">
              <div class="text-3xl font-bold text-purple-600 mb-2">${result.summary.fullDayAbsent}</div>
              <div class="text-sm text-gray-600">Full Day Messages</div>
            </div>
            
            <div class="stats-card rounded-xl p-6 text-center border-l-4 border-orange-500">
              <div class="text-3xl font-bold text-orange-600 mb-2">${result.summary.partialDayAbsent}</div>
              <div class="text-sm text-gray-600">Partial Day Messages</div>
            </div>
          </div>
          
          <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
            <h5 class="font-semibold text-green-800 mb-3">
              <i class="fas fa-info-circle mr-2"></i>Summary:
            </h5>
            <div class="text-green-700 space-y-1">
              <p><strong>Date:</strong> ${result.date}</p>
              <p><strong>Stream:</strong> ${result.stream} Semester ${result.semester}</p>
              <p><strong>Success Rate:</strong> ${successRate}%</p>
              <p><strong>Subjects included:</strong> ${result.subjectsIncluded.join(', ')}</p>
              <p><strong>Sent at:</strong> ${new Date(result.triggeredAt).toLocaleString()}</p>
              ${result.summary.isForceResend ? '<p><strong>Type:</strong> Force Resend</p>' : ''}
            </div>
          </div>
          
          ${result.summary.messagesFailed > 0 ? `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6">
              <h5 class="font-semibold text-red-800 mb-3">
                <i class="fas fa-exclamation-triangle mr-2"></i>Failed Messages:
              </h5>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                ${result.whatsappResults.filter(r => !r.success).slice(0, 10).map(failure => `
                  <div class="text-sm text-red-700">
                    <strong>${failure.studentID}</strong> - ${failure.error}
                  </div>
                `).join('')}
                ${result.whatsappResults.filter(r => !r.success).length > 10 ? 
                  `<div class="text-sm text-red-600">... and ${result.whatsappResults.filter(r => !r.success).length - 10} more</div>` : ''}
              </div>
            </div>
          ` : ''}
          
          <div class="text-center mt-8">
            <button onclick="clearForm()" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-8 py-3 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-300 font-semibold">
              <i class="fas fa-plus mr-2"></i>Send More Messages
            </button>
          </div>
        </div>
      `;
    }

    // Notification system
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notificationContainer');
      if (!container) return;
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="flex items-center justify-between">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      container.appendChild(notification);
      
      // Show notification
      setTimeout(() => notification.classList.add('show'), 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }
      }, 5000);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        previewMessages();
      }
      
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        sendMessages();
      }
      
      if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        clearForm();
      }
    });

  </script>
</body>

</body>
</html>
